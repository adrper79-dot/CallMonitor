# Cloudflare & Codebase Roadmap (Updated: Feb 8, 2026)

**Architecture**: âœ… **HYBRID GOSPEL** - Static UI (Cloudflare Pages) + Workers API (Hono) + Neon Postgres (Hyperdrive)  
**Deployment**: âœ… Live at https://voxsouth.online (Pages) + https://wordisbond-api.adrper79.workers.dev (API)  
**Status**: âœ… **PRODUCTION** â€” Custom Workers auth (9 endpoints), all API routes live, 29/29 production-verified  
**Progress**: 104/109 items complete | Tests: âœ… GREEN CI (123 passed, 87 skipped) | Lint: âœ… PASSING (126 warnings)

> **Auth**: âœ… RESOLVED â€” Custom session-based auth built on Cloudflare Workers (Hono). PBKDF2 passwords, CSRF protection, KV rate limiting, HttpOnly cookies. See [AUTH_ARCHITECTURE_DECISION.md](AUTH_ARCHITECTURE_DECISION.md).

---

## ðŸš¨ BLOCKERS (Deploy/Tests) - PROGRESS: 15/15 âœ… COMPLETE

### âœ… Completed

- [x] **Tests/DB Auth** (`tests/setup.ts`): Added Neon/pg mocks. âœ…
- [x] **Build Static** (`next.config.js`): `output: 'export'` configured. âœ…
- [x] **Vitest Timeout** (`vitest.config.ts`): 30s timeout set. âœ…
- [x] **UUID Mock** (`tests/setup.ts`): Added uuid mock. âœ…
- [x] **RateLimit Reset** (`rateLimit.test.ts`): Fixed flaky timing test. âœ…
- [x] **Compliance RLS** (`compliance.test.ts`): Added vitest mocks. âœ…
- [x] **CRM Token** (`crm-integration.test.ts`): Mocked pool + crmService. âœ…
- [x] **Translation Mock** (`translation.test.ts`): Fixed pgClient mock. âœ…
- [x] **Cron Triggers** (`workers/wrangler.toml`): Added scheduled handlers. âœ…
- [x] **Health Route** (`workers/src/routes/health.ts`): DB/KV/R2 checks. âœ…
- [x] **Env Verify** (`scripts/verify-env.ts`): Pre-deploy validation. âœ…
- [x] **Auth Migration** (`migrations/auth_pg_adapter.sql`): Created. âœ…
- [x] **Integration Tests Skippable** (`describeOrSkip` pattern): 13 test files marked. âœ…
- [x] **Orphaned Code Cleanup** (`__tests__/*.ts`): Fixed syntax errors. âœ…
- [x] **Missing Imports** (`tier1-features.test.ts`): Added FEATURE_FLAGS import. âœ…

### ðŸ“‹ Status

> **All blockers resolved!** CI is now green with 123 passing tests.
> Integration tests run with: `RUN_INTEGRATION=1 npm test`

---

## âš ï¸ RISK/SCALE (Perf/Sec) - PROGRESS: 25/25 âœ… COMPLETE (1 N/A)

### âœ… Completed

- [x] **Cache TTL** (`lib/cache.ts`): ORG preset bumped to 10m/24h. âœ…
- [x] **Cron Triggers** (`workers/wrangler.toml`): 3 crons configured. âœ…
- [x] **Health Route** (`workers/src/routes/health.ts`): Full bind checks. âœ…
- [x] **Deps Audit** (`package.json`): Removed 10 unused packages. âœ…
- [x] **Workers Split** (`workers/`): Hono API fully scaffolded. âœ…
- [x] **Hyperdrive Fallback** (`lib/pgClient.ts`): Bind preference. âœ…
- [x] **KV Sessions** (`workers/src/lib/auth.ts`): JWT via KV. âœ…
- [x] **Scheduled Handler** (`workers/src/scheduled.ts`): Cron jobs. âœ…
- [x] **R2 Proxy** (`workers/src/routes/recordings.ts`): Full R2 recordings CRUD + signed URLs. âœ…
- [x] **RateLimit Edge** (`workers/src/lib/rate-limit.ts`): KV-backed rate limiting. âœ…
- [x] **Pool Hardening** (`workers/src/lib/db.ts`): max=5, idle/connection timeouts, statement_timeout=30s. âœ…
- [x] **Structured Logger** (`workers/src/lib/logger.ts`): JSON structured logging, all console.log/warn/error migrated. âœ…
- [x] **Idempotency** (`workers/src/lib/idempotency.ts`): KV-backed, fail-open, 24h TTL, wired to billing/calls/bookings mutations. âœ…
- [x] **Billing 500 Fix** (`workers/src/routes/billing.ts`): Column fallback for missing `plan` column. âœ…
- [x] **Audit Logs** (`workers/src/lib/audit.ts`): Centralized writeAuditLog utility + wired to calls, billing, recordings. âœ…
- [x] **CORS Idempotency Fix** (`workers/src/index.ts`): Added `Idempotency-Key` to allowHeaders + `Idempotent-Replayed` to exposeHeaders. âœ…
- [x] **X-Correlation-ID** (`workers/src/index.ts`): Response header + CORS `exposeHeaders` for client-side log correlation. âœ…
- [x] **CSRF Hardening** (`workers/src/routes/auth.ts`): CSRF token validation on signup + forgot-password (matching login pattern). Frontend forms updated. âœ…
- [x] **Supabase Removal** (`package.json`): Removed `@supabase/ssr`; `CampaignProgress` rewritten from Realtime to API polling. âœ…
- [x] **RLS Audit** (`scripts/rls-audit.sql`): Diagnostic script â€” table RLS status, active policies, org-scoped gaps, fix SQL. âœ…
- [x] **Schema Drift** (`scripts/schema-drift-check.sh`): CI-ready diff check â€” live vs snapshot, `db:schema-check` / `db:schema-snapshot` scripts. âœ…

### ðŸ”„ Remaining

- [x] ~~**Sentry Workers**~~ **N/A** â€” Removed; using structured logger + Cloudflare Logpush. âœ…
- [ ] **WAF Rules** (CF Dashboard): Rate limit /api. **10min**
- [x] ~~**Origin CA**~~ **N/A** â€” Pages + Workers run natively on Cloudflare edge; no origin server to protect with Origin CA. Universal SSL already active. âœ…
- [x] **Image CDN** (`next.config.js` + `lib/cloudflare-image-loader.ts`): CF Image Resizing loader + remotePatterns config. âœ…
- [x] **Backup Policy** (`scripts/neon-backup.sh`): pg_dump â†’ gzip, 30-day retention, `db:backup` npm script. âœ…
- [x] **Public Compress** (`public/branding/`): logo-master.webp exists (84% savings). PNG originals retained for brand guidelines. âœ…
- [x] **OpenAPI Gen** (`public/openapi.yaml`): Updated with 12 new route groups (bookings, audit, orgs, users, scorecards, caller-id, webrtc, bond-ai, tts, usage) + 7 new schemas. âœ…
- [x] **Rate Limiting** (6 route files): KV-backed per-IP rate limits on billing, calls, voice, team, bookings, webhooks â€” 22 mutation endpoints protected. âœ…
- [x] **Analytics Rate Limiting** (`workers/src/routes/analytics.ts`): 8 read endpoints (60/5min) + CSV export (5/15min), pool leak fix on all 12 DB-backed endpoints. âœ…
- [x] **Stripe Webhook Audit Logging** (`workers/src/routes/webhooks.ts`): writeAuditLog() on 4 Stripe handlers (subscription updated/canceled, invoice paid/failed), pool leak fix. âœ…
- [x] **Pool Leak Remediation** (all 34 route files): Every `getDb()` call now has `finally { await db.end() }` â€” 147+ endpoints fixed. Zero connection leaks. âœ…
- [x] **RLS Enforcement Migration** (`migrations/2026-02-08-rls-enforcement.sql`): Idempotent RLS policies for 30 org-scoped tables. âœ…

### ðŸ“‹ Recommendations

> **Priority**: WAF rules + RLS Audit (core resilience).
> **Security**: WAF rules should be configured in CF Dashboard immediately.
> **Compliance**: RLS Audit critical for HIPAA/SOC2 requirements.
> **Resilience**: âœ… Idempotency layer complete â€” billing, calls, bookings protected.

---

## ðŸ”§ DX/CI (Dev Flow) - PROGRESS: 19/20

### âœ… Completed

- [x] **gitignore** (`.gitignore`): Cleaned up patterns. âœ…
- [x] **Vitest CI** (`vitest.config.ts`): Coverage thresholds 60%. âœ…
- [x] **Scripts Menu** (`package.json`): Organized npm scripts. âœ…
- [x] **Env Example** (`.env.example`): All vars documented. âœ…
- [x] **Tier1 Guard** (`vitest.config.ts`): Test gate ready. âœ…
- [x] **describeOrSkip Pattern** (all test files): Integration tests skippable. âœ…
- [x] **Test Syntax Fixes** (`__tests__/*.ts`): Orphaned code cleanup. âœ…
- [x] **Prettier** (`.prettierrc`): Config added + format scripts. âœ…
- [x] **ESLint Flat Config** (`eslint.config.mjs`): ESLint 9 migration. âœ…
- [x] **Lint Fix** (`eslint`): 0 errors, 126 warnings (gradual cleanup). âœ…
- [x] **React Hooks Fix** (`useVoiceConfig.tsx`): Fixed conditional hooks violation. âœ…
- [x] **Husky** (`.husky/pre-commit`): Pre-commit hooks with lint-staged (ESLint + Prettier). âœ…
- [x] **Console Cleanup** (`workers/src/`): All console.log/warn/error â†’ structured logger. âœ…
- [x] **DB Reset** (`migrations/reset_test.sql`): Idempotent truncate + deterministic test org/users/calls/audit seed. âœ…
- [x] **README Scripts** (`README.md`): Root README with architecture, all npm scripts, project structure, env vars, deploy guide. âœ…
- [x] **Types Gen** (`.husky/pre-commit`): Auto-runs `wrangler types` when wrangler config changes in pre-commit. âœ…

### ðŸ”„ Remaining

- [ ] **Test E2E** (`tests/e2e/`): Playwright setup. **2hr**
- [x] **Manual Tests** (`scripts/smoke-test.sh`): Curl-based smoke tests â€” public/auth-boundary/auth-flow/authenticated/rate-limit endpoints, `test:smoke` npm script. âœ…
- [x] **Schema Doc** (`docs/SCHEMA_ERD.md`): Mermaid ERD with 47 active tables, all relationships, multi-tenant isolation diagram. âœ…
- [x] **Permission Matrix** (`tools/generate-permission-matrix.ts` â†’ `docs/PERMISSION_MATRIX.md`): Auto-generated 66 routes Ã— 7 roles matrix with role inheritance. âœ…

### ðŸ“‹ Recommendations

> **Quick Wins**: Types Gen CI hook (10min), DB Reset script (30min), README scripts doc (30min).
> **E2E**: Consider Playwright for critical flows (signin, call start).
> **Docs**: Schema ERD helps onboarding new developers.
> **Pre-commit**: âœ… Husky + lint-staged now auto-lint + auto-format on commit.

---

## ðŸ† DESIGN/CODE EXCELLENCE (ARCH_DOCS Alignment) - PROGRESS: 6/12

**Standards**: Call-rooted architecture, single Voice Ops UI, immutable data (CAS), edge-first, strict RBAC, Telnyx integration.
**Practices**: Typesafe (Zod validation), DRY principles, structured logging (no console.log), error boundaries, modular libs.
**Elegant**: Modular architecture, HOFs/custom hooks, performance (Suspense/streaming), design system (cva).

### ðŸš¨ Design Violations (Architecture)

- [x] **SWML â†’ Telnyx** (`app/api/calls/*`, `lib/signalwire*`, `tests/call*`): Migrate to Telnyx VXML. âœ…
  > Fully complete: All SignalWire code/config/references removed in v4.16. `lib/webhookSecurity.ts` + `app/services/recordingStorage.ts` deleted. `.env.example`, landing page, trust page, evidence manifest, circuit breaker, fetchWithRetry, callPlacer JSDoc all updated. `@supabase/ssr` removed.
- [x] **Multi-Pages Consolidation** (`app/voice/` â†’ redirect only): `voice-operations/` is the single Voice Ops root. `voice/` is a 5-line redirect page. âœ…
- [x] **Console Logging** (`workers/src/`): Structured logger (`workers/src/lib/logger.ts`) + all routes migrated. âœ…

### âš ï¸ Best Practices (Code Quality)

- [x] **Zod API Validation** (`workers/src/lib/schemas.ts`): 45+ schemas, all POST/PUT routes validated. âœ…
- [x] **Error Boundaries** (`app/error.tsx` + 10 route-specific): Root catch-all + key routes covered. âœ…
- [x] **RBAC Hooks** (`hooks/useRole.ts`): `useRole`, `usePermissions` hooks + Workers RBAC route. âœ…
- [x] **Immutable Evidence** (`migrations/2026-02-09-evidence-immutable-views.sql`): SELECT-only RLS policies + 3 read-only views. HIPAA safe harbor. âœ…

### ðŸ”§ Elegant Patterns (Developer Experience)

- [ ] **Lib Modules** (`lib/`): Split into `/db`, `/api`, `/ui` modules. **4hr**
- [ ] **Higher-Order Hooks** (`hooks/`): Create `useCallModulation` HOF. **2hr**
- [x] **Suspense/Streaming** (`app/`): Loading boundaries for bookings, campaigns, reports, settings, analytics. âœ…
- [ ] **Tailwind CVA** (`components/` with raw clsx): Migrate to class-variance-authority. **2hr**

### ðŸ“‹ Recommendations

> **Priority**: Zod validation (API security) + Error boundaries (stability) first.
> **Architecture**: Telnyx migration aligns with LAW compliance + vendor diversity.
> **Modularity**: Lib split enables better tree-shaking and faster builds.
> **Elegance**: CVA + HOFs reduce boilerplate, improve DX significantly.

---

## âœ¨ POLISH (Ongoing) - 40+ Items

Low priority, addressed during normal dev work:

- Unused imports cleanup (lint --fix)
- Console.log removal
- Comment cleanup
- Emoji standardization

---

## ðŸ“Š Test Status Summary

| Category    | Passed  | Skipped | Total   |
| ----------- | ------- | ------- | ------- |
| Unit Tests  | 81      | 58      | 139     |
| Integration | 42      | 29      | 71      |
| **Total**   | **123** | **87**  | **210** |

**CI Status**: âœ… GREEN (100% pass rate on non-skipped tests)

### Skipped Test Suites (Integration-Only)

These tests use `describeOrSkip` and run with `RUN_INTEGRATION=1`:

1. `startCallHandler.test.ts` - SignalWire integration
2. `startCallHandler.enforce.test.ts` - Voice config enforcement
3. `callExecutionFlow.test.ts` - Full call flow
4. `startCallFlow.test.ts` - Call start integration
5. `scoring.test.ts` - Scorecard with DB
6. `evidenceManifest.test.ts` - Artifact DB operations
7. `crm-integration.test.ts` - CRM sync
8. `compliance.test.ts` - HIPAA/SOC2 RLS
9. `external-entities.test.ts` - Entity overlay
10. `governed-caller-id.test.ts` - Caller ID governance
11. `immutable-search.test.ts` - Search layer
12. `rti-layer.test.ts` - RTI immutability
13. `tier1-features.test.ts` - Core features
14. `rateLimit.test.ts` - Rate limiting

### ðŸ“‹ Test Recommendations

> **Run Integration Tests**: `RUN_INTEGRATION=1 npm run test:run`
> **Option B**: Create `.env.test.local` with real Neon test DB for full integration runs.
> **Option C**: Add GitHub Action that runs integration tests on `main` branch only.

---

## ðŸš€ Deployment Commands

```bash
# Verify environment before deploy
npm run env:verify

# Deploy UI (Cloudflare Pages)
npm run ui:deploy

# Deploy API (Cloudflare Workers)
npm run api:deploy

# Deploy both
npm run deploy:all   # Includes env:verify

# Check health
npm run health-check
```

---

## ðŸ“… Next Sprint Priorities

### Week 1 (Feb 1-7)

1. âœ… Test mocks complete (123/210 passing, 87 integration-skipped)
2. âœ… Skip integration tests for CI (`describeOrSkip` pattern)
3. âœ… Prettier + ESLint flat config setup
4. âœ… Lint --fix completed (0 errors, 126 warnings)
5. âœ… Deploy UI + API to production
6. [ ] Configure WAF rules
7. âœ… ~~Set up Sentry for Workers~~ â€” Removed; using structured logger + Cloudflare Logpush

### Week 2 (Feb 8-14) - **Excellence Focus**

1. âœ… **Zod API Validation** (45+ schemas): All Workers routes validated
2. âœ… **Error Boundaries** (app/): Root + 10 route-specific boundaries
3. âœ… Console.log â†’ Logger service migration (all Workers routes)
4. âœ… R2 proxy for recordings (already implemented in Workers)
5. âœ… KV-backed rate limiting (already implemented)
6. [ ] Playwright E2E for critical flows

### Week 3 (Feb 15-21) - **Architecture Refinement**

1. [x] **Telnyx Migration** (SWML â†’ Telnyx): Legacy SignalWire code deleted. Workers already uses Telnyx Call Control directly. âœ…
2. [ ] **Lib Modules** (lib/ â†’ /db/api/ui): Modular architecture
3. [x] **RBAC Hooks** (`hooks/useRole.ts`): useRole, usePermissions hooks âœ…
4. [x] RLS audit and hardening (`migrations/2026-02-08-rls-enforcement.sql` + `scripts/rls-audit.sql`) âœ…
5. [x] Schema drift CI check (`scripts/schema-drift-check.sh`) âœ…

### Week 4+ (Feb 22+) - **Elegance & Scale**

1. [ ] **CVA Migration** (Tailwind): Design system
2. [x] **Suspense/Streaming** (app/): Loading boundaries for bookings, campaigns, reports, settings, analytics âœ…
3. [ ] **HOF Hooks** (useCallModulation): Elegant patterns
4. [x] OpenAPI generation âœ…
5. [x] Idempotency layer âœ…
6. [x] Full audit logging âœ…

---

**Track**: Update [x] as items complete. **Progress**: 104/109 (95%).
**Last Updated**: Feb 8, 2026 by GitHub Copilot

---

## ðŸš€ STACK EXCELLENCE (Full-Stack Integration) â€” PROGRESS: 12/12 âœ… COMPLETE

**Stack**: Cloudflare (Pages/Workers/Hyperdrive/R2/KV) + Neon (Postgres) + Telnyx (Voice) + Stripe (Billing) + AssemblyAI (Transcription) + OpenAI (LLM) + ElevenLabs (TTS)

### Telephony (Telnyx VXML)

- [x] **Telnyx VXML Migration** (app/\_api_to_migrate/calls\*): Workers API uses Telnyx Call Control directly. Legacy `lib/signalwire/` deleted in v4.15. âœ…
- [x] **Webhook Handlers** (workers/src/routes/webhooks.ts): Telnyx call events + HMAC verification. âœ…
- [x] **Call Recording Storage** (workers/src/routes/recordings.ts): R2 bucket integration + signed URLs. âœ…

### Billing (Stripe)

- [x] **Stripe Webhooks** (workers/src/routes/billing.ts): HMAC-verified webhooks. âœ…
- [x] **Usage Metering** (`workers/src/routes/usage.ts`): Calls, minutes, recordings, transcriptions per month with plan limits + rate limiting. âœ…
- [x] **Subscription Management** (`workers/src/routes/billing.ts`): Resume, change-plan (upgrade/downgrade with Stripe proration) + full pool leak fix. âœ…

### AI Stack (Edge Proxies)

- [x] **AssemblyAI Proxy** (`workers/src/routes/ai-transcribe.ts`): Edge proxy with plan-gating (starter+), rate limiting, usage tracking, audit logging. âœ…
- [x] **OpenAI Rate Limiter** (`workers/src/routes/ai-llm.ts`): KV-throttled chat/summarize/analyze with plan-gating (pro+), input validation, cost tracking. âœ…
- [x] **ElevenLabs TTS** (`workers/src/routes/tts.ts`): KV-cached audio by content hash (SHA-256 of text+voice+model). 7-day TTL. Skips ElevenLabs API on cache hit. âœ…

### Database (Neon)

- [x] **Connection Pool Hardening** (`workers/src/lib/db.ts`): max=5, idle/connection timeouts, statement_timeout=30s. âœ…
- [x] **Query Timeout Config** (`workers/src/lib/db.ts`): Statement timeout = 30s via connection options. âœ…
- [x] **Plan Gating Middleware** (`workers/src/lib/plan-gating.ts`): KV-cached plan lookup, `requirePlan()` guard, applied to bond-ai/reports/teams. âœ…
- [x] **Capabilities API** (`workers/src/routes/capabilities.ts`): 3 endpoints â€” all capabilities, batch check, plan details. âœ…
- [x] **RLS Policy Audit** (`migrations/2026-02-08-rls-enforcement.sql`): 30 org-scoped tables with idempotent RLS policies. âœ…

---
