"use strict";(self.webpackChunk_N_E=self.webpackChunk_N_E||[]).push([[9655],{1719:(e,t,a)=>{a.d(t,{A:()=>c});var l=a(95155),n=a(12115),s=a(79288),r=a(67812),i=a(97003);function c(e){let{callId:t,organizationId:a,limit:c=10,events:o}=e,[d,u]=(0,n.useState)(o||[]),[m,f]=(0,n.useState)("all"),{updates:h,connected:p}=(0,s.x)(a||null),{data:g}=(0,s.n)(async()=>{if(!a)return[];try{let e=await fetch("/api/audit-logs?orgId=".concat(encodeURIComponent(a),"&limit=").concat(c),{credentials:"include"});if(401===e.status)return[];if(e.ok)return(await e.json()).events||[];return[]}catch(e){return[]}},3e4,!p&&!!a);(0,n.useEffect)(()=>{h.length&&h.forEach(e=>{if("audit_logs"===e.table||"calls"===e.table||"recordings"===e.table||"ai_runs"===e.table){var t,a,l,n,s,r;let i={id:(null==(t=e.new)?void 0:t.id)||"event-".concat(Date.now()),call_id:(null==(a=e.new)?void 0:a.call_id)||(null==(l=e.new)?void 0:l.call_sid)||void 0,timestamp:(null==(n=e.new)?void 0:n.created_at)||new Date().toISOString(),type:function(e,t){if("calls"===e)return"completed"===t.status?"call.completed":"failed"===t.status?"call.failed":"call.started";if("recordings"===e)return"recording.available";if("ai_runs"===e){var a,l;return(null==(a=t.model)?void 0:a.includes("transcription"))?"transcription.completed":(null==(l=t.model)?void 0:l.includes("translation"))?"translation.completed":"ai.run.completed"}return"".concat(e,".updated")}(e.table,e.new),title:function(e,t){if("calls"===e)return"completed"===t.status?"Call completed":"failed"===t.status?"Call failed":"Call started";if("recordings"===e)return"Recording available";if("ai_runs"===e){var a,l;return(null==(a=t.model)?void 0:a.includes("transcription"))?"Transcription completed":(null==(l=t.model)?void 0:l.includes("translation"))?"Translation completed":"AI processing completed"}return"".concat(e," updated")}(e.table,e.new),status:(s=e.table,r=e.new,"calls"===s?"completed"===r.status?"success":"failed"===r.status?"error":"info":"recordings"===s||"ai_runs"===s?"success":"info")};u(e=>[i,...e].slice(0,2*c))}})},[h,c]),(0,n.useEffect)(()=>{!p&&g.length>0&&u(g)},[g,p]);let v=d.filter(e=>t?e.call_id===t:"all"===m||e.type.includes(m)).slice(0,c);return(0,l.jsxs)("section",{"aria-label":"Activity feed",className:"w-full",children:[(0,l.jsxs)("div",{className:"flex items-center justify-between mb-3",children:[(0,l.jsx)("h3",{className:"text-sm font-semibold text-gray-900",children:"Activity"}),!p&&(0,l.jsx)("span",{className:"text-xs text-warning","aria-label":"Real-time disconnected",children:"Offline"})]}),!t&&(0,l.jsxs)("div",{className:"flex gap-1 mb-3",children:[(0,l.jsx)(i.$,{variant:"all"===m?"secondary":"ghost",size:"sm",onClick:()=>f("all"),className:"text-xs",children:"All"}),(0,l.jsx)(i.$,{variant:"call"===m?"secondary":"ghost",size:"sm",onClick:()=>f("call"),className:"text-xs",children:"Calls"}),(0,l.jsx)(i.$,{variant:"transcript"===m?"secondary":"ghost",size:"sm",onClick:()=>f("transcript"),className:"text-xs",children:"Transcripts"})]}),(0,l.jsxs)("div",{role:"status","aria-live":"polite",className:"sr-only",children:[v.length," events shown"]}),(0,l.jsx)("div",{className:"max-h-[60vh] overflow-y-auto",children:0===v.length?(0,l.jsx)("div",{className:"py-8 text-center text-sm text-gray-400",children:"No recent activity"}):(0,l.jsx)("ul",{className:"space-y-2",children:v.map(e=>(0,l.jsx)("li",{className:"p-3 bg-gray-50 rounded-md border border-gray-200 transition-colors ".concat(e.call_id?"cursor-pointer hover:bg-gray-100":""),onClick:()=>e.call_id&&void(e.call_id&&window.dispatchEvent(new CustomEvent("call:select",{detail:{callId:e.call_id}}))),children:(0,l.jsxs)("div",{className:"flex items-start justify-between gap-3",children:[(0,l.jsxs)("div",{className:"flex-1 min-w-0",children:[(0,l.jsx)("p",{className:"text-sm text-gray-900",children:e.title}),(0,l.jsx)("p",{className:"text-xs text-gray-500 mt-1",children:new Date(e.timestamp).toLocaleString()}),e.call_id&&(0,l.jsxs)("p",{className:"text-xs text-primary-600 mt-1",children:["Call: ",e.call_id.slice(0,8),"..."]})]}),(0,l.jsx)(r.E,{variant:"error"===e.status?"error":"warning"===e.status?"warning":"success"===e.status?"success":"default",children:e.status||"info"})]})},e.id))})})]})}},2521:(e,t,a)=>{a.d(t,{z:()=>s});var l=a(95155);a(12115);let n={primary:"bg-primary-600",blue:"bg-primary-600",green:"bg-success",orange:"bg-warning",red:"bg-error"};function s(e){let{value:t,label:a,color:s="primary",showValue:r=!1,className:i=""}=e,c=Math.max(0,Math.min(100,t)),o=n[s];return(0,l.jsxs)("div",{className:i,children:[a&&(0,l.jsxs)("div",{className:"flex justify-between text-xs mb-1",children:[(0,l.jsx)("span",{className:"text-gray-500",id:"progress-label-".concat(a.replace(/\s+/g,"-").toLowerCase()),children:a}),r&&(0,l.jsxs)("span",{className:"text-gray-900 font-medium tabular-nums",children:[Math.round(c),"%"]})]}),(0,l.jsx)("div",{className:"h-2 bg-gray-100 rounded-full overflow-hidden",role:"progressbar","aria-valuenow":Math.round(c),"aria-valuemin":0,"aria-valuemax":100,"aria-label":a||"Progress: ".concat(Math.round(c),"%"),children:(0,l.jsx)("div",{className:"h-full ".concat(o," transition-all duration-300 ease-out"),style:{width:"".concat(c,"%")}})})]})}},12862:(e,t,a)=>{async function l(e){let t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{},a=await fetch(e,{...t,method:"GET",credentials:"include"});if(!a.ok){var l;let e=await a.json().catch(()=>({message:a.statusText}));throw new r(a.status,(null==(l=e.error)?void 0:l.message)||e.message||"Request failed")}return a.json()}async function n(e,t){let a=arguments.length>2&&void 0!==arguments[2]?arguments[2]:{},l={"Content-Type":"application/json",...a.headers},n=await fetch(e,{...a,method:"POST",credentials:"include",headers:l,body:t?JSON.stringify(t):void 0});if(!n.ok){var s;let e=await n.json().catch(()=>({message:n.statusText}));throw new r(n.status,(null==(s=e.error)?void 0:s.message)||e.message||"Request failed")}return n.json()}async function s(e){let t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{},a=await fetch(e,{...t,method:"DELETE",credentials:"include"});if(!a.ok){var l;let e=await a.json().catch(()=>({message:a.statusText}));throw new r(a.status,(null==(l=e.error)?void 0:l.message)||e.message||"Request failed")}return a.json()}a.d(t,{$P:()=>n,Al:()=>s,Vg:()=>l});class r extends Error{constructor(e,t){super(t),this.status=e,this.name="ApiError"}}},21297:(e,t,a)=>{a.d(t,{J:()=>r,e:()=>s});var l=a(12115),n=a(12862);function s(e){let[t,a]=(0,l.useState)({role:null,plan:null,loading:!0,error:null});return(0,l.useEffect)(()=>{if(!e)return void a({role:null,plan:null,loading:!1,error:null});!async function(){if(e)try{let t=await (0,n.Vg)("/api/rbac/context?orgId=".concat(encodeURIComponent(e)));a({role:t.role||null,plan:t.plan||null,loading:!1,error:null})}catch(e){a({role:null,plan:null,loading:!1,error:(null==e?void 0:e.message)||"Failed to load permissions"})}}()},[e]),t}function r(e,t,a){let{role:l,plan:n,loading:r}=s(e);return!r&&!!l&&!!n&&(["owner","admin"].includes(l)||"read"===a&&["operator","analyst","viewer"].includes(l)||"execute"===a&&"operator"===l)&&("free"!==n||"call"===t)}},79288:(e,t,a)=>{a.d(t,{n:()=>r,x:()=>s});var l=a(12115),n=a(95704);function s(e){let[t,a]=(0,l.useState)([]),[s,r]=(0,l.useState)(!1);return(0,l.useRef)(null),(0,l.useRef)(new Date),(0,l.useEffect)(()=>{if(!e||setupAttemptedRef.current)return;setupAttemptedRef.current=!0;let t=!0,l=null;return async function(){try{let s=await fetch("/api/realtime/subscribe",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({organization_id:e}),credentials:"include"});if(!s.ok||!t)return;let{config:i}=await s.json();if(!i||!t)return;let c=n.env.NEXT_PUBLIC_SUPABASE_ANON_KEY||"";if(!c)return void console.warn("useRealtime: NEXT_PUBLIC_SUPABASE_ANON_KEY not set");for(let n of(l=getRealtimeClient(i.supabaseUrl,c),i.channels)){let s="".concat(n.name,"-").concat((null==e?void 0:e.slice(0,8))||"default"),i=l.channel(s).on("postgres_changes",{event:"*",schema:"public",table:n.table,filter:n.filter},e=>{t&&a(t=>[...t.slice(-50),{...e,receivedAt:Date.now()}])}).subscribe(e=>{t&&r("SUBSCRIBED"===e)});channelsRef.current.push(i)}}catch(e){console.warn("useRealtime: setup failed, using polling fallback")}}(),()=>{t=!1,channelsRef.current.forEach(e=>{if(l)try{l.removeChannel(e)}catch(e){}}),channelsRef.current=[],setupAttemptedRef.current=!1}},[e]),{updates:t,connected:s,clearUpdates:(0,l.useCallback)(()=>a([]),[])}}function r(e){let t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:5e3,a=!(arguments.length>2)||void 0===arguments[2]||arguments[2],[n,s]=(0,l.useState)([]),[r,i]=(0,l.useState)(!0);return(0,l.useEffect)(()=>{if(!a)return;let l=!0;async function n(){try{let t=await e();l&&(s(t),i(!1))}catch(e){l&&i(!1)}}n();let r=setInterval(n,t);return()=>{l=!1,clearInterval(r)}},[e,t,a]),{data:n,loading:r}}}}]);