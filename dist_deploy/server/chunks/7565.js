"use strict";exports.id=7565,exports.ids=[7565],exports.modules={10095:(a,b,c)=>{c.d(b,{Gz:()=>l,Z0:()=>k,sM:()=>j,ws:()=>i});var d=c(30477),e=c(32524),f=c(60387);class g{constructor(){this.metrics={failureCount:0,successCount:0,lastFailureTime:null,lastAlertTime:null,consecutiveFailures:0},this.ALERT_THRESHOLD=10,this.ALERT_INTERVAL_MS=6e4,this.CONSECUTIVE_FAILURE_THRESHOLD=5,this.METRIC_WINDOW_MS=3e5,this.windowTimer=null,this.startWindowTimer()}recordSuccess(){this.metrics.successCount++,this.metrics.consecutiveFailures=0}recordFailure(a,b){this.metrics.failureCount++,this.metrics.lastFailureTime=Date.now(),this.metrics.consecutiveFailures++,d.v.error("Audit log write failed",a,{...b,consecutiveFailures:this.metrics.consecutiveFailures,failureCount:this.metrics.failureCount}),this.checkAndAlert(b)}checkAndAlert(a){let b=Date.now();if(this.metrics.consecutiveFailures>=this.CONSECUTIVE_FAILURE_THRESHOLD)return void this.sendAlert("CONSECUTIVE_FAILURES",{consecutiveFailures:this.metrics.consecutiveFailures,threshold:this.CONSECUTIVE_FAILURE_THRESHOLD,...a});this.metrics.failureCount>=this.ALERT_THRESHOLD&&(!this.metrics.lastAlertTime||b-this.metrics.lastAlertTime>this.ALERT_INTERVAL_MS)&&this.sendAlert("HIGH_FAILURE_RATE",{failureCount:this.metrics.failureCount,successCount:this.metrics.successCount,threshold:this.ALERT_THRESHOLD,timeWindow:Math.floor((b-(this.metrics.lastAlertTime||b))/1e3),...a})}sendAlert(a,b){this.metrics.lastAlertTime=Date.now();let c=this.metrics.failureCount+this.metrics.successCount,e={alertType:a,errorRate:c>0?Math.round(this.metrics.failureCount/c*100):0,failureCount:this.metrics.failureCount,successCount:this.metrics.successCount,consecutiveFailures:this.metrics.consecutiveFailures,...b};"CONSECUTIVE_FAILURES"===a?d.v.error("CRITICAL: Audit log consecutive failures detected",void 0,e):d.v.error("ALERT: High audit log failure rate detected",void 0,e)}startWindowTimer(){this.windowTimer&&clearInterval(this.windowTimer),this.windowTimer=setInterval(()=>{this.resetMetrics()},this.METRIC_WINDOW_MS)}resetMetrics(){this.metrics.failureCount>0&&d.v.info("Audit log metrics reset",{previousFailureCount:this.metrics.failureCount,previousSuccessCount:this.metrics.successCount,window:Math.floor(this.METRIC_WINDOW_MS/1e3)}),this.metrics.failureCount=0,this.metrics.successCount=0}getMetrics(){return{...this.metrics}}getHealthStatus(){let a=this.metrics.failureCount+this.metrics.successCount,b=a>0?Math.round(this.metrics.failureCount/a*100):0;return{healthy:this.metrics.consecutiveFailures<this.CONSECUTIVE_FAILURE_THRESHOLD&&this.metrics.failureCount<this.ALERT_THRESHOLD,errorRate:b,consecutiveFailures:this.metrics.consecutiveFailures,recentFailures:this.metrics.failureCount}}reset(){this.metrics={failureCount:0,successCount:0,lastFailureTime:null,lastAlertTime:null,consecutiveFailures:0}}destroy(){this.windowTimer&&(clearInterval(this.windowTimer),this.windowTimer=null)}}let h=new g;async function i(a,b){try{return await a(),h.recordSuccess(),!0}catch(a){return h.recordFailure(a,b),!1}}function j(){return h.getHealthStatus()}function k(){return h.getMetrics()}async function l(a){let{organizationId:b,actorId:c,systemId:d,resource:g,resourceId:h,payload:j,actorLabel:k}=a;await i(async()=>await (0,f.P)(`INSERT INTO audit_logs (id, organization_id, user_id, system_id, resource_type, resource_id, action, actor_type, actor_label, after, created_at)
        VALUES ($1, $2, $3, $4, $5, $6, 'error', $7, $8, $9, NOW())`,[(0,e.A)(),b,c,d,g,h,c?"human":"system",k||c||"system",JSON.stringify(j)]),{resource:g,resourceId:h,action:"error"})}},27237:(a,b,c)=>{c.d(b,{mU:()=>k,oH:()=>l});var d=c(30477),e=c(59175);let f={maxRetries:3,baseDelay:1e3,maxDelay:1e4,shouldRetry:g};function g(a,b){return!b||!!(b.status>=500)&&!!(b.status<600)||429===b.status}function h(a,b,c){let d=b*Math.pow(2,a),e=.25*d*(Math.random()-.5);return Math.floor(Math.min(d+e,c))}async function i(a,b={},c={}){let k={...f,...c},{maxRetries:l,baseDelay:m,maxDelay:n}=k,o=k.shouldRetry??g,p=function(a){try{let b=new URL(a).hostname;if(b.includes("signalwire"))return"SignalWire";if(b.includes("assemblyai"))return"AssemblyAI";if(b.includes("elevenlabs"))return"ElevenLabs";if(b.includes("resend"))return"Resend";return"External"}catch{return"External"}}(a);for(let c=0;c<=l;c++)try{c>0&&d.v.info(`Retrying ${p} API call`,{attempt:c,maxRetries:l,url:function(a){try{let b=new URL(a);return b.searchParams.has("token")&&b.searchParams.set("token","[REDACTED]"),b.searchParams.has("api_key")&&b.searchParams.set("api_key","[REDACTED]"),b.toString()}catch{return"[INVALID_URL]"}}(a)});let f=await fetch(a,b);if(f.ok)return c>0&&d.v.info(`${p} API call succeeded after retry`,{attempt:c,status:f.status}),f;f.clone();let g=Error(`HTTP ${f.status}: ${f.statusText}`);if(!o(g,f))throw d.v.warn(`${p} API call failed (non-retriable)`,{status:f.status,statusText:f.statusText}),new e.u({code:`${p.toUpperCase()}_API_ERROR`,message:`${p} API returned ${f.status}`,user_message:`${p} service returned an error. Please try again.`,severity:f.status>=500?"HIGH":"MEDIUM",retriable:!1,details:{status:f.status,statusText:f.statusText}});if(c===l)throw d.v.error(`${p} API call failed after ${l} retries`,g,{status:f.status,attempts:c+1}),new e.u({code:`${p.toUpperCase()}_API_FAILED`,message:`${p} API failed after ${l} retries`,user_message:`${p} service is temporarily unavailable. Please try again later.`,severity:"HIGH",retriable:!0,details:{status:f.status,attempts:c+1,lastError:g.message}});let i=h(c,m,n);d.v.info(`${p} API call failed, retrying in ${i}ms`,{attempt:c+1,maxRetries:l,status:f.status}),await j(i)}catch(b){if(b instanceof e.u)throw b;if(!o(b))throw new e.u({code:`${p.toUpperCase()}_NETWORK_ERROR`,message:`Network error contacting ${p}`,user_message:`Unable to reach ${p} service. Please check your connection.`,severity:"HIGH",retriable:!1,details:{error:b?.message}});if(c===l)throw d.v.error(`${p} network error after ${l} retries`,b,{attempts:c+1}),new e.u({code:`${p.toUpperCase()}_UNREACHABLE`,message:`${p} unreachable after ${l} retries`,user_message:`Unable to reach ${p} service. Please try again later.`,severity:"CRITICAL",retriable:!0,details:{error:b?.message,attempts:c+1}});let a=h(c,m,n);d.v.info(`${p} network error, retrying in ${a}ms`,{attempt:c+1,maxRetries:l,error:b?.message}),await j(a)}throw new e.u({code:`${p.toUpperCase()}_RETRY_EXHAUSTED`,message:`${p} API retry exhausted`,user_message:"Service temporarily unavailable. Please try again.",severity:"HIGH",retriable:!0})}function j(a){return new Promise(b=>setTimeout(b,a))}async function k(a,b={}){return i(a,b,{maxRetries:3,baseDelay:1e3,maxDelay:1e4})}async function l(a,b={}){return i(a,b,{maxRetries:3,baseDelay:1500,maxDelay:12e3})}},29838:(a,b,c)=>{c.d(b,{aC:()=>i,eU:()=>j,ne:()=>h});var d=c(30477),e=c(59175);class f{constructor(a){this.resetTimer=null,this.config=a,this.metrics={successCount:0,failureCount:0,totalCount:0,lastFailureTime:null,lastSuccessTime:null,consecutiveFailures:0,state:"CLOSED",stateChangedAt:Date.now()}}async execute(a){if("OPEN"===this.metrics.state){let a=Date.now()-this.metrics.stateChangedAt;if(a>=this.config.resetTimeout)this.transitionToHalfOpen();else throw new e.u({code:`${this.config.vendorName.toUpperCase()}_CIRCUIT_OPEN`,message:`${this.config.vendorName} circuit breaker is open`,user_message:`${this.config.vendorName} service is temporarily unavailable. Please try again in a few moments.`,severity:"HIGH",retriable:!0,details:{state:this.metrics.state,timeSinceOpen:Math.floor(a/1e3),resetIn:Math.floor((this.config.resetTimeout-a)/1e3)}})}try{let b=await this.executeWithTimeout(a);return this.onSuccess(),b}catch(a){throw this.onFailure(a),a}}async executeWithTimeout(a){return new Promise((b,c)=>{let d=setTimeout(()=>{c(Error(`${this.config.vendorName} request timeout after ${this.config.timeout}ms`))},this.config.timeout);a().then(a=>{clearTimeout(d),b(a)}).catch(a=>{clearTimeout(d),c(a)})})}onSuccess(){this.metrics.successCount++,this.metrics.totalCount++,this.metrics.lastSuccessTime=Date.now(),this.metrics.consecutiveFailures=0,"HALF_OPEN"===this.metrics.state&&this.transitionToClosed()}onFailure(a){if(this.metrics.failureCount++,this.metrics.totalCount++,this.metrics.lastFailureTime=Date.now(),this.metrics.consecutiveFailures++,d.v.warn(`${this.config.vendorName} circuit breaker: failure recorded`,{error:a.message,consecutiveFailures:this.metrics.consecutiveFailures,state:this.metrics.state}),"HALF_OPEN"===this.metrics.state)return void this.transitionToOpen();this.shouldOpenCircuit()&&this.transitionToOpen()}shouldOpenCircuit(){return!(this.metrics.totalCount<this.config.volumeThreshold)&&this.metrics.failureCount/this.metrics.totalCount*100>=this.config.errorThresholdPercentage}transitionToOpen(){"OPEN"!==this.metrics.state&&(this.metrics.state="OPEN",this.metrics.stateChangedAt=Date.now(),d.v.error(`${this.config.vendorName} circuit breaker OPENED`,void 0,{failureCount:this.metrics.failureCount,totalCount:this.metrics.totalCount,errorPercentage:Math.round(this.metrics.failureCount/this.metrics.totalCount*100),consecutiveFailures:this.metrics.consecutiveFailures}),this.resetTimer&&clearTimeout(this.resetTimer),this.resetTimer=setTimeout(()=>{this.transitionToHalfOpen()},this.config.resetTimeout))}transitionToHalfOpen(){"HALF_OPEN"!==this.metrics.state&&(this.metrics.state="HALF_OPEN",this.metrics.stateChangedAt=Date.now(),d.v.warn(`${this.config.vendorName} circuit breaker HALF_OPEN - testing recovery`,{timeSinceOpen:Math.floor((Date.now()-this.metrics.stateChangedAt)/1e3)}))}transitionToClosed(){if("CLOSED"===this.metrics.state)return;let a=this.metrics.state;this.metrics.state="CLOSED",this.metrics.stateChangedAt=Date.now(),this.metrics.successCount=0,this.metrics.failureCount=0,this.metrics.totalCount=0,this.metrics.consecutiveFailures=0,this.resetTimer&&(clearTimeout(this.resetTimer),this.resetTimer=null),d.v.info(`${this.config.vendorName} circuit breaker CLOSED - service recovered`,{previousState:a,downtime:"OPEN"===a?Math.floor((Date.now()-this.metrics.stateChangedAt)/1e3):0})}getState(){return this.metrics.state}getMetrics(){return{...this.metrics}}getHealthStatus(){let a=this.metrics.totalCount>0?this.metrics.failureCount/this.metrics.totalCount*100:0;return{healthy:"CLOSED"===this.metrics.state,state:this.metrics.state,errorRate:Math.round(a),consecutiveFailures:this.metrics.consecutiveFailures}}reset(){this.transitionToClosed(),d.v.info(`${this.config.vendorName} circuit breaker manually reset`)}}class g{getBreaker(a,b){if(!this.breakers.has(a)){let c={timeout:1e4,errorThresholdPercentage:50,resetTimeout:3e4,volumeThreshold:10,vendorName:a,...b};this.breakers.set(a,new f(c))}return this.breakers.get(a)}getHealthStatuses(){let a={};return this.breakers.forEach((b,c)=>{a[c]=b.getHealthStatus()}),a}constructor(){this.breakers=new Map}}let h=new g,i=h.getBreaker("SignalWire",{timeout:1e4,errorThresholdPercentage:50,resetTimeout:3e4,volumeThreshold:10});h.getBreaker("AssemblyAI",{timeout:15e3,errorThresholdPercentage:40,resetTimeout:6e4,volumeThreshold:5});let j=h.getBreaker("ElevenLabs",{timeout:2e4,errorThresholdPercentage:45,resetTimeout:45e3,volumeThreshold:8})},32524:(a,b,c)=>{c.d(b,{A:()=>i});var d=c(55511);let e={randomUUID:d.randomUUID},f=new Uint8Array(256),g=f.length,h=[];for(let a=0;a<256;++a)h.push((a+256).toString(16).slice(1));let i=function(a,b,c){if(e.randomUUID&&!b&&!a)return e.randomUUID();let i=(a=a||{}).random??a.rng?.()??(g>f.length-16&&((0,d.randomFillSync)(f),g=0),f.slice(g,g+=16));if(i.length<16)throw Error("Random bytes length must be >= 16");if(i[6]=15&i[6]|64,i[8]=63&i[8]|128,b){if((c=c||0)<0||c+16>b.length)throw RangeError(`UUID byte range ${c}:${c+15} is out of buffer bounds`);for(let a=0;a<16;++a)b[c+a]=i[a];return b}return function(a,b=0){return(h[a[b+0]]+h[a[b+1]]+h[a[b+2]]+h[a[b+3]]+"-"+h[a[b+4]]+h[a[b+5]]+"-"+h[a[b+6]]+h[a[b+7]]+"-"+h[a[b+8]]+h[a[b+9]]+"-"+h[a[b+10]]+h[a[b+11]]+h[a[b+12]]+h[a[b+13]]+h[a[b+14]]+h[a[b+15]]).toLowerCase()}(i)}},49605:(a,b,c)=>{c.d(b,{S3:()=>h,Yw:()=>i,ay:()=>j,lf:()=>g});var d=c(60387),e=c(59175),f=c(30477);async function g(a){let{organizationId:b,callId:c,metric:g,quantity:h,metadata:i}=a;try{let a=new Date,e=new Date(a.getFullYear(),a.getMonth(),1),j=new Date(a.getFullYear(),a.getMonth()+1,0,23,59,59);await (0,d.P)(`INSERT INTO usage_records (
        id, organization_id, call_id, metric, quantity, billing_period_start, billing_period_end, metadata
       ) VALUES (gen_random_uuid(), $1, $2, $3, $4, $5, $6, $7)`,[b,c,g,h,e.toISOString(),j.toISOString(),JSON.stringify(i||{})]),f.v.info("Usage tracked",{organizationId:b,metric:g,quantity:h,callId:c})}catch(a){if(f.v.error("Failed to track usage",a,{organizationId:b,metric:g,quantity:h}),a instanceof e.u)throw a;throw new e.u({code:"USAGE_TRACKING_ERROR",message:"Unexpected error tracking usage",user_message:"Unable to record usage. Please contact support.",severity:"HIGH",retriable:!0,details:{error:a.message}})}}async function h(a){try{let b=new Date,c=new Date(b.getFullYear(),b.getMonth(),1),e=new Date(b.getFullYear(),b.getMonth()+1,0,23,59,59),{rows:f}=await (0,d.P)(`SELECT metric, quantity FROM usage_records 
       WHERE organization_id = $1 
       AND billing_period_start >= $2 
       AND billing_period_end <= $3`,[a,c.toISOString(),e.toISOString()]),g={calls:0,minutes:0,transcriptions:0,translations:0,period_start:c.toISOString(),period_end:e.toISOString()};return f?.forEach(a=>{"call"===a.metric&&(g.calls+=a.quantity),"minute"===a.metric&&(g.minutes+=a.quantity),"transcription"===a.metric&&(g.transcriptions+=a.quantity),"translation"===a.metric&&(g.translations+=a.quantity)}),g}catch(a){if(a instanceof e.u)throw a;throw new e.u({code:"USAGE_SUMMARY_ERROR",message:"Failed to generate usage summary",user_message:"Unable to load usage data.",severity:"MEDIUM",retriable:!0})}}async function i(a,b,c){try{let{rows:e}=await (0,d.P)("SELECT * FROM usage_limits WHERE plan = $1 LIMIT 1",[b.toLowerCase()]),g=e[0];if(!g)return f.v.warn("Plan limits not found, allowing usage",{plan:b}),{allowed:!0};let i=await h(a);if("call"===c&&i.calls>=g.calls_per_month)return{allowed:!1,reason:`Monthly call limit reached (${g.calls_per_month} calls)`,limits:g};if("minute"===c&&i.minutes>=g.minutes_per_month)return{allowed:!1,reason:`Monthly minute limit reached (${g.minutes_per_month} minutes)`,limits:g};if("transcription"===c&&i.transcriptions>=g.transcriptions_per_month)return{allowed:!1,reason:`Monthly transcription limit reached (${g.transcriptions_per_month})`,limits:g};if("translation"===c&&i.translations>=g.translations_per_month)return{allowed:!1,reason:`Monthly translation limit reached (${g.translations_per_month})`,limits:g};return{allowed:!0,limits:g}}catch(d){return f.v.error("Error checking usage limits",d,{organizationId:a,plan:b,metric:c}),{allowed:!0}}}async function j(a){try{let{rows:b}=await (0,d.P)("SELECT * FROM usage_limits WHERE organization_id = $1",[a]);if(!b||0===b.length)return{calls_per_month:100,minutes_per_month:500,transcriptions_per_month:50,translations_per_month:0,can_record:!0,can_transcribe:!0,can_translate:!1,can_use_secret_shopper:!1,allow_overage:!1};let c={calls_per_month:100,minutes_per_month:500,transcriptions_per_month:50,translations_per_month:0,can_record:!0,can_transcribe:!0,can_translate:!1,can_use_secret_shopper:!1,allow_overage:!1};return b.forEach(a=>{"month"===a.billing_period&&("call"===a.metric&&(c.calls_per_month=a.limit_value),"minute"===a.metric&&(c.minutes_per_month=a.limit_value),"transcription"===a.metric&&(c.transcriptions_per_month=a.limit_value),"translation"===a.metric&&(c.translations_per_month=a.limit_value))}),c.can_translate=c.translations_per_month>0,c}catch(b){return f.v.error("Error fetching plan limits",b,{organizationId:a}),null}}},84988:(a,b,c)=>{c.d(b,{TS:()=>f,cX:()=>e}),c(30477);let d=[{name:"SIGNALWIRE_PROJECT_ID",required:!0,description:"SignalWire project ID for call execution",validate:a=>a.length>0||"Must not be empty"},{name:"SIGNALWIRE_TOKEN",required:!0,description:"SignalWire API token",validate:a=>a.length>0||"Must not be empty"},{name:"SIGNALWIRE_SPACE",required:!0,description:"SignalWire space URL",validate:a=>a.includes("signalwire.com")||"Must be a valid SignalWire space URL"},{name:"ASSEMBLYAI_API_KEY",required:!0,description:"AssemblyAI API key for transcription",validate:a=>a.length>0||"Must not be empty"},{name:"NEXT_PUBLIC_SUPABASE_URL",required:!0,description:"Supabase project URL",validate:a=>a.startsWith("https://")||"Must be a valid HTTPS URL"},{name:"NEXT_PUBLIC_SUPABASE_ANON_KEY",required:!0,description:"Supabase anonymous key",validate:a=>a.length>0||"Must not be empty"},{name:"SUPABASE_SERVICE_ROLE_KEY",required:!0,description:"Supabase service role key (server-side only)",validate:a=>a.length>0||"Must not be empty"},{name:"NEXT_PUBLIC_APP_URL",required:!0,description:"Public application URL for webhooks",validate:a=>a.startsWith("https://")||a.startsWith("http://localhost")||"Must be a valid URL"},{name:"NEXTAUTH_SECRET",required:!0,description:"NextAuth secret for session encryption",validate:a=>a.length>=32||"Must be at least 32 characters"},{name:"OPENAI_API_KEY",required:!1,description:"OpenAI API key for translation (optional)",validate:a=>a.length>0||"Must not be empty if provided"},{name:"ELEVENLABS_API_KEY",required:!1,description:"ElevenLabs API key for text-to-speech (optional)",validate:a=>a.startsWith("sk_")||'Must start with "sk_"'},{name:"TRANSLATION_LIVE_ASSIST_PREVIEW",required:!1,description:"Enable live translation preview feature (SignalWire AI Agents)",validate:a=>"true"===a||"false"===a||'Must be "true" or "false"'}];function e(){let a=[],b=[];for(let c of d){let d=process.env[c.name];if(d){if(c.validate){let e=c.validate(d);if(!0!==e){let d="string"==typeof e?e:"Invalid value";c.required?a.push({name:c.name,message:`${c.description}: ${d}`}):b.push({name:c.name,message:`${c.description}: ${d}`})}}}else c.required?a.push({name:c.name,message:`Required environment variable missing: ${c.description}`}):b.push({name:c.name,message:`Optional environment variable not set: ${c.description}`})}return{valid:0===a.length,errors:a,warnings:b}}function f(){return"true"===process.env.TRANSLATION_LIVE_ASSIST_PREVIEW}},97565:(a,b,c)=>{c.d(b,{A:()=>p});var d=c(32524),e=c(59175),f=c(84988),g=c(30477),h=c(10095),i=c(49605);class j{constructor(){}async canUserUseCallerId(a,b,c){let{rows:d}=await query(`SELECT id, permission_type FROM caller_id_permissions 
             WHERE organization_id = $1 AND user_id = $2 AND caller_id_number_id = $3 AND is_active = true
             LIMIT 1`,[a,b,c]);if(d?.length)return!0;let{rows:e}=await query("SELECT role FROM org_members WHERE organization_id = $1 AND user_id = $2 LIMIT 1",[a,b]);return["owner","admin"].includes(e?.[0]?.role||"")}async validateCallerIdForUser(a,b,c){if(!c){let c=await this.getDefaultCallerId(a,b);return c?{allowed:!0,callerIdNumberId:c.id,phoneNumber:c.phone_number}:{allowed:!1,callerIdNumberId:null,phoneNumber:null,reason:"No caller ID specified and no default rule configured"}}let d=this.normalizeE164(c),{rows:e}=await query(`SELECT id, phone_number, status, is_verified FROM caller_id_numbers 
             WHERE organization_id = $1 AND phone_number = $2 LIMIT 1`,[a,d]),f=e[0];return f?"active"!==f.status?{allowed:!1,callerIdNumberId:f.id,phoneNumber:d,reason:`Caller ID is ${f.status}`}:f.is_verified?await this.canUserUseCallerId(a,b,f.id)?{allowed:!0,callerIdNumberId:f.id,phoneNumber:d}:{allowed:!1,callerIdNumberId:f.id,phoneNumber:d,reason:"User does not have permission to use this caller ID"}:{allowed:!1,callerIdNumberId:f.id,phoneNumber:d,reason:"Caller ID is not verified"}:{allowed:!1,callerIdNumberId:null,phoneNumber:d,reason:"Caller ID not registered for this organization"}}async getAvailableCallerIds(a,b){let{rows:c}=await query("SELECT role FROM org_members WHERE organization_id = $1 AND user_id = $2 LIMIT 1",[a,b]);if(["owner","admin"].includes(c?.[0]?.role||"")){let{rows:b}=await query(`SELECT id, phone_number, display_name, is_default FROM caller_id_numbers 
                 WHERE organization_id = $1 AND status = 'active' AND is_verified = true 
                 ORDER BY is_default DESC`,[a]);return(b||[]).map(a=>({...a,permission_type:"full"}))}let{rows:d}=await query(`SELECT p.permission_type, c.id, c.phone_number, c.display_name, c.is_default, c.status, c.is_verified
             FROM caller_id_permissions p
             JOIN caller_id_numbers c ON p.caller_id_number_id = c.id
             WHERE p.organization_id = $1 AND p.user_id = $2 AND p.is_active = true`,[a,b]);return d?.length?d.filter(a=>"active"===a.status&&a.is_verified).map(a=>({id:a.id,phone_number:a.phone_number,display_name:a.display_name,is_default:a.is_default,permission_type:a.permission_type})):[]}async getDefaultCallerId(a,b){let{rows:c}=await query("SELECT role FROM org_members WHERE organization_id = $1 AND user_id = $2 LIMIT 1",[a,b]),d=c?.[0]?.role,{rows:e}=await query(`SELECT r.id, r.scope_type, r.user_id, r.role_scope, r.priority, 
                    c.id as cid_id, c.phone_number, c.status, c.is_verified
             FROM caller_id_default_rules r
             JOIN caller_id_numbers c ON r.caller_id_number_id = c.id
             WHERE r.organization_id = $1 AND r.is_active = true
             AND (r.user_id = $2 OR r.user_id IS NULL)
             ORDER BY r.priority ASC`,[a,b]);if(!e?.length){let{rows:b}=await query(`SELECT id, phone_number FROM caller_id_numbers 
                 WHERE organization_id = $1 AND is_default = true AND status = 'active' AND is_verified = true 
                 LIMIT 1`,[a]);return b?.[0]||null}for(let a of e)if("active"===a.status&&a.is_verified&&("user"===a.scope_type&&a.user_id===b||"role"===a.scope_type&&a.role_scope===d||"organization"===a.scope_type))return{id:a.cid_id,phone_number:a.phone_number};return null}async grantPermission(a,b,c,e,f){let i=(0,d.A)();try{await query(`INSERT INTO caller_id_permissions (
                    id, organization_id, caller_id_number_id, user_id, permission_type, 
                    is_active, granted_by, granted_at
                 ) VALUES ($1, $2, $3, $4, $5, true, $6, NOW())
                 ON CONFLICT (organization_id, caller_id_number_id, user_id) 
                 DO UPDATE SET is_active = true, permission_type = $5, granted_at = NOW(), revoked_at = NULL`,[i,a,b,c,e,f])}catch(a){return g.v.error("Failed to grant caller ID permission",a),{success:!1,error:a.message}}return await (0,h.ws)(async()=>await query(`INSERT INTO audit_logs (id, organization_id, user_id, resource_type, resource_id, action, actor_type, after)
                 VALUES ($1, $2, $3, 'caller_id_permission', $4, 'grant', 'human', $5)`,[(0,d.A)(),a,f,i,JSON.stringify({target_user_id:c,caller_id_number_id:b,permission_type:e})]),{resource:"caller_id_permission",resourceId:i,action:"grant"}),{success:!0,permissionId:i}}async revokePermission(a,b,c,e,f){let{rows:g}=await query(`SELECT id FROM caller_id_permissions 
             WHERE organization_id = $1 AND caller_id_number_id = $2 AND user_id = $3 AND is_active = true LIMIT 1`,[a,b,c]);if(!g.length)return{success:!1,error:"No active permission found"};let i=g[0].id;try{await query("UPDATE caller_id_permissions SET is_active = false, revoked_at = NOW(), revoked_by = $1, revoked_reason = $2 WHERE id = $3",[e,f,i])}catch(a){return{success:!1,error:a.message}}return await (0,h.ws)(async()=>await query(`INSERT INTO audit_logs (id, organization_id, user_id, resource_type, resource_id, action, actor_type, after)
                 VALUES ($1, $2, $3, 'caller_id_permission', $4, 'revoke', 'human', $5)`,[(0,d.A)(),a,e,i,JSON.stringify({target_user_id:c,caller_id_number_id:b,reason:f})]),{resource:"caller_id_permission",resourceId:i,action:"revoke"}),{success:!0}}async retireNumber(a,b,c){let{rows:e}=await query("SELECT id, organization_id, phone_number, status FROM caller_id_numbers WHERE id = $1 LIMIT 1",[a]),f=e[0];if(!f)return{success:!1,error:"Caller ID number not found"};if("retired"===f.status)return{success:!1,error:"Number is already retired"};try{await query("UPDATE caller_id_numbers SET status = 'retired', retired_at = NOW(), retired_by = $1, notes = $2 WHERE id = $3",[b,c?`Retired: ${c}`:null,a])}catch(a){return{success:!1,error:a.message}}return await query("UPDATE caller_id_permissions SET is_active = false, revoked_at = NOW(), revoked_by = $1, revoked_reason = 'Number retired' WHERE caller_id_number_id = $2 AND is_active = true",[b,a]),await query("UPDATE caller_id_default_rules SET is_active = false WHERE caller_id_number_id = $1 AND is_active = true",[a]),await (0,h.ws)(async()=>await query(`INSERT INTO audit_logs (id, organization_id, user_id, resource_type, resource_id, action, actor_type, before, after)
                 VALUES ($1, $2, $3, 'caller_id_number', $4, 'retire', 'human', $5, $6)`,[(0,d.A)(),f.organization_id,b,a,JSON.stringify({status:f.status}),JSON.stringify({status:"retired",reason:c})]),{resource:"caller_id_number",resourceId:a,action:"retire"}),{success:!0}}async setDefaultRule(a,b,c,e,f){let i=(0,d.A)();try{await query(`INSERT INTO caller_id_default_rules (
                    id, organization_id, scope_type, user_id, role_scope, caller_id_number_id, priority, is_active, created_by
                 ) VALUES ($1, $2, $3, $4, $5, $6, $7, true, $8)`,[i,a,c,f?.userId,f?.roleScope,b,f?.priority||100,e])}catch(a){return g.v.error("Failed to set default rule",a),{success:!1,error:a.message}}return await (0,h.ws)(async()=>await query(`INSERT INTO audit_logs (id, organization_id, user_id, resource_type, resource_id, action, actor_type, after)
                 VALUES ($1, $2, $3, 'caller_id_default_rule', $4, 'create', 'human', $5)`,[(0,d.A)(),a,e,i,JSON.stringify({scope_type:c,caller_id_number_id:b})]),{resource:"caller_id_default_rule",resourceId:i,action:"create"}),{success:!0,ruleId:i}}normalizeE164(a){let b=a.replace(/[^\d+]/g,"");return b.startsWith("+")?b:`+${b}`}}var k=c(27237),l=c(29838),m=c(60387);async function n(a){let b,c,{toNumber:d,callId:f,organizationId:h,useLiveTranslation:i=!1,translateFrom:j,translateTo:m,conference:n,leg:o,config:p,voiceConfigClient:q,onAuditError:r}=a;g.v.info("placeSignalWireCall: ENTERED function",{toNumber:d?"[REDACTED]":null,useLiveTranslation:i,callId:f,conference:n||"none",leg:o||"single"});let{projectId:s,token:t,space:u,number:v,appUrl:w}=p;if(!(s&&t&&u&&v)){let a=[];s||a.push("SIGNALWIRE_PROJECT_ID"),t||a.push("SIGNALWIRE_TOKEN"),u||a.push("SIGNALWIRE_SPACE"),v||a.push("SIGNALWIRE_NUMBER");let b=new e.u({code:"SIGNALWIRE_CONFIG_MISSING",message:`SignalWire credentials missing: ${a.join(", ")}`,user_message:"System configuration error - please contact support",severity:"CRITICAL",retriable:!1});throw await r("systems",null,b.toJSON()),g.v.error("CRITICAL: SignalWire config missing",void 0,{missing:a.join(", ")}),b}let x=Buffer.from(`${s}:${t}`).toString("base64"),y=new URLSearchParams,z=v;try{let a=await q.getCallerIdMask(h),b=a?.caller_id_mask,c=a?.caller_id_verified;b&&(c||b.startsWith("+1"))&&(z=b,g.v.info("placeSignalWireCall: using caller ID mask",{fromNumber:z,original:v,masked:!0,verified:c}))}catch(a){g.v.warn("placeSignalWireCall: failed to fetch caller ID mask",a)}if(y.append("From",z),y.append("To",d),!f){let a=new e.u({code:"CALL_ID_REQUIRED",message:"callId is required for all outbound calls",user_message:"Call configuration error",severity:"CRITICAL"});return await r("calls",null,a.toJSON()),{success:!1,error:a.toJSON()}}if(i&&(!j||!m)){let a=new e.u({code:"TRANSLATION_PARAMS_MISSING",message:"translateFrom and translateTo required when useLiveTranslation=true",user_message:"Invalid call configuration",severity:"HIGH",retriable:!1});return await r("calls",f,a.toJSON()),{success:!1,error:a.toJSON()}}let A=`${w}/api/voice/swml/outbound?callId=${encodeURIComponent(f)}&orgId=${encodeURIComponent(h)}`;i&&j&&m&&(A+=`&from=${encodeURIComponent(j)}&to=${encodeURIComponent(m)}`),n&&(A+=`&conference=${encodeURIComponent(n)}`,o&&(A+=`&leg=${encodeURIComponent(o)}`)),y.append("Url",A),g.v.info("placeSignalWireCall: routing to SWML endpoint",{callId:f,organizationId:h,useLiveTranslation:i,translateFrom:j,translateTo:m,conference:n,leg:o,swmlUrl:A});let B=f?`?callId=${encodeURIComponent(f)}`:"";y.append("StatusCallback",`${w}/api/webhooks/signalwire${B}`),y.append("Record","true"),y.append("RecordingStatusCallback",`${w}/api/webhooks/signalwire${B}`),y.append("RecordingStatusCallbackEvent","completed"),g.v.info("placeSignalWireCall: RECORDING ENABLED",{Record:"true",RecordingStatusCallback:`${w}/api/webhooks/signalwire`,isConferenceCall:!!n});let C=`https://${u}.signalwire.com/api/laml/2010-04-01/Accounts/${s}/Calls.json`;g.v.debug("placeSignalWireCall: FULL REST API REQUEST",{endpoint:C,to:d?"[REDACTED]":null,from:v?"[REDACTED]":null,hasRecord:y.has("Record"),recordValue:y.get("Record"),hasRecordingCallback:y.has("RecordingStatusCallback"),urlCallback:y.get("Url"),statusCallback:y.get("StatusCallback")});try{b=await l.aC.execute(async()=>await (0,k.mU)(C,{method:"POST",headers:{Authorization:`Basic ${x}`,"Content-Type":"application/x-www-form-urlencoded"},body:y}))}catch(b){if(b instanceof e.u)throw await r("calls",f,b.toJSON()),b;g.v.error("placeSignalWireCall: SignalWire fetch error",b,{error:b?.message??String(b)});let a=new e.u({code:"SIGNALWIRE_FETCH_FAILED",message:"Failed to reach SignalWire",user_message:"Failed to place call via carrier",severity:"HIGH",retriable:!0,details:{cause:b?.message??String(b)}});throw await r("calls",f,a.toJSON()),a}if(!b.ok){let a=await b.text();g.v.error("placeSignalWireCall: SignalWire POST failed",void 0,{status:b.status,body:a});let c=new e.u({code:"SIGNALWIRE_API_ERROR",message:`SignalWire Error: ${b.status}`,user_message:"Failed to place call via carrier",severity:"HIGH",retriable:!0,details:{provider_error:a}});throw await r("calls",f,c.toJSON()),c}try{c=await b.json()}catch(c){g.v.error("placeSignalWireCall: Failed to parse SignalWire JSON response",c,{status:b.status,contentType:b.headers.get("content-type")});let a=new e.u({code:"SIGNALWIRE_RESPONSE_PARSE_FAILED",message:"Invalid response from SignalWire",user_message:"Failed to place call - carrier response error",severity:"HIGH",retriable:!0});throw await r("calls",f,a.toJSON()),a}g.v.info("placeSignalWireCall: SignalWire responded",{callSid:c?.sid?"[REDACTED_SID]":null});let D=c?.sid??null;return D?{success:!0,callSid:D}:{success:!1,error:{message:"No call SID returned from SignalWire"}}}let o=/^\+?[1-9]\d{1,14}$/;async function p(a,b={}){let{signalwireCall:c,env:k=process.env}=b,l=null,q=null,r=null,s=a.organization_id;async function t(a,b,c){await (0,h.Gz)({organizationId:s,actorId:l,systemId:q,resource:a,resourceId:b,payload:c})}let u=async(a,b=!1,c,d,f,h)=>{let i=function(a){let b=String(a.SIGNALWIRE_SPACE||"").replace(/^https?:\/\//,"").replace(/\/$/,"").replace(/\.signalwire\.com$/i,"").trim(),c=a.SIGNALWIRE_PROJECT_ID,d=a.SIGNALWIRE_TOKEN||a.SIGNALWIRE_API_TOKEN,e=a.SIGNALWIRE_NUMBER,f=a.NEXT_PUBLIC_APP_URL;return c&&d&&b&&e&&f?{projectId:c,token:d,space:b,number:e,appUrl:f}:null}(k);if(!i){let a=[];k.SIGNALWIRE_PROJECT_ID||a.push("SIGNALWIRE_PROJECT_ID"),k.SIGNALWIRE_TOKEN||k.SIGNALWIRE_API_TOKEN||a.push("SIGNALWIRE_TOKEN"),k.SIGNALWIRE_SPACE||a.push("SIGNALWIRE_SPACE"),k.SIGNALWIRE_NUMBER||a.push("SIGNALWIRE_NUMBER"),k.NEXT_PUBLIC_APP_URL||a.push("NEXT_PUBLIC_APP_URL");let b=new e.u({code:"SIGNALWIRE_CONFIG_MISSING",message:`SignalWire credentials missing: ${a.join(", ")}`,user_message:"System configuration error - please contact support",severity:"CRITICAL",retriable:!1});throw await t("systems",null,b.toJSON()),g.v.error("CRITICAL: SignalWire config missing",void 0,{missing:a.join(", ")}),b}let j=await n({toNumber:a,callId:r,organizationId:s,useLiveTranslation:b,translateFrom:c,translateTo:d,conference:f,leg:h,config:i,voiceConfigClient:{async getCallerIdMask(a){let{rows:b}=await (0,m.P)("SELECT caller_id_mask, caller_id_verified FROM voice_configs WHERE organization_id = $1 LIMIT 1",[a]);return b?.[0]||null},async getTranslationLanguages(a){let{rows:b}=await (0,m.P)("SELECT translate_from, translate_to FROM voice_configs WHERE organization_id = $1 LIMIT 1",[a]);return b?.[0]||null}},onAuditError:t});return j.success?j.callSid:null};try{let{from_number:b,phone_number:n,flow_type:p,modulations:v}=a;s=a.organization_id,g.v.info("startCallHandler: initiating call",{organization_id:s,from_number:"[REDACTED]",phone_number:"[REDACTED]",flow_type:p,modulations:v});let w=a.actor_id??null;if(l=w,!w)if("production"!==k.NODE_ENV)l=w="28d68e05-ab20-40ee-b935-b19e8927ae68",g.v.warn("startCallHandler: using dev fallback actorId",{actorId:w});else{let a=new e.u({code:"AUTH_REQUIRED",message:"Unauthenticated",user_message:"Authentication required",severity:"HIGH",retriable:!1});throw await t("organizations",null,a.toJSON()),a}if(!/^[0-9a-fA-F-]{36}$/.test(s)){let a=new e.u({code:"CALL_START_INVALID_ORG",message:"Invalid organization id",user_message:"Invalid organization identifier",severity:"MEDIUM",retriable:!1});throw await t("organizations",null,a.toJSON()),a}let x=null;try{let{rows:a}=await (0,m.P)("SELECT id, plan, tool_id FROM organizations WHERE id = $1 LIMIT 1",[s]);x=a[0]}catch(b){let a=new e.u({code:"CALL_START_DB_ORG_LOOKUP",message:"Organization lookup failed",user_message:"Unable to verify organization.",severity:"HIGH",retriable:!0,details:{cause:b.message}});throw await t("organizations",null,a.toJSON()),a}if(!x){let a=new e.u({code:"CALL_START_ORG_NOT_FOUND",message:"Organization not found",user_message:"Organization not found.",severity:"HIGH",retriable:!1});throw await t("organizations",null,a.toJSON()),a}if("free"===x.plan){let a=new e.u({code:"CALL_START_PLAN_LIMIT_EXCEEDED",message:"Plan does not permit outbound calls",user_message:"Your plan does not allow outbound calls. Please upgrade.",severity:"HIGH",retriable:!1});throw await t("organizations",x.id,a.toJSON()),a}let y=await (0,i.Yw)(s,x.plan,"call");if(!y.allowed){let a=new e.u({code:"USAGE_LIMIT_EXCEEDED",message:y.reason||"Usage limit exceeded",user_message:y.reason||"Your monthly call limit has been reached. Please upgrade your plan.",severity:"MEDIUM",retriable:!1});throw await t("calls",r,a.toJSON()),a}let z=[];try{let{rows:a}=await (0,m.P)("SELECT id, role FROM org_members WHERE organization_id = $1 AND user_id = $2 LIMIT 1",[s,w]);z=a}catch(b){let a=new e.u({code:"AUTH_MEMBERSHIP_LOOKUP_FAILED",message:"Membership lookup failed",user_message:"Unable to verify membership",severity:"HIGH",retriable:!0,details:{cause:b.message}});throw await t("org_members",null,a.toJSON()),a}let A={record:!1,transcribe:!1,translate:!1};try{let{rows:a}=await (0,m.P)(`SELECT record, transcribe, live_translate, translate_from, translate_to, survey, synthetic_caller 
         FROM voice_configs WHERE organization_id = $1 LIMIT 1`,[s]);if(a&&a[0]){let b=a[0];A.record=!!b.record,A.transcribe=!!b.transcribe,A.translate=!!b.live_translate,A.survey=!!b.survey,A.synthetic_caller=!!b.synthetic_caller,"string"==typeof b.translate_from&&(A.translate_from=b.translate_from),"string"==typeof b.translate_to&&(A.translate_to=b.translate_to)}}catch(a){}if(!z||0===z.length){let a=new e.u({code:"AUTH_ORG_MISMATCH",message:"Actor not authorized for organization",user_message:"Not authorized for this organization",severity:"HIGH",retriable:!1});throw await t("org_members",null,a.toJSON()),a}let B=z[0].role?.toLowerCase()||"viewer",C=["owner","admin","operator"];if(!C.includes(B)){let a=new e.u({code:"CALL_EXECUTE_FORBIDDEN",message:"Insufficient permissions to execute calls",user_message:"You do not have permission to place calls. Only Owners, Admins, and Operators can place calls.",severity:"HIGH",retriable:!1});throw await t("org_members",null,{...a.toJSON(),role:B,required_roles:C}),a}let D=null,E=new j;if(!(D=await E.validateCallerIdForUser(s,w,b)).allowed){let a=new e.u({code:"CALLER_ID_NOT_PERMITTED",message:D.reason||"Caller ID not permitted",user_message:D.reason||"You do not have permission to use this caller ID.",severity:"HIGH",retriable:!1,details:{requested_from_number:"[REDACTED]"}});throw await t("caller_id_permissions",null,{...a.toJSON(),reason:D.reason}),a}if(b=D.phoneNumber||b,g.v.info("startCallHandler: caller ID validated",{callerId:"[REDACTED]",callerIdNumberId:D.callerIdNumberId}),!o.test(n)){let a=new e.u({code:"CALL_START_INVALID_PHONE",message:"Invalid phone number format",user_message:"The phone number provided is invalid. Please verify and try again.",severity:"MEDIUM",retriable:!1});throw await t("calls",null,a.toJSON()),a}let F=[];try{let{rows:a}=await (0,m.P)("SELECT id, key FROM systems WHERE key IN ('system-cpid', 'system-ai')",[]);F=a}catch(b){let a=new e.u({code:"CALL_START_SYS_LOOKUP_FAILED",message:"System lookup failed",user_message:"Service error",severity:"HIGH",retriable:!0,details:{cause:b.message}});throw await t("systems",null,a.toJSON()),a}let G={};(F||[]).forEach(a=>{G[a.key]=a.id});let H=G["system-cpid"]??null,I=G["system-ai"]??null;if(q=H,!H){let a=new e.u({code:"CALL_START_SYS_MISSING",message:"Control system not registered",user_message:"Service misconfiguration",severity:"HIGH",retriable:!1});throw await t("systems",null,a.toJSON()),a}r=(0,d.A)();try{await (0,m.P)(`INSERT INTO calls (id, organization_id, system_id, status, started_at, ended_at, created_by, caller_id_number_id, caller_id_used)
             VALUES ($1, $2, $3, 'pending', NULL, NULL, $4, $5, $6)`,[r,s,H,w,D?.callerIdNumberId||null,b||null])}catch(b){g.v.error("startCallHandler: failed to insert call row",void 0,{callId:r,error:b?.message});let a=new e.u({code:"CALL_START_DB_INSERT",message:"Failed to create call record",user_message:"We encountered a system error while starting your call. Please try again.",severity:"HIGH",retriable:!0,details:{cause:b.message}});throw await t("calls",r,a.toJSON()),a}await (0,h.ws)(async()=>await (0,m.P)(`INSERT INTO audit_logs (id, organization_id, user_id, system_id, resource_type, resource_id, action, actor_type, actor_label, after, created_at)
         VALUES ($1, $2, $3, $4, 'calls', $5, 'intent:call_start', $6, $7, $8, NOW())`,[(0,d.A)(),s,l,q,r,l?"human":"system",l||"cpid-call-handler",JSON.stringify({flow_type:p,modulations:A,record_enabled:A?.record??!1,declared_at:new Date().toISOString()})]),{resource:"calls",resourceId:r,action:"intent:call_start"});let J=null;if(c)if(g.v.info("startCallHandler: using injected signalwireCall to place outbound call"),"bridge"===p&&b&&o.test(b)){let a=await c({from:String(k.SIGNALWIRE_NUMBER||""),to:b,url:String(k.NEXT_PUBLIC_APP_URL)+"/api/voice/swml/outbound-v2",statusCallback:String(k.NEXT_PUBLIC_APP_URL)+"/api/webhooks/signalwire"}),d=await c({from:String(k.SIGNALWIRE_NUMBER||""),to:n,url:String(k.NEXT_PUBLIC_APP_URL)+"/api/voice/swml/outbound-v2",statusCallback:String(k.NEXT_PUBLIC_APP_URL)+"/api/webhooks/signalwire"});J=d.call_sid,g.v.info("startCallHandler: injected signalwireCall bridge created",{a:a.call_sid?"[REDACTED]":null,b:d.call_sid?"[REDACTED]":null})}else J=(await c({from:String(k.SIGNALWIRE_NUMBER||""),to:n,url:String(k.NEXT_PUBLIC_APP_URL)+"/api/voice/swml/outbound-v2",statusCallback:String(k.NEXT_PUBLIC_APP_URL)+"/api/webhooks/signalwire"})).call_sid,g.v.info("startCallHandler: injected signalwireCall returned",{call_sid:J?"[REDACTED]":null});else{let a=String(x.plan??"").toLowerCase(),c=(0,f.TS)(),d=["business","enterprise"].includes(a)||"production"!==k.NODE_ENV&&c,e=d&&c&&!0===A.translate&&!!A.translate_from&&!!A.translate_to;if(g.v.info("startCallHandler: about to place SignalWire call",{flow_type:p,has_from_number:!!b,from_number_valid:!!b&&o.test(b),shouldUseLiveTranslation:e,plan:a,isBusinessPlan:d,isFeatureFlagEnabled:c}),"bridge"===p&&b&&o.test(b)){let a=`bridge-${r}`,c=await u(b,e,A.translate_from,A.translate_to,a,"1"),d=await u(n,e,A.translate_from,A.translate_to,a,"2");J=d,g.v.info("startCallHandler: signalwire bridge created",{conference:a,legA:c?"[REDACTED]":null,legB:d?"[REDACTED]":null,liveTranslation:e})}else J=await u(n,e,A.translate_from,A.translate_to),g.v.info("startCallHandler: signalwire call placed",{call_sid:J?"[REDACTED]":null,liveTranslation:e})}let K="UPDATE calls SET status = 'in_progress'",L=[];J&&(K+=", call_sid = $1",L.push(J)),K+=` WHERE id = $${L.length+1}`,L.push(r);try{await (0,m.P)(K,L);try{await (0,i.lf)({organizationId:s,callId:r,metric:"call",quantity:1,metadata:{phone_number:n,flow_type:p,plan:x.plan,call_sid:J||null}})}catch(a){g.v.error("startCallHandler: failed to track call usage",a,{callId:r,organization_id:s})}g.v.info("startCallHandler: updated call with call_sid",{callId:r,hasSid:!!J})}catch(a){g.v.error("startCallHandler: failed to update call",void 0,{callId:r,error:a?.message}),await t("calls",r,{message:"Failed to save call_sid",error:a.message})}if(A.transcribe)if(I){let a=(0,d.A)();try{await (0,m.P)(`INSERT INTO ai_runs (id, call_id, system_id, model, status, produced_by, is_authoritative)
                 VALUES ($1, $2, $3, 'assemblyai-v1', 'queued', 'model', true)`,[a,r,I])}catch(a){g.v.error("startCallHandler: failed to insert ai_run",void 0,{callId:r,error:a?.message}),await t("ai_runs",r,new e.u({code:"AI_TRANSC_INSERT_FAILED",message:"Failed to enqueue transcription",user_message:"Transcription could not be started. The call will continue without transcription.",severity:"MEDIUM",retriable:!0,details:{cause:a.message}}).toJSON())}}else await t("systems",r,new e.u({code:"CALL_START_AI_SYSTEM_MISSING",message:"AI system not registered",user_message:"Transcription unavailable right now.",severity:"MEDIUM",retriable:!0}).toJSON());if(A.translate){let a=A.translate_from??null,b=A.translate_to??null;if(a&&b)if(I){let c=(0,d.A)();try{await (0,m.P)(`INSERT INTO ai_runs (id, call_id, system_id, model, status, produced_by, is_authoritative, output)
                 VALUES ($1, $2, $3, 'assemblyai-translation-v1', 'queued', 'model', true, $4)`,[c,r,I,JSON.stringify({translate_from:a,translate_to:b,pending:!0})])}catch(a){g.v.error("startCallHandler: failed to insert ai_run (translation)",void 0,{callId:r,error:a?.message}),await t("ai_runs",r,new e.u({code:"AI_TRANSL_INSERT_FAILED",message:"Failed to enqueue translation",user_message:"Translation could not be started. The call will continue without translation.",severity:"MEDIUM",retriable:!0,details:{cause:a.message}}).toJSON())}}else await t("systems",r,new e.u({code:"CALL_START_AI_SYSTEM_MISSING",message:"AI system not registered",user_message:"Translation unavailable right now.",severity:"MEDIUM",retriable:!0}).toJSON());else await t("ai_runs",r,new e.u({code:"AI_TRANSL_LANG_MISSING",message:"Translation configured but language codes missing",user_message:"Translation configuration incomplete; skipping translation.",severity:"MEDIUM",retriable:!1}).toJSON())}if(A.survey)if(I){let a=(0,d.A)();try{await (0,m.P)(`INSERT INTO ai_runs (id, call_id, system_id, model, status, produced_by, is_authoritative, output)
                VALUES ($1, $2, $3, 'assemblyai-survey', 'queued', 'model', true, $4)`,[a,r,I,JSON.stringify({pending:!0})])}catch(a){g.v.error("startCallHandler: failed to insert ai_run (survey)",void 0,{callId:r,error:a?.message}),await t("ai_runs",r,new e.u({code:"AI_SURVEY_INSERT_FAILED",message:"Failed to enqueue survey",user_message:"Survey could not be started.",severity:"MEDIUM",retriable:!0,details:{cause:a.message}}).toJSON())}}else await t("systems",r,new e.u({code:"CALL_START_AI_SYSTEM_MISSING",message:"AI system not registered",user_message:"Survey unavailable right now.",severity:"MEDIUM",retriable:!0}).toJSON());if(A.record){let a=x?.tool_id??null;if(a)try{await (0,m.P)(`INSERT INTO audit_logs (id, organization_id, user_id, system_id, resource_type, resource_id, action, actor_type, actor_label, after, created_at)
                 VALUES ($1, $2, $3, $4, 'calls', $5, 'intent:recording_requested', $6, $7, $8, NOW())`,[(0,d.A)(),s,l,q,r,l?"human":"system",l||"cpid-call-handler",JSON.stringify({tool_id:a,requested_at:new Date().toISOString()})])}catch(a){}else await t("calls",r,new e.u({code:"RECORDING_TOOL_NOT_FOUND",message:"No recording tool available for organization",user_message:"No recording tool available for your organization",severity:"MEDIUM",retriable:!1}).toJSON())}let M=[];try{let{rows:a}=await (0,m.P)("SELECT * FROM calls WHERE id = $1 LIMIT 1",[r]);M=a}catch(b){g.v.error("startCallHandler: failed to fetch persisted call",void 0,{callId:r,error:b?.message});let a=new e.u({code:"CALL_START_FETCH_PERSISTED_FAILED",message:"Failed to read back persisted call",user_message:"We started the call but could not verify its record. Please contact support.",severity:"HIGH",retriable:!0,details:{cause:b?.message}});throw await t("calls",r,a.toJSON()),a}if(!M?.[0]){let a=new e.u({code:"CALL_START_FETCH_PERSISTED_FAILED",message:"Failed to read back persisted call",user_message:"We started the call but could not verify its record. Please contact support.",severity:"HIGH",retriable:!0});throw await t("calls",r,a.toJSON()),a}let N=M[0];try{await (0,m.P)(`INSERT INTO audit_logs (id, organization_id, user_id, system_id, resource_type, resource_id, action, actor_type, actor_label, after, created_at)
             VALUES ($1, $2, $3, $4, 'calls', $5, 'create', $6, $7, $8, NOW())`,[(0,d.A)(),s,l,q,r,l?"human":"system",l||"cpid-call-handler",JSON.stringify({...N,config:A,call_sid:J})])}catch(a){g.v.error("startCallHandler: failed to insert audit log",a,{callId:r}),await t("audit_logs",r,new e.u({code:"AUDIT_LOG_INSERT_FAILED",message:"Failed to write audit log",user_message:"Call started but an internal audit log could not be saved.",severity:"MEDIUM",retriable:!0,details:{cause:a.message}}).toJSON())}return g.v.info("startCallHandler: call flow completed",{callId:r}),{success:!0,call_id:r}}catch(b){if(b instanceof e.u){let a=b.toJSON();try{await (0,m.P)("INSERT INTO audit_logs (id, organization_id, user_id, system_id, resource_type, resource_id, action, actor_type, actor_label, after, created_at) VALUES ($1, $2, $3, $4, 'calls', $5, 'error', $6, $7, $8, NOW())",[(0,d.A)(),s,l??null,q??null,r??null,l?"human":"system",l||"cpid-call-handler",JSON.stringify(a)])}catch(a){}return{success:!1,error:{id:a.id,code:a.code,message:a.user_message??a.message,severity:a.severity}}}g.v.error("startCallHandler unexpected error",b);let a=new e.u({code:"CALL_START_UNEXPECTED",message:b?.message??"Unexpected error",user_message:"An unexpected error occurred while starting the call.",severity:"CRITICAL",retriable:!0,details:{stack:b?.stack}}).toJSON();try{await (0,m.P)("INSERT INTO audit_logs (id, organization_id, user_id, system_id, resource_type, resource_id, action, actor_type, actor_label, after, created_at) VALUES ($1, $2, null, null, 'calls', null, 'error', 'system', 'cpid-call-handler', $3, NOW())",[(0,d.A)(),s,JSON.stringify(a)])}catch(a){}return{success:!1,error:{id:a.id,code:a.code,message:a.user_message??a.message,severity:a.severity}}}}}};