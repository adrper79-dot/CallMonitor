"use strict";exports.id=6625,exports.ids=[6625],exports.modules={26625:(a,b,c)=>{c.d(b,{translateText:()=>h});var d=c(60387),e=c(50366),f=c(73537),g=c(30477);async function h(a){let{callId:b,translationRunId:c,text:h,fromLanguage:i,toLanguage:j,organizationId:k,recordingUrl:l,useVoiceCloning:m}=a;g.v.info("translation: starting",{callId:b,translationRunId:c,fromLanguage:i,toLanguage:j,textLength:h?.length||0,hasRecordingUrl:!!l,useVoiceCloning:m});try{let{rows:a}=await (0,d.P)("SELECT plan FROM organizations WHERE id = $1",[k]),n=a[0]?.plan?.toLowerCase(),o=["global","enterprise","business","pro","standard","active","free"];if(!o.includes(n||"")){g.v.error("TRANSLATION_FAILED: Plan does not support translation",void 0,{organizationId:k,plan:n,allowedPlans:o.join(", ")}),await (0,d.P)(`UPDATE ai_runs SET
            status = 'failed',
            completed_at = NOW(),
            produced_by = 'model',
            is_authoritative = false,
            output = $1
         WHERE id = $2`,[{error:"Plan does not support translation",plan:n},c]);return}let p=null,q=null;if(process.env.OPENAI_API_KEY)try{let a=new AbortController,d=setTimeout(()=>a.abort(),3e4),e=await fetch("https://api.openai.com/v1/chat/completions",{method:"POST",headers:{Authorization:`Bearer ${process.env.OPENAI_API_KEY}`,"Content-Type":"application/json"},signal:a.signal,body:JSON.stringify({model:"gpt-3.5-turbo",messages:[{role:"system",content:"auto"===i||"auto"===j?"You are a professional translator. First detect the language of the following text. Then translate it to the most appropriate target language. If the text is in English, translate to Spanish. If the text is in Spanish, translate to English. If the text is in another language, translate to English. Only return the translated text, no explanations or language labels.":`You are a professional translator. Translate the following text from ${i} to ${j}. Only return the translated text, no explanations.`},{role:"user",content:h}],temperature:.3,max_tokens:2e3})});if(clearTimeout(d),e.ok){let a=await e.json();(p=a.choices?.[0]?.message?.content?.trim()||null)&&g.v.info("translation: OpenAI translation successful",{translationRunId:c,callId:b})}else{let a=await e.text();q=`OpenAI API error: ${e.status} - ${a}`}}catch(a){q=a?.name==="AbortError"?"OpenAI translation timed out (30s)":`OpenAI translation failed: ${a?.message||"Unknown error"}`}else q="OPENAI_API_KEY not configured - translation requires OpenAI",g.v.error("TRANSLATION_FAILED: OPENAI_API_KEY not set",void 0,{translationRunId:c,callId:b,resolution:"Set OPENAI_API_KEY environment variable"});if(p){let a=null,k=null,n=!1;if(process.env.ELEVENLABS_API_KEY)try{let d;if(g.v.debug("translation: generating audio with ElevenLabs",{translationRunId:c,chars:p.length,useVoiceCloning:!!m}),m&&l)try{g.v.debug("translation: attempting voice cloning from recording",{translationRunId:c});let a=await fetch(l);if(a.ok){let e=Buffer.from(await a.arrayBuffer());e.length>5e4?(d=k=(await (0,f.E1)(e,`call-${b}-${Date.now()}`,`Cloned voice for translation run ${c}`)).voiceId,n=!0,g.v.info("translation: voice cloned successfully",{translationRunId:c,clonedVoiceId:k})):g.v.warn("translation: recording too short for voice cloning",{translationRunId:c})}else g.v.warn("translation: could not download recording for voice cloning",{translationRunId:c,status:a.status})}catch(a){g.v.error("translation: voice cloning failed, falling back to default voice",a,{translationRunId:c})}let h=(await (0,f._M)(p,j,d)).getReader(),i=[];for(;;){let{done:a,value:b}=await h.read();if(a)break;i.push(b)}let o=Buffer.concat(i),q=`translations/${c}.mp3`;try{await e.Ay.upload("recordings",q,o,"audio/mpeg");try{let b=await e.Ay.createSignedUrl("recordings",q,86400);a=b?.signedUrl||b}catch(c){let b=await e.Ay.getPublicUrl("recordings",q);a=b.publicURL||b.publicUrl}g.v.info("translation: audio generated and uploaded",{translationRunId:c,usedVoiceCloning:n})}catch(a){g.v.error("translation: audio upload failed",a,{translationRunId:c})}if(k)try{await (0,f.Rw)(k),g.v.debug("translation: cleaned up cloned voice",{translationRunId:c,clonedVoiceId:k})}catch(a){g.v.warn("translation: could not delete cloned voice",{clonedVoiceId:k,error:a?.message})}}catch(a){g.v.error("translation: ElevenLabs audio generation failed",a,{translationRunId:c})}await (0,d.P)(`UPDATE ai_runs SET
            status = 'completed',
            completed_at = NOW(),
            produced_by = 'model',
            is_authoritative = false,
            output = $1
         WHERE id = $2`,[{from_language:i,to_language:j,source_text:h,translated_text:p,translated_audio_url:a,provider:"openai",tts_provider:a?"elevenlabs":null,voice_cloning_used:n,completed_at:new Date().toISOString()},c]),g.v.info("translation: completed",{translationRunId:c,callId:b,fromLanguage:i,toLanguage:j,hasAudio:!!a,usedVoiceCloning:n})}else await (0,d.P)(`UPDATE ai_runs SET
            status = 'failed',
            completed_at = NOW(),
            produced_by = 'model',
            is_authoritative = false,
            output = $1
         WHERE id = $2`,[{from_language:i,to_language:j,source_text:h,error:q||"Translation failed",failed_at:new Date().toISOString()},c]),g.v.error("translation: failed",void 0,{translationRunId:c,callId:b,error:q})}catch(a){g.v.error("translation: service error",a,{translationRunId:c,callId:b}),await (0,d.P)(`UPDATE ai_runs SET
            status = 'failed',
            completed_at = NOW(),
            produced_by = 'model',
            is_authoritative = false,
            output = $1
         WHERE id = $2`,[{error:a?.message||"Translation service error",failed_at:new Date().toISOString()},c])}}}};