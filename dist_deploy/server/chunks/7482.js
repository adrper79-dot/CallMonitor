exports.id=7482,exports.ids=[7482],exports.modules={10095:(a,b,c)=>{"use strict";c.d(b,{Gz:()=>l,Z0:()=>k,sM:()=>j,ws:()=>i});var d=c(30477),e=c(32524),f=c(60387);class g{constructor(){this.metrics={failureCount:0,successCount:0,lastFailureTime:null,lastAlertTime:null,consecutiveFailures:0},this.ALERT_THRESHOLD=10,this.ALERT_INTERVAL_MS=6e4,this.CONSECUTIVE_FAILURE_THRESHOLD=5,this.METRIC_WINDOW_MS=3e5,this.windowTimer=null,this.startWindowTimer()}recordSuccess(){this.metrics.successCount++,this.metrics.consecutiveFailures=0}recordFailure(a,b){this.metrics.failureCount++,this.metrics.lastFailureTime=Date.now(),this.metrics.consecutiveFailures++,d.v.error("Audit log write failed",a,{...b,consecutiveFailures:this.metrics.consecutiveFailures,failureCount:this.metrics.failureCount}),this.checkAndAlert(b)}checkAndAlert(a){let b=Date.now();if(this.metrics.consecutiveFailures>=this.CONSECUTIVE_FAILURE_THRESHOLD)return void this.sendAlert("CONSECUTIVE_FAILURES",{consecutiveFailures:this.metrics.consecutiveFailures,threshold:this.CONSECUTIVE_FAILURE_THRESHOLD,...a});this.metrics.failureCount>=this.ALERT_THRESHOLD&&(!this.metrics.lastAlertTime||b-this.metrics.lastAlertTime>this.ALERT_INTERVAL_MS)&&this.sendAlert("HIGH_FAILURE_RATE",{failureCount:this.metrics.failureCount,successCount:this.metrics.successCount,threshold:this.ALERT_THRESHOLD,timeWindow:Math.floor((b-(this.metrics.lastAlertTime||b))/1e3),...a})}sendAlert(a,b){this.metrics.lastAlertTime=Date.now();let c=this.metrics.failureCount+this.metrics.successCount,e={alertType:a,errorRate:c>0?Math.round(this.metrics.failureCount/c*100):0,failureCount:this.metrics.failureCount,successCount:this.metrics.successCount,consecutiveFailures:this.metrics.consecutiveFailures,...b};"CONSECUTIVE_FAILURES"===a?d.v.error("CRITICAL: Audit log consecutive failures detected",void 0,e):d.v.error("ALERT: High audit log failure rate detected",void 0,e)}startWindowTimer(){this.windowTimer&&clearInterval(this.windowTimer),this.windowTimer=setInterval(()=>{this.resetMetrics()},this.METRIC_WINDOW_MS)}resetMetrics(){this.metrics.failureCount>0&&d.v.info("Audit log metrics reset",{previousFailureCount:this.metrics.failureCount,previousSuccessCount:this.metrics.successCount,window:Math.floor(this.METRIC_WINDOW_MS/1e3)}),this.metrics.failureCount=0,this.metrics.successCount=0}getMetrics(){return{...this.metrics}}getHealthStatus(){let a=this.metrics.failureCount+this.metrics.successCount,b=a>0?Math.round(this.metrics.failureCount/a*100):0;return{healthy:this.metrics.consecutiveFailures<this.CONSECUTIVE_FAILURE_THRESHOLD&&this.metrics.failureCount<this.ALERT_THRESHOLD,errorRate:b,consecutiveFailures:this.metrics.consecutiveFailures,recentFailures:this.metrics.failureCount}}reset(){this.metrics={failureCount:0,successCount:0,lastFailureTime:null,lastAlertTime:null,consecutiveFailures:0}}destroy(){this.windowTimer&&(clearInterval(this.windowTimer),this.windowTimer=null)}}let h=new g;async function i(a,b){try{return await a(),h.recordSuccess(),!0}catch(a){return h.recordFailure(a,b),!1}}function j(){return h.getHealthStatus()}function k(){return h.getMetrics()}async function l(a){let{organizationId:b,actorId:c,systemId:d,resource:g,resourceId:h,payload:j,actorLabel:k}=a;await i(async()=>await (0,f.P)(`INSERT INTO audit_logs (id, organization_id, user_id, system_id, resource_type, resource_id, action, actor_type, actor_label, after, created_at)
        VALUES ($1, $2, $3, $4, $5, $6, 'error', $7, $8, $9, NOW())`,[(0,e.A)(),b,c,d,g,h,c?"human":"system",k||c||"system",JSON.stringify(j)]),{resource:g,resourceId:h,action:"error"})}},30477:(a,b,c)=>{"use strict";c.d(b,{v:()=>e});class d{constructor(){this.isDevelopment=!1,this.isTest=!1}shouldLog(a){return!this.isTest&&(!!this.isDevelopment||"warn"===a||"error"===a)}formatMessage(a,b,c){let d=new Date().toISOString(),e=c?` ${JSON.stringify(c)}`:"";return`[${d}] [${a.toUpperCase()}] ${b}${e}`}debug(a,b){this.shouldLog("debug")&&console.log(this.formatMessage("debug",a,b))}info(a,b){this.shouldLog("info")&&console.log(this.formatMessage("info",a,b))}warn(a,b){this.shouldLog("warn")&&console.warn(this.formatMessage("warn",a,b))}error(a,b,c){if(this.shouldLog("error")){let d=b instanceof Error?{name:b.name,message:b.message,stack:b.stack,...c}:{error:b,...c};console.error(this.formatMessage("error",a,d))}}apiRequest(a,b,c){this.info(`API Request: ${a} ${b}`,c)}apiResponse(a,b,c,d){let e={statusCode:c,duration:d};c>=500?this.error(`API Response: ${a} ${b}`,void 0,e):c>=400?this.warn(`API Response: ${a} ${b}`,e):this.info(`API Response: ${a} ${b}`,e)}dbQuery(a,b){this.debug("Database query",{query:a.substring(0,100),params:b})}externalCall(a,b,c){this.info(`External call: ${a}`,{endpoint:b,...c})}}let e=new d},32524:(a,b,c)=>{"use strict";c.d(b,{A:()=>i});var d=c(55511);let e={randomUUID:d.randomUUID},f=new Uint8Array(256),g=f.length,h=[];for(let a=0;a<256;++a)h.push((a+256).toString(16).slice(1));let i=function(a,b,c){if(e.randomUUID&&!b&&!a)return e.randomUUID();let i=(a=a||{}).random??a.rng?.()??(g>f.length-16&&((0,d.randomFillSync)(f),g=0),f.slice(g,g+=16));if(i.length<16)throw Error("Random bytes length must be >= 16");if(i[6]=15&i[6]|64,i[8]=63&i[8]|128,b){if((c=c||0)<0||c+16>b.length)throw RangeError(`UUID byte range ${c}:${c+15} is out of buffer bounds`);for(let a=0;a<16;++a)b[c+a]=i[a];return b}return function(a,b=0){return(h[a[b+0]]+h[a[b+1]]+h[a[b+2]]+h[a[b+3]]+"-"+h[a[b+4]]+h[a[b+5]]+"-"+h[a[b+6]]+h[a[b+7]]+"-"+h[a[b+8]]+h[a[b+9]]+"-"+h[a[b+10]]+h[a[b+11]]+h[a[b+12]]+h[a[b+13]]+h[a[b+14]]+h[a[b+15]]).toLowerCase()}(i)}},39727:()=>{},47990:()=>{},56042:(a,b,c)=>{"use strict";c.d(b,{CS:()=>h,um:()=>i});var d=c(30477),e=c(60387),f=c(32524);async function g(a){try{d.v.info("Audit log",{event:a.event_type,action:a.action,status:a.status,actor:a.actor_id,resource:a.resource_id});let b=(0,f.A)(),c="user"===a.actor_type?a.actor_id:null,g="system"===a.actor_type?a.actor_id:null,h={event_type:a.event_type,status:a.status,metadata:a.metadata||{},error_message:a.error_message,ip_address:a.ip_address,user_agent:a.user_agent};return await (0,e.P)(`INSERT INTO audit_logs (
        id, 
        organization_id, 
        user_id, 
        system_id, 
        resource_type, 
        resource_id, 
        action, 
        actor_type, 
        actor_label, 
        before, 
        after, 
        created_at
      ) VALUES ($1, $2, $3, $4, $5, $6, $7, $8, $9, $10, $11, NOW())`,[b,a.organization_id||null,c||null,g||null,a.resource_type||null,a.resource_id||null,a.action,a.actor_type||"system",a.event_type,null,JSON.stringify(h)]),!0}catch(b){return d.v.error("Audit log write exception",b,{event_type:a.event_type}),!1}}async function h(a,b,c,d){return g({event_type:{organizations:"USER_ACTION",subscriptions:"SUBSCRIPTION_UPDATED",campaigns:"CAMPAIGN_EXECUTED",reports:"REPORT_GENERATED"}[a]||"USER_ACTION",resource_type:a,resource_id:b,action:c,status:"success",metadata:d})}async function i(a,b,c){return g({event_type:"USER_ACTION",resource_type:a,resource_id:b,action:"error",status:"failure",error_message:c.message,metadata:c})}},60387:(a,b,c)=>{"use strict";c.d(b,{Ay:()=>h,P:()=>f,d_:()=>e,ro:()=>g});var d=c(9608);if("undefined"==typeof WebSocket)try{let a=c(45361);d.Vz.webSocketConstructor=a}catch(a){}let e=()=>{let a=(()=>{try{let a=globalThis.HYPERDRIVE||globalThis.env?.HYPERDRIVE||globalThis.__env__?.HYPERDRIVE||globalThis.CF_BINDINGS?.HYPERDRIVE;if(a?.connectionString)return console.log("Using Hyperdrive connection"),a.connectionString}catch(a){console.warn("Hyperdrive binding not accessible:",a)}try{let a=globalThis.env||globalThis.__env__||globalThis.ENVIRONMENT||globalThis.CF_BINDINGS;if(a?.NEON_PG_CONN)return console.log("Using Worker secret for database connection"),a.NEON_PG_CONN}catch(a){console.warn("Worker secrets not accessible:",a)}let a=process.env.NEON_PG_CONN||process.env.PG_CONN||process.env.DATABASE_URL;return a?(console.log("Using process.env for database connection"),a):(console.error("No database connection configured in any location"),null)})();return a?new d.bC({connectionString:a}):(console.warn("No Postgres connection configured - returning null pool"),null)};async function f(a,b,c){try{let d=e();if(!d)return console.warn("Pool not available, returning mock response"),{rows:[],rowCount:0};let f=await d.connect();try{return c?.organizationId&&await f.query("SELECT set_config('app.current_organization_id', $1, true)",[c.organizationId]),c?.userId&&await f.query("SELECT set_config('app.current_user_id', $1, true)",[c.userId]),await f.query(a,b)}finally{f.release()}}catch(a){return console.error("Database query failed:",a),{rows:[],rowCount:0}}}async function g(a,b){let c=e(),d=await c.connect();try{await d.query("BEGIN"),b?.organizationId&&await d.query("SELECT set_config('app.current_organization_id', $1, true)",[b.organizationId]);let c=await a(d);return await d.query("COMMIT"),c}catch(a){throw await d.query("ROLLBACK"),a}finally{d.release()}}let h={query:f}},73087:(a,b,c)=>{"use strict";c.d(b,{rE:()=>e});var d=c(77598);function e(a){let b=function(){let a=process.env.CRM_ENCRYPTION_KEY||process.env.NEXTAUTH_SECRET||"dev-key-min-32-chars-for-aes256!";return(0,d.createHash)("sha256").update(a).digest()}(),c=(0,d.randomBytes)(16),e=(0,d.createCipheriv)("aes-256-gcm",b,c),f=e.update(a,"utf8","base64");f+=e.final("base64");let g=e.getAuthTag();return`v2:${c.toString("base64")}:${g.toString("base64")}:${f}`}c(30477),c(60387),c(10095),c(56042)},78335:()=>{},96487:()=>{}};