"use strict";exports.id=9883,exports.ids=[9883],exports.modules={89883:(a,b,c)=>{c.d(b,{queueCampaignExecution:()=>q});var d=c(60387),e=c(30477),f=c(59175);let g={rateLimitPerMinute:10,maxConcurrent:5,retryDelay:6e4};async function h(a){try{e.v.info("executeCampaign: starting",{campaignId:a});let b=await i(a);if(!b)throw new f.u("Campaign not found",404,"CAMPAIGN_NOT_FOUND");let c={organizationId:b.organization_id};if("active"!==b.status)throw new f.u("Campaign is not active",400,"CAMPAIGN_NOT_ACTIVE");let d=await j(a,c);if(0===d.length){e.v.info("executeCampaign: no pending calls",{campaignId:a}),await p(a);return}let h={...g,rateLimitPerMinute:b.call_config.rate_limit_per_minute||g.rateLimitPerMinute};e.v.info("executeCampaign: processing calls",{campaignId:a,pendingCalls:d.length,config:h}),await k(b,d,h,c),e.v.info("executeCampaign: completed",{campaignId:a})}catch(b){throw e.v.error("executeCampaign: failed",b,{campaignId:a}),b}}async function i(a){try{let{rows:b}=await (0,d.P)("SELECT * FROM campaigns WHERE id = $1 LIMIT 1",[a]);return b[0]||null}catch(b){return e.v.error("getCampaign: database error",b,{campaignId:a}),null}}async function j(a,b){try{let{rows:c}=await (0,d.P)(`SELECT * FROM campaign_calls 
       WHERE campaign_id = $1 AND status = 'pending' 
       ORDER BY created_at ASC`,[a],b);return c}catch(b){return e.v.error("getPendingCalls: database error",b,{campaignId:a}),[]}}async function k(a,b,c,d){let e=Math.min(c.maxConcurrent,c.rateLimitPerMinute),f=6e4/(c.rateLimitPerMinute/e);for(let c=0;c<b.length;c+=e){let g=b.slice(c,c+e);await Promise.allSettled(g.map(b=>l(a,b,d))),await o(a.id),c+e<b.length&&await function(a){return new Promise(b=>setTimeout(b,a))}(f)}0===(await j(a.id,d)).length&&await p(a.id)}async function l(a,b,c){try{e.v.info("executeCall: starting",{campaignId:a.id,callId:b.id,phone:b.target_phone}),await (0,d.P)(`UPDATE campaign_calls 
       SET status = 'calling', started_at = NOW() 
       WHERE id = $1`,[b.id],c);let{rows:g}=await (0,d.P)("SELECT phone_number FROM caller_id_numbers WHERE id = $1 LIMIT 1",[a.caller_id_id],c),h=g[0];if(!h)throw new f.u("Caller ID not found",404,"CALLER_ID_NOT_FOUND");let i=await m(a,b,h.phone_number),j=await n(i);await (0,d.P)(`UPDATE campaign_calls 
       SET call_id = $1, status = 'completed', outcome = $2, 
           duration_seconds = $3, completed_at = NOW() 
       WHERE id = $4`,[j.call_id,j.outcome,j.duration,b.id],c),e.v.info("executeCall: completed",{campaignId:a.id,callId:b.id,resultCallId:j.call_id})}catch(f){if(e.v.error("executeCall: failed",f,{campaignId:a.id,callId:b.id,phone:b.target_phone}),b.attempt_number<b.max_attempts){let a=new Date(Date.now()+3e5).toISOString();await (0,d.P)(`UPDATE campaign_calls 
         SET status = 'pending', attempt_number = $1, 
             error_message = $2, scheduled_for = $3 
         WHERE id = $4`,[b.attempt_number+1,f.message,a,b.id],c)}else await (0,d.P)(`UPDATE campaign_calls 
         SET status = 'failed', outcome = 'error', 
             error_message = $1, completed_at = NOW() 
         WHERE id = $2`,[f.message,b.id],c)}}async function m(a,b,c){let d={to:b.target_phone,from:c,organization_id:a.organization_id,campaign_id:a.id,campaign_call_id:b.id};switch(a.call_flow_type){case"secret_shopper":return{...d,call_type:"secret_shopper",script_id:a.script_id,swml_url:`https://voxsouth.online/api/voice/swml/shopper?campaignCallId=${b.id}`};case"survey":return{...d,call_type:"survey",survey_id:a.survey_id,swml_url:`https://voxsouth.online/api/voice/swml/survey?campaignCallId=${b.id}`};default:return{...d,call_type:a.call_flow_type,custom_prompt:a.custom_prompt}}}async function n(a){process.env.SIGNALWIRE_PROJECT_ID,process.env.SIGNALWIRE_TOKEN,process.env.SIGNALWIRE_SPACE;try{let b=await fetch("https://voxsouth.online/api/voice/call",{method:"POST",headers:{"Content-Type":"application/json",Authorization:`Bearer ${process.env.SERVICE_API_KEY}`},body:JSON.stringify({to_number:a.to,from_number:a.from,record:!0,transcribe:!0,organization_id:a.organization_id,campaign_id:a.campaign_id,campaign_call_id:a.campaign_call_id,swml_url:a.swml_url,call_type:a.call_type})});if(!b.ok){let a=await b.json();throw new f.u(a.message||"Failed to initiate call",b.status,"SIGNALWIRE_CALL_FAILED")}return{call_id:(await b.json()).call_id,outcome:"answered",duration:0}}catch(b){throw e.v.error("initiateSignalWireCall: failed",b,a),b}}async function o(a){try{let{rows:b}=await (0,d.P)("SELECT * FROM get_campaign_stats($1)",[a]),c=b[0];if(!c)return;await (0,d.P)(`UPDATE campaigns 
       SET total_targets = $1, calls_completed = $2, 
           calls_successful = $3, calls_failed = $4 
       WHERE id = $5`,[c.total,c.completed,c.successful,c.failed,a])}catch(b){e.v.error("updateCampaignProgress: failed",b,{campaignId:a})}}async function p(a){try{await (0,d.P)(`UPDATE campaigns 
       SET status = 'completed', completed_at = NOW() 
       WHERE id = $1`,[a]),await (0,d.P)(`INSERT INTO campaign_audit_log (campaign_id, user_id, action, changes) 
       VALUES ($1, NULL, 'completed', $2)`,[a,JSON.stringify({status:"completed"})]),e.v.info("completeCampaign: campaign completed",{campaignId:a})}catch(b){e.v.error("completeCampaign: failed",b,{campaignId:a})}}async function q(a){h(a).catch(b=>{e.v.error("queueCampaignExecution: execution failed",b,{campaignId:a})})}}};