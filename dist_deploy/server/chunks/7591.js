"use strict";exports.id=7591,exports.ids=[6625,7591],exports.modules={26625:(a,b,c)=>{c.d(b,{translateText:()=>h});var d=c(60387),e=c(50366),f=c(73537),g=c(30477);async function h(a){let{callId:b,translationRunId:c,text:h,fromLanguage:i,toLanguage:j,organizationId:k,recordingUrl:l,useVoiceCloning:m}=a;g.v.info("translation: starting",{callId:b,translationRunId:c,fromLanguage:i,toLanguage:j,textLength:h?.length||0,hasRecordingUrl:!!l,useVoiceCloning:m});try{let{rows:a}=await (0,d.P)("SELECT plan FROM organizations WHERE id = $1",[k]),n=a[0]?.plan?.toLowerCase(),o=["global","enterprise","business","pro","standard","active","free"];if(!o.includes(n||"")){g.v.error("TRANSLATION_FAILED: Plan does not support translation",void 0,{organizationId:k,plan:n,allowedPlans:o.join(", ")}),await (0,d.P)(`UPDATE ai_runs SET
            status = 'failed',
            completed_at = NOW(),
            produced_by = 'model',
            is_authoritative = false,
            output = $1
         WHERE id = $2`,[{error:"Plan does not support translation",plan:n},c]);return}let p=null,q=null;if(process.env.OPENAI_API_KEY)try{let a=new AbortController,d=setTimeout(()=>a.abort(),3e4),e=await fetch("https://api.openai.com/v1/chat/completions",{method:"POST",headers:{Authorization:`Bearer ${process.env.OPENAI_API_KEY}`,"Content-Type":"application/json"},signal:a.signal,body:JSON.stringify({model:"gpt-3.5-turbo",messages:[{role:"system",content:"auto"===i||"auto"===j?"You are a professional translator. First detect the language of the following text. Then translate it to the most appropriate target language. If the text is in English, translate to Spanish. If the text is in Spanish, translate to English. If the text is in another language, translate to English. Only return the translated text, no explanations or language labels.":`You are a professional translator. Translate the following text from ${i} to ${j}. Only return the translated text, no explanations.`},{role:"user",content:h}],temperature:.3,max_tokens:2e3})});if(clearTimeout(d),e.ok){let a=await e.json();(p=a.choices?.[0]?.message?.content?.trim()||null)&&g.v.info("translation: OpenAI translation successful",{translationRunId:c,callId:b})}else{let a=await e.text();q=`OpenAI API error: ${e.status} - ${a}`}}catch(a){q=a?.name==="AbortError"?"OpenAI translation timed out (30s)":`OpenAI translation failed: ${a?.message||"Unknown error"}`}else q="OPENAI_API_KEY not configured - translation requires OpenAI",g.v.error("TRANSLATION_FAILED: OPENAI_API_KEY not set",void 0,{translationRunId:c,callId:b,resolution:"Set OPENAI_API_KEY environment variable"});if(p){let a=null,k=null,n=!1;if(process.env.ELEVENLABS_API_KEY)try{let d;if(g.v.debug("translation: generating audio with ElevenLabs",{translationRunId:c,chars:p.length,useVoiceCloning:!!m}),m&&l)try{g.v.debug("translation: attempting voice cloning from recording",{translationRunId:c});let a=await fetch(l);if(a.ok){let e=Buffer.from(await a.arrayBuffer());e.length>5e4?(d=k=(await (0,f.E1)(e,`call-${b}-${Date.now()}`,`Cloned voice for translation run ${c}`)).voiceId,n=!0,g.v.info("translation: voice cloned successfully",{translationRunId:c,clonedVoiceId:k})):g.v.warn("translation: recording too short for voice cloning",{translationRunId:c})}else g.v.warn("translation: could not download recording for voice cloning",{translationRunId:c,status:a.status})}catch(a){g.v.error("translation: voice cloning failed, falling back to default voice",a,{translationRunId:c})}let h=(await (0,f._M)(p,j,d)).getReader(),i=[];for(;;){let{done:a,value:b}=await h.read();if(a)break;i.push(b)}let o=Buffer.concat(i),q=`translations/${c}.mp3`;try{await e.Ay.upload("recordings",q,o,"audio/mpeg");try{let b=await e.Ay.createSignedUrl("recordings",q,86400);a=b?.signedUrl||b}catch(c){let b=await e.Ay.getPublicUrl("recordings",q);a=b.publicURL||b.publicUrl}g.v.info("translation: audio generated and uploaded",{translationRunId:c,usedVoiceCloning:n})}catch(a){g.v.error("translation: audio upload failed",a,{translationRunId:c})}if(k)try{await (0,f.Rw)(k),g.v.debug("translation: cleaned up cloned voice",{translationRunId:c,clonedVoiceId:k})}catch(a){g.v.warn("translation: could not delete cloned voice",{clonedVoiceId:k,error:a?.message})}}catch(a){g.v.error("translation: ElevenLabs audio generation failed",a,{translationRunId:c})}await (0,d.P)(`UPDATE ai_runs SET
            status = 'completed',
            completed_at = NOW(),
            produced_by = 'model',
            is_authoritative = false,
            output = $1
         WHERE id = $2`,[{from_language:i,to_language:j,source_text:h,translated_text:p,translated_audio_url:a,provider:"openai",tts_provider:a?"elevenlabs":null,voice_cloning_used:n,completed_at:new Date().toISOString()},c]),g.v.info("translation: completed",{translationRunId:c,callId:b,fromLanguage:i,toLanguage:j,hasAudio:!!a,usedVoiceCloning:n})}else await (0,d.P)(`UPDATE ai_runs SET
            status = 'failed',
            completed_at = NOW(),
            produced_by = 'model',
            is_authoritative = false,
            output = $1
         WHERE id = $2`,[{from_language:i,to_language:j,source_text:h,error:q||"Translation failed",failed_at:new Date().toISOString()},c]),g.v.error("translation: failed",void 0,{translationRunId:c,callId:b,error:q})}catch(a){g.v.error("translation: service error",a,{translationRunId:c,callId:b}),await (0,d.P)(`UPDATE ai_runs SET
            status = 'failed',
            completed_at = NOW(),
            produced_by = 'model',
            is_authoritative = false,
            output = $1
         WHERE id = $2`,[{error:a?.message||"Translation service error",failed_at:new Date().toISOString()},c])}}},50980:(a,b,c)=>{c.r(b),c.d(b,{ERROR_CATALOG:()=>d,getDefaultError:()=>f,getErrorDefinition:()=>e});let d={AUTH_REQUIRED:{code:"AUTH_REQUIRED",category:"AUTH",severity:"HIGH",internalMessage:"Authentication required",userMessage:"Please sign in to continue",httpStatus:401,shouldAlert:!1,trackKPI:!0},AUTH_ORG_MISMATCH:{code:"AUTH_ORG_MISMATCH",category:"AUTH",severity:"HIGH",internalMessage:"User not authorized for organization",userMessage:"You do not have access to this organization",httpStatus:401,shouldAlert:!1,trackKPI:!0},FORBIDDEN:{code:"FORBIDDEN",category:"AUTH",severity:"HIGH",internalMessage:"Insufficient permissions",userMessage:"You do not have permission to perform this action",httpStatus:403,shouldAlert:!1,trackKPI:!0},DB_QUERY_FAILED:{code:"DB_QUERY_FAILED",category:"DB",severity:"HIGH",internalMessage:"Database query failed",userMessage:"Could not retrieve data. Please try again.",httpStatus:500,shouldAlert:!0,trackKPI:!0},DB_INSERT_FAILED:{code:"DB_INSERT_FAILED",category:"DB",severity:"HIGH",internalMessage:"Database insert failed",userMessage:"Could not save data. Please try again.",httpStatus:500,shouldAlert:!0,trackKPI:!0},DB_UPDATE_FAILED:{code:"DB_UPDATE_FAILED",category:"DB",severity:"HIGH",internalMessage:"Database update failed",userMessage:"Could not update data. Please try again.",httpStatus:500,shouldAlert:!0,trackKPI:!0},CALL_START_FAILED:{code:"CALL_START_FAILED",category:"VOICE",severity:"HIGH",internalMessage:"Failed to start call",userMessage:"Unable to place call. Please try again.",httpStatus:500,shouldAlert:!0,trackKPI:!0},SIGNALWIRE_CONFIG_MISSING:{code:"SIGNALWIRE_CONFIG_MISSING",category:"EXTERNAL",severity:"CRITICAL",internalMessage:"SignalWire credentials missing",userMessage:"System configuration error. Please contact support.",httpStatus:500,shouldAlert:!0,trackKPI:!0},SIGNALWIRE_API_ERROR:{code:"SIGNALWIRE_API_ERROR",category:"EXTERNAL",severity:"HIGH",internalMessage:"SignalWire API error",userMessage:"Call service temporarily unavailable. Please try again.",httpStatus:502,shouldAlert:!0,trackKPI:!0},ASSEMBLYAI_API_ERROR:{code:"ASSEMBLYAI_API_ERROR",category:"AI",severity:"HIGH",internalMessage:"AssemblyAI API error",userMessage:"Transcription service temporarily unavailable.",httpStatus:502,shouldAlert:!0,trackKPI:!0},TRANSCRIPTION_FAILED:{code:"TRANSCRIPTION_FAILED",category:"AI",severity:"MEDIUM",internalMessage:"Transcription processing failed",userMessage:"Transcription could not be completed.",httpStatus:500,shouldAlert:!1,trackKPI:!0},LIVE_TRANSLATE_EXECUTION_FAILED:{code:"LIVE_TRANSLATE_EXECUTION_FAILED",category:"EXTERNAL",severity:"MEDIUM",internalMessage:"Live translation execution failed",userMessage:"Live translation encountered an issue. Post-call transcript is still available.",httpStatus:500,shouldAlert:!1,trackKPI:!0},LIVE_TRANSLATE_VENDOR_DOWN:{code:"LIVE_TRANSLATE_VENDOR_DOWN",category:"EXTERNAL",severity:"HIGH",internalMessage:"Live translation vendor service unavailable",userMessage:"Live translation service is temporarily unavailable. Post-call transcript will be available.",httpStatus:503,shouldAlert:!0,trackKPI:!0},PLAN_LIMIT_EXCEEDED:{code:"PLAN_LIMIT_EXCEEDED",category:"ORG",severity:"MEDIUM",internalMessage:"Plan limit exceeded",userMessage:"This feature is not available on your current plan. Please upgrade.",httpStatus:403,shouldAlert:!1,trackKPI:!0},ORG_NOT_FOUND:{code:"ORG_NOT_FOUND",category:"ORG",severity:"MEDIUM",internalMessage:"Organization not found",userMessage:"Organization not found",httpStatus:404,shouldAlert:!1,trackKPI:!1},SYSTEM_ERROR:{code:"SYSTEM_ERROR",category:"SYSTEM",severity:"CRITICAL",internalMessage:"Unexpected system error",userMessage:"An unexpected error occurred. Please try again.",httpStatus:500,shouldAlert:!0,trackKPI:!0},SERVICE_UNAVAILABLE:{code:"SERVICE_UNAVAILABLE",category:"SYSTEM",severity:"HIGH",internalMessage:"Service temporarily unavailable",userMessage:"Service temporarily unavailable. Please try again later.",httpStatus:503,shouldAlert:!0,trackKPI:!0},INVALID_INPUT:{code:"INVALID_INPUT",category:"USER",severity:"MEDIUM",internalMessage:"Invalid input provided",userMessage:"Invalid input. Please check your request and try again.",httpStatus:400,shouldAlert:!1,trackKPI:!1},INVALID_PHONE:{code:"INVALID_PHONE",category:"USER",severity:"MEDIUM",internalMessage:"Invalid phone number format",userMessage:"The phone number provided is invalid. Please verify and try again.",httpStatus:400,shouldAlert:!1,trackKPI:!1}};function e(a){return d[a]||null}function f(){return d.SYSTEM_ERROR}},59175:(a,b,c)=>{c.d(b,{u:()=>d});class d extends Error{constructor(a,b,d,e){if("string"==typeof a){super(a);let c=new Date().toISOString().slice(0,10).replace(/-/g,""),f=Math.random().toString(36).slice(2,8).toUpperCase();this.id=`ERR_${c}_${f}`,this.code=d||"UNKNOWN_ERROR",this.user_message=a,this.severity="MEDIUM",this.retriable=!1,this.details=e,this.httpStatus=b||500}else{if(super(a.message),a.id)this.id=a.id;else{let a=new Date().toISOString().slice(0,10).replace(/-/g,""),b=Math.random().toString(36).slice(2,8).toUpperCase();this.id=`ERR_${a}_${b}`}this.code=a.code,this.user_message=a.user_message,this.severity=a.severity??"MEDIUM",this.retriable=!!a.retriable,this.details=a.details;try{let{getErrorDefinition:a}=c(50980),b=a(this.code);this.httpStatus=b?.httpStatus||500}catch{this.httpStatus=500}}}toJSON(){return{id:this.id,code:this.code,message:this.message,user_message:this.user_message,severity:this.severity,httpStatus:this.httpStatus}}}}};