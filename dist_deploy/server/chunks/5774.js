"use strict";exports.id=5774,exports.ids=[5774],exports.modules={27237:(a,b,c)=>{c.d(b,{mU:()=>k,oH:()=>l});var d=c(30477),e=c(59175);let f={maxRetries:3,baseDelay:1e3,maxDelay:1e4,shouldRetry:g};function g(a,b){return!b||!!(b.status>=500)&&!!(b.status<600)||429===b.status}function h(a,b,c){let d=b*Math.pow(2,a),e=.25*d*(Math.random()-.5);return Math.floor(Math.min(d+e,c))}async function i(a,b={},c={}){let k={...f,...c},{maxRetries:l,baseDelay:m,maxDelay:n}=k,o=k.shouldRetry??g,p=function(a){try{let b=new URL(a).hostname;if(b.includes("signalwire"))return"SignalWire";if(b.includes("assemblyai"))return"AssemblyAI";if(b.includes("elevenlabs"))return"ElevenLabs";if(b.includes("resend"))return"Resend";return"External"}catch{return"External"}}(a);for(let c=0;c<=l;c++)try{c>0&&d.v.info(`Retrying ${p} API call`,{attempt:c,maxRetries:l,url:function(a){try{let b=new URL(a);return b.searchParams.has("token")&&b.searchParams.set("token","[REDACTED]"),b.searchParams.has("api_key")&&b.searchParams.set("api_key","[REDACTED]"),b.toString()}catch{return"[INVALID_URL]"}}(a)});let f=await fetch(a,b);if(f.ok)return c>0&&d.v.info(`${p} API call succeeded after retry`,{attempt:c,status:f.status}),f;f.clone();let g=Error(`HTTP ${f.status}: ${f.statusText}`);if(!o(g,f))throw d.v.warn(`${p} API call failed (non-retriable)`,{status:f.status,statusText:f.statusText}),new e.u({code:`${p.toUpperCase()}_API_ERROR`,message:`${p} API returned ${f.status}`,user_message:`${p} service returned an error. Please try again.`,severity:f.status>=500?"HIGH":"MEDIUM",retriable:!1,details:{status:f.status,statusText:f.statusText}});if(c===l)throw d.v.error(`${p} API call failed after ${l} retries`,g,{status:f.status,attempts:c+1}),new e.u({code:`${p.toUpperCase()}_API_FAILED`,message:`${p} API failed after ${l} retries`,user_message:`${p} service is temporarily unavailable. Please try again later.`,severity:"HIGH",retriable:!0,details:{status:f.status,attempts:c+1,lastError:g.message}});let i=h(c,m,n);d.v.info(`${p} API call failed, retrying in ${i}ms`,{attempt:c+1,maxRetries:l,status:f.status}),await j(i)}catch(b){if(b instanceof e.u)throw b;if(!o(b))throw new e.u({code:`${p.toUpperCase()}_NETWORK_ERROR`,message:`Network error contacting ${p}`,user_message:`Unable to reach ${p} service. Please check your connection.`,severity:"HIGH",retriable:!1,details:{error:b?.message}});if(c===l)throw d.v.error(`${p} network error after ${l} retries`,b,{attempts:c+1}),new e.u({code:`${p.toUpperCase()}_UNREACHABLE`,message:`${p} unreachable after ${l} retries`,user_message:`Unable to reach ${p} service. Please try again later.`,severity:"CRITICAL",retriable:!0,details:{error:b?.message,attempts:c+1}});let a=h(c,m,n);d.v.info(`${p} network error, retrying in ${a}ms`,{attempt:c+1,maxRetries:l,error:b?.message}),await j(a)}throw new e.u({code:`${p.toUpperCase()}_RETRY_EXHAUSTED`,message:`${p} API retry exhausted`,user_message:"Service temporarily unavailable. Please try again.",severity:"HIGH",retriable:!0})}function j(a){return new Promise(b=>setTimeout(b,a))}async function k(a,b={}){return i(a,b,{maxRetries:3,baseDelay:1e3,maxDelay:1e4})}async function l(a,b={}){return i(a,b,{maxRetries:3,baseDelay:1500,maxDelay:12e3})}},29838:(a,b,c)=>{c.d(b,{aC:()=>i,eU:()=>j,ne:()=>h});var d=c(30477),e=c(59175);class f{constructor(a){this.resetTimer=null,this.config=a,this.metrics={successCount:0,failureCount:0,totalCount:0,lastFailureTime:null,lastSuccessTime:null,consecutiveFailures:0,state:"CLOSED",stateChangedAt:Date.now()}}async execute(a){if("OPEN"===this.metrics.state){let a=Date.now()-this.metrics.stateChangedAt;if(a>=this.config.resetTimeout)this.transitionToHalfOpen();else throw new e.u({code:`${this.config.vendorName.toUpperCase()}_CIRCUIT_OPEN`,message:`${this.config.vendorName} circuit breaker is open`,user_message:`${this.config.vendorName} service is temporarily unavailable. Please try again in a few moments.`,severity:"HIGH",retriable:!0,details:{state:this.metrics.state,timeSinceOpen:Math.floor(a/1e3),resetIn:Math.floor((this.config.resetTimeout-a)/1e3)}})}try{let b=await this.executeWithTimeout(a);return this.onSuccess(),b}catch(a){throw this.onFailure(a),a}}async executeWithTimeout(a){return new Promise((b,c)=>{let d=setTimeout(()=>{c(Error(`${this.config.vendorName} request timeout after ${this.config.timeout}ms`))},this.config.timeout);a().then(a=>{clearTimeout(d),b(a)}).catch(a=>{clearTimeout(d),c(a)})})}onSuccess(){this.metrics.successCount++,this.metrics.totalCount++,this.metrics.lastSuccessTime=Date.now(),this.metrics.consecutiveFailures=0,"HALF_OPEN"===this.metrics.state&&this.transitionToClosed()}onFailure(a){if(this.metrics.failureCount++,this.metrics.totalCount++,this.metrics.lastFailureTime=Date.now(),this.metrics.consecutiveFailures++,d.v.warn(`${this.config.vendorName} circuit breaker: failure recorded`,{error:a.message,consecutiveFailures:this.metrics.consecutiveFailures,state:this.metrics.state}),"HALF_OPEN"===this.metrics.state)return void this.transitionToOpen();this.shouldOpenCircuit()&&this.transitionToOpen()}shouldOpenCircuit(){return!(this.metrics.totalCount<this.config.volumeThreshold)&&this.metrics.failureCount/this.metrics.totalCount*100>=this.config.errorThresholdPercentage}transitionToOpen(){"OPEN"!==this.metrics.state&&(this.metrics.state="OPEN",this.metrics.stateChangedAt=Date.now(),d.v.error(`${this.config.vendorName} circuit breaker OPENED`,void 0,{failureCount:this.metrics.failureCount,totalCount:this.metrics.totalCount,errorPercentage:Math.round(this.metrics.failureCount/this.metrics.totalCount*100),consecutiveFailures:this.metrics.consecutiveFailures}),this.resetTimer&&clearTimeout(this.resetTimer),this.resetTimer=setTimeout(()=>{this.transitionToHalfOpen()},this.config.resetTimeout))}transitionToHalfOpen(){"HALF_OPEN"!==this.metrics.state&&(this.metrics.state="HALF_OPEN",this.metrics.stateChangedAt=Date.now(),d.v.warn(`${this.config.vendorName} circuit breaker HALF_OPEN - testing recovery`,{timeSinceOpen:Math.floor((Date.now()-this.metrics.stateChangedAt)/1e3)}))}transitionToClosed(){if("CLOSED"===this.metrics.state)return;let a=this.metrics.state;this.metrics.state="CLOSED",this.metrics.stateChangedAt=Date.now(),this.metrics.successCount=0,this.metrics.failureCount=0,this.metrics.totalCount=0,this.metrics.consecutiveFailures=0,this.resetTimer&&(clearTimeout(this.resetTimer),this.resetTimer=null),d.v.info(`${this.config.vendorName} circuit breaker CLOSED - service recovered`,{previousState:a,downtime:"OPEN"===a?Math.floor((Date.now()-this.metrics.stateChangedAt)/1e3):0})}getState(){return this.metrics.state}getMetrics(){return{...this.metrics}}getHealthStatus(){let a=this.metrics.totalCount>0?this.metrics.failureCount/this.metrics.totalCount*100:0;return{healthy:"CLOSED"===this.metrics.state,state:this.metrics.state,errorRate:Math.round(a),consecutiveFailures:this.metrics.consecutiveFailures}}reset(){this.transitionToClosed(),d.v.info(`${this.config.vendorName} circuit breaker manually reset`)}}class g{getBreaker(a,b){if(!this.breakers.has(a)){let c={timeout:1e4,errorThresholdPercentage:50,resetTimeout:3e4,volumeThreshold:10,vendorName:a,...b};this.breakers.set(a,new f(c))}return this.breakers.get(a)}getHealthStatuses(){let a={};return this.breakers.forEach((b,c)=>{a[c]=b.getHealthStatus()}),a}constructor(){this.breakers=new Map}}let h=new g,i=h.getBreaker("SignalWire",{timeout:1e4,errorThresholdPercentage:50,resetTimeout:3e4,volumeThreshold:10});h.getBreaker("AssemblyAI",{timeout:15e3,errorThresholdPercentage:40,resetTimeout:6e4,volumeThreshold:5});let j=h.getBreaker("ElevenLabs",{timeout:2e4,errorThresholdPercentage:45,resetTimeout:45e3,volumeThreshold:8})},50366:(a,b,c)=>{c.d(b,{Ay:()=>p});var d=c(91043),e=c(78677);let f=process.env.R2_ENDPOINT,g=process.env.R2_ACCESS_KEY_ID,h=process.env.R2_SECRET_ACCESS_KEY,i=null;async function j(a,b,c,e){if(!i)throw Error("R2 client not configured; set R2_* envs");let f=new d.PutObjectCommand({Bucket:a,Key:b,Body:c,ContentType:e});return i.send(f)}async function k(a,b){if(!i)throw Error("R2 client not configured; set R2_* envs");let c=new d.GetObjectCommand({Bucket:a,Key:b}),e=(await i.send(c)).Body,f=[];for await(let a of e)f.push(Buffer.from(a));return Buffer.concat(f)}async function l(a,b,c=3600){if(!i)throw Error("R2 client not configured; set R2_* envs");let f=new d.GetObjectCommand({Bucket:a,Key:b});return await (0,e.A)(i,f,{expiresIn:c})}f&&g&&h&&(i=new d.S3Client({endpoint:f,region:process.env.R2_REGION||"auto",credentials:{accessKeyId:g,secretAccessKey:h},forcePathStyle:!1}));class m{constructor(){this.bucket=globalThis.RECORDINGS_BUCKET}isAvailable(){return!!this.bucket}async upload(a,b,c){if(!this.bucket)throw Error("R2 bucket binding RECORDINGS_BUCKET not found");await this.bucket.put(a,b,{httpMetadata:{contentType:c||"application/octet-stream"}})}async getPublicUrl(a){return`/api/recordings/${encodeURIComponent(a)}`}}let n=new m;function o(){if(!n.isAvailable()&&!i)throw Error("R2 not configured: ensure RECORDINGS_BUCKET binding exists or set R2_ENDPOINT, R2_ACCESS_KEY_ID and R2_SECRET_ACCESS_KEY")}let p={upload:async function(a,b,c,d){if(n.isAvailable()){let a=c instanceof Buffer?c:"string"==typeof c?new TextEncoder().encode(c):c;await n.upload(b,a,d);return}return o(),j(a,b,c,d)},download:async function(a,b){if(n.isAvailable()){let a=await globalThis.RECORDINGS_BUCKET.get(b);return a?await a.arrayBuffer():null}return o(),k(a,b)},getPublicUrl:async function(a,b){if(n.isAvailable()){let a=await n.getPublicUrl(b);return{publicURL:a,publicUrl:a}}o();let c=process.env.R2_ENDPOINT;if(!c)throw Error("R2_ENDPOINT required to construct public URL");let d=`${c.replace(/\/$/,"")}/${a}/${encodeURIComponent(b)}`;return{publicURL:d,publicUrl:d}},createSignedUrl:async function(a,b,c=3600){return o(),{signedUrl:await l(a,b,c)}}}},73537:(a,b,c)=>{c.d(b,{E1:()=>h,Rw:()=>i,_M:()=>g});var d=c(30477),e=c(27237),f=c(29838);async function g(a,b="en",c){let e=function(){let a=process.env.ELEVENLABS_API_KEY;if(!a)throw Error("ELEVENLABS_API_KEY environment variable is not set");return a}();try{let f=`https://api.elevenlabs.io/v1/text-to-speech/${encodeURIComponent(c||("en"===b?"EXAVITQu4vr4xnSDxMaL":"pNInz6obpgDQGcFmaJgB"))}`,g=await fetch(f,{method:"POST",headers:{"xi-api-key":e,"Content-Type":"application/json",Accept:"audio/mpeg"},body:JSON.stringify({text:a,model_id:"eleven_multilingual_v2",voice_settings:{stability:.5,similarity_boost:.75,style:0,use_speaker_boost:!0}})});if(!g.ok){let a=await g.text();throw d.v.error("ElevenLabs TTS fetch error",void 0,{status:g.status,body:a}),Error(`ElevenLabs TTS failed: ${g.status} - ${a}`)}if(g.body)return g.body;let h=Buffer.from(await g.arrayBuffer());return new ReadableStream({start(a){a.enqueue(new Uint8Array(h)),a.close()}})}catch(a){throw d.v.error("ElevenLabs TTS error",a),Error(`ElevenLabs TTS failed: ${a?.message||"Unknown error"}`)}}async function h(a,b,c){let g=process.env.ELEVENLABS_API_KEY;if(!g)throw Error("ELEVENLABS_API_KEY environment variable is not set");try{let h,i=new FormData;i.append("name",b),c&&i.append("description",c);let j=a.buffer.slice(a.byteOffset,a.byteOffset+a.byteLength),k=new Blob([j],{type:"audio/mpeg"});i.append("files",k,"voice_sample.mp3"),i.append("labels",JSON.stringify({source:"callmonitor",type:"instant_clone"}));try{h=await f.eU.execute(async()=>await (0,e.oH)("https://api.elevenlabs.io/v1/voices/add",{method:"POST",headers:{"xi-api-key":g},body:i}))}catch(a){throw d.v.error("ElevenLabs voice clone fetch error",a),Error(`Voice cloning failed: ${a?.message||"Network error"}`)}if(!h.ok){let a=await h.text();throw d.v.error("ElevenLabs voice clone error",void 0,{error:a}),Error(`Voice cloning failed: ${h.status} - ${a}`)}let l=await h.json();return d.v.info("ElevenLabs voice cloned successfully",{voiceId:l.voice_id,name:b}),{voiceId:l.voice_id,name:l.name||b}}catch(a){throw d.v.error("ElevenLabs voice cloning error",a),Error(`Voice cloning failed: ${a?.message||"Unknown error"}`)}}async function i(a){let b=process.env.ELEVENLABS_API_KEY;if(!b)throw Error("ELEVENLABS_API_KEY environment variable is not set");try{let c;try{c=await f.eU.execute(async()=>await (0,e.oH)(`https://api.elevenlabs.io/v1/voices/${a}`,{method:"DELETE",headers:{"xi-api-key":b}}))}catch(a){d.v.warn("ElevenLabs voice delete fetch error",{error:a?.message});return}if(!c.ok&&404!==c.status){let a=await c.text();d.v.warn("ElevenLabs voice delete error",{error:a})}d.v.debug("ElevenLabs voice deleted",{voiceId:a})}catch(a){d.v.warn("ElevenLabs voice deletion error",{error:a?.message})}}}};