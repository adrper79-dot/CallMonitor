"use strict";exports.id=4284,exports.ids=[4284],exports.modules={12323:(a,b,c)=>{c.d(b,{Ez:()=>g,zV:()=>f});var d=c(77598),e=c.n(d);function f(a,b="sha256"){let c=JSON.stringify(function a(b){if(null==b)return b;if(Array.isArray(b))return b.map(a);if(b&&"object"==typeof b&&b.constructor===Object){let c={};for(let d of Object.keys(b).sort())c[d]=a(b[d]);return c}return b}(a));return e().createHash(b).update(c,"utf8").digest("hex")}function g(a,b="sha256"){let c=f(a,b);return`${b}:${c}`}},14284:(a,b,c)=>{c.d(b,{checkAndGenerateManifest:()=>l});var d=c(32524),e=c(60387),f=c(77598),g=c.n(f),h=c(30477),i=c(65241),j=c(12323);async function k(a,b,c,f){try{let{rows:k}=await (0,e.P)(`SELECT id, version FROM evidence_manifests 
       WHERE recording_id = $1 AND superseded_at IS NULL 
       ORDER BY version DESC LIMIT 1`,[b]);if(k?.[0]&&!f)return h.v.debug("evidenceManifest: manifest already exists",{manifestId:k[0].id,recordingId:b}),k[0].id;let l=[],n={},o=new Date().toISOString(),{rows:p}=await (0,e.P)(`SELECT id, recording_url, duration_seconds, status, created_at, source, media_hash, created_by 
       FROM recordings WHERE id = $1 LIMIT 1`,[b]),q=p?.[0];q&&(l.push({type:"recording",id:q.id,uri:q.recording_url,sha256:q.media_hash||void 0,produced_by:"system",produced_by_model:q.source||"signalwire",produced_at:q.created_at,input_refs:[],version:1,metadata:{duration_seconds:q.duration_seconds,status:q.status,source:q.source||"signalwire"}}),n.recording_source=q.source||"signalwire");let{rows:r}=await (0,e.P)(`SELECT id, version, transcript_json, transcript_hash, produced_by, produced_by_model, created_at 
       FROM transcript_versions 
       WHERE recording_id = $1 
       ORDER BY version DESC LIMIT 1`,[b]);if(r?.[0]){let a=r[0];l.push({type:"transcript",id:a.id,sha256:a.transcript_hash,produced_by:a.produced_by,produced_by_model:a.produced_by_model,produced_at:a.created_at,input_refs:[{type:"recording",id:b,hash:q?.media_hash}],version:a.version,metadata:{text:a.transcript_json?.text,confidence:a.transcript_json?.confidence}}),n.transcription_model=a.produced_by_model||"assemblyai-v1"}else{let{rows:a}=await (0,e.P)("SELECT transcript_json FROM recordings WHERE id = $1 LIMIT 1",[b]);if(a?.[0]?.transcript_json){let c=a[0].transcript_json,d=g().createHash("sha256").update(JSON.stringify(c)).digest("hex");l.push({type:"transcript",id:`${b}-transcript`,sha256:d,produced_by:"model",produced_by_model:"assemblyai-v1",produced_at:o,input_refs:[{type:"recording",id:b}],version:1,metadata:{text:c.text,confidence:c.confidence,transcript_id:c.transcript_id}}),n.transcription_model="assemblyai-v1"}}let{rows:s}=await (0,e.P)(`SELECT id, output, model, completed_at, system_id 
       FROM ai_runs 
       WHERE call_id = $1 AND model ILIKE '%translation%' AND status = 'completed' 
       LIMIT 1`,[a]);if(s?.[0]){let a=s[0];l.push({type:"translation",id:a.id,produced_by:"model",produced_by_model:a.model,produced_at:a.completed_at||o,input_refs:[{type:"transcript",id:`${b}-transcript`}],version:1,metadata:{from_language:a.output?.from_language,to_language:a.output?.to_language}}),n.translation_model=a.model||"assemblyai-translation"}let{rows:t}=await (0,e.P)(`SELECT id, output, completed_at 
       FROM ai_runs 
       WHERE call_id = $1 AND output->>'type' = 'survey' 
       LIMIT 1`,[a]);if(t?.[0]){let a=t[0];l.push({type:"survey",id:a.id,produced_by:"model",produced_by_model:"assemblyai-nlp",produced_at:a.completed_at||o,input_refs:[{type:"transcript",id:`${b}-transcript`}],version:1,metadata:{responses:a.output?.responses}}),n.survey_processor="assemblyai-nlp"}if(f){let{rows:a}=await (0,e.P)(`SELECT id, scores_json, total_score, created_at, manual_overrides_json 
         FROM scored_recordings 
         WHERE recording_id = $1 AND scorecard_id = $2 
         LIMIT 1`,[b,f]);if(a?.[0]){let c=a[0];l.push({type:"score",id:c.id,produced_by:c.manual_overrides_json?"human":"model",produced_by_model:"qise-v1",produced_at:c.created_at,input_refs:[{type:"transcript",id:`${b}-transcript`},{type:"recording",id:b}],version:1,metadata:{total_score:c.total_score,scorecard_id:f,has_manual_overrides:!!c.manual_overrides_json}}),n.scoring_engine="qise-v1"}}let u=k?.[0]?.version?k[0].version+1:1,v=k?.[0]?.id||null,w=(0,d.A)(),x={manifest_id:w,created_at:o,call_id:a,organization_id:c,artifacts:l,manifest_hash:"",producer:"call_monitor_v1",version:u,parent_manifest_id:v||void 0,provenance:n};x.manifest_hash=(0,j.Ez)(x),await (0,e.P)(`INSERT INTO evidence_manifests (
        id, organization_id, recording_id, scorecard_id, manifest, 
        created_at, version, parent_manifest_id
      ) VALUES ($1, $2, $3, $4, $5, $6, $7, $8)`,[w,c,b,f||null,JSON.stringify(x),o,u,v]);let y=await (0,i.Cu)({manifestId:w,manifestHash:x.manifest_hash,organizationId:c,callId:a,recordingId:b,artifacts:l,version:u,parentManifestId:v||null});if(v)try{await (0,e.P)(`UPDATE evidence_manifests 
           SET superseded_at = $1, superseded_by = $2 
           WHERE id = $3`,[o,w,v])}catch{h.v.warn("evidenceManifest: could not mark parent as superseded (trigger may prevent)",{parentManifestId:v})}await m(c,"evidence_manifest",w,{produced_by:"system",produced_by_system_id:null,input_refs:l.map(a=>({type:a.type,id:a.id,hash:a.sha256})),version:u,metadata:{artifact_count:l.length}}),await m(c,"evidence_bundle",y,{produced_by:"system",produced_by_system_id:null,input_refs:[{type:"evidence_manifest",id:w,hash:x.manifest_hash},...l.map(a=>({type:a.type,id:a.id,hash:a.sha256}))],version:u,metadata:{artifact_count:l.length}});try{await (0,e.P)("UPDATE recordings SET evidence_completeness = 'complete' WHERE id = $1",[b]),await (0,e.P)("UPDATE calls SET evidence_completeness = 'complete' WHERE id = $1",[a])}catch(c){h.v.warn("evidenceManifest: could not update evidence completeness",{callId:a,recordingId:b,error:c instanceof Error?c.message:String(c)})}return h.v.info("evidenceManifest: generated manifest",{manifestId:w,callId:a,recordingId:b,artifactCount:l.length,version:u}),w}catch(c){throw h.v.error("evidenceManifest: generation error",c,{callId:a,recordingId:b}),c}}async function l(a,b,c){try{let{rows:d}=await (0,e.P)("SELECT status, transcript_json FROM recordings WHERE id = $1 LIMIT 1",[b]),f=d?.[0];if(!f||"completed"!==f.status)return null;let{rows:g}=await (0,e.P)("SELECT transcribe FROM voice_configs WHERE organization_id = $1 LIMIT 1",[c]);if(g?.[0]?.transcribe===!0&&!f.transcript_json)return null;return await k(a,b,c)}catch(c){return h.v.error("evidenceManifest: check error",c,{callId:a,recordingId:b}),null}}async function m(a,b,c,f){try{let g=(0,d.A)();return await (0,e.P)(`INSERT INTO artifact_provenance (
        id, organization_id, artifact_type, artifact_id, parent_artifact_id, 
        parent_artifact_type, produced_by, produced_by_model, produced_by_user_id, 
        produced_by_system_id, input_refs, version, metadata, produced_at
      ) VALUES ($1, $2, $3, $4, $5, $6, $7, $8, $9, $10, $11, $12, $13, NOW())`,[g,a,b,c,f.parent_artifact_id||null,f.parent_artifact_type||null,f.produced_by,f.produced_by_model||null,f.produced_by_user_id||null,f.produced_by_system_id||null,JSON.stringify(f.input_refs||[]),f.version||1,JSON.stringify(f.metadata||{})]),g}catch(a){return h.v.warn("evidenceManifest: provenance recording error",{error:a?.message||String(a),artifactId:c}),null}}},65241:(a,b,c)=>{c.d(b,{Cu:()=>j,Oj:()=>k});var d=c(32524),e=c(60387),f=c(30477),g=c(12323);async function h(a){let b=process.env.RFC3161_TSA_PROXY_URL;if(!b)return{tsa:null,tsaStatus:"not_configured"};let c=new Date().toISOString();try{let d=await fetch(b,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({hash_hex:a,hash_algorithm:"sha256"})});if(!d.ok)return{tsa:null,tsaStatus:"error",tsaRequestedAt:c,tsaError:`RFC3161 proxy responded ${d.status}`};let e=await d.json(),f=e?.token_der_base64||e?.token_base64||null,h=f?`sha256:${(0,g.zV)(f)}`:null;return{tsa:{tsa_url:e?.tsa_url||b,timestamp:e?.timestamp,policy_oid:e?.policy_oid,serial:e?.serial,token_der_base64:f,token_hash:h},tsaStatus:"completed",tsaRequestedAt:c,tsaReceivedAt:new Date().toISOString()}}catch(a){return{tsa:null,tsaStatus:"error",tsaRequestedAt:c,tsaError:a?.message||"RFC3161 request failed"}}}async function i(a,b){let c=new Date().toISOString();try{await (0,e.P)("UPDATE evidence_bundles SET tsa_requested_at = $1 WHERE id = $2",[c,a]);let d=await h(b);await (0,e.P)(`UPDATE evidence_bundles SET 
         tsa = $1, 
         tsa_status = $2, 
         tsa_received_at = $3, 
         tsa_error = $4 
       WHERE id = $5`,[JSON.stringify(d.tsa),d.tsaStatus,d.tsaReceivedAt||null,d.tsaError||null,a]),f.v.info("evidenceBundle: TSA request completed",{bundleId:a,status:d.tsaStatus})}catch(b){await (0,e.P)("UPDATE evidence_bundles SET tsa_status = 'error', tsa_error = $1 WHERE id = $2",[b?.message||"TSA request failed",a]),f.v.error("evidenceBundle: TSA request failed",b,{bundleId:a})}}async function j(a){let{manifestId:b,manifestHash:c,organizationId:h,callId:j,recordingId:k,artifacts:l,version:m,parentManifestId:n}=a;try{let{rows:a}=await (0,e.P)("SELECT id FROM evidence_bundles WHERE manifest_id = $1 AND superseded_at IS NULL LIMIT 1",[b]);if(a?.[0])return a[0].id;let o=l.map(a=>({type:a.type,id:a.id,sha256:a.sha256??null})).sort((a,b)=>a.type===b.type?a.id.localeCompare(b.id):a.type.localeCompare(b.type)),p=new Date().toISOString(),q={manifest_id:b,manifest_hash:c,artifact_hashes:o,organization_id:h,call_id:j,created_at:p,version:m},r=(0,g.zV)(q),s=`sha256:${r}`,t=null;if(n){let{rows:a}=await (0,e.P)("SELECT id FROM evidence_bundles WHERE manifest_id = $1 AND superseded_at IS NULL LIMIT 1",[n]);t=a?.[0]?.id||null}let u=!!process.env.RFC3161_TSA_PROXY_URL,v=u?"pending":"not_configured",w=function(a){let b=new Set(a.map(a=>a.type));return b.has("recording")?b.has("transcript")?"complete":"partial":"failed"}(l),x=(0,d.A)();return await (0,e.P)(`INSERT INTO evidence_bundles (
        id, organization_id, call_id, recording_id, manifest_id, manifest_hash, 
        artifact_hashes, bundle_payload, bundle_hash, bundle_hash_algo, version, 
        parent_bundle_id, immutable_storage, custody_status, retention_class, 
        legal_hold_flag, evidence_completeness, tsa, tsa_status, tsa_requested_at, 
        tsa_received_at, tsa_error, created_at
      ) VALUES ($1, $2, $3, $4, $5, $6, $7, $8, $9, $10, $11, $12, $13, $14, $15, $16, $17, $18, $19, $20, $21, $22, $23)`,[x,h,j,k||null,b,c,JSON.stringify(o),JSON.stringify(q),s,"sha256",m,t,!0,"active","default",!1,w,null,v,null,null,null,p]),f.v.info("evidenceBundle: created bundle",{bundleId:x,manifestId:b,callId:j,bundleHash:s,tsaStatus:v}),u&&setImmediate(async()=>{try{await i(x,r)}catch(a){f.v.warn("evidenceBundle: async TSA request failed",{bundleId:x,error:String(a)})}}),x}catch(a){throw f.v.error("evidenceBundle: creation error",a,{manifestId:b,callId:j}),a}}async function k(a){let{rows:b}=await (0,e.P)("SELECT id FROM evidence_bundles WHERE manifest_id = $1 AND superseded_at IS NULL LIMIT 1",[a]);if(b?.[0])return b[0].id;let{rows:c}=await (0,e.P)(`SELECT id, manifest, organization_id, recording_id, version, parent_manifest_id 
     FROM evidence_manifests WHERE id = $1 LIMIT 1`,[a]),d=c?.[0];if(!d)throw Error(`Manifest ${a} not found for bundle recovery`);return j({manifestId:a,manifestHash:d.manifest?.manifest_hash||"",organizationId:d.organization_id,callId:d.manifest?.call_id||"",recordingId:d.recording_id,artifacts:d.manifest?.artifacts||[],version:d.version,parentManifestId:d.parent_manifest_id})}}};