"use strict";exports.id=8499,exports.ids=[8499],exports.modules={3208:(a,b,c)=>{c.d(b,{A:()=>g});var d=c(81742),e=c(60387);let f=null,g=new Proxy({},{get(a,b){let c=function(){if(f)return f;if(process.env.NEON_PG_CONN||process.env.PG_CONN||process.env.DATABASE_URL)return f=function(){function a(a){return'"'+a.replace(/"/g,'""')+'"'}class b{constructor(a){this.selects=null,this.where=[],this.table=a}select(a){return this.selects=a,this}eq(b,c){let d=this._nextParamIndex();return this.where.push({clause:`${a(b)} = $${d}`,params:[c]}),this}limit(a){return this.limitCount=a,this}order(b,c="asc"){return this.orderBy=`${a(b)} ${c.toUpperCase()}`,this}async single(){let{text:a,params:b}=this._buildSelect(!0);try{return{data:(await e.Ay.query(a,b)).rows[0]||null,error:null}}catch(a){return{data:null,error:a}}}async insert(b){let c=Object.keys(b),d=c.map((a,b)=>`$${b+1}`),f=c.map(a=>b[a]),g=`INSERT INTO ${a(this.table)} (${c.map(a).join(",")}) VALUES (${d.join(",")}) RETURNING *`;try{return{data:(await e.Ay.query(g,f)).rows,error:null}}catch(a){return{data:null,error:a}}}async update(b){let c=Object.keys(b),d=c.map((b,c)=>`${a(b)} = $${c+1}`),f=c.map(a=>b[a]),g=this._gatherWhereParams(),h=`UPDATE ${a(this.table)} SET ${d.join(",")} ${this._whereClause(g.length)} RETURNING *`;try{return{data:(await e.Ay.query(h,f.concat(g))).rows,error:null}}catch(a){return{data:null,error:a}}}_gatherWhereParams(){return this.where.flatMap(a=>a.params)}_whereClause(a=0){return 0===this.where.length?"":"WHERE "+this.where.map((b,c)=>(this._paramOffsetForIndex(c),b.clause.replace(/\$(\d+)/g,(b,c)=>`$${a+parseInt(c,10)}`))).join(" AND ")}_nextParamIndex(){return this.where.flatMap(a=>a.params).length+1}_paramOffsetForIndex(a){return this.where.slice(0,a).flatMap(a=>a.params).length+1}_buildSelect(b=!1){let c=this.selects||"*",d=this._gatherWhereParams(),e=this._whereClause(0),f=b||this.limitCount?`LIMIT ${b?1:this.limitCount}`:"",g=this.orderBy?`ORDER BY ${this.orderBy}`:"";return{text:`SELECT ${c} FROM ${a(this.table)} ${e} ${g} ${f}`,params:d}}}return new Proxy({},{get:(a,c)=>function(a){if("from"===c)return function(a){return new b(a)}}})}();let a=process.env.SUPABASE_URL||process.env.NEXT_PUBLIC_SUPABASE_URL,b=process.env.SUPABASE_SERVICE_ROLE_KEY;if(!a)throw Error("Missing SUPABASE_URL or NEXT_PUBLIC_SUPABASE_URL environment variable");if(!b)throw Error("Missing SUPABASE_SERVICE_ROLE_KEY environment variable");return f=(0,d.UU)(a,b,{auth:{autoRefreshToken:!1,persistSession:!1}})}(),g=c[b];return"function"==typeof g?g.bind(c):g}})},30880:(a,b,c)=>{c.d(b,{captureAttentionEvent:()=>k});var d=c(3208),e=c(32524),f=c(30477);async function g(a){try{let b,{data:c,error:f}=await d.A.from("attention_policies").select("*").eq("organization_id",a.organization_id).eq("is_enabled",!0).order("priority",{ascending:!0});if(f)throw f;let g="needs_review",i="No decisive policy matched; defaulting to review.";for(let d of c){let c=await h(a,d);if(c){g=c.decision,i=c.reason,b=d.id;break}}let k={id:(0,e.A)(),organization_id:a.organization_id,attention_event_id:a.id,decision:g,reason:i,policy_id:b,produced_by:"system",input_refs:[],created_at:new Date().toISOString()};return await d.A.from("attention_decisions").insert(k),"escalate"===g&&await j(k,a),k}catch(c){f.v.error("RTI Policy Evaluation Failed",{error:c,eventId:a.id});let b={id:(0,e.A)(),organization_id:a.organization_id,attention_event_id:a.id,decision:"needs_review",reason:"System error during evaluation",produced_by:"system",input_refs:[],created_at:new Date().toISOString()};return await d.A.from("attention_decisions").insert(b),b}}async function h(a,b){let c=b.policy_config||{};switch(b.policy_type){case"quiet_hours":if(function(a){if(!a.start_hour||!a.end_hour)return!1;let b=new Date().getUTCHours();return a.start_hour>a.end_hour?b>=a.start_hour||b<a.end_hour:b>=a.start_hour&&b<a.end_hour}(c)){if("critical"===(a.payload_snapshot?.severity||"info"))return null;return{decision:"suppress",reason:`Suppressed by Quiet Hours (${c.start} to ${c.end})`}}break;case"recurring_suppress":if(await i(a,c))return{decision:"suppress",reason:`Suppressed as recurring noise (>${c.count} times in ${c.window_hours}h)`};break;case"threshold":let d=a.payload_snapshot?.severity||"info";if("critical"===d||"high"===d)return{decision:"escalate",reason:`Escalated due to high severity (${d})`};if(c.min_severity&&c.min_severity===d)return{decision:"escalate",reason:"Escalated due to matching severity rule"};break;case"keyword_escalate":let e=c.keywords||[],f=JSON.stringify(a.payload_snapshot).toLowerCase();if(e.some(a=>f.includes(a.toLowerCase())))return{decision:"escalate",reason:"Escalated due to keyword match"}}return null}async function i(a,b){let c=b.count||3,e=b.window_hours||24,f=new Date(Date.now()-60*e*6e4).toISOString(),{count:g}=await d.A.from("attention_events").select("*",{count:"exact",head:!0}).eq("organization_id",a.organization_id).eq("source_id",a.source_id).eq("event_type",a.event_type).gte("occurred_at",f);return(g||0)>=c}async function j(a,b){f.v.info("RTI ESCALATION TRIGGERED",{decisionId:a.id,eventId:b.id})}async function k(a){let b=(0,e.A)(),c=a.occurredAt||new Date().toISOString(),h={id:b,organization_id:a.organizationId,event_type:a.eventType,source_table:a.sourceTable,source_id:a.sourceId,occurred_at:c,payload_snapshot:a.payload,input_refs:a.inputRefs||[],created_at:new Date().toISOString()},{error:i}=await d.A.from("attention_events").insert({id:h.id,organization_id:h.organization_id,event_type:h.event_type,source_table:h.source_table,source_id:h.source_id,occurred_at:h.occurred_at,payload_snapshot:h.payload_snapshot,input_refs:h.input_refs});if(i)throw f.v.error("Failed to persist attention_event",{error:i,params:a}),i;try{await g(h)}catch(a){f.v.error("Policy evaluation failed during ingest",{error:a,eventId:b})}return h}}};