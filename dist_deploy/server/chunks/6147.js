"use strict";exports.id=6147,exports.ids=[6147],exports.modules={66147:(a,b,c)=>{c.d(b,{authOptions:()=>q,t:()=>n});var d=c(28120),e=c(75783),f=c(32003),g=c(12513),h=c(11748),i=c(60387),j=c(77598),k=c(30477),l=c(78537);async function m(a,b){let c=process.env.RESEND_API_KEY;if(!c)throw Error("RESEND_API_KEY not configured");let d=await fetch("https://api.resend.com/emails",{method:"POST",headers:{"Content-Type":"application/json",Authorization:`Bearer ${c}`},body:JSON.stringify({from:process.env.EMAIL_FROM||`no-reply@${process.env.NEXTAUTH_URL?.replace(/^https?:\/\//,"")}`,to:[a],subject:"Your sign-in link",html:b,tags:[{name:"category",value:"auth"}]})});if(!d.ok)throw Error(`Resend API error: ${d.status} ${await d.text()}`)}function n(){let a=function(){try{let a=(0,i.d_)();return(0,l.A)(a)}catch(a){k.v.warn("[Auth] Postgres pool not available - disabling adapter");return}}(),b=function(a){let b=[];if(b.push((0,d.A)({name:"Credentials",credentials:{username:{label:"Username or Email",type:"text"},password:{label:"Password",type:"password"}},async authorize(a){if(!a||!a.username||!a.password)return null;let b=String(a.username).toLowerCase();globalThis.__loginRateLimiter||(globalThis.__loginRateLimiter=new Map);let c=globalThis.__loginRateLimiter;function d(){return Date.now()}let e=c.get(b)||{attempts:[],blockedUntil:0};if(e.attempts=e.attempts.filter(a=>a>d()-9e5),e.blockedUntil&&e.blockedUntil>d())return null;let f=String(a.username),g=null;if(/^[^@\s]+@[^@\s]+\.[^@\s]+$/.test(f))g=f;else try{let a=await i.Ay.query("SELECT email, username FROM users WHERE username = $1 OR email = $1 LIMIT 1",[f]);a?.rows&&a.rows.length&&(g=a.rows[0].email??null)}catch(a){}if(!g)return e.attempts.push(d()),e.attempts.length>=5&&(e.blockedUntil=d()+9e5),c.set(b,e),null;try{let a=g.toLowerCase().split("@")[1],b=await i.Ay.query("SELECT require_sso, provider_name FROM org_sso_configs WHERE is_enabled = true AND verified_domains @> $1::jsonb LIMIT 1",[JSON.stringify([a])]),c=b?.rows&&b.rows.length?b.rows[0]:null;if(c?.require_sso)return k.v.warn("Password login blocked: SSO required for domain",{email:g,domain:a}),null}catch(a){k.v.debug("SSO check skipped",{error:a.message})}try{let f=await i.Ay.query("SELECT id, email, password_hash FROM users WHERE email = $1 LIMIT 1",[g]),h=f?.rows&&f.rows.length?f.rows[0]:null;if(!h||!h.password_hash)return e.attempts.push(d()),e.attempts.length>=5&&(e.blockedUntil=d()+9e5),c.set(b,e),null;let[k,l]=String(h.password_hash).split(":");if(!k||!l)return e.attempts.push(d()),e.attempts.length>=5&&(e.blockedUntil=d()+9e5),c.set(b,e),null;let m=(0,j.scryptSync)(a.password,k,64).toString("hex");if(!(0,j.timingSafeEqual)(Buffer.from(m,"hex"),Buffer.from(l,"hex")))return e.attempts.push(d()),e.attempts.length>=5&&(e.blockedUntil=d()+9e5),c.set(b,e),null;return c.delete(b),{id:h.id,email:h.email,name:h.email}}catch(a){return e.attempts.push(d()),e.attempts.length>=5&&(e.blockedUntil=d()+9e5),c.set(b,e),null}}})),a&&1)try{let a=c(29662).A;b.push(a({async sendVerificationRequest({identifier:a,url:b}){let c=`<p>Sign in: <a href="${b}">${b}</a></p>`;try{await m(a,c)}catch(a){throw k.v.error("[Auth] Resend email failed",a),Error("Failed to send verification email")}},server:void 0}))}catch(a){k.v.warn("[Auth] Could not load EmailProvider (likely Edge runtime)",a)}else k.v.warn("[Auth] Email provider disabled: Supabase adapter unavailable or Edge runtime detected");return process.env.GOOGLE_CLIENT_ID&&process.env.GOOGLE_CLIENT_SECRET&&b.push((0,e.A)({clientId:process.env.GOOGLE_CLIENT_ID,clientSecret:process.env.GOOGLE_CLIENT_SECRET,allowDangerousEmailAccountLinking:!1})),process.env.AZURE_AD_CLIENT_ID&&process.env.AZURE_AD_CLIENT_SECRET&&process.env.AZURE_AD_TENANT_ID&&b.push((0,f.A)({clientId:process.env.AZURE_AD_CLIENT_ID,clientSecret:process.env.AZURE_AD_CLIENT_SECRET,tenantId:process.env.AZURE_AD_TENANT_ID,allowDangerousEmailAccountLinking:!1})),process.env.TWITTER_CLIENT_ID&&process.env.TWITTER_CLIENT_SECRET&&b.push((0,g.Ay)({clientId:process.env.TWITTER_CLIENT_ID,clientSecret:process.env.TWITTER_CLIENT_SECRET,version:"2.0"})),process.env.FACEBOOK_CLIENT_ID&&process.env.FACEBOOK_CLIENT_SECRET&&b.push((0,h.A)({clientId:process.env.FACEBOOK_CLIENT_ID,clientSecret:process.env.FACEBOOK_CLIENT_SECRET})),b}(a);return{...a?{adapter:a}:{},providers:b,secret:process.env.NEXTAUTH_SECRET,cookies:{sessionToken:{name:"next-auth.session-token",options:{httpOnly:!0,sameSite:"lax",path:"/",secure:!0}},callbackUrl:{name:"next-auth.callback-url",options:{httpOnly:!0,sameSite:"lax",path:"/",secure:!0}},csrfToken:{name:"next-auth.csrf-token",options:{httpOnly:!0,sameSite:"lax",path:"/",secure:!0}}},session:{strategy:a?"database":"jwt",maxAge:2592e3},useSecureCookies:!0,callbacks:{async signIn({user:a,account:b}){if(b&&["google","azure-ad","twitter","facebook"].includes(b.provider))try{let c=a.id,d=(a=>{if(!a)return a;let b=a.split("@");if(2!==b.length)return a.toLowerCase();let c=b[0],d=b[1].toLowerCase();return d.endsWith("gmail.com")||d.endsWith("googlemail.com")?(c.split("+")[0].replace(/\./g,"")+"@"+d).toLowerCase():d.endsWith("outlook.com")||d.endsWith("hotmail.com")||d.endsWith("live.com")||d.endsWith("microsoft.com")?(c.split("+")[0]+"@"+d).toLowerCase():a.toLowerCase()})(a.email||""),e=await i.Ay.query("SELECT user_id FROM accounts WHERE provider = $1 AND provider_account_id = $2 LIMIT 1",[b.provider,b.providerAccountId]),f=e?.rows&&e.rows.length?e.rows[0]:null,g=null;if(f&&f.user_id){let a=await i.Ay.query("SELECT id, organization_id FROM users WHERE id = $1 LIMIT 1",[f.user_id]);g=a?.rows&&a.rows.length?a.rows[0]:null}if(!g){let b=await i.Ay.query("SELECT id, organization_id FROM users WHERE normalized_email = $1 OR email = $2 LIMIT 1",[d,a.email]);g=b?.rows&&b.rows.length?b.rows[0]:null}if(g){let c=`${b.provider}:${b.providerAccountId}`,d=await i.Ay.query("SELECT id FROM accounts WHERE provider = $1 AND provider_account_id = $2 LIMIT 1",[b.provider,b.providerAccountId]);if(!(d?.rows&&d.rows.length?d.rows[0]:null))try{await i.Ay.query("INSERT INTO accounts (id, user_id, type, provider, provider_account_id) VALUES ($1,$2,$3,$4,$5)",[c,g.id,b.type||"oauth",b.provider,b.providerAccountId])}catch(a){k.v.warn("[Auth] Could not create accounts link",{error:a})}k.v.info("[Auth] Linked OAuth login to existing user",{email:a.email,userId:g.id})}else{let b=await i.Ay.query("INSERT INTO organizations (name, plan, created_at) VALUES ($1,$2,$3) RETURNING id",[`${a.email?.split("@")[0]??"user"}'s Organization`,"professional",new Date().toISOString()]),e=b?.rows&&b.rows.length?b.rows[0].id:null;if(!e)throw Error("Failed to create organization");await i.Ay.query("INSERT INTO users (id, email, normalized_email, organization_id, role, is_admin, created_at) VALUES ($1,$2,$3,$4,$5,$6,$7)",[c,a.email,d,e,"owner",!0,new Date().toISOString()]),await i.Ay.query("INSERT INTO org_members (organization_id, user_id, role) VALUES ($1,$2,$3)",[e,c,"owner"]),k.v.info("[Auth] Created new user/org for OAuth login",{email:a.email,userId:c,orgId:e})}}catch(a){k.v.error("[Auth] User/org setup failed on OAuth login",a)}return!0},jwt:async({token:a,user:b})=>(b&&(a.id=b.id),a),session:async({session:a,token:b})=>(a?.user&&b?.id&&(a.user.id=b.id),a)}}}let o=null;function p(){if(o)return o;try{return o=n()}catch(b){k.v.error("[auth] Failed to initialize auth options",b);let a={providers:[],secret:process.env.NEXTAUTH_SECRET||"auth-secret-fallback",session:{strategy:"jwt",maxAge:2592e3},cookies:{sessionToken:{name:"next-auth.session-token",options:{httpOnly:!0,sameSite:"lax",path:"/",secure:!0}},callbackUrl:{name:"next-auth.callback-url",options:{httpOnly:!0,sameSite:"lax",path:"/",secure:!0}},csrfToken:{name:"next-auth.csrf-token",options:{httpOnly:!0,sameSite:"lax",path:"/",secure:!0}}},useSecureCookies:!0,callbacks:{jwt:async({token:a,user:b})=>(b&&(a.id=b.id),a),session:async({session:a,token:b})=>(a?.user&&b?.id&&(a.user.id=b.id),a)}};return o=a,a}}let q=new Proxy({},{get:(a,b,c)=>Reflect.get(p(),b,c),has:(a,b)=>Reflect.has(p(),b),ownKeys:a=>Reflect.ownKeys(p()),getOwnPropertyDescriptor:(a,b)=>Reflect.getOwnPropertyDescriptor(p(),b),getPrototypeOf:a=>Reflect.getPrototypeOf(p())})}};