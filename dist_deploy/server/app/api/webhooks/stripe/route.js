"use strict";(()=>{var a={};a.id=4024,a.ids=[4024],a.modules={261:a=>{a.exports=require("next/dist/shared/lib/router/utils/app-paths")},3295:a=>{a.exports=require("next/dist/server/app-render/after-task-async-storage.external.js")},8086:a=>{a.exports=require("module")},10846:a=>{a.exports=require("next/dist/compiled/next-server/app-page.runtime.prod.js")},15456:(a,b,c)=>{c.d(b,{Eb:()=>i,Tf:()=>h,YO:()=>j});var d=c(60387),e=c(30477);let f={maxAttempts:5,windowMs:9e5,blockMs:9e5};async function g(a,b=f){let c=Date.now(),h=c-b.windowMs;try{let{rows:e}=await (0,d.P)(`SELECT attempted_at, succeeded FROM login_attempts 
       WHERE username = $1 AND attempted_at >= $2 
       ORDER BY attempted_at DESC`,[a,new Date(h).toISOString()]);if(e){let a,d=e.filter(a=>!a.succeeded),f=d.length,g=d[0];if(g&&f>=b.maxAttempts&&(a=new Date(g.attempted_at).getTime()+b.blockMs)>c)return{allowed:!1,remaining:0,resetAt:a,blockedUntil:a};let h=Math.max(0,b.maxAttempts-f);return{allowed:h>0,remaining:h,resetAt:c+b.windowMs,blockedUntil:a}}}catch(a){e.v.warn("rateLimit: DB query failed, using in-memory fallback",{error:a.message})}global.__rateLimiter||(global.__rateLimiter=new Map);let i=global.__rateLimiter,j=i.get(a)||{attempts:[],blockedUntil:0};if(j.attempts=j.attempts.filter(a=>a>h),j.blockedUntil&&j.blockedUntil>c)return{allowed:!1,remaining:0,resetAt:j.blockedUntil,blockedUntil:j.blockedUntil};let k=j.attempts.length;return k>=b.maxAttempts?(j.blockedUntil=c+b.blockMs,i.set(a,j),{allowed:!1,remaining:0,resetAt:j.blockedUntil,blockedUntil:j.blockedUntil}):{allowed:!0,remaining:b.maxAttempts-k,resetAt:c+b.windowMs}}function h(a){let b=a.headers.get("x-forwarded-for");if(b)return b.split(",")[0].trim();let c=a.headers.get("x-real-ip");return c||"unknown"}async function i(a,b=100,c=6e4){let d=await g(a,{maxAttempts:b,windowMs:c,blockMs:c}),e=d.resetAt-Date.now();return{allowed:d.allowed,remaining:d.remaining,resetIn:Math.max(0,e)}}function j(a,b){return async c=>{let d=b?.identifier?b.identifier(c):h(c),e=b?.config||f,i=await g(d,e);if(!i.allowed)return new Response(JSON.stringify({success:!1,error:{code:"RATE_LIMIT_EXCEEDED",message:"Too many requests. Please try again later.",severity:"MEDIUM"}}),{status:429,headers:{"Content-Type":"application/json","X-RateLimit-Limit":String(e.maxAttempts),"X-RateLimit-Remaining":String(i.remaining),"X-RateLimit-Reset":String(Math.ceil(i.resetAt/1e3)),...i.blockedUntil?{"Retry-After":String(Math.ceil((i.blockedUntil-Date.now())/1e3))}:{}}});let j=await a(c);return j.headers.set("X-RateLimit-Limit",String(e.maxAttempts)),j.headers.set("X-RateLimit-Remaining",String(i.remaining)),j.headers.set("X-RateLimit-Reset",String(Math.ceil(i.resetAt/1e3))),j}}},19063:a=>{a.exports=require("require-in-the-middle")},19121:a=>{a.exports=require("next/dist/server/app-render/action-async-storage.external.js")},19771:a=>{a.exports=require("process")},21820:a=>{a.exports=require("os")},27910:a=>{a.exports=require("stream")},28354:a=>{a.exports=require("util")},29021:a=>{a.exports=require("fs")},29294:a=>{a.exports=require("next/dist/server/app-render/work-async-storage.external.js")},31027:(a,b,c)=>{c.r(b),c.d(b,{handler:()=>R,patchFetch:()=>Q,routeModule:()=>M,serverHooks:()=>P,workAsyncStorage:()=>N,workUnitAsyncStorage:()=>O});var d={};c.r(d),c.d(d,{POST:()=>L,dynamic:()=>B,runtime:()=>C});var e=c(95736),f=c(9117),g=c(4044),h=c(39326),i=c(32324),j=c(261),k=c(54290),l=c(85328),m=c(38928),n=c(46595),o=c(3421),p=c(17679),q=c(41681),r=c(63446),s=c(86439),t=c(51356),u=c(10641),v=c(94498),w=c(60387),x=c(30477),y=c(36238),z=c(15456),A=c(56042);let B="force-dynamic",C="nodejs",D=process.env.STRIPE_WEBHOOK_SECRET;async function E(a){let b,c=await a.text(),d=a.headers.get("stripe-signature");try{b=v._4.webhooks.constructEvent(c,d,D)}catch(a){return x.v.error("Stripe webhook signature verification failed",a),y.wT.badRequest("Invalid signature")}try{x.v.info("Stripe webhook received",{type:b.type,id:b.id});let a=await (0,w.P)("SELECT id, processed FROM stripe_events WHERE stripe_event_id = $1 LIMIT 1",[b.id]);if(a.rows.length>0&&a.rows[0].processed)return x.v.info("Stripe webhook already processed",{eventId:b.id}),u.NextResponse.json({received:!0,status:"already_processed"});switch(await (0,w.P)(`INSERT INTO stripe_events (stripe_event_id, event_type, data, processed) 
       VALUES ($1, $2, $3, false)
       ON CONFLICT (stripe_event_id) DO UPDATE SET data = EXCLUDED.data`,[b.id,b.type,JSON.stringify(b.data)]),b.type){case"checkout.session.completed":await F(b.data.object);break;case"customer.subscription.created":case"customer.subscription.updated":await G(b.data.object);break;case"customer.subscription.deleted":await H(b.data.object);break;case"invoice.paid":await I(b.data.object);break;case"invoice.payment_failed":await J(b.data.object);break;case"payment_method.attached":await K(b.data.object);break;default:x.v.info("Stripe webhook event not handled",{type:b.type})}return await (0,w.P)("UPDATE stripe_events SET processed = true, processed_at = NOW() WHERE stripe_event_id = $1",[b.id]),u.NextResponse.json({received:!0})}catch(a){return x.v.error("Stripe webhook processing failed",a,{eventType:b.type,eventId:b.id}),await (0,w.P)("UPDATE stripe_events SET processed = false, error_message = $1, processed_at = NOW() WHERE stripe_event_id = $2",[a.message,b.id]),y.wT.internal("Webhook processing failed")}}async function F(a){let b=a.metadata?.organization_id;if(!b||"subscription"!==a.mode||!a.subscription)return;let c=await v._4.subscriptions.retrieve(a.subscription);await G(c),await (0,A.CS)("organizations",b,"subscription_checkout_completed",{session_id:a.id,subscription_id:c.id})}async function G(a){var b;let c=a.metadata?.organization_id;if(!c)return;let d=a.items.data[0]?.price.id||"",e=(b=d).includes("pro")?"pro":b.includes("business")?"business":b.includes("enterprise")?"enterprise":"free",f={organization_id:c,stripe_customer_id:a.customer,stripe_subscription_id:a.id,stripe_price_id:d,plan:e,status:a.status,current_period_start:new Date(1e3*a.current_period_start).toISOString(),current_period_end:new Date(1e3*a.current_period_end).toISOString(),cancel_at_period_end:a.cancel_at_period_end,canceled_at:a.canceled_at?new Date(1e3*a.canceled_at).toISOString():null,amount_cents:a.items.data[0]?.price.unit_amount||0,currency:a.currency,interval:a.items.data[0]?.price.recurring?.interval||"month",trial_start:a.trial_start?new Date(1e3*a.trial_start).toISOString():null,trial_end:a.trial_end?new Date(1e3*a.trial_end).toISOString():null},g=Object.keys(f),h=Object.values(f),i=h.map((a,b)=>`$${b+1}`),j=g.map((a,b)=>`${a} = EXCLUDED.${a}`).join(", ");await (0,w.P)(`INSERT INTO stripe_subscriptions (${g.join(",")}) VALUES (${i.join(",")})
     ON CONFLICT (stripe_subscription_id) DO UPDATE SET ${j}`,h),await (0,A.CS)("organizations",c,"subscription_updated",{subscription_id:a.id,status:a.status,plan:e})}async function H(a){let b=a.metadata?.organization_id;b&&(await (0,w.P)("UPDATE stripe_subscriptions SET status = 'canceled', canceled_at = NOW() WHERE stripe_subscription_id = $1",[a.id]),await (0,A.CS)("organizations",b,"subscription_deleted",{subscription_id:a.id}))}async function I(a){let b=a.subscription_details?.metadata?.organization_id||a.metadata?.organization_id;if(!b)return;let c={organization_id:b,stripe_invoice_id:a.id,stripe_customer_id:a.customer,stripe_subscription_id:a.subscription,status:a.status||"paid",amount_due_cents:a.amount_due,amount_paid_cents:a.amount_paid,currency:a.currency,invoice_date:new Date(1e3*a.created).toISOString(),due_date:a.due_date?new Date(1e3*a.due_date).toISOString():null,paid_at:new Date().toISOString(),invoice_pdf_url:a.invoice_pdf||null,hosted_invoice_url:a.hosted_invoice_url||null},d=Object.keys(c),e=Object.values(c),f=e.map((a,b)=>`$${b+1}`),g=d.map((a,b)=>`${a} = EXCLUDED.${a}`).join(", ");await (0,w.P)(`INSERT INTO stripe_invoices (${d.join(",")}) VALUES (${f.join(",")})
     ON CONFLICT (stripe_invoice_id) DO UPDATE SET ${g}`,e),await (0,A.CS)("organizations",b,"invoice_paid",{invoice_id:a.id,amount_cents:a.amount_paid})}async function J(a){let b=a.subscription_details?.metadata?.organization_id||a.metadata?.organization_id;if(!b)return;let c={organization_id:b,stripe_invoice_id:a.id,stripe_customer_id:a.customer,stripe_subscription_id:a.subscription,status:"uncollectible",amount_due_cents:a.amount_due,amount_paid_cents:a.amount_paid,currency:a.currency,invoice_date:new Date(1e3*a.created).toISOString(),due_date:a.due_date?new Date(1e3*a.due_date).toISOString():null,paid_at:null,invoice_pdf_url:a.invoice_pdf||null,hosted_invoice_url:a.hosted_invoice_url||null},d=Object.keys(c),e=Object.values(c),f=e.map((a,b)=>`$${b+1}`),g=d.map((a,b)=>`${a} = EXCLUDED.${a}`).join(", ");await (0,w.P)(`INSERT INTO stripe_invoices (${d.join(",")}) VALUES (${f.join(",")})
     ON CONFLICT (stripe_invoice_id) DO UPDATE SET ${g}`,e),await (0,A.um)("organizations",b,{message:"Invoice payment failed",invoice_id:a.id,amount_due_cents:a.amount_due})}async function K(a){if(!a.customer)return;let b=await v._4.customers.retrieve(a.customer),c=b.metadata?.organization_id;if(!c)return;let d={organization_id:c,stripe_customer_id:a.customer,stripe_payment_method_id:a.id,type:a.type,is_default:!1};"card"===a.type&&a.card?(d.card_brand=a.card.brand,d.card_last4=a.card.last4,d.card_exp_month=a.card.exp_month,d.card_exp_year=a.card.exp_year):"us_bank_account"===a.type&&a.us_bank_account&&(d.bank_name=a.us_bank_account.bank_name,d.bank_last4=a.us_bank_account.last4);let e=Object.keys(d),f=Object.values(d),g=f.map((a,b)=>`$${b+1}`),h=e.map((a,b)=>`${a} = EXCLUDED.${a}`).join(", ");await (0,w.P)(`INSERT INTO stripe_payment_methods (${e.join(",")}) VALUES (${g.join(",")})
     ON CONFLICT (stripe_payment_method_id) DO UPDATE SET ${h}`,f),await (0,A.CS)("organizations",c,"payment_method_added",{payment_method_id:a.id})}let L=(0,z.YO)(E,{identifier:a=>`webhook-stripe-${(0,z.Tf)(a)}`,config:{maxAttempts:1e3,windowMs:6e4,blockMs:3e5}}),M=new e.AppRouteRouteModule({definition:{kind:f.RouteKind.APP_ROUTE,page:"/api/webhooks/stripe/route",pathname:"/api/webhooks/stripe",filename:"route",bundlePath:"app/api/webhooks/stripe/route"},distDir:".next",relativeProjectDir:"",resolvedPagePath:"C:\\Users\\Ultimate Warrior\\My project\\gemini-project\\app\\api\\webhooks\\stripe\\route.ts",nextConfigOutput:"",userland:d}),{workAsyncStorage:N,workUnitAsyncStorage:O,serverHooks:P}=M;function Q(){return(0,g.patchFetch)({workAsyncStorage:N,workUnitAsyncStorage:O})}async function R(a,b,c){var d;let e="/api/webhooks/stripe/route";"/index"===e&&(e="/");let g=await M.prepare(a,b,{srcPage:e,multiZoneDraftMode:!1});if(!g)return b.statusCode=400,b.end("Bad Request"),null==c.waitUntil||c.waitUntil.call(c,Promise.resolve()),null;let{buildId:u,params:v,nextConfig:w,isDraftMode:x,prerenderManifest:y,routerServerContext:z,isOnDemandRevalidate:A,revalidateOnlyGenerated:B,resolvedPathname:C}=g,D=(0,j.normalizeAppPath)(e),E=!!(y.dynamicRoutes[D]||y.routes[C]);if(E&&!x){let a=!!y.routes[C],b=y.dynamicRoutes[D];if(b&&!1===b.fallback&&!a)throw new s.NoFallbackError}let F=null;!E||M.isDev||x||(F="/index"===(F=C)?"/":F);let G=!0===M.isDev||!E,H=E&&!G,I=a.method||"GET",J=(0,i.getTracer)(),K=J.getActiveScopeSpan(),L={params:v,prerenderManifest:y,renderOpts:{experimental:{cacheComponents:!!w.experimental.cacheComponents,authInterrupts:!!w.experimental.authInterrupts},supportsDynamicResponse:G,incrementalCache:(0,h.getRequestMeta)(a,"incrementalCache"),cacheLifeProfiles:null==(d=w.experimental)?void 0:d.cacheLife,isRevalidate:H,waitUntil:c.waitUntil,onClose:a=>{b.on("close",a)},onAfterTaskError:void 0,onInstrumentationRequestError:(b,c,d)=>M.onRequestError(a,b,d,z)},sharedContext:{buildId:u}},N=new k.NodeNextRequest(a),O=new k.NodeNextResponse(b),P=l.NextRequestAdapter.fromNodeNextRequest(N,(0,l.signalFromNodeResponse)(b));try{let d=async c=>M.handle(P,L).finally(()=>{if(!c)return;c.setAttributes({"http.status_code":b.statusCode,"next.rsc":!1});let d=J.getRootSpanAttributes();if(!d)return;if(d.get("next.span_type")!==m.BaseServerSpan.handleRequest)return void console.warn(`Unexpected root span type '${d.get("next.span_type")}'. Please report this Next.js issue https://github.com/vercel/next.js`);let e=d.get("next.route");if(e){let a=`${I} ${e}`;c.setAttributes({"next.route":e,"http.route":e,"next.span_name":a}),c.updateName(a)}else c.updateName(`${I} ${a.url}`)}),g=async g=>{var i,j;let k=async({previousCacheEntry:f})=>{try{if(!(0,h.getRequestMeta)(a,"minimalMode")&&A&&B&&!f)return b.statusCode=404,b.setHeader("x-nextjs-cache","REVALIDATED"),b.end("This page could not be found"),null;let e=await d(g);a.fetchMetrics=L.renderOpts.fetchMetrics;let i=L.renderOpts.pendingWaitUntil;i&&c.waitUntil&&(c.waitUntil(i),i=void 0);let j=L.renderOpts.collectedTags;if(!E)return await (0,o.I)(N,O,e,L.renderOpts.pendingWaitUntil),null;{let a=await e.blob(),b=(0,p.toNodeOutgoingHttpHeaders)(e.headers);j&&(b[r.NEXT_CACHE_TAGS_HEADER]=j),!b["content-type"]&&a.type&&(b["content-type"]=a.type);let c=void 0!==L.renderOpts.collectedRevalidate&&!(L.renderOpts.collectedRevalidate>=r.INFINITE_CACHE)&&L.renderOpts.collectedRevalidate,d=void 0===L.renderOpts.collectedExpire||L.renderOpts.collectedExpire>=r.INFINITE_CACHE?void 0:L.renderOpts.collectedExpire;return{value:{kind:t.CachedRouteKind.APP_ROUTE,status:e.status,body:Buffer.from(await a.arrayBuffer()),headers:b},cacheControl:{revalidate:c,expire:d}}}}catch(b){throw(null==f?void 0:f.isStale)&&await M.onRequestError(a,b,{routerKind:"App Router",routePath:e,routeType:"route",revalidateReason:(0,n.c)({isRevalidate:H,isOnDemandRevalidate:A})},z),b}},l=await M.handleResponse({req:a,nextConfig:w,cacheKey:F,routeKind:f.RouteKind.APP_ROUTE,isFallback:!1,prerenderManifest:y,isRoutePPREnabled:!1,isOnDemandRevalidate:A,revalidateOnlyGenerated:B,responseGenerator:k,waitUntil:c.waitUntil});if(!E)return null;if((null==l||null==(i=l.value)?void 0:i.kind)!==t.CachedRouteKind.APP_ROUTE)throw Object.defineProperty(Error(`Invariant: app-route received invalid cache entry ${null==l||null==(j=l.value)?void 0:j.kind}`),"__NEXT_ERROR_CODE",{value:"E701",enumerable:!1,configurable:!0});(0,h.getRequestMeta)(a,"minimalMode")||b.setHeader("x-nextjs-cache",A?"REVALIDATED":l.isMiss?"MISS":l.isStale?"STALE":"HIT"),x&&b.setHeader("Cache-Control","private, no-cache, no-store, max-age=0, must-revalidate");let m=(0,p.fromNodeOutgoingHttpHeaders)(l.value.headers);return(0,h.getRequestMeta)(a,"minimalMode")&&E||m.delete(r.NEXT_CACHE_TAGS_HEADER),!l.cacheControl||b.getHeader("Cache-Control")||m.get("Cache-Control")||m.set("Cache-Control",(0,q.getCacheControlHeader)(l.cacheControl)),await (0,o.I)(N,O,new Response(l.value.body,{headers:m,status:l.value.status||200})),null};K?await g(K):await J.withPropagatedContext(a.headers,()=>J.trace(m.BaseServerSpan.handleRequest,{spanName:`${I} ${a.url}`,kind:i.SpanKind.SERVER,attributes:{"http.method":I,"http.target":a.url}},g))}catch(b){if(b instanceof s.NoFallbackError||await M.onRequestError(a,b,{routerKind:"App Router",routePath:D,routeType:"route",revalidateReason:(0,n.c)({isRevalidate:H,isOnDemandRevalidate:A})}),E)throw b;return await (0,o.I)(N,O,new Response(null,{status:500})),null}}},31421:a=>{a.exports=require("node:child_process")},33873:a=>{a.exports=require("path")},34631:a=>{a.exports=require("tls")},36686:a=>{a.exports=require("diagnostics_channel")},37067:a=>{a.exports=require("node:http")},38522:a=>{a.exports=require("node:zlib")},41692:a=>{a.exports=require("node:tls")},44708:a=>{a.exports=require("node:https")},44870:a=>{a.exports=require("next/dist/compiled/next-server/app-route.runtime.prod.js")},48161:a=>{a.exports=require("node:os")},53053:a=>{a.exports=require("node:diagnostics_channel")},55511:a=>{a.exports=require("crypto")},55591:a=>{a.exports=require("https")},56801:a=>{a.exports=require("import-in-the-middle")},57075:a=>{a.exports=require("node:stream")},57975:a=>{a.exports=require("node:util")},63033:a=>{a.exports=require("next/dist/server/app-render/work-unit-async-storage.external.js")},73024:a=>{a.exports=require("node:fs")},73566:a=>{a.exports=require("worker_threads")},74075:a=>{a.exports=require("zlib")},75919:a=>{a.exports=require("node:worker_threads")},76760:a=>{a.exports=require("node:path")},77030:a=>{a.exports=require("node:net")},78474:a=>{a.exports=require("node:events")},79428:a=>{a.exports=require("buffer")},79551:a=>{a.exports=require("url")},79646:a=>{a.exports=require("child_process")},80481:a=>{a.exports=require("node:readline")},81630:a=>{a.exports=require("http")},83997:a=>{a.exports=require("tty")},84297:a=>{a.exports=require("async_hooks")},86439:a=>{a.exports=require("next/dist/shared/lib/no-fallback-error.external")},86592:a=>{a.exports=require("node:inspector")},91645:a=>{a.exports=require("net")},94735:a=>{a.exports=require("events")},98995:a=>{a.exports=require("node:module")}};var b=require("../../../../webpack-runtime.js");b.C(a);var c=b.X(0,[4996,1692,4680,1214,798],()=>b(b.s=31027));module.exports=c})();