(()=>{var a={};a.id=8358,a.ids=[6625,7591,8358],a.modules={261:a=>{"use strict";a.exports=require("next/dist/shared/lib/router/utils/app-paths")},3295:a=>{"use strict";a.exports=require("next/dist/server/app-render/after-task-async-storage.external.js")},8086:a=>{"use strict";a.exports=require("module")},8887:(a,b,c)=>{"use strict";c.r(b),c.d(b,{handler:()=>K,patchFetch:()=>J,routeModule:()=>F,serverHooks:()=>I,workAsyncStorage:()=>G,workUnitAsyncStorage:()=>H});var d={};c.r(d),c.d(d,{GET:()=>E,POST:()=>D,dynamic:()=>B,runtime:()=>C});var e=c(95736),f=c(9117),g=c(4044),h=c(39326),i=c(32324),j=c(261),k=c(54290),l=c(85328),m=c(38928),n=c(46595),o=c(3421),p=c(17679),q=c(41681),r=c(63446),s=c(86439),t=c(51356),u=c(10641),v=c(32524),w=c(60387),x=c(99505),y=c(36238),z=c(30477),A=c(26625);let B="force-dynamic",C="nodejs";async function D(a,{params:b}){try{let{id:c}=await b;if(!c||!/^[0-9a-f]{8}-[0-9a-f]{4}-[0-9a-f]{4}-[0-9a-f]{4}-[0-9a-f]{12}$/i.test(c))return y.wT.badRequest("Invalid call ID");let d=await (0,x.c)("operator"),e=d.user.id,f=d.user.organizationId,{toLanguage:g,fromLanguage:h,useVoiceCloning:i}=await a.json();if(!g)return y.wT.badRequest("toLanguage is required");if(!/^[a-z]{2}(-[A-Z]{2})?$/.test(g))return y.wT.badRequest('Invalid toLanguage format. Use ISO codes like "es", "fr", "de", "zh"');let{rows:j}=await (0,w.P)("SELECT id, organization_id, status FROM calls WHERE id = $1 AND organization_id = $2",[c,f]);if(0===j.length)return y.wT.notFound("Call not found");let k=null,l=null,m=null,{rows:n}=await (0,w.P)("SELECT id, transcript_json, recording_url FROM recordings WHERE call_id = $1 LIMIT 1",[c]);if(n.length>0&&n[0].transcript_json){let a=n[0].transcript_json;k=a.text||null,l=a.language_code||null,m=n[0].recording_url}if(!k){let{rows:a}=await (0,w.P)(`SELECT id, output FROM ai_runs 
         WHERE call_id = $1 AND model IN ('assemblyai-v1', 'assemblyai-upload') AND status = 'completed'
         ORDER BY completed_at DESC LIMIT 1`,[c]);if(a.length>0){let b=a[0].output;k=b?.transcript?.text||null,l=b?.transcript?.language_code||null}}if(!k)return y.wT.badRequest("No transcript available for this call. Transcription must complete first.");let o=h||l||"en";if(o===g)return y.wT.badRequest("Source and target languages are the same");if(!process.env.OPENAI_API_KEY)return y.wT.serviceUnavailable("Translation service not configured");let{rows:p}=await (0,w.P)(`SELECT id, status, output FROM ai_runs 
       WHERE call_id = $1 AND model = 'assemblyai-translation' LIMIT 10`,[c]),q=p?.find(a=>{let b=a.output;return b?.to_language===g&&"completed"===a.status});if(q)return u.NextResponse.json({success:!0,message:"Translation already exists for this language",translation_id:q.id,status:"completed"});let{rows:r}=await (0,w.P)("SELECT id FROM systems WHERE key = 'system-ai' LIMIT 1",[]),s=r[0]?.id,t=(0,v.A)();try{await (0,w.P)(`INSERT INTO audit_logs (id, organization_id, user_id, system_id, resource_type, resource_id, action, before, after, created_at)
         VALUES ($1, $2, $3, $4, $5, $6, $7, $8, $9, NOW())`,[(0,v.A)(),f,e,s||null,"ai_runs",t,"intent:translation_requested",null,{call_id:c,from_language:o,to_language:g,provider:"openai",triggered_by:"manual",declared_at:new Date().toISOString()}])}catch(a){}try{await (0,w.P)(`INSERT INTO ai_runs (id, call_id, system_id, model, status, started_at, output)
             VALUES ($1, $2, $3, $4, $5, NOW(), $6)`,[t,c,s||null,"assemblyai-translation","queued",{from_language:o,to_language:g,source_text:k,detected_language:l,triggered_by:"manual"}])}catch(a){return z.v.error("Failed to create translation ai_run",a,{callId:c,translationRunId:t}),y.wT.internal("Failed to create translation job")}return(0,A.translateText)({callId:c,translationRunId:t,text:k,fromLanguage:o,toLanguage:g,organizationId:f,recordingUrl:m||void 0,useVoiceCloning:i||!1}).catch(a=>{z.v.error("Translation failed",a,{callId:c,translationRunId:t})}),z.v.info("Manual translation triggered",{callId:c,translationRunId:t,fromLanguage:o,toLanguage:g}),u.NextResponse.json({success:!0,translation_id:t,status:"queued",from_language:o,to_language:g,message:"Translation started. Poll /api/ai-runs/{id}/status for completion."})}catch(a){return z.v.error("Translation trigger error",a),y.wT.internal(a.message||"Failed to trigger translation")}}async function E(a,{params:b}){try{let{id:a}=await b;if(!a||!/^[0-9a-f]{8}-[0-9a-f]{4}-[0-9a-f]{4}-[0-9a-f]{4}-[0-9a-f]{12}$/i.test(a))return y.wT.badRequest("Invalid call ID");let c=(await (0,x.c)("viewer")).user.organizationId,{rows:d}=await (0,w.P)("SELECT id FROM calls WHERE id = $1 AND organization_id = $2",[a,c]);if(0===d.length)return y.wT.notFound("Call not found");let{rows:e}=await (0,w.P)(`SELECT id, status, started_at, completed_at, output 
       FROM ai_runs 
       WHERE call_id = $1 AND model = 'assemblyai-translation' 
       ORDER BY started_at DESC`,[a]),f=e.map(a=>{let b=a.output;return{id:a.id,status:a.status,from_language:b?.from_language,to_language:b?.to_language,translated_text:b?.translated_text,audio_url:b?.translated_audio_url,voice_cloning_used:b?.voice_cloning_used||!1,started_at:a.started_at,completed_at:a.completed_at,error:b?.error}});return u.NextResponse.json({success:!0,call_id:a,translations:f})}catch(a){return z.v.error("Get translations error",a),y.wT.internal(a.message||"Failed to fetch translations")}}let F=new e.AppRouteRouteModule({definition:{kind:f.RouteKind.APP_ROUTE,page:"/api/calls/[id]/translate/route",pathname:"/api/calls/[id]/translate",filename:"route",bundlePath:"app/api/calls/[id]/translate/route"},distDir:".next",relativeProjectDir:"",resolvedPagePath:"C:\\Users\\Ultimate Warrior\\My project\\gemini-project\\app\\api\\calls\\[id]\\translate\\route.ts",nextConfigOutput:"",userland:d}),{workAsyncStorage:G,workUnitAsyncStorage:H,serverHooks:I}=F;function J(){return(0,g.patchFetch)({workAsyncStorage:G,workUnitAsyncStorage:H})}async function K(a,b,c){var d;let e="/api/calls/[id]/translate/route";"/index"===e&&(e="/");let g=await F.prepare(a,b,{srcPage:e,multiZoneDraftMode:!1});if(!g)return b.statusCode=400,b.end("Bad Request"),null==c.waitUntil||c.waitUntil.call(c,Promise.resolve()),null;let{buildId:u,params:v,nextConfig:w,isDraftMode:x,prerenderManifest:y,routerServerContext:z,isOnDemandRevalidate:A,revalidateOnlyGenerated:B,resolvedPathname:C}=g,D=(0,j.normalizeAppPath)(e),E=!!(y.dynamicRoutes[D]||y.routes[C]);if(E&&!x){let a=!!y.routes[C],b=y.dynamicRoutes[D];if(b&&!1===b.fallback&&!a)throw new s.NoFallbackError}let G=null;!E||F.isDev||x||(G="/index"===(G=C)?"/":G);let H=!0===F.isDev||!E,I=E&&!H,J=a.method||"GET",K=(0,i.getTracer)(),L=K.getActiveScopeSpan(),M={params:v,prerenderManifest:y,renderOpts:{experimental:{cacheComponents:!!w.experimental.cacheComponents,authInterrupts:!!w.experimental.authInterrupts},supportsDynamicResponse:H,incrementalCache:(0,h.getRequestMeta)(a,"incrementalCache"),cacheLifeProfiles:null==(d=w.experimental)?void 0:d.cacheLife,isRevalidate:I,waitUntil:c.waitUntil,onClose:a=>{b.on("close",a)},onAfterTaskError:void 0,onInstrumentationRequestError:(b,c,d)=>F.onRequestError(a,b,d,z)},sharedContext:{buildId:u}},N=new k.NodeNextRequest(a),O=new k.NodeNextResponse(b),P=l.NextRequestAdapter.fromNodeNextRequest(N,(0,l.signalFromNodeResponse)(b));try{let d=async c=>F.handle(P,M).finally(()=>{if(!c)return;c.setAttributes({"http.status_code":b.statusCode,"next.rsc":!1});let d=K.getRootSpanAttributes();if(!d)return;if(d.get("next.span_type")!==m.BaseServerSpan.handleRequest)return void console.warn(`Unexpected root span type '${d.get("next.span_type")}'. Please report this Next.js issue https://github.com/vercel/next.js`);let e=d.get("next.route");if(e){let a=`${J} ${e}`;c.setAttributes({"next.route":e,"http.route":e,"next.span_name":a}),c.updateName(a)}else c.updateName(`${J} ${a.url}`)}),g=async g=>{var i,j;let k=async({previousCacheEntry:f})=>{try{if(!(0,h.getRequestMeta)(a,"minimalMode")&&A&&B&&!f)return b.statusCode=404,b.setHeader("x-nextjs-cache","REVALIDATED"),b.end("This page could not be found"),null;let e=await d(g);a.fetchMetrics=M.renderOpts.fetchMetrics;let i=M.renderOpts.pendingWaitUntil;i&&c.waitUntil&&(c.waitUntil(i),i=void 0);let j=M.renderOpts.collectedTags;if(!E)return await (0,o.I)(N,O,e,M.renderOpts.pendingWaitUntil),null;{let a=await e.blob(),b=(0,p.toNodeOutgoingHttpHeaders)(e.headers);j&&(b[r.NEXT_CACHE_TAGS_HEADER]=j),!b["content-type"]&&a.type&&(b["content-type"]=a.type);let c=void 0!==M.renderOpts.collectedRevalidate&&!(M.renderOpts.collectedRevalidate>=r.INFINITE_CACHE)&&M.renderOpts.collectedRevalidate,d=void 0===M.renderOpts.collectedExpire||M.renderOpts.collectedExpire>=r.INFINITE_CACHE?void 0:M.renderOpts.collectedExpire;return{value:{kind:t.CachedRouteKind.APP_ROUTE,status:e.status,body:Buffer.from(await a.arrayBuffer()),headers:b},cacheControl:{revalidate:c,expire:d}}}}catch(b){throw(null==f?void 0:f.isStale)&&await F.onRequestError(a,b,{routerKind:"App Router",routePath:e,routeType:"route",revalidateReason:(0,n.c)({isRevalidate:I,isOnDemandRevalidate:A})},z),b}},l=await F.handleResponse({req:a,nextConfig:w,cacheKey:G,routeKind:f.RouteKind.APP_ROUTE,isFallback:!1,prerenderManifest:y,isRoutePPREnabled:!1,isOnDemandRevalidate:A,revalidateOnlyGenerated:B,responseGenerator:k,waitUntil:c.waitUntil});if(!E)return null;if((null==l||null==(i=l.value)?void 0:i.kind)!==t.CachedRouteKind.APP_ROUTE)throw Object.defineProperty(Error(`Invariant: app-route received invalid cache entry ${null==l||null==(j=l.value)?void 0:j.kind}`),"__NEXT_ERROR_CODE",{value:"E701",enumerable:!1,configurable:!0});(0,h.getRequestMeta)(a,"minimalMode")||b.setHeader("x-nextjs-cache",A?"REVALIDATED":l.isMiss?"MISS":l.isStale?"STALE":"HIT"),x&&b.setHeader("Cache-Control","private, no-cache, no-store, max-age=0, must-revalidate");let m=(0,p.fromNodeOutgoingHttpHeaders)(l.value.headers);return(0,h.getRequestMeta)(a,"minimalMode")&&E||m.delete(r.NEXT_CACHE_TAGS_HEADER),!l.cacheControl||b.getHeader("Cache-Control")||m.get("Cache-Control")||m.set("Cache-Control",(0,q.getCacheControlHeader)(l.cacheControl)),await (0,o.I)(N,O,new Response(l.value.body,{headers:m,status:l.value.status||200})),null};L?await g(L):await K.withPropagatedContext(a.headers,()=>K.trace(m.BaseServerSpan.handleRequest,{spanName:`${J} ${a.url}`,kind:i.SpanKind.SERVER,attributes:{"http.method":J,"http.target":a.url}},g))}catch(b){if(b instanceof s.NoFallbackError||await F.onRequestError(a,b,{routerKind:"App Router",routePath:D,routeType:"route",revalidateReason:(0,n.c)({isRevalidate:I,isOnDemandRevalidate:A})}),E)throw b;return await (0,o.I)(N,O,new Response(null,{status:500})),null}}},10846:a=>{"use strict";a.exports=require("next/dist/compiled/next-server/app-page.runtime.prod.js")},11723:a=>{"use strict";a.exports=require("querystring")},12412:a=>{"use strict";a.exports=require("assert")},14985:a=>{"use strict";a.exports=require("dns")},19063:a=>{"use strict";a.exports=require("require-in-the-middle")},19121:a=>{"use strict";a.exports=require("next/dist/server/app-render/action-async-storage.external.js")},19771:a=>{"use strict";a.exports=require("process")},19891:(a,b,c)=>{"use strict";c.d(b,{En:()=>i,Ip:()=>g,Ry:()=>h});let d=new Map,e=new Map,f={status:"healthy",criticalErrors:0,highErrors:0,lastUpdated:new Date().toISOString()};function g(){return Array.from(d.values())}function h(){return Array.from(e.values())}function i(){return{...f}}},21820:a=>{"use strict";a.exports=require("os")},26625:(a,b,c)=>{"use strict";c.d(b,{translateText:()=>h});var d=c(60387),e=c(50366),f=c(73537),g=c(30477);async function h(a){let{callId:b,translationRunId:c,text:h,fromLanguage:i,toLanguage:j,organizationId:k,recordingUrl:l,useVoiceCloning:m}=a;g.v.info("translation: starting",{callId:b,translationRunId:c,fromLanguage:i,toLanguage:j,textLength:h?.length||0,hasRecordingUrl:!!l,useVoiceCloning:m});try{let{rows:a}=await (0,d.P)("SELECT plan FROM organizations WHERE id = $1",[k]),n=a[0]?.plan?.toLowerCase(),o=["global","enterprise","business","pro","standard","active","free"];if(!o.includes(n||"")){g.v.error("TRANSLATION_FAILED: Plan does not support translation",void 0,{organizationId:k,plan:n,allowedPlans:o.join(", ")}),await (0,d.P)(`UPDATE ai_runs SET
            status = 'failed',
            completed_at = NOW(),
            produced_by = 'model',
            is_authoritative = false,
            output = $1
         WHERE id = $2`,[{error:"Plan does not support translation",plan:n},c]);return}let p=null,q=null;if(process.env.OPENAI_API_KEY)try{let a=new AbortController,d=setTimeout(()=>a.abort(),3e4),e=await fetch("https://api.openai.com/v1/chat/completions",{method:"POST",headers:{Authorization:`Bearer ${process.env.OPENAI_API_KEY}`,"Content-Type":"application/json"},signal:a.signal,body:JSON.stringify({model:"gpt-3.5-turbo",messages:[{role:"system",content:"auto"===i||"auto"===j?"You are a professional translator. First detect the language of the following text. Then translate it to the most appropriate target language. If the text is in English, translate to Spanish. If the text is in Spanish, translate to English. If the text is in another language, translate to English. Only return the translated text, no explanations or language labels.":`You are a professional translator. Translate the following text from ${i} to ${j}. Only return the translated text, no explanations.`},{role:"user",content:h}],temperature:.3,max_tokens:2e3})});if(clearTimeout(d),e.ok){let a=await e.json();(p=a.choices?.[0]?.message?.content?.trim()||null)&&g.v.info("translation: OpenAI translation successful",{translationRunId:c,callId:b})}else{let a=await e.text();q=`OpenAI API error: ${e.status} - ${a}`}}catch(a){q=a?.name==="AbortError"?"OpenAI translation timed out (30s)":`OpenAI translation failed: ${a?.message||"Unknown error"}`}else q="OPENAI_API_KEY not configured - translation requires OpenAI",g.v.error("TRANSLATION_FAILED: OPENAI_API_KEY not set",void 0,{translationRunId:c,callId:b,resolution:"Set OPENAI_API_KEY environment variable"});if(p){let a=null,k=null,n=!1;if(process.env.ELEVENLABS_API_KEY)try{let d;if(g.v.debug("translation: generating audio with ElevenLabs",{translationRunId:c,chars:p.length,useVoiceCloning:!!m}),m&&l)try{g.v.debug("translation: attempting voice cloning from recording",{translationRunId:c});let a=await fetch(l);if(a.ok){let e=Buffer.from(await a.arrayBuffer());e.length>5e4?(d=k=(await (0,f.E1)(e,`call-${b}-${Date.now()}`,`Cloned voice for translation run ${c}`)).voiceId,n=!0,g.v.info("translation: voice cloned successfully",{translationRunId:c,clonedVoiceId:k})):g.v.warn("translation: recording too short for voice cloning",{translationRunId:c})}else g.v.warn("translation: could not download recording for voice cloning",{translationRunId:c,status:a.status})}catch(a){g.v.error("translation: voice cloning failed, falling back to default voice",a,{translationRunId:c})}let h=(await (0,f._M)(p,j,d)).getReader(),i=[];for(;;){let{done:a,value:b}=await h.read();if(a)break;i.push(b)}let o=Buffer.concat(i),q=`translations/${c}.mp3`;try{await e.Ay.upload("recordings",q,o,"audio/mpeg");try{let b=await e.Ay.createSignedUrl("recordings",q,86400);a=b?.signedUrl||b}catch(c){let b=await e.Ay.getPublicUrl("recordings",q);a=b.publicURL||b.publicUrl}g.v.info("translation: audio generated and uploaded",{translationRunId:c,usedVoiceCloning:n})}catch(a){g.v.error("translation: audio upload failed",a,{translationRunId:c})}if(k)try{await (0,f.Rw)(k),g.v.debug("translation: cleaned up cloned voice",{translationRunId:c,clonedVoiceId:k})}catch(a){g.v.warn("translation: could not delete cloned voice",{clonedVoiceId:k,error:a?.message})}}catch(a){g.v.error("translation: ElevenLabs audio generation failed",a,{translationRunId:c})}await (0,d.P)(`UPDATE ai_runs SET
            status = 'completed',
            completed_at = NOW(),
            produced_by = 'model',
            is_authoritative = false,
            output = $1
         WHERE id = $2`,[{from_language:i,to_language:j,source_text:h,translated_text:p,translated_audio_url:a,provider:"openai",tts_provider:a?"elevenlabs":null,voice_cloning_used:n,completed_at:new Date().toISOString()},c]),g.v.info("translation: completed",{translationRunId:c,callId:b,fromLanguage:i,toLanguage:j,hasAudio:!!a,usedVoiceCloning:n})}else await (0,d.P)(`UPDATE ai_runs SET
            status = 'failed',
            completed_at = NOW(),
            produced_by = 'model',
            is_authoritative = false,
            output = $1
         WHERE id = $2`,[{from_language:i,to_language:j,source_text:h,error:q||"Translation failed",failed_at:new Date().toISOString()},c]),g.v.error("translation: failed",void 0,{translationRunId:c,callId:b,error:q})}catch(a){g.v.error("translation: service error",a,{translationRunId:c,callId:b}),await (0,d.P)(`UPDATE ai_runs SET
            status = 'failed',
            completed_at = NOW(),
            produced_by = 'model',
            is_authoritative = false,
            output = $1
         WHERE id = $2`,[{error:a?.message||"Translation service error",failed_at:new Date().toISOString()},c])}}},27910:a=>{"use strict";a.exports=require("stream")},28354:a=>{"use strict";a.exports=require("util")},29021:a=>{"use strict";a.exports=require("fs")},29294:a=>{"use strict";a.exports=require("next/dist/server/app-render/work-async-storage.external.js")},30477:(a,b,c)=>{"use strict";c.d(b,{v:()=>e});class d{constructor(){this.isDevelopment=!1,this.isTest=!1}shouldLog(a){return!this.isTest&&(!!this.isDevelopment||"warn"===a||"error"===a)}formatMessage(a,b,c){let d=new Date().toISOString(),e=c?` ${JSON.stringify(c)}`:"";return`[${d}] [${a.toUpperCase()}] ${b}${e}`}debug(a,b){this.shouldLog("debug")&&console.log(this.formatMessage("debug",a,b))}info(a,b){this.shouldLog("info")&&console.log(this.formatMessage("info",a,b))}warn(a,b){this.shouldLog("warn")&&console.warn(this.formatMessage("warn",a,b))}error(a,b,c){if(this.shouldLog("error")){let d=b instanceof Error?{name:b.name,message:b.message,stack:b.stack,...c}:{error:b,...c};console.error(this.formatMessage("error",a,d))}}apiRequest(a,b,c){this.info(`API Request: ${a} ${b}`,c)}apiResponse(a,b,c,d){let e={statusCode:c,duration:d};c>=500?this.error(`API Response: ${a} ${b}`,void 0,e):c>=400?this.warn(`API Response: ${a} ${b}`,e):this.info(`API Response: ${a} ${b}`,e)}dbQuery(a,b){this.debug("Database query",{query:a.substring(0,100),params:b})}externalCall(a,b,c){this.info(`External call: ${a}`,{endpoint:b,...c})}}let e=new d},31421:a=>{"use strict";a.exports=require("node:child_process")},32524:(a,b,c)=>{"use strict";c.d(b,{A:()=>i});var d=c(55511);let e={randomUUID:d.randomUUID},f=new Uint8Array(256),g=f.length,h=[];for(let a=0;a<256;++a)h.push((a+256).toString(16).slice(1));let i=function(a,b,c){if(e.randomUUID&&!b&&!a)return e.randomUUID();let i=(a=a||{}).random??a.rng?.()??(g>f.length-16&&((0,d.randomFillSync)(f),g=0),f.slice(g,g+=16));if(i.length<16)throw Error("Random bytes length must be >= 16");if(i[6]=15&i[6]|64,i[8]=63&i[8]|128,b){if((c=c||0)<0||c+16>b.length)throw RangeError(`UUID byte range ${c}:${c+15} is out of buffer bounds`);for(let a=0;a<16;++a)b[c+a]=i[a];return b}return function(a,b=0){return(h[a[b+0]]+h[a[b+1]]+h[a[b+2]]+h[a[b+3]]+"-"+h[a[b+4]]+h[a[b+5]]+"-"+h[a[b+6]]+h[a[b+7]]+"-"+h[a[b+8]]+h[a[b+9]]+"-"+h[a[b+10]]+h[a[b+11]]+h[a[b+12]]+h[a[b+13]]+h[a[b+14]]+h[a[b+15]]).toLowerCase()}(i)}},33873:a=>{"use strict";a.exports=require("path")},34631:a=>{"use strict";a.exports=require("tls")},36238:(a,b,c)=>{"use strict";c.d(b,{wT:()=>g,kU:()=>f});var d=c(10641);function e(a,b,c=500,f="MEDIUM"){let g=`ERR_${new Date().toISOString().slice(0,10).replace(/-/g,"")}_${Math.random().toString(36).substring(2,8).toUpperCase()}`;return d.NextResponse.json({success:!1,error:{id:g,code:a,message:b,severity:f.toLowerCase()}},{status:c})}function f(a,b=200){return d.NextResponse.json({success:!0,...a},{status:b})}c(59175),c(50980),c(19891);let g={unauthorized:()=>e("UNAUTHORIZED","Authentication required",401,"MEDIUM"),forbidden:()=>e("FORBIDDEN","You do not have permission to access this resource",403,"MEDIUM"),notFound:(a="Resource")=>e("NOT_FOUND",`${a} not found`,404,"LOW"),badRequest:(a="Invalid request")=>e("BAD_REQUEST",a,400,"LOW"),internal:(a="An unexpected error occurred")=>e("INTERNAL_ERROR",a,500,"HIGH"),dbError:(a="Database operation failed")=>e("DB_ERROR",a,500,"HIGH"),validationError:a=>e("VALIDATION_ERROR",a,400,"LOW"),serviceUnavailable:a=>e("SERVICE_UNAVAILABLE",`${a} is temporarily unavailable`,503,"HIGH")}},36686:a=>{"use strict";a.exports=require("diagnostics_channel")},37067:a=>{"use strict";a.exports=require("node:http")},38522:a=>{"use strict";a.exports=require("node:zlib")},39727:()=>{},41692:a=>{"use strict";a.exports=require("node:tls")},44708:a=>{"use strict";a.exports=require("node:https")},44870:a=>{"use strict";a.exports=require("next/dist/compiled/next-server/app-route.runtime.prod.js")},47990:()=>{},48161:a=>{"use strict";a.exports=require("node:os")},50980:(a,b,c)=>{"use strict";c.r(b),c.d(b,{ERROR_CATALOG:()=>d,getDefaultError:()=>f,getErrorDefinition:()=>e});let d={AUTH_REQUIRED:{code:"AUTH_REQUIRED",category:"AUTH",severity:"HIGH",internalMessage:"Authentication required",userMessage:"Please sign in to continue",httpStatus:401,shouldAlert:!1,trackKPI:!0},AUTH_ORG_MISMATCH:{code:"AUTH_ORG_MISMATCH",category:"AUTH",severity:"HIGH",internalMessage:"User not authorized for organization",userMessage:"You do not have access to this organization",httpStatus:401,shouldAlert:!1,trackKPI:!0},FORBIDDEN:{code:"FORBIDDEN",category:"AUTH",severity:"HIGH",internalMessage:"Insufficient permissions",userMessage:"You do not have permission to perform this action",httpStatus:403,shouldAlert:!1,trackKPI:!0},DB_QUERY_FAILED:{code:"DB_QUERY_FAILED",category:"DB",severity:"HIGH",internalMessage:"Database query failed",userMessage:"Could not retrieve data. Please try again.",httpStatus:500,shouldAlert:!0,trackKPI:!0},DB_INSERT_FAILED:{code:"DB_INSERT_FAILED",category:"DB",severity:"HIGH",internalMessage:"Database insert failed",userMessage:"Could not save data. Please try again.",httpStatus:500,shouldAlert:!0,trackKPI:!0},DB_UPDATE_FAILED:{code:"DB_UPDATE_FAILED",category:"DB",severity:"HIGH",internalMessage:"Database update failed",userMessage:"Could not update data. Please try again.",httpStatus:500,shouldAlert:!0,trackKPI:!0},CALL_START_FAILED:{code:"CALL_START_FAILED",category:"VOICE",severity:"HIGH",internalMessage:"Failed to start call",userMessage:"Unable to place call. Please try again.",httpStatus:500,shouldAlert:!0,trackKPI:!0},SIGNALWIRE_CONFIG_MISSING:{code:"SIGNALWIRE_CONFIG_MISSING",category:"EXTERNAL",severity:"CRITICAL",internalMessage:"SignalWire credentials missing",userMessage:"System configuration error. Please contact support.",httpStatus:500,shouldAlert:!0,trackKPI:!0},SIGNALWIRE_API_ERROR:{code:"SIGNALWIRE_API_ERROR",category:"EXTERNAL",severity:"HIGH",internalMessage:"SignalWire API error",userMessage:"Call service temporarily unavailable. Please try again.",httpStatus:502,shouldAlert:!0,trackKPI:!0},ASSEMBLYAI_API_ERROR:{code:"ASSEMBLYAI_API_ERROR",category:"AI",severity:"HIGH",internalMessage:"AssemblyAI API error",userMessage:"Transcription service temporarily unavailable.",httpStatus:502,shouldAlert:!0,trackKPI:!0},TRANSCRIPTION_FAILED:{code:"TRANSCRIPTION_FAILED",category:"AI",severity:"MEDIUM",internalMessage:"Transcription processing failed",userMessage:"Transcription could not be completed.",httpStatus:500,shouldAlert:!1,trackKPI:!0},LIVE_TRANSLATE_EXECUTION_FAILED:{code:"LIVE_TRANSLATE_EXECUTION_FAILED",category:"EXTERNAL",severity:"MEDIUM",internalMessage:"Live translation execution failed",userMessage:"Live translation encountered an issue. Post-call transcript is still available.",httpStatus:500,shouldAlert:!1,trackKPI:!0},LIVE_TRANSLATE_VENDOR_DOWN:{code:"LIVE_TRANSLATE_VENDOR_DOWN",category:"EXTERNAL",severity:"HIGH",internalMessage:"Live translation vendor service unavailable",userMessage:"Live translation service is temporarily unavailable. Post-call transcript will be available.",httpStatus:503,shouldAlert:!0,trackKPI:!0},PLAN_LIMIT_EXCEEDED:{code:"PLAN_LIMIT_EXCEEDED",category:"ORG",severity:"MEDIUM",internalMessage:"Plan limit exceeded",userMessage:"This feature is not available on your current plan. Please upgrade.",httpStatus:403,shouldAlert:!1,trackKPI:!0},ORG_NOT_FOUND:{code:"ORG_NOT_FOUND",category:"ORG",severity:"MEDIUM",internalMessage:"Organization not found",userMessage:"Organization not found",httpStatus:404,shouldAlert:!1,trackKPI:!1},SYSTEM_ERROR:{code:"SYSTEM_ERROR",category:"SYSTEM",severity:"CRITICAL",internalMessage:"Unexpected system error",userMessage:"An unexpected error occurred. Please try again.",httpStatus:500,shouldAlert:!0,trackKPI:!0},SERVICE_UNAVAILABLE:{code:"SERVICE_UNAVAILABLE",category:"SYSTEM",severity:"HIGH",internalMessage:"Service temporarily unavailable",userMessage:"Service temporarily unavailable. Please try again later.",httpStatus:503,shouldAlert:!0,trackKPI:!0},INVALID_INPUT:{code:"INVALID_INPUT",category:"USER",severity:"MEDIUM",internalMessage:"Invalid input provided",userMessage:"Invalid input. Please check your request and try again.",httpStatus:400,shouldAlert:!1,trackKPI:!1},INVALID_PHONE:{code:"INVALID_PHONE",category:"USER",severity:"MEDIUM",internalMessage:"Invalid phone number format",userMessage:"The phone number provided is invalid. Please verify and try again.",httpStatus:400,shouldAlert:!1,trackKPI:!1}};function e(a){return d[a]||null}function f(){return d.SYSTEM_ERROR}},51455:a=>{"use strict";a.exports=require("node:fs/promises")},53053:a=>{"use strict";a.exports=require("node:diagnostics_channel")},55511:a=>{"use strict";a.exports=require("crypto")},55591:a=>{"use strict";a.exports=require("https")},56801:a=>{"use strict";a.exports=require("import-in-the-middle")},57075:a=>{"use strict";a.exports=require("node:stream")},57975:a=>{"use strict";a.exports=require("node:util")},59175:(a,b,c)=>{"use strict";c.d(b,{u:()=>d});class d extends Error{constructor(a,b,d,e){if("string"==typeof a){super(a);let c=new Date().toISOString().slice(0,10).replace(/-/g,""),f=Math.random().toString(36).slice(2,8).toUpperCase();this.id=`ERR_${c}_${f}`,this.code=d||"UNKNOWN_ERROR",this.user_message=a,this.severity="MEDIUM",this.retriable=!1,this.details=e,this.httpStatus=b||500}else{if(super(a.message),a.id)this.id=a.id;else{let a=new Date().toISOString().slice(0,10).replace(/-/g,""),b=Math.random().toString(36).slice(2,8).toUpperCase();this.id=`ERR_${a}_${b}`}this.code=a.code,this.user_message=a.user_message,this.severity=a.severity??"MEDIUM",this.retriable=!!a.retriable,this.details=a.details;try{let{getErrorDefinition:a}=c(50980),b=a(this.code);this.httpStatus=b?.httpStatus||500}catch{this.httpStatus=500}}}toJSON(){return{id:this.id,code:this.code,message:this.message,user_message:this.user_message,severity:this.severity,httpStatus:this.httpStatus}}}},60387:(a,b,c)=>{"use strict";c.d(b,{Ay:()=>h,P:()=>f,d_:()=>e,ro:()=>g});var d=c(9608);if("undefined"==typeof WebSocket)try{let a=c(45361);d.Vz.webSocketConstructor=a}catch(a){}let e=()=>{let a=(()=>{try{let a=globalThis.HYPERDRIVE||globalThis.env?.HYPERDRIVE||globalThis.__env__?.HYPERDRIVE||globalThis.CF_BINDINGS?.HYPERDRIVE;if(a?.connectionString)return console.log("Using Hyperdrive connection"),a.connectionString}catch(a){console.warn("Hyperdrive binding not accessible:",a)}try{let a=globalThis.env||globalThis.__env__||globalThis.ENVIRONMENT||globalThis.CF_BINDINGS;if(a?.NEON_PG_CONN)return console.log("Using Worker secret for database connection"),a.NEON_PG_CONN}catch(a){console.warn("Worker secrets not accessible:",a)}let a=process.env.NEON_PG_CONN||process.env.PG_CONN||process.env.DATABASE_URL;return a?(console.log("Using process.env for database connection"),a):(console.error("No database connection configured in any location"),null)})();return a?new d.bC({connectionString:a}):(console.warn("No Postgres connection configured - returning null pool"),null)};async function f(a,b,c){try{let d=e();if(!d)return console.warn("Pool not available, returning mock response"),{rows:[],rowCount:0};let f=await d.connect();try{return c?.organizationId&&await f.query("SELECT set_config('app.current_organization_id', $1, true)",[c.organizationId]),c?.userId&&await f.query("SELECT set_config('app.current_user_id', $1, true)",[c.userId]),await f.query(a,b)}finally{f.release()}}catch(a){return console.error("Database query failed:",a),{rows:[],rowCount:0}}}async function g(a,b){let c=e(),d=await c.connect();try{await d.query("BEGIN"),b?.organizationId&&await d.query("SELECT set_config('app.current_organization_id', $1, true)",[b.organizationId]);let c=await a(d);return await d.query("COMMIT"),c}catch(a){throw await d.query("ROLLBACK"),a}finally{d.release()}}let h={query:f}},63033:a=>{"use strict";a.exports=require("next/dist/server/app-render/work-unit-async-storage.external.js")},73024:a=>{"use strict";a.exports=require("node:fs")},73566:a=>{"use strict";a.exports=require("worker_threads")},74075:a=>{"use strict";a.exports=require("zlib")},75919:a=>{"use strict";a.exports=require("node:worker_threads")},76760:a=>{"use strict";a.exports=require("node:path")},77030:a=>{"use strict";a.exports=require("node:net")},77598:a=>{"use strict";a.exports=require("node:crypto")},78335:()=>{},78474:a=>{"use strict";a.exports=require("node:events")},79428:a=>{"use strict";a.exports=require("buffer")},79551:a=>{"use strict";a.exports=require("url")},79646:a=>{"use strict";a.exports=require("child_process")},80481:a=>{"use strict";a.exports=require("node:readline")},81630:a=>{"use strict";a.exports=require("http")},83997:a=>{"use strict";a.exports=require("tty")},84297:a=>{"use strict";a.exports=require("async_hooks")},86439:a=>{"use strict";a.exports=require("next/dist/shared/lib/no-fallback-error.external")},86592:a=>{"use strict";a.exports=require("node:inspector")},91043:a=>{"use strict";a.exports=require("@aws-sdk/client-s3")},91645:a=>{"use strict";a.exports=require("net")},94735:a=>{"use strict";a.exports=require("events")},96487:()=>{},98995:a=>{"use strict";a.exports=require("node:module")},99505:(a,b,c)=>{"use strict";c.d(b,{c:()=>h});var d=c(1093),e=c(66147),f=c(60387),g=c(59175);async function h(a){let b=await (0,d.getServerSession)(e.authOptions);if(!b?.user)throw new g.u("Unauthorized",401,"AUTH_REQUIRED");let c=b.user.id;if(!c)throw new g.u("Unauthorized",401,"AUTH_REQUIRED");let{rows:h}=await (0,f.P)("SELECT role, organization_id FROM org_members WHERE user_id = $1 LIMIT 1",[c]),i=h[0];if(!i)throw new g.u("User is not part of an organization",404,"NO_ORGANIZATION");let j=i.role,k={owner:5,admin:4,operator:3,analyst:2,viewer:1},l=k[j]||0;if(!(Array.isArray(a)?a:[a]).some(a=>l>=(k[a]||0)))throw new g.u("Insufficient permissions",403,"INSUFFICIENT_ROLE");return{user:{id:c,email:b.user.email,name:b.user.name,role:j,organizationId:i.organization_id}}}}};var b=require("../../../../../webpack-runtime.js");b.C(a);var c=b.X(0,[4996,1692,4680,6802,1093,9376,8677,6147,5774],()=>b(b.s=8887));module.exports=c})();