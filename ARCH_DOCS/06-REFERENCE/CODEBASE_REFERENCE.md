# Codebase Reference

**Purpose:** Quick lookup for key functions, modules, relationships. Avoid re-parsing source.

## Backend: workers/src/lib/ (Core Utils)

**Insight:** Modular middleware-first design. Auth/DB gating on all routes. Error handling consistent.

| Module                   | Key Functions                                                                                             | Usage/Context                                                  |
| ------------------------ | --------------------------------------------------------------------------------------------------------- | -------------------------------------------------------------- |
| auth.ts                  | `verifySession(c)`, `requireAuth(c)`, `requireRole(c, role)`, `computeFingerprint(c)`                     | Session from KV/cookies, RLS set `app.current_organization_id` |
| db.ts                    | `getDb(env): DbClient`                                                                                    | Postgres client w/ Hyperdrive pooling                          |
| bond-ai.ts               | `chatCompletion(...)`, `buildSystemPrompt(session)`, `fetchCallContext(orgId, callId)`                    | OpenAI integration, context-aware prompts                      |
| webhook-retry.ts         | `deliverWithRetry(options)`, `fanOutToSubscribers(options)`                                               | Exponential backoff, dead-letter KV                            |
| translation-processor.ts | `translateAndStore(callId, audioUrl)`                                                                     | AssemblyAI → DeepL → ElevenLabs pipeline                       |
| plan-gating.ts           | `getOrgPlan(env, orgId)`, `requirePlan(minPlan)`                                                          | Stripe sync, feature flags                                     |
| errors.ts                | `createAppError(code, msg)`, `logError(ctx)`                                                              | Correlation IDs, Sentry integration                            |
| health-probes.ts         | `probeAll(env)`                                                                                           | /healthz checks DB/R2/Telnyx/OpenAI                            |
| Others                   | `idempotent(ttl)`, `rateLimit(config)`, `validateBody<T>(schema)`, `sendEmail(...)`, `writeAuditLog(...)` | Middleware chain: rate-limit → idempotent → auth → validate    |

## Routes: workers/src/routes/ (\*.ts)

- **Core:** calls.ts, recordings/audio.ts, scorecards.ts
- **Voice:** caller-id.ts (`listCallerIds`), tts.ts
- **AI:** bond-ai.ts, shopper.ts (`upsertScript`)
- **Admin:** admin.ts, teams.ts, billing.ts (`getBillingInfo`)
- **Webhooks:** webhooks.ts (`handleCallInitiated`, Stripe/Telnyx handlers)
- **Other:** reports.ts, campaigns.ts, compliance.ts, retention.ts, collections.ts

**Pattern:** Routes → lib/auth → lib/db → Neon; Webhooks → lib/webhook-retry → subscribers.

## Frontend/Shared: lib/ (Next.js App)

**Insight:** Client-side API wrapper, RBAC for UI gating, utils for display.

| Module            | Key Functions/Classes                                                              | Usage                                          |
| ----------------- | ---------------------------------------------------------------------------------- | ---------------------------------------------- |
| apiClient.ts      | `apiGet/Post/Patch/Delete(url, opts)`, `ApiError`                                  | Auth headers from localStorage, error handling |
| rbac.ts           | `hasPermission(role, plan, feature, action)`, `planSupportsFeature(plan, feature)` | UI conditional render (e.g., pro features)     |
| utils.ts          | `cn(...classes)`, `formatCurrency(cents)`, `formatDuration(seconds)`               | Tailwind clsx, data formatting                 |
| csv-validators.ts | `validateCsvRow(row)`, `validateCsvRows(rows)`                                     | Legacy CSV validation (retained for backward compat) |
| smart-csv-import.ts | `smartColumnMapping()`, `transformRow()`, `validateAllRows()`, `downloadTemplate()` | Smart CSV import engine — fuzzy matching, coercion, validation |
| logger.ts         | `new Logger().info(msg, ctx)`                                                      | Console-based, levels debug/info/warn/error    |

**Core Patterns/Insights:**

- **Request Flow:** Browser → apiClient → Workers routes → auth/db/plan → DB (RLS org_id).
- **Error Propagation:** AppError → JSON response → ApiError → UI toast.
- **Real-time:** WebSockets? (useRealtime hook → Workers scheduled?).
- **Tests:** vitest in tests/production/ validate integrations.

**Relationships:**

- Frontend (`lib/apiClient`) → Backend routes → `lib/db` → DB tables (org-scoped).
- RBAC client/server sync (roles from org_members).

**Full Source:** workers/src/, lib/, app/, components/.

---

_Generated by Cline._
