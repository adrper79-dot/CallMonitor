-- WARNING: This schema is for context only and is not meant to be run.
-- Table order and constraints may not be valid for execution.

CREATE TABLE public.access_grants_archived (
  id uuid NOT NULL,
  organization_id uuid,
  user_id uuid,
  role_id uuid,
  system_id uuid,
  created_at timestamp with time zone DEFAULT now(),
  CONSTRAINT access_grants_archived_pkey PRIMARY KEY (id),
  CONSTRAINT access_grants_organization_id_fkey FOREIGN KEY (organization_id) REFERENCES public.organizations(id),
  CONSTRAINT access_grants_user_id_fkey FOREIGN KEY (user_id) REFERENCES public.users(id),
  CONSTRAINT access_grants_role_id_fkey FOREIGN KEY (role_id) REFERENCES public.roles_archived(id),
  CONSTRAINT access_grants_system_id_fkey FOREIGN KEY (system_id) REFERENCES public.systems(id)
);
CREATE TABLE public.ai_runs (
  id uuid NOT NULL,
  call_id uuid,
  system_id uuid,
  model text,
  status text,
  started_at timestamp with time zone,
  completed_at timestamp with time zone,
  output jsonb,
  CONSTRAINT ai_runs_pkey PRIMARY KEY (id),
  CONSTRAINT ai_runs_call_id_fkey FOREIGN KEY (call_id) REFERENCES public.calls(id),
  CONSTRAINT ai_runs_system_id_fkey FOREIGN KEY (system_id) REFERENCES public.systems(id)
);
CREATE TABLE public.alert_acknowledgements (
  id uuid NOT NULL DEFAULT gen_random_uuid(),
  alert_id uuid,
  user_id uuid,
  acknowledged_at timestamp with time zone DEFAULT now(),
  acknowledgement_message text,
  created_at timestamp with time zone DEFAULT now(),
  CONSTRAINT alert_acknowledgements_pkey PRIMARY KEY (id)
);
CREATE TABLE public.alerts (
  id uuid NOT NULL DEFAULT gen_random_uuid(),
  organization_id uuid,
  test_config_id uuid,
  rule jsonb,
  enabled boolean DEFAULT true,
  last_triggered timestamp with time zone,
  CONSTRAINT alerts_pkey PRIMARY KEY (id),
  CONSTRAINT alerts_organization_id_fkey FOREIGN KEY (organization_id) REFERENCES public.organizations(id),
  CONSTRAINT alerts_test_config_id_fkey FOREIGN KEY (test_config_id) REFERENCES public.test_configs(id)
);
CREATE TABLE public.artifacts (
  id text NOT NULL,
  type text NOT NULL,
  title text,
  created_at timestamp with time zone DEFAULT now(),
  duration_seconds integer,
  size_bytes bigint,
  storage_bucket text,
  storage_path text,
  provenance jsonb,
  transcript jsonb,
  evidence_manifest jsonb,
  CONSTRAINT artifacts_pkey PRIMARY KEY (id)
);
CREATE TABLE public.audit_logs (
  id uuid NOT NULL,
  organization_id uuid,
  user_id uuid,
  system_id uuid,
  actor_type text,                           -- human | system | vendor | automation
  actor_label text,                          -- optional display label
  resource_type text,
  resource_id uuid,
  action text,
  before jsonb,
  after jsonb,
  created_at timestamp with time zone DEFAULT now(),
  CONSTRAINT audit_logs_pkey PRIMARY KEY (id),
  CONSTRAINT audit_logs_organization_id_fkey FOREIGN KEY (organization_id) REFERENCES public.organizations(id),
  CONSTRAINT audit_logs_user_id_fkey FOREIGN KEY (user_id) REFERENCES public.users(id),
  CONSTRAINT audit_logs_system_id_fkey FOREIGN KEY (system_id) REFERENCES public.systems(id)
);
-- Cal.com-style Booking Events (January 2026)
CREATE TABLE public.booking_events (
  id uuid PRIMARY KEY DEFAULT gen_random_uuid(),
  organization_id uuid NOT NULL REFERENCES public.organizations(id),
  user_id uuid REFERENCES public.users(id),
  call_id uuid REFERENCES public.calls(id),           -- Link to resulting call
  title text NOT NULL,
  description text,
  start_time timestamptz NOT NULL,
  end_time timestamptz NOT NULL,
  duration_minutes integer NOT NULL DEFAULT 30,
  timezone text DEFAULT 'UTC',
  attendee_name text,
  attendee_email text,
  attendee_phone text NOT NULL,                       -- Required for calling
  from_number text,                                   -- Caller's phone (for bridge calls)
  status text NOT NULL DEFAULT 'pending',             -- pending, calling, completed, cancelled, failed
  reminder_sent boolean DEFAULT false,
  reminder_sent_at timestamptz,
  modulations jsonb DEFAULT '{}',                     -- Override call modulations
  notes text,
  created_at timestamptz DEFAULT now(),
  updated_at timestamptz DEFAULT now(),
  created_by uuid REFERENCES public.users(id)
);

-- Caller ID Numbers for Masking/Verification (January 2026)
CREATE TABLE public.caller_id_numbers (
  id uuid PRIMARY KEY DEFAULT gen_random_uuid(),
  organization_id uuid NOT NULL REFERENCES public.organizations(id),
  phone_number text NOT NULL,                          -- E.164 format
  display_name text,                                   -- Friendly name
  is_verified boolean DEFAULT false,                   -- Verification status
  is_default boolean DEFAULT false,                    -- Default caller ID for org
  verification_code text,                              -- Temporary code during verification
  verified_at timestamptz,                             -- When verified
  created_by uuid REFERENCES public.users(id),
  signalwire_verification_sid text,                    -- Call SID for verification call
  use_count integer DEFAULT 0,                         -- Usage tracking
  created_at timestamptz DEFAULT now()
);
CREATE TABLE public.calls (
  id uuid NOT NULL,
  organization_id uuid,
  system_id uuid,
  status text,
  started_at timestamp with time zone,
  ended_at timestamp with time zone,
  created_by uuid,
  call_sid text,
  custody_status text DEFAULT 'active'::text,
  retention_class text DEFAULT 'default'::text,
  legal_hold_flag boolean DEFAULT false,
  evidence_completeness text DEFAULT 'unknown'::text,
  CONSTRAINT calls_pkey PRIMARY KEY (id),
  CONSTRAINT calls_organization_id_fkey FOREIGN KEY (organization_id) REFERENCES public.organizations(id),
  CONSTRAINT calls_system_id_fkey FOREIGN KEY (system_id) REFERENCES public.systems(id),
  CONSTRAINT calls_created_by_fkey FOREIGN KEY (created_by) REFERENCES public.users(id)
);
CREATE TABLE public.capabilities_archived (
  id uuid NOT NULL,
  system_id uuid,
  action text NOT NULL,
  description text,
  CONSTRAINT capabilities_archived_pkey PRIMARY KEY (id),
  CONSTRAINT capabilities_system_id_fkey FOREIGN KEY (system_id) REFERENCES public.systems(id)
);
CREATE TABLE public.carrier_status (
  id uuid NOT NULL DEFAULT uuid_generate_v4(),
  carrier_name text NOT NULL UNIQUE,
  status text NOT NULL CHECK (status = ANY (ARRAY['operational'::text, 'degraded'::text, 'outage'::text])),
  last_updated timestamp with time zone DEFAULT now(),
  official_url text,
  status_page_api text,
  description text,
  created_at timestamp with time zone DEFAULT now(),
  incident_count integer DEFAULT 0,
  last_incident_at timestamp with time zone,
  CONSTRAINT carrier_status_pkey PRIMARY KEY (id)
);
CREATE TABLE public.evidence_manifests (
  id uuid NOT NULL DEFAULT gen_random_uuid(),
  organization_id uuid NOT NULL,
  recording_id uuid NOT NULL,
  scorecard_id uuid,
  manifest jsonb NOT NULL,
  created_at timestamp with time zone DEFAULT now(),
  version integer NOT NULL DEFAULT 1,
  parent_manifest_id uuid,
  superseded_at timestamp with time zone,
  superseded_by uuid,
  CONSTRAINT evidence_manifests_pkey PRIMARY KEY (id),
  CONSTRAINT evidence_manifests_recording_id_fkey FOREIGN KEY (recording_id) REFERENCES public.recordings(id),
  CONSTRAINT evidence_manifests_parent_fkey FOREIGN KEY (parent_manifest_id) REFERENCES public.evidence_manifests(id)
);
-- Custody-grade evidence bundles with RFC3161 timestamping (January 2026)
-- Per ARCH_DOCS/01-CORE/THE_FINAL_ARCHITECTURE_MINIMAL_ADDITIONS.md
CREATE TABLE public.evidence_bundles (
  id uuid NOT NULL DEFAULT gen_random_uuid(),
  organization_id uuid NOT NULL,
  call_id uuid NOT NULL,
  recording_id uuid,
  manifest_id uuid NOT NULL,
  manifest_hash text NOT NULL,
  artifact_hashes jsonb NOT NULL DEFAULT '[]'::jsonb,
  bundle_payload jsonb NOT NULL,
  bundle_hash text NOT NULL,
  bundle_hash_algo text NOT NULL DEFAULT 'sha256',
  version integer NOT NULL DEFAULT 1,
  parent_bundle_id uuid,
  superseded_at timestamp with time zone,
  superseded_by uuid,
  immutable_storage boolean NOT NULL DEFAULT true,
  is_authoritative boolean NOT NULL DEFAULT true,
  produced_by text NOT NULL DEFAULT 'system_cas',
  immutability_policy text NOT NULL DEFAULT 'immutable',
  custody_status text DEFAULT 'active'::text,
  retention_class text DEFAULT 'default'::text,
  legal_hold_flag boolean DEFAULT false,
  evidence_completeness text DEFAULT 'unknown'::text,
  tsa jsonb,
  tsa_status text NOT NULL DEFAULT 'not_configured',
  tsa_requested_at timestamp with time zone,
  tsa_received_at timestamp with time zone,
  tsa_error text,
  created_at timestamp with time zone NOT NULL DEFAULT now(),
  CONSTRAINT evidence_bundles_pkey PRIMARY KEY (id),
  CONSTRAINT evidence_bundles_organization_id_fkey FOREIGN KEY (organization_id) REFERENCES public.organizations(id),
  CONSTRAINT evidence_bundles_call_id_fkey FOREIGN KEY (call_id) REFERENCES public.calls(id),
  CONSTRAINT evidence_bundles_recording_id_fkey FOREIGN KEY (recording_id) REFERENCES public.recordings(id),
  CONSTRAINT evidence_bundles_manifest_id_fkey FOREIGN KEY (manifest_id) REFERENCES public.evidence_manifests(id),
  CONSTRAINT evidence_bundles_parent_bundle_id_fkey FOREIGN KEY (parent_bundle_id) REFERENCES public.evidence_bundles(id),
  CONSTRAINT evidence_bundles_immutability_policy_check CHECK (immutability_policy IN ('immutable', 'limited', 'mutable')),
  CONSTRAINT evidence_bundles_tsa_status_check CHECK (tsa_status IN ('not_configured', 'pending', 'completed', 'error'))
);
-- Unique constraint: one active bundle per manifest
CREATE UNIQUE INDEX uq_evidence_bundles_manifest_active ON public.evidence_bundles (manifest_id) WHERE superseded_at IS NULL;
-- Indexes for evidence_bundles
CREATE INDEX idx_evidence_bundles_org_created ON public.evidence_bundles (organization_id, created_at DESC);
CREATE INDEX idx_evidence_bundles_call ON public.evidence_bundles (call_id, created_at DESC);
CREATE INDEX idx_evidence_bundles_manifest ON public.evidence_bundles (manifest_id);
CREATE TABLE public.execution_contexts (
  id uuid NOT NULL,
  name text UNIQUE,
  isolation_level text,
  description text,
  CONSTRAINT execution_contexts_pkey PRIMARY KEY (id)
);
CREATE TABLE public.kpi_logs (
  id bigint NOT NULL DEFAULT nextval('kpi_logs_id_seq'::regclass),
  test_id uuid,
  stage text NOT NULL,
  status text NOT NULL CHECK (status = ANY (ARRAY['success'::text, 'failure'::text])),
  message text NOT NULL,
  duration_ms integer,
  error_details text,
  metadata jsonb DEFAULT '{}'::jsonb,
  created_at timestamp with time zone DEFAULT now(),
  CONSTRAINT kpi_logs_pkey PRIMARY KEY (id),
  CONSTRAINT kpi_logs_test_id_fkey FOREIGN KEY (test_id) REFERENCES public.test_configs(id)
);
CREATE TABLE public.kpi_settings (
  id uuid NOT NULL DEFAULT gen_random_uuid(),
  organization_id uuid NOT NULL UNIQUE,
  response_time_threshold_ms integer DEFAULT 5000,
  response_time_warning_ms integer DEFAULT 3000,
  consecutive_failures_before_alert integer DEFAULT 3,
  alert_sensitivity text DEFAULT 'medium'::text CHECK (alert_sensitivity = ANY (ARRAY['low'::text, 'medium'::text, 'high'::text])),
  default_test_frequency text DEFAULT '5min'::text CHECK (default_test_frequency = ANY (ARRAY['5min'::text, '15min'::text, '30min'::text, '1hr'::text, '4hr'::text, '24hr'::text])),
  send_email_alerts boolean DEFAULT true,
  send_sms_alerts boolean DEFAULT true,
  alert_on_recovery boolean DEFAULT true,
  created_at timestamp with time zone DEFAULT now(),
  updated_at timestamp with time zone DEFAULT now(),
  CONSTRAINT kpi_settings_pkey PRIMARY KEY (id),
  CONSTRAINT kpi_settings_organization_id_fkey FOREIGN KEY (organization_id) REFERENCES public.organizations(id)
);
CREATE TABLE public.login_attempts (
  id uuid NOT NULL DEFAULT gen_random_uuid(),
  username text NOT NULL,
  ip text,
  succeeded boolean NOT NULL DEFAULT false,
  attempted_at timestamp with time zone NOT NULL DEFAULT now(),
  CONSTRAINT login_attempts_pkey PRIMARY KEY (id)
);
CREATE TABLE public.media_sessions (
  id uuid NOT NULL,
  call_id uuid,
  system_id uuid,
  freeswitch_node text,
  started_at timestamp with time zone,
  ended_at timestamp with time zone,
  CONSTRAINT media_sessions_pkey PRIMARY KEY (id),
  CONSTRAINT media_sessions_call_id_fkey FOREIGN KEY (call_id) REFERENCES public.calls(id),
  CONSTRAINT media_sessions_system_id_fkey FOREIGN KEY (system_id) REFERENCES public.systems(id)
);
CREATE TABLE public.monitored_numbers (
  id uuid NOT NULL DEFAULT gen_random_uuid(),
  organization_id uuid NOT NULL,
  number text NOT NULL,
  name text,
  description text,
  type text DEFAULT 'inbound'::text,
  test_frequency text NOT NULL DEFAULT 'hourly'::text,
  greeting_message_id uuid,
  custom_greeting_message text,
  is_active boolean DEFAULT true,
  created_at timestamp with time zone DEFAULT now(),
  updated_at timestamp with time zone DEFAULT now(),
  CONSTRAINT monitored_numbers_pkey PRIMARY KEY (id),
  CONSTRAINT monitored_numbers_organization_id_fkey FOREIGN KEY (organization_id) REFERENCES public.organizations(id),
  CONSTRAINT monitored_numbers_greeting_message_id_fkey FOREIGN KEY (greeting_message_id) REFERENCES public.stock_messages(id)
);
CREATE TABLE public.network_incidents (
  id uuid NOT NULL DEFAULT uuid_generate_v4(),
  title text NOT NULL,
  description text,
  source text NOT NULL,
  link text,
  pub_date timestamp with time zone,
  severity text CHECK (severity = ANY (ARRAY['low'::text, 'medium'::text, 'high'::text, 'critical'::text])),
  affected_carriers ARRAY,
  created_at timestamp with time zone DEFAULT now(),
  is_active boolean DEFAULT true,
  CONSTRAINT network_incidents_pkey PRIMARY KEY (id)
);
CREATE TABLE public.number_kpi_logs (
  id uuid NOT NULL DEFAULT gen_random_uuid(),
  monitored_number_id uuid NOT NULL,
  organization_id uuid NOT NULL,
  stage text,
  duration_ms integer,
  meta jsonb,
  created_at timestamp with time zone DEFAULT now(),
  CONSTRAINT number_kpi_logs_pkey PRIMARY KEY (id),
  CONSTRAINT number_kpi_logs_monitored_number_id_fkey FOREIGN KEY (monitored_number_id) REFERENCES public.monitored_numbers(id),
  CONSTRAINT number_kpi_logs_organization_id_fkey FOREIGN KEY (organization_id) REFERENCES public.organizations(id)
);
CREATE TABLE public.number_kpi_snapshot (
  id uuid NOT NULL DEFAULT gen_random_uuid(),
  monitored_number_id uuid NOT NULL,
  organization_id uuid NOT NULL,
  status text NOT NULL,
  uptime_percentage numeric,
  last_24h_failures integer,
  last_test_at timestamp with time zone,
  last_test_status text,
  avg_response_time_ms integer,
  last_updated timestamp with time zone DEFAULT now(),
  CONSTRAINT number_kpi_snapshot_pkey PRIMARY KEY (id),
  CONSTRAINT number_kpi_snapshot_monitored_number_id_fkey FOREIGN KEY (monitored_number_id) REFERENCES public.monitored_numbers(id),
  CONSTRAINT number_kpi_snapshot_organization_id_fkey FOREIGN KEY (organization_id) REFERENCES public.organizations(id)
);
CREATE TABLE public.org_members (
  id uuid NOT NULL DEFAULT gen_random_uuid(),
  organization_id uuid NOT NULL,
  user_id uuid NOT NULL,
  role text DEFAULT 'member'::text,
  created_at timestamp with time zone DEFAULT now(),
  CONSTRAINT org_members_pkey PRIMARY KEY (id),
  CONSTRAINT org_members_organization_id_fkey FOREIGN KEY (organization_id) REFERENCES public.organizations(id),
  CONSTRAINT org_members_user_id_fkey FOREIGN KEY (user_id) REFERENCES public.users(id)
);
CREATE TABLE public.organizations (
  id uuid NOT NULL DEFAULT gen_random_uuid(),
  name text NOT NULL,
  plan text,
  created_at timestamp with time zone DEFAULT now(),
  plan_status text DEFAULT 'active'::text CHECK (plan_status = ANY (ARRAY['active'::text, 'past_due'::text, 'canceled'::text, 'trialing'::text, 'incomplete'::text])),
  stripe_customer_id text UNIQUE,
  stripe_subscription_id text,
  tenant_id uuid,
  tool_id uuid,
  created_by uuid,
  CONSTRAINT organizations_pkey PRIMARY KEY (id),
  CONSTRAINT organizations_created_by_fkey FOREIGN KEY (created_by) REFERENCES auth.users(id)
);
CREATE TABLE public.recordings (
  id uuid NOT NULL DEFAULT gen_random_uuid(),
  organization_id uuid NOT NULL,
  call_sid text NOT NULL,
  recording_sid text UNIQUE,
  recording_url text NOT NULL,
  duration_seconds integer,
  transcript_json jsonb,
  status text DEFAULT 'pending'::text,
  created_at timestamp with time zone DEFAULT now(),
  updated_at timestamp with time zone DEFAULT now(),
  custody_status text DEFAULT 'active'::text,
  retention_class text DEFAULT 'default'::text,
  legal_hold_flag boolean DEFAULT false,
  evidence_completeness text DEFAULT 'unknown'::text,
  tool_id uuid NOT NULL,
  created_by uuid,
  CONSTRAINT recordings_pkey PRIMARY KEY (id),
  CONSTRAINT recordings_organization_id_fkey FOREIGN KEY (organization_id) REFERENCES public.organizations(id),
  CONSTRAINT recordings_tool_id_fkey FOREIGN KEY (tool_id) REFERENCES public.tools(id),
  CONSTRAINT recordings_created_by_fkey FOREIGN KEY (created_by) REFERENCES auth.users(id)
);
CREATE TABLE public.report_schedules (
  id uuid NOT NULL DEFAULT gen_random_uuid(),
  organization_id uuid,
  test_config_id uuid,
  frequency text NOT NULL CHECK (frequency = ANY (ARRAY['daily'::text, 'weekly'::text])),
  recipient_emails ARRAY NOT NULL,
  is_active boolean DEFAULT true,
  created_at timestamp with time zone DEFAULT now(),
  CONSTRAINT report_schedules_pkey PRIMARY KEY (id),
  CONSTRAINT report_schedules_organization_id_fkey FOREIGN KEY (organization_id) REFERENCES public.organizations(id),
  CONSTRAINT report_schedules_test_config_id_fkey FOREIGN KEY (test_config_id) REFERENCES public.test_configs(id)
);
CREATE TABLE public.role_capabilities_archived (
  role_id uuid NOT NULL,
  capability_id uuid NOT NULL,
  CONSTRAINT role_capabilities_archived_pkey PRIMARY KEY (role_id, capability_id),
  CONSTRAINT role_capabilities_role_id_fkey FOREIGN KEY (role_id) REFERENCES public.roles_archived(id),
  CONSTRAINT role_capabilities_capability_id_fkey FOREIGN KEY (capability_id) REFERENCES public.capabilities_archived(id)
);
CREATE TABLE public.roles_archived (
  id uuid NOT NULL,
  organization_id uuid,
  name text,
  created_at timestamp with time zone DEFAULT now(),
  CONSTRAINT roles_archived_pkey PRIMARY KEY (id),
  CONSTRAINT roles_organization_id_fkey FOREIGN KEY (organization_id) REFERENCES public.organizations(id)
);
CREATE TABLE public.scorecards (
  id uuid NOT NULL DEFAULT gen_random_uuid(),
  organization_id uuid NOT NULL,
  name text NOT NULL,
  description text,
  structure jsonb NOT NULL,
  is_template boolean DEFAULT false,
  created_at timestamp with time zone DEFAULT now(),
  updated_at timestamp with time zone DEFAULT now(),
  tool_id uuid NOT NULL,
  created_by uuid,
  CONSTRAINT scorecards_pkey PRIMARY KEY (id),
  CONSTRAINT scorecards_organization_id_fkey FOREIGN KEY (organization_id) REFERENCES public.organizations(id),
  CONSTRAINT scorecards_tool_id_fkey FOREIGN KEY (tool_id) REFERENCES public.tools(id),
  CONSTRAINT scorecards_created_by_fkey FOREIGN KEY (created_by) REFERENCES auth.users(id)
);
CREATE TABLE public.scored_recordings (
  id uuid NOT NULL DEFAULT gen_random_uuid(),
  organization_id uuid NOT NULL,
  recording_id uuid NOT NULL,
  scorecard_id uuid NOT NULL,
  scores_json jsonb NOT NULL,
  total_score numeric,
  manual_overrides_json jsonb,
  created_at timestamp with time zone DEFAULT now(),
  updated_at timestamp with time zone DEFAULT now(),
  CONSTRAINT scored_recordings_pkey PRIMARY KEY (id),
  CONSTRAINT scored_recordings_organization_id_fkey FOREIGN KEY (organization_id) REFERENCES public.organizations(id),
  CONSTRAINT scored_recordings_recording_id_fkey FOREIGN KEY (recording_id) REFERENCES public.recordings(id),
  CONSTRAINT scored_recordings_scorecard_id_fkey FOREIGN KEY (scorecard_id) REFERENCES public.scorecards(id)
);
CREATE TABLE public.shopper_campaigns_archive (
  id uuid NOT NULL DEFAULT uuid_generate_v4(),
  organization_id uuid NOT NULL,
  name text NOT NULL,
  description text,
  scenario text NOT NULL,
  schedule text DEFAULT 'manual'::text,
  phone_numbers ARRAY DEFAULT '{}'::text[],
  is_active boolean DEFAULT true,
  created_at timestamp with time zone DEFAULT now(),
  updated_at timestamp with time zone DEFAULT now(),
  created_by uuid,
  caller_number text,
  phone_to_test text,
  CONSTRAINT shopper_campaigns_archive_pkey PRIMARY KEY (id)
);
CREATE TABLE public.shopper_jobs_archive (
  id uuid NOT NULL DEFAULT gen_random_uuid(),
  campaign_id uuid,
  organization_id uuid,
  result_id uuid,
  payload jsonb,
  status text NOT NULL DEFAULT 'pending'::text,
  attempt_count integer NOT NULL DEFAULT 0,
  max_attempts integer NOT NULL DEFAULT 5,
  next_try_at timestamp with time zone DEFAULT now(),
  last_error text,
  created_at timestamp with time zone DEFAULT now(),
  updated_at timestamp with time zone DEFAULT now(),
  CONSTRAINT shopper_jobs_archive_pkey PRIMARY KEY (id)
);
CREATE TABLE public.shopper_results (
  id uuid NOT NULL DEFAULT uuid_generate_v4(),
  campaign_id uuid NOT NULL,
  phone_number text,
  call_sid text,
  status text NOT NULL,
  score integer,
  notes text,
  call_duration integer,
  created_at timestamp with time zone DEFAULT now(),
  organization_id uuid,
  call_date timestamp with time zone DEFAULT now(),
  created_by uuid,
  meta jsonb,
  shopper_call_sid text,
  conference text,
  tool_id uuid NOT NULL,
  CONSTRAINT shopper_results_pkey PRIMARY KEY (id),
  CONSTRAINT shopper_results_organization_id_fkey FOREIGN KEY (organization_id) REFERENCES public.organizations(id),
  CONSTRAINT shopper_results_created_by_fkey FOREIGN KEY (created_by) REFERENCES auth.users(id),
  CONSTRAINT shopper_results_tool_id_fkey FOREIGN KEY (tool_id) REFERENCES public.tools(id)
);
CREATE TABLE public.stock_messages (
  id uuid NOT NULL DEFAULT gen_random_uuid(),
  name text NOT NULL,
  type text NOT NULL DEFAULT 'greeting'::text,
  text text NOT NULL,
  category text,
  duration_seconds integer,
  is_active boolean DEFAULT true,
  created_at timestamp with time zone DEFAULT now(),
  CONSTRAINT stock_messages_pkey PRIMARY KEY (id)
);
CREATE TABLE public.systems (
  id uuid NOT NULL,
  key text NOT NULL UNIQUE,
  name text NOT NULL,
  description text,
  category text,
  execution_plane text CHECK (execution_plane = ANY (ARRAY['control'::text, 'media'::text, 'ai'::text])),
  is_billable boolean DEFAULT false,
  is_internal boolean DEFAULT true,
  created_at timestamp with time zone DEFAULT now(),
  CONSTRAINT systems_pkey PRIMARY KEY (id)
);
CREATE TABLE public.test_configs (
  id uuid NOT NULL DEFAULT gen_random_uuid(),
  organization_id uuid,
  name text,
  phone_to text NOT NULL,
  schedule text NOT NULL,
  active boolean DEFAULT true,
  created_at timestamp with time zone DEFAULT now(),
  custom_message text,
  dtmf_required boolean DEFAULT false,
  dtmf_expected character varying,
  description text,
  carrier text,
  test_script text DEFAULT 'basic'::text,
  alert_rules jsonb DEFAULT '{"alert_email": true, "consecutive_failures": 2}'::jsonb,
  last_test_at timestamp with time zone,
  last_status text,
  updated_at timestamp with time zone DEFAULT now(),
  tool_id uuid NOT NULL,
  created_by uuid,
  CONSTRAINT test_configs_pkey PRIMARY KEY (id),
  CONSTRAINT test_configs_organization_id_fkey FOREIGN KEY (organization_id) REFERENCES public.organizations(id),
  CONSTRAINT test_configs_tool_id_fkey FOREIGN KEY (tool_id) REFERENCES public.tools(id),
  CONSTRAINT test_configs_created_by_fkey FOREIGN KEY (created_by) REFERENCES auth.users(id)
);
CREATE TABLE public.test_frequency_config (
  id uuid NOT NULL DEFAULT gen_random_uuid(),
  monitored_number_id uuid,
  frequency text NOT NULL,
  hours_between_tests integer,
  day_of_week integer,
  time_of_day time without time zone,
  is_active boolean DEFAULT true,
  created_at timestamp with time zone DEFAULT now(),
  CONSTRAINT test_frequency_config_pkey PRIMARY KEY (id),
  CONSTRAINT test_frequency_config_monitored_number_id_fkey FOREIGN KEY (monitored_number_id) REFERENCES public.monitored_numbers(id)
);
CREATE TABLE public.test_results (
  id uuid NOT NULL DEFAULT gen_random_uuid(),
  test_config_id uuid,
  status text,
  duration_ms integer,
  meta jsonb,
  created_at timestamp with time zone DEFAULT now(),
  tool_id uuid NOT NULL,
  created_by uuid,
  CONSTRAINT test_results_pkey PRIMARY KEY (id),
  CONSTRAINT test_results_test_config_id_fkey FOREIGN KEY (test_config_id) REFERENCES public.test_configs(id),
  CONSTRAINT test_results_tool_id_fkey FOREIGN KEY (tool_id) REFERENCES public.tools(id),
  CONSTRAINT test_results_created_by_fkey FOREIGN KEY (created_by) REFERENCES auth.users(id)
);
CREATE TABLE public.test_statistics (
  id uuid NOT NULL DEFAULT gen_random_uuid(),
  test_config_id uuid NOT NULL UNIQUE,
  uptime_percentage_24h numeric DEFAULT 100.00,
  uptime_percentage_7d numeric DEFAULT 100.00,
  uptime_percentage_30d numeric DEFAULT 100.00,
  avg_response_ms_24h integer,
  min_response_ms_24h integer,
  max_response_ms_24h integer,
  total_tests_24h integer DEFAULT 0,
  failures_24h integer DEFAULT 0,
  consecutive_failures integer DEFAULT 0,
  current_status text DEFAULT 'unknown'::text CHECK (current_status = ANY (ARRAY['healthy'::text, 'warning'::text, 'critical'::text, 'unknown'::text])),
  last_success_at timestamp with time zone,
  last_failure_at timestamp with time zone,
  hourly_uptime_trend jsonb DEFAULT '[]'::jsonb,
  updated_at timestamp with time zone DEFAULT now(),
  system_id uuid,
  created_by uuid,
  visibility text DEFAULT 'org'::text CHECK (visibility = ANY (ARRAY['private'::text, 'team'::text, 'org'::text])),
  CONSTRAINT test_statistics_pkey PRIMARY KEY (id),
  CONSTRAINT test_statistics_test_config_id_fkey FOREIGN KEY (test_config_id) REFERENCES public.test_configs(id),
  CONSTRAINT test_statistics_system_id_fkey FOREIGN KEY (system_id) REFERENCES public.systems(id),
  CONSTRAINT test_statistics_created_by_fkey FOREIGN KEY (created_by) REFERENCES public.users(id)
);
CREATE TABLE public.tool_access (
  id uuid,
  organization_id uuid,
  user_id uuid,
  tool USER-DEFINED,
  role USER-DEFINED,
  created_at timestamp with time zone,
  updated_at timestamp with time zone
);
CREATE TABLE public.tool_access_archived (
  id uuid NOT NULL DEFAULT gen_random_uuid(),
  organization_id uuid NOT NULL,
  user_id uuid NOT NULL,
  tool USER-DEFINED NOT NULL,
  role USER-DEFINED NOT NULL DEFAULT 'viewer'::tool_role_type,
  created_at timestamp with time zone DEFAULT now(),
  updated_at timestamp with time zone DEFAULT now(),
  CONSTRAINT tool_access_archived_pkey PRIMARY KEY (id),
  CONSTRAINT tool_access_organization_id_fkey FOREIGN KEY (organization_id) REFERENCES public.organizations(id),
  CONSTRAINT tool_access_user_id_fkey FOREIGN KEY (user_id) REFERENCES auth.users(id)
);
CREATE TABLE public.tool_settings (
  id uuid NOT NULL DEFAULT gen_random_uuid(),
  organization_id uuid NOT NULL,
  tool USER-DEFINED NOT NULL,
  settings jsonb DEFAULT '{}'::jsonb,
  created_at timestamp with time zone DEFAULT now(),
  updated_at timestamp with time zone DEFAULT now(),
  CONSTRAINT tool_settings_pkey PRIMARY KEY (id),
  CONSTRAINT tool_settings_organization_id_fkey FOREIGN KEY (organization_id) REFERENCES public.organizations(id)
);
CREATE TABLE public.tool_team_members (
  id uuid NOT NULL DEFAULT gen_random_uuid(),
  organization_id uuid NOT NULL,
  user_id uuid NOT NULL,
  tool USER-DEFINED NOT NULL,
  role USER-DEFINED NOT NULL,
  invited_by uuid,
  invited_at timestamp with time zone,
  accepted_at timestamp with time zone,
  created_at timestamp with time zone DEFAULT now(),
  CONSTRAINT tool_team_members_pkey PRIMARY KEY (id),
  CONSTRAINT tool_team_members_organization_id_fkey FOREIGN KEY (organization_id) REFERENCES public.organizations(id),
  CONSTRAINT tool_team_members_user_id_fkey FOREIGN KEY (user_id) REFERENCES auth.users(id),
  CONSTRAINT tool_team_members_invited_by_fkey FOREIGN KEY (invited_by) REFERENCES auth.users(id)
);
CREATE TABLE public.tools (
  id uuid NOT NULL DEFAULT gen_random_uuid(),
  name text NOT NULL UNIQUE,
  description text,
  created_at timestamp with time zone DEFAULT now(),
  CONSTRAINT tools_pkey PRIMARY KEY (id)
);
CREATE TABLE public.users (
  id uuid NOT NULL,
  organization_id uuid,
  email text NOT NULL UNIQUE,
  phone text,
  role text DEFAULT 'viewer'::text,
  created_at timestamp with time zone DEFAULT now(),
  is_admin boolean DEFAULT false,
  tenant_id uuid,
  tool_id uuid,
  created_by uuid,
  CONSTRAINT users_pkey PRIMARY KEY (id),
  CONSTRAINT users_organization_id_fkey FOREIGN KEY (organization_id) REFERENCES public.organizations(id),
  CONSTRAINT users_id_fkey FOREIGN KEY (id) REFERENCES auth.users(id),
  CONSTRAINT users_created_by_fkey FOREIGN KEY (created_by) REFERENCES auth.users(id)
);
CREATE TABLE public.voice_configs (
  id uuid NOT NULL DEFAULT gen_random_uuid(),
  organization_id uuid NOT NULL,
  record boolean DEFAULT false,
  transcribe boolean DEFAULT false,
  translate boolean DEFAULT false,
  translate_from text,
  translate_to text,
  survey boolean DEFAULT false,
  synthetic_caller boolean DEFAULT false,
  use_voice_cloning boolean DEFAULT false,  -- Enable voice cloning for translations
  cloned_voice_id text,                      -- ElevenLabs cloned voice ID
  -- AI Survey Bot fields (January 2026)
  survey_prompts jsonb DEFAULT '[]',         -- Array of survey questions
  survey_voice text DEFAULT 'rime.spore',    -- SignalWire TTS voice for survey bot
  survey_webhook_email text,                 -- Email address for survey results
  survey_inbound_number text,                -- SignalWire phone number SID
  -- Caller ID Masking fields (January 2026)
  caller_id_mask text,                       -- Custom caller ID to display
  caller_id_verified boolean DEFAULT false,  -- Whether mask has been verified
  caller_id_verified_at timestamptz,         -- When verified
  -- Live Translation fields (January 2026)
  live_translate boolean DEFAULT false,      -- Enable real-time translation
  live_translate_from text,                  -- Source language for live translation
  live_translate_to text,                    -- Target language for live translation
  updated_by uuid,
  updated_at timestamp with time zone DEFAULT now(),
  CONSTRAINT voice_configs_pkey PRIMARY KEY (id),
  CONSTRAINT voice_configs_organization_id_fkey FOREIGN KEY (organization_id) REFERENCES public.organizations(id),
  CONSTRAINT voice_configs_updated_by_fkey FOREIGN KEY (updated_by) REFERENCES public.users(id)
);

-- Voice Targets - Numbers to Call (January 2026)
CREATE TABLE public.voice_targets (
  id uuid PRIMARY KEY DEFAULT gen_random_uuid(),
  organization_id uuid NOT NULL REFERENCES public.organizations(id),
  phone_number text NOT NULL,                   -- E.164 format
  name text,                                    -- Human-readable name
  description text,
  is_active boolean DEFAULT true,
  created_at timestamptz DEFAULT now(),
  created_by uuid REFERENCES public.users(id)
);

-- Surveys - After-Call Survey Definitions (January 2026)
CREATE TABLE public.surveys (
  id uuid PRIMARY KEY DEFAULT gen_random_uuid(),
  organization_id uuid NOT NULL REFERENCES public.organizations(id),
  name text NOT NULL,
  description text,
  questions jsonb DEFAULT '[]',                 -- Array of {type, question, options}
  is_active boolean DEFAULT true,
  created_at timestamptz DEFAULT now(),
  updated_at timestamptz DEFAULT now(),
  created_by uuid REFERENCES public.users(id)
);

-- Secret Shopper Scripts (January 2026)
CREATE TABLE public.shopper_scripts (
  id uuid PRIMARY KEY DEFAULT gen_random_uuid(),
  organization_id uuid NOT NULL REFERENCES public.organizations(id),
  name text NOT NULL,
  description text,
  persona_name text,                          -- Shopper persona name
  persona_background text,                    -- Background story
  scenario text NOT NULL,                     -- What the shopper is trying to accomplish
  expected_outcomes jsonb DEFAULT '[]',       -- Expected agent behaviors
  tts_voice text DEFAULT 'en-US-Jenny',       -- Voice for TTS
  tts_provider text DEFAULT 'elevenlabs',     -- elevenlabs or signalwire
  scoring_criteria jsonb DEFAULT '[]',        -- Custom scoring rubric
  is_active boolean DEFAULT true,
  created_at timestamptz DEFAULT now(),
  updated_at timestamptz DEFAULT now(),
  created_by uuid REFERENCES public.users(id)
);
CREATE TABLE public.webhook_configs (
  id uuid NOT NULL DEFAULT gen_random_uuid(),
  organization_id uuid,
  type text NOT NULL CHECK (type = ANY (ARRAY['slack'::text, 'teams'::text])),
  url text NOT NULL,
  is_active boolean DEFAULT true,
  test_sent_at timestamp with time zone,
  created_at timestamp with time zone DEFAULT now(),
  updated_at timestamp with time zone DEFAULT now(),
  CONSTRAINT webhook_configs_pkey PRIMARY KEY (id),
  CONSTRAINT webhook_configs_organization_id_fkey FOREIGN KEY (organization_id) REFERENCES public.organizations(id)
);

-- =============================================================================
-- SYSTEM OF RECORD COMPLIANCE TABLES (January 2026)
-- =============================================================================

-- Immutable transcript history for chain of custody
CREATE TABLE public.transcript_versions (
  id uuid PRIMARY KEY DEFAULT gen_random_uuid(),
  recording_id uuid NOT NULL REFERENCES public.recordings(id),
  organization_id uuid NOT NULL REFERENCES public.organizations(id),
  version integer NOT NULL DEFAULT 1,
  transcript_json jsonb NOT NULL,
  transcript_hash text NOT NULL,              -- SHA256 of transcript content
  produced_by text NOT NULL CHECK (produced_by IN ('system', 'human', 'model')),
  produced_by_model text,                     -- e.g., 'assemblyai-v1'
  produced_by_user_id uuid REFERENCES public.users(id),
  input_refs jsonb,                           -- References to input artifacts
  created_at timestamptz NOT NULL DEFAULT now(),
  UNIQUE(recording_id, version)
);

-- Chain of custody for all artifacts
CREATE TABLE public.artifact_provenance (
  id uuid PRIMARY KEY DEFAULT gen_random_uuid(),
  organization_id uuid NOT NULL REFERENCES public.organizations(id),
  artifact_type text NOT NULL CHECK (artifact_type IN ('recording', 'transcript', 'translation', 'survey', 'score', 'evidence_manifest', 'evidence_bundle')),
  artifact_id uuid NOT NULL,
  parent_artifact_id uuid,                    -- Reference to input artifact
  parent_artifact_type text,
  produced_by text NOT NULL CHECK (produced_by IN ('system', 'human', 'model')),
  produced_by_model text,
  produced_by_user_id uuid REFERENCES public.users(id),
  produced_by_system_id uuid REFERENCES public.systems(id),
  produced_at timestamptz NOT NULL DEFAULT now(),
  input_refs jsonb,                           -- Array of {type, id, hash} references
  version integer NOT NULL DEFAULT 1,
  metadata jsonb,
  created_at timestamptz NOT NULL DEFAULT now()
);

-- Evidence bundles for custody-grade packaging
CREATE TABLE public.evidence_bundles (
  id uuid PRIMARY KEY DEFAULT gen_random_uuid(),
  organization_id uuid NOT NULL REFERENCES public.organizations(id),
  call_id uuid NOT NULL REFERENCES public.calls(id),
  recording_id uuid REFERENCES public.recordings(id),
  manifest_id uuid NOT NULL REFERENCES public.evidence_manifests(id),
  manifest_hash text NOT NULL,
  artifact_hashes jsonb NOT NULL DEFAULT '[]'::jsonb,  -- List of {type, id, sha256}
  bundle_payload jsonb NOT NULL,                       -- Canonical payload
  bundle_hash text NOT NULL,                           -- SHA256 of payload
  bundle_hash_algo text NOT NULL DEFAULT 'sha256',
  version integer NOT NULL DEFAULT 1,
  parent_bundle_id uuid REFERENCES public.evidence_bundles(id),
  superseded_at timestamptz,
  superseded_by uuid REFERENCES public.evidence_bundles(id),
  immutable_storage boolean NOT NULL DEFAULT true,
  is_authoritative boolean NOT NULL DEFAULT true,
  produced_by text NOT NULL DEFAULT 'system_cas',
  immutability_policy text NOT NULL DEFAULT 'immutable'
    CHECK (immutability_policy IN ('immutable', 'limited', 'mutable')),
  tsa jsonb,                                           -- RFC3161 token payload
  tsa_status text NOT NULL DEFAULT 'not_configured'
    CHECK (tsa_status IN ('not_configured', 'pending', 'completed', 'error')),
  tsa_requested_at timestamptz,
  tsa_received_at timestamptz,
  tsa_error text,
  created_at timestamptz NOT NULL DEFAULT now()
);

-- Export bundle tracking for portability
CREATE TABLE public.call_export_bundles (
  id uuid PRIMARY KEY DEFAULT gen_random_uuid(),
  organization_id uuid NOT NULL REFERENCES public.organizations(id),
  call_id uuid NOT NULL REFERENCES public.calls(id),
  bundle_hash text NOT NULL,                  -- SHA256 of entire bundle
  artifacts_included jsonb NOT NULL,          -- List of {type, id, hash}
  storage_path text,                          -- Path in storage bucket
  exported_by uuid REFERENCES public.users(id),
  exported_at timestamptz NOT NULL DEFAULT now(),
  expires_at timestamptz,                     -- Optional expiration
  download_count integer DEFAULT 0,
  metadata jsonb
);

-- Additional columns for System of Record compliance:
-- recordings: source, external_call_id, media_hash, is_altered, original_url, is_deleted, deleted_at, deleted_by
-- calls: is_deleted, deleted_at, deleted_by
-- ai_runs: is_deleted, deleted_at, deleted_by
-- scored_recordings: is_deleted, deleted_at, deleted_by
-- evidence_manifests: version, parent_manifest_id, superseded_at, superseded_by

-- =============================================================================
-- STRIPE BILLING TABLES (Migration: 20260116_stripe_billing)
-- =============================================================================

-- Subscriptions table: Track Stripe subscription state
CREATE TABLE public.stripe_subscriptions (
  id uuid PRIMARY KEY DEFAULT uuid_generate_v4(),
  organization_id uuid NOT NULL REFERENCES public.organizations(id) ON DELETE CASCADE,
  
  -- Stripe identifiers
  stripe_customer_id text NOT NULL,
  stripe_subscription_id text UNIQUE NOT NULL,
  stripe_price_id text NOT NULL,
  
  -- Subscription details
  plan text NOT NULL CHECK (plan IN ('free', 'pro', 'business', 'enterprise')),
  status text NOT NULL CHECK (status IN ('active', 'canceled', 'past_due', 'unpaid', 'incomplete', 'incomplete_expired', 'trialing', 'paused')),
  
  -- Billing cycle
  current_period_start timestamptz NOT NULL,
  current_period_end timestamptz NOT NULL,
  cancel_at_period_end boolean NOT NULL DEFAULT false,
  canceled_at timestamptz,
  
  -- Pricing
  amount_cents integer NOT NULL,
  currency text NOT NULL DEFAULT 'usd',
  interval text NOT NULL CHECK (interval IN ('month', 'year')),
  
  -- Trial
  trial_start timestamptz,
  trial_end timestamptz,
  
  -- Metadata
  created_at timestamptz NOT NULL DEFAULT now(),
  updated_at timestamptz NOT NULL DEFAULT now(),
  
  -- Constraints
  UNIQUE(organization_id, stripe_subscription_id)
);

-- Payment methods table: Track customer payment methods
CREATE TABLE public.stripe_payment_methods (
  id uuid PRIMARY KEY DEFAULT uuid_generate_v4(),
  organization_id uuid NOT NULL REFERENCES public.organizations(id) ON DELETE CASCADE,
  stripe_customer_id text NOT NULL,
  stripe_payment_method_id text UNIQUE NOT NULL,
  
  -- Payment method details
  type text NOT NULL CHECK (type IN ('card', 'bank_account', 'sepa_debit', 'us_bank_account')),
  is_default boolean NOT NULL DEFAULT false,
  
  -- Card details (if type = 'card')
  card_brand text,
  card_last4 text,
  card_exp_month integer,
  card_exp_year integer,
  
  -- Bank details (if type = 'bank_account' or 'us_bank_account')
  bank_name text,
  bank_last4 text,
  
  -- Metadata
  created_at timestamptz NOT NULL DEFAULT now(),
  updated_at timestamptz NOT NULL DEFAULT now()
);

-- Invoice history table: Track billing history
CREATE TABLE public.stripe_invoices (
  id uuid PRIMARY KEY DEFAULT uuid_generate_v4(),
  organization_id uuid NOT NULL REFERENCES public.organizations(id) ON DELETE CASCADE,
  stripe_invoice_id text UNIQUE NOT NULL,
  stripe_customer_id text NOT NULL,
  stripe_subscription_id text,
  
  -- Invoice details
  status text NOT NULL CHECK (status IN ('draft', 'open', 'paid', 'void', 'uncollectible')),
  amount_due_cents integer NOT NULL,
  amount_paid_cents integer NOT NULL DEFAULT 0,
  currency text NOT NULL DEFAULT 'usd',
  
  -- Dates
  invoice_date timestamptz NOT NULL,
  due_date timestamptz,
  paid_at timestamptz,
  
  -- Links
  invoice_pdf_url text,
  hosted_invoice_url text,
  
  -- Metadata
  created_at timestamptz NOT NULL DEFAULT now(),
  updated_at timestamptz NOT NULL DEFAULT now()
);

-- Billing events log: Audit trail for all billing events
CREATE TABLE public.stripe_events (
  id uuid PRIMARY KEY DEFAULT uuid_generate_v4(),
  stripe_event_id text UNIQUE NOT NULL,
  event_type text NOT NULL,
  organization_id uuid REFERENCES public.organizations(id) ON DELETE SET NULL,
  
  -- Event data
  data jsonb NOT NULL,
  processed boolean NOT NULL DEFAULT false,
  error_message text,
  
  -- Metadata
  created_at timestamptz NOT NULL DEFAULT now(),
  processed_at timestamptz
);

-- =============================================================================
-- USAGE METERING TABLES (Migration: 20260116_usage_metering)
-- =============================================================================

-- Usage Records Table: Tracks all billable usage events per organization
CREATE TABLE public.usage_records (
  id uuid PRIMARY KEY DEFAULT gen_random_uuid(),
  organization_id uuid NOT NULL REFERENCES public.organizations(id) ON DELETE CASCADE,
  call_id uuid REFERENCES public.calls(id) ON DELETE SET NULL,
  
  -- Usage metrics
  metric text NOT NULL CHECK (metric IN ('call', 'minute', 'transcription', 'translation', 'ai_run')),
  quantity integer NOT NULL DEFAULT 1,
  unit_cost_cents integer,
  
  -- Billing period tracking
  billing_period_start timestamptz NOT NULL,
  billing_period_end timestamptz NOT NULL,
  
  -- Metadata
  metadata jsonb DEFAULT '{}'::jsonb,
  created_at timestamptz NOT NULL DEFAULT now()
);

-- Usage Limits Table: Define plan limits per organization
CREATE TABLE public.usage_limits (
  id uuid PRIMARY KEY DEFAULT gen_random_uuid(),
  organization_id uuid NOT NULL REFERENCES public.organizations(id) ON DELETE CASCADE,
  
  -- Limits per metric
  metric text NOT NULL CHECK (metric IN ('call', 'minute', 'transcription', 'translation', 'ai_run')),
  limit_value integer NOT NULL,
  billing_period text NOT NULL CHECK (billing_period IN ('month', 'year', 'lifetime')),
  
  -- Enforcement
  enforce_limit boolean NOT NULL DEFAULT true,
  notify_at_percent integer DEFAULT 80 CHECK (notify_at_percent > 0 AND notify_at_percent <= 100),
  
  -- Metadata
  created_at timestamptz NOT NULL DEFAULT now(),
  updated_at timestamptz NOT NULL DEFAULT now(),
  
  UNIQUE(organization_id, metric, billing_period)
);

-- =============================================================================
-- AI AGENT CONFIGURATION (Migration: 20260116_ai_agent_config)
-- =============================================================================

-- AI Agent Audit Log: Tracks configuration changes
CREATE TABLE public.ai_agent_audit_log (
  id uuid PRIMARY KEY DEFAULT uuid_generate_v4(),
  organization_id uuid NOT NULL REFERENCES public.organizations(id) ON DELETE CASCADE,
  changed_by uuid REFERENCES public.users(id),
  change_type text NOT NULL CHECK (change_type IN ('created', 'updated', 'deleted', 'enabled', 'disabled')),
  old_config jsonb,
  new_config jsonb,
  change_reason text,
  created_at timestamptz NOT NULL DEFAULT now()
);

-- Note: AI Agent configuration fields are added to voice_configs table:
-- - ai_agent_id text
-- - ai_agent_prompt text
-- - ai_agent_temperature numeric(3,2) DEFAULT 0.3
-- - ai_agent_model text DEFAULT 'gpt-4o-mini'
-- - ai_post_prompt_url text
-- - ai_features_enabled boolean DEFAULT true

-- =============================================================================
-- CAMPAIGN MANAGER TABLES (Migration: 20260117000000_campaigns)
-- =============================================================================

-- Campaigns table: Manage bulk outbound calling campaigns
CREATE TABLE public.campaigns (
  id uuid PRIMARY KEY DEFAULT gen_random_uuid(),
  organization_id uuid NOT NULL REFERENCES public.organizations(id) ON DELETE CASCADE,
  name text NOT NULL,
  description text,
  
  -- Campaign configuration
  status text NOT NULL DEFAULT 'draft' CHECK (status IN ('draft', 'scheduled', 'active', 'paused', 'completed', 'canceled')),
  call_flow_type text NOT NULL CHECK (call_flow_type IN ('secret_shopper', 'survey', 'outbound', 'test')),
  
  -- Target configuration
  target_list jsonb NOT NULL DEFAULT '[]'::jsonb, -- Array of {phone, metadata}
  caller_id_id uuid REFERENCES public.caller_id_numbers(id) ON DELETE SET NULL,
  
  -- Script configuration
  script_id uuid REFERENCES public.shopper_scripts(id) ON DELETE SET NULL,
  survey_id uuid REFERENCES public.surveys(id) ON DELETE SET NULL,
  custom_prompt text,
  
  -- Scheduling
  schedule_type text NOT NULL DEFAULT 'immediate' CHECK (schedule_type IN ('immediate', 'scheduled', 'recurring')),
  scheduled_at timestamptz,
  recurring_pattern jsonb, -- cron-like pattern: {frequency: 'daily' | 'weekly', time: 'HH:MM', days: [0-6]}
  
  -- Call configuration
  call_config jsonb DEFAULT '{}'::jsonb, -- {max_duration, timeout, retry_attempts}
  
  -- Progress tracking
  total_targets integer NOT NULL DEFAULT 0,
  calls_completed integer NOT NULL DEFAULT 0,
  calls_successful integer NOT NULL DEFAULT 0,
  calls_failed integer NOT NULL DEFAULT 0,
  
  -- Audit fields
  created_by uuid NOT NULL REFERENCES public.users(id),
  created_at timestamptz NOT NULL DEFAULT now(),
  updated_at timestamptz NOT NULL DEFAULT now(),
  started_at timestamptz,
  completed_at timestamptz
);

-- Campaign calls table: Track individual calls within a campaign
CREATE TABLE public.campaign_calls (
  id uuid PRIMARY KEY DEFAULT gen_random_uuid(),
  campaign_id uuid NOT NULL REFERENCES public.campaigns(id) ON DELETE CASCADE,
  call_id uuid REFERENCES public.calls(id) ON DELETE SET NULL,
  
  -- Target information
  target_phone text NOT NULL,
  target_metadata jsonb DEFAULT '{}'::jsonb,
  
  -- Execution status
  status text NOT NULL DEFAULT 'pending' CHECK (status IN ('pending', 'calling', 'completed', 'failed', 'canceled')),
  attempt_number integer NOT NULL DEFAULT 1,
  max_attempts integer NOT NULL DEFAULT 3,
  
  -- Result tracking
  outcome text CHECK (outcome IN ('answered', 'no_answer', 'busy', 'failed', 'error')),
  duration_seconds integer,
  error_message text,
  
  -- Scoring (for secret shopper campaigns)
  score_data jsonb,
  
  -- Timestamps
  scheduled_for timestamptz,
  started_at timestamptz,
  completed_at timestamptz,
  created_at timestamptz NOT NULL DEFAULT now(),
  updated_at timestamptz NOT NULL DEFAULT now()
);

-- Campaign audit log: Track all campaign changes
CREATE TABLE public.campaign_audit_log (
  id uuid PRIMARY KEY DEFAULT gen_random_uuid(),
  campaign_id uuid NOT NULL REFERENCES public.campaigns(id) ON DELETE CASCADE,
  user_id uuid REFERENCES public.users(id) ON DELETE SET NULL,
  action text NOT NULL, -- created, updated, started, paused, resumed, completed, canceled
  changes jsonb, -- Before/after snapshot
  created_at timestamptz NOT NULL DEFAULT now()
);

-- =============================================================================
-- REPORT BUILDER TABLES (Migration: 20260117000001_reports)
-- =============================================================================

-- Report templates: Reusable report configurations
CREATE TABLE public.report_templates (
  id uuid PRIMARY KEY DEFAULT gen_random_uuid(),
  organization_id uuid NOT NULL REFERENCES public.organizations(id) ON DELETE CASCADE,
  name text NOT NULL,
  description text,
  
  -- Report configuration
  report_type text NOT NULL CHECK (report_type IN ('call_volume', 'quality_scorecard', 'campaign_performance', 'custom')),
  data_source text NOT NULL CHECK (data_source IN ('calls', 'campaigns', 'scorecards', 'surveys', 'multi')),
  
  -- Filters and parameters
  filters jsonb NOT NULL DEFAULT '{}'::jsonb, -- {date_range, statuses, users, tags, etc}
  metrics jsonb NOT NULL DEFAULT '[]'::jsonb, -- Array of metric names to include
  dimensions jsonb NOT NULL DEFAULT '[]'::jsonb, -- Group by dimensions
  
  -- Visualization config
  visualization_config jsonb DEFAULT '{}'::jsonb, -- Chart types, colors, layout
  
  -- Access control
  is_public boolean NOT NULL DEFAULT false, -- Accessible to all org members
  created_by uuid NOT NULL REFERENCES public.users(id),
  
  -- Timestamps
  created_at timestamptz NOT NULL DEFAULT now(),
  updated_at timestamptz NOT NULL DEFAULT now()
);

-- Generated reports: Instances of report execution
CREATE TABLE public.generated_reports (
  id uuid PRIMARY KEY DEFAULT gen_random_uuid(),
  template_id uuid NOT NULL REFERENCES public.report_templates(id) ON DELETE CASCADE,
  organization_id uuid NOT NULL REFERENCES public.organizations(id) ON DELETE CASCADE,
  
  -- Report metadata
  name text NOT NULL,
  file_path text, -- S3/storage path for exported report
  file_format text CHECK (file_format IN ('pdf', 'csv', 'xlsx', 'json')),
  file_size_bytes integer,
  
  -- Report data (for JSON reports, stored inline)
  report_data jsonb, -- Actual report results
  
  -- Generation metadata
  parameters jsonb NOT NULL DEFAULT '{}'::jsonb, -- Parameters used for generation
  generated_by uuid NOT NULL REFERENCES public.users(id),
  generated_at timestamptz NOT NULL DEFAULT now(),
  
  -- Status tracking
  status text NOT NULL DEFAULT 'generating' CHECK (status IN ('generating', 'completed', 'failed')),
  error_message text,
  generation_duration_ms integer,
  
  -- Expiration
  expires_at timestamptz, -- Auto-delete after this date
  
  created_at timestamptz NOT NULL DEFAULT now()
);

-- Scheduled reports: Automated report generation
CREATE TABLE public.scheduled_reports (
  id uuid PRIMARY KEY DEFAULT gen_random_uuid(),
  template_id uuid NOT NULL REFERENCES public.report_templates(id) ON DELETE CASCADE,
  organization_id uuid NOT NULL REFERENCES public.organizations(id) ON DELETE CASCADE,
  
  -- Schedule configuration
  name text NOT NULL,
  schedule_pattern text NOT NULL, -- cron-like: 'daily', 'weekly', 'monthly'
  schedule_time time NOT NULL DEFAULT '09:00:00', -- Time of day to run
  schedule_days integer[], -- Days of week (0-6) or month (1-31)
  timezone text NOT NULL DEFAULT 'UTC',
  
  -- Delivery configuration
  delivery_method text NOT NULL DEFAULT 'email' CHECK (delivery_method IN ('email', 'webhook', 'storage')),
  delivery_config jsonb NOT NULL DEFAULT '{}'::jsonb, -- {emails: [], webhook_url: '', etc}
  
  -- Status
  is_active boolean NOT NULL DEFAULT true,
  last_run_at timestamptz,
  next_run_at timestamptz,
  
  -- Audit
  created_by uuid NOT NULL REFERENCES public.users(id),
  created_at timestamptz NOT NULL DEFAULT now(),
  updated_at timestamptz NOT NULL DEFAULT now()
);

-- Report access log: Track who viewed which reports
CREATE TABLE public.report_access_log (
  id uuid PRIMARY KEY DEFAULT gen_random_uuid(),
  report_id uuid NOT NULL REFERENCES public.generated_reports(id) ON DELETE CASCADE,
  user_id uuid NOT NULL REFERENCES public.users(id) ON DELETE SET NULL,
  action text NOT NULL CHECK (action IN ('viewed', 'downloaded', 'shared')),
  accessed_at timestamptz NOT NULL DEFAULT now()
);