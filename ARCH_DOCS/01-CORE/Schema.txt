-- WARNING: This schema is for context only and is not meant to be run.
-- Table order and constraints may not be valid for execution.

CREATE TABLE public.access_grants_archived (
  id uuid NOT NULL,
  organization_id uuid,
  user_id uuid,
  role_id uuid,
  system_id uuid,
  created_at timestamp with time zone DEFAULT now(),
  CONSTRAINT access_grants_archived_pkey PRIMARY KEY (id),
  CONSTRAINT access_grants_organization_id_fkey FOREIGN KEY (organization_id) REFERENCES public.organizations(id),
  CONSTRAINT access_grants_role_id_fkey FOREIGN KEY (role_id) REFERENCES public.roles_archived(id),
  CONSTRAINT access_grants_system_id_fkey FOREIGN KEY (system_id) REFERENCES public.systems(id)
);
CREATE TABLE public.accounts (
  id text NOT NULL,
  user_id text NOT NULL,
  type text NOT NULL,
  provider text NOT NULL,
  provider_account_id text NOT NULL,
  refresh_token text,
  access_token text,
  expires_at integer,
  token_type text,
  scope text,
  id_token text,
  session_state text,
  oauth_token_secret text,
  oauth_token text,
  providerAccountId text DEFAULT provider_account_id,
  CONSTRAINT accounts_pkey PRIMARY KEY (id)
);
CREATE TABLE public.ai_agent_audit_log (
  id uuid NOT NULL DEFAULT uuid_generate_v4(),
  organization_id uuid NOT NULL,
  changed_by uuid,
  change_type text NOT NULL CHECK (change_type = ANY (ARRAY['created'::text, 'updated'::text, 'deleted'::text, 'enabled'::text, 'disabled'::text])),
  old_config jsonb,
  new_config jsonb,
  change_reason text,
  created_at timestamp with time zone NOT NULL DEFAULT now(),
  CONSTRAINT ai_agent_audit_log_pkey PRIMARY KEY (id),
  CONSTRAINT ai_agent_audit_log_organization_id_fkey FOREIGN KEY (organization_id) REFERENCES public.organizations(id)
);
CREATE TABLE public.ai_runs (
  id uuid NOT NULL,
  call_id uuid,
  system_id uuid,
  model text,
  status text,
  started_at timestamp with time zone,
  completed_at timestamp with time zone,
  output jsonb,
  is_deleted boolean DEFAULT false,
  deleted_at timestamp with time zone,
  deleted_by uuid,
  is_authoritative boolean NOT NULL DEFAULT false,
  produced_by text,
  job_id text,
  CONSTRAINT ai_runs_pkey PRIMARY KEY (id),
  CONSTRAINT ai_runs_call_id_fkey FOREIGN KEY (call_id) REFERENCES public.calls(id),
  CONSTRAINT ai_runs_system_id_fkey FOREIGN KEY (system_id) REFERENCES public.systems(id)
);
CREATE TABLE public.alert_acknowledgements (
  id uuid NOT NULL DEFAULT gen_random_uuid(),
  alert_id uuid,
  user_id uuid,
  acknowledged_at timestamp with time zone DEFAULT now(),
  acknowledgement_message text,
  created_at timestamp with time zone DEFAULT now(),
  CONSTRAINT alert_acknowledgements_pkey PRIMARY KEY (id)
);
CREATE TABLE public.alerts (
  id uuid NOT NULL DEFAULT gen_random_uuid(),
  organization_id uuid,
  test_config_id uuid,
  rule jsonb,
  enabled boolean DEFAULT true,
  last_triggered timestamp with time zone,
  CONSTRAINT alerts_pkey PRIMARY KEY (id),
  CONSTRAINT alerts_organization_id_fkey FOREIGN KEY (organization_id) REFERENCES public.organizations(id),
  CONSTRAINT alerts_test_config_id_fkey FOREIGN KEY (test_config_id) REFERENCES public.test_configs(id)
);
CREATE TABLE public.artifact_provenance (
  id uuid NOT NULL DEFAULT gen_random_uuid(),
  organization_id uuid NOT NULL,
  artifact_type text NOT NULL CHECK (artifact_type = ANY (ARRAY['recording'::text, 'transcript'::text, 'translation'::text, 'survey'::text, 'score'::text, 'evidence_manifest'::text, 'evidence_bundle'::text])),
  artifact_id uuid NOT NULL,
  parent_artifact_id uuid,
  parent_artifact_type text,
  produced_by text NOT NULL CHECK (produced_by = ANY (ARRAY['system'::text, 'human'::text, 'model'::text])),
  produced_by_model text,
  produced_by_user_id uuid,
  produced_by_system_id uuid,
  produced_at timestamp with time zone NOT NULL DEFAULT now(),
  input_refs jsonb,
  version integer NOT NULL DEFAULT 1,
  metadata jsonb,
  created_at timestamp with time zone NOT NULL DEFAULT now(),
  CONSTRAINT artifact_provenance_pkey PRIMARY KEY (id),
  CONSTRAINT artifact_provenance_organization_id_fkey FOREIGN KEY (organization_id) REFERENCES public.organizations(id),
  CONSTRAINT artifact_provenance_produced_by_system_id_fkey FOREIGN KEY (produced_by_system_id) REFERENCES public.systems(id)
);
CREATE TABLE public.artifacts (
  id text NOT NULL,
  type text NOT NULL,
  title text,
  created_at timestamp with time zone DEFAULT now(),
  duration_seconds integer,
  size_bytes bigint,
  storage_bucket text,
  storage_path text,
  provenance jsonb,
  transcript jsonb,
  evidence_manifest jsonb,
  CONSTRAINT artifacts_pkey PRIMARY KEY (id)
);
CREATE TABLE public.attention_decisions (
  id uuid NOT NULL DEFAULT gen_random_uuid(),
  organization_id uuid NOT NULL,
  attention_event_id uuid NOT NULL,
  decision text NOT NULL CHECK (decision = ANY (ARRAY['escalate'::text, 'suppress'::text, 'include_in_digest'::text, 'needs_review'::text])),
  reason text NOT NULL,
  policy_id uuid,
  confidence integer CHECK (confidence >= 0 AND confidence <= 100),
  uncertainty_notes text,
  produced_by text NOT NULL CHECK (produced_by = ANY (ARRAY['system'::text, 'human'::text, 'model'::text])),
  produced_by_model text,
  produced_by_user_id uuid,
  input_refs jsonb NOT NULL DEFAULT '[]'::jsonb,
  created_at timestamp with time zone NOT NULL DEFAULT now(),
  CONSTRAINT attention_decisions_pkey PRIMARY KEY (id),
  CONSTRAINT attention_decisions_org_fkey FOREIGN KEY (organization_id) REFERENCES public.organizations(id),
  CONSTRAINT attention_decisions_event_fkey FOREIGN KEY (attention_event_id) REFERENCES public.attention_events(id),
  CONSTRAINT attention_decisions_policy_fkey FOREIGN KEY (policy_id) REFERENCES public.attention_policies(id)
);
CREATE TABLE public.attention_events (
  id uuid NOT NULL DEFAULT gen_random_uuid(),
  organization_id uuid NOT NULL,
  event_type text NOT NULL CHECK (event_type = ANY (ARRAY['call_completed'::text, 'alert_triggered'::text, 'webhook_failed'::text, 'carrier_degraded'::text, 'campaign_ended'::text, 'evidence_generated'::text, 'system_error'::text])),
  source_table text NOT NULL,
  source_id uuid NOT NULL,
  occurred_at timestamp with time zone NOT NULL,
  payload_snapshot jsonb NOT NULL DEFAULT '{}'::jsonb,
  input_refs jsonb NOT NULL DEFAULT '[]'::jsonb,
  created_at timestamp with time zone NOT NULL DEFAULT now(),
  CONSTRAINT attention_events_pkey PRIMARY KEY (id),
  CONSTRAINT attention_events_org_fkey FOREIGN KEY (organization_id) REFERENCES public.organizations(id)
);
CREATE TABLE public.attention_policies (
  id uuid NOT NULL DEFAULT gen_random_uuid(),
  organization_id uuid NOT NULL,
  name text NOT NULL,
  description text,
  policy_type text NOT NULL CHECK (policy_type = ANY (ARRAY['quiet_hours'::text, 'threshold'::text, 'recurring_suppress'::text, 'keyword_escalate'::text, 'custom'::text])),
  policy_config jsonb NOT NULL DEFAULT '{}'::jsonb,
  priority integer NOT NULL DEFAULT 100,
  is_enabled boolean NOT NULL DEFAULT true,
  created_by uuid NOT NULL,
  created_at timestamp with time zone NOT NULL DEFAULT now(),
  updated_at timestamp with time zone NOT NULL DEFAULT now(),
  CONSTRAINT attention_policies_pkey PRIMARY KEY (id),
  CONSTRAINT attention_policies_org_fkey FOREIGN KEY (organization_id) REFERENCES public.organizations(id)
);
CREATE TABLE public.audit_logs (
  id uuid NOT NULL,
  organization_id uuid,
  user_id uuid,
  system_id uuid,
  resource_type text,
  resource_id uuid,
  action text,
  before jsonb,
  after jsonb,
  created_at timestamp with time zone DEFAULT now(),
  actor_type text CHECK (actor_type = ANY (ARRAY['human'::text, 'system'::text, 'vendor'::text, 'automation'::text])),
  actor_label text,
  CONSTRAINT audit_logs_pkey PRIMARY KEY (id),
  CONSTRAINT audit_logs_organization_id_fkey FOREIGN KEY (organization_id) REFERENCES public.organizations(id),
  CONSTRAINT audit_logs_system_id_fkey FOREIGN KEY (system_id) REFERENCES public.systems(id)
);
CREATE TABLE public.booking_events (
  id uuid NOT NULL DEFAULT gen_random_uuid(),
  organization_id uuid NOT NULL,
  user_id uuid,
  call_id uuid,
  title text NOT NULL,
  description text,
  start_time timestamp with time zone NOT NULL,
  end_time timestamp with time zone NOT NULL,
  duration_minutes integer NOT NULL DEFAULT 30,
  timezone text DEFAULT 'UTC'::text,
  attendee_name text,
  attendee_email text,
  attendee_phone text NOT NULL,
  status text NOT NULL DEFAULT 'pending'::text,
  reminder_sent boolean DEFAULT false,
  modulations jsonb DEFAULT '{}'::jsonb,
  notes text,
  created_at timestamp with time zone DEFAULT now(),
  updated_at timestamp with time zone DEFAULT now(),
  created_by uuid,
  from_number text,
  CONSTRAINT booking_events_pkey PRIMARY KEY (id),
  CONSTRAINT booking_events_organization_id_fkey FOREIGN KEY (organization_id) REFERENCES public.organizations(id),
  CONSTRAINT booking_events_call_id_fkey FOREIGN KEY (call_id) REFERENCES public.calls(id)
);
CREATE TABLE public.call_confirmation_checklists (
  id uuid NOT NULL DEFAULT gen_random_uuid(),
  call_id uuid NOT NULL,
  template_id uuid NOT NULL,
  organization_id uuid NOT NULL,
  status text NOT NULL DEFAULT 'pending'::text CHECK (status = ANY (ARRAY['pending'::text, 'confirmed'::text, 'declined'::text, 'skipped'::text, 'not_applicable'::text])),
  confirmation_id uuid,
  skip_reason text,
  created_at timestamp with time zone NOT NULL DEFAULT now(),
  updated_at timestamp with time zone NOT NULL DEFAULT now(),
  CONSTRAINT call_confirmation_checklists_pkey PRIMARY KEY (id),
  CONSTRAINT call_confirmation_checklists_call_id_fkey FOREIGN KEY (call_id) REFERENCES public.calls(id),
  CONSTRAINT call_confirmation_checklists_template_id_fkey FOREIGN KEY (template_id) REFERENCES public.confirmation_templates(id),
  CONSTRAINT call_confirmation_checklists_organization_id_fkey FOREIGN KEY (organization_id) REFERENCES public.organizations(id),
  CONSTRAINT call_confirmation_checklists_confirmation_id_fkey FOREIGN KEY (confirmation_id) REFERENCES public.call_confirmations(id)
);
CREATE TABLE public.call_confirmations (
  id uuid NOT NULL DEFAULT gen_random_uuid(),
  call_id uuid NOT NULL,
  organization_id uuid NOT NULL,
  confirmation_type text NOT NULL CHECK (confirmation_type = ANY (ARRAY['disclosure_accepted'::text, 'recording_consent'::text, 'terms_agreed'::text, 'price_confirmed'::text, 'scope_confirmed'::text, 'identity_verified'::text, 'authorization_given'::text, 'understanding_confirmed'::text, 'custom'::text])),
  confirmation_label text,
  prompt_text text NOT NULL,
  confirmer_role text NOT NULL CHECK (confirmer_role = ANY (ARRAY['customer'::text, 'operator'::text, 'third_party'::text, 'both'::text])),
  confirmed_at timestamp with time zone NOT NULL DEFAULT now(),
  recording_timestamp_seconds numeric,
  captured_by text NOT NULL DEFAULT 'human'::text CHECK (captured_by = ANY (ARRAY['human'::text, 'system'::text])),
  captured_by_user_id uuid,
  verification_method text CHECK (verification_method = ANY (ARRAY['verbal'::text, 'keypress'::text, 'biometric'::text, 'document'::text, 'other'::text])),
  notes text,
  created_at timestamp with time zone NOT NULL DEFAULT now(),
  updated_at timestamp with time zone NOT NULL DEFAULT now(),
  CONSTRAINT call_confirmations_pkey PRIMARY KEY (id),
  CONSTRAINT call_confirmations_call_id_fkey FOREIGN KEY (call_id) REFERENCES public.calls(id),
  CONSTRAINT call_confirmations_organization_id_fkey FOREIGN KEY (organization_id) REFERENCES public.organizations(id)
);
CREATE TABLE public.call_export_bundles (
  id uuid NOT NULL DEFAULT gen_random_uuid(),
  organization_id uuid NOT NULL,
  call_id uuid NOT NULL,
  bundle_hash text NOT NULL,
  artifacts_included jsonb NOT NULL,
  storage_path text,
  exported_by uuid,
  exported_at timestamp with time zone NOT NULL DEFAULT now(),
  expires_at timestamp with time zone,
  download_count integer DEFAULT 0,
  metadata jsonb,
  CONSTRAINT call_export_bundles_pkey PRIMARY KEY (id),
  CONSTRAINT call_export_bundles_organization_id_fkey FOREIGN KEY (organization_id) REFERENCES public.organizations(id),
  CONSTRAINT call_export_bundles_call_id_fkey FOREIGN KEY (call_id) REFERENCES public.calls(id)
);
CREATE TABLE public.call_notes (
  id uuid NOT NULL DEFAULT gen_random_uuid(),
  call_id uuid NOT NULL,
  organization_id uuid NOT NULL,
  tags ARRAY DEFAULT '{}'::text[],
  note text,
  created_by uuid NOT NULL,
  created_at timestamp with time zone DEFAULT now(),
  updated_at timestamp with time zone DEFAULT now(),
  CONSTRAINT call_notes_pkey PRIMARY KEY (id)
);
CREATE TABLE public.caller_id_default_rules (
  id uuid NOT NULL DEFAULT gen_random_uuid(),
  organization_id uuid NOT NULL,
  scope_type text NOT NULL CHECK (scope_type = ANY (ARRAY['organization'::text, 'user'::text, 'role'::text])),
  user_id uuid,
  role_scope text,
  caller_id_number_id uuid NOT NULL,
  priority integer NOT NULL DEFAULT 100,
  is_active boolean NOT NULL DEFAULT true,
  effective_from timestamp with time zone NOT NULL DEFAULT now(),
  effective_until timestamp with time zone,
  created_by uuid NOT NULL,
  created_at timestamp with time zone NOT NULL DEFAULT now(),
  updated_at timestamp with time zone NOT NULL DEFAULT now(),
  CONSTRAINT caller_id_default_rules_pkey PRIMARY KEY (id),
  CONSTRAINT caller_id_default_rules_org_fkey FOREIGN KEY (organization_id) REFERENCES public.organizations(id),
  CONSTRAINT caller_id_default_rules_caller_id_fkey FOREIGN KEY (caller_id_number_id) REFERENCES public.caller_id_numbers(id)
);
CREATE TABLE public.caller_id_numbers (
  id uuid NOT NULL DEFAULT gen_random_uuid(),
  organization_id uuid NOT NULL,
  phone_number text NOT NULL,
  display_name text,
  is_verified boolean DEFAULT false,
  verification_code text,
  verified_at timestamp with time zone,
  signalwire_verification_sid text,
  is_default boolean DEFAULT false,
  use_count integer DEFAULT 0,
  last_used_at timestamp with time zone,
  created_at timestamp with time zone DEFAULT now(),
  created_by uuid,
  status text NOT NULL DEFAULT 'active'::text CHECK (status = ANY (ARRAY['active'::text, 'suspended'::text, 'retired'::text])),
  retired_at timestamp with time zone,
  retired_by uuid,
  notes text,
  CONSTRAINT caller_id_numbers_pkey PRIMARY KEY (id),
  CONSTRAINT caller_id_numbers_organization_id_fkey FOREIGN KEY (organization_id) REFERENCES public.organizations(id)
);
CREATE TABLE public.caller_id_permissions (
  id uuid NOT NULL DEFAULT gen_random_uuid(),
  organization_id uuid NOT NULL,
  caller_id_number_id uuid NOT NULL,
  user_id uuid NOT NULL,
  permission_type text NOT NULL DEFAULT 'use'::text CHECK (permission_type = ANY (ARRAY['use'::text, 'manage'::text, 'full'::text])),
  is_active boolean NOT NULL DEFAULT true,
  granted_at timestamp with time zone NOT NULL DEFAULT now(),
  granted_by uuid NOT NULL,
  revoked_at timestamp with time zone,
  revoked_by uuid,
  revoke_reason text,
  created_at timestamp with time zone NOT NULL DEFAULT now(),
  updated_at timestamp with time zone NOT NULL DEFAULT now(),
  CONSTRAINT caller_id_permissions_pkey PRIMARY KEY (id),
  CONSTRAINT caller_id_permissions_org_fkey FOREIGN KEY (organization_id) REFERENCES public.organizations(id),
  CONSTRAINT caller_id_permissions_caller_id_fkey FOREIGN KEY (caller_id_number_id) REFERENCES public.caller_id_numbers(id)
);
CREATE TABLE public.calls (
  id uuid NOT NULL CHECK (id IS NOT NULL AND id::text ~ '^[0-9a-f]{8}-[0-9a-f]{4}-4[0-9a-f]{3}-[89ab][0-9a-f]{3}-[0-9a-f]{12}$'::text),
  organization_id uuid,
  system_id uuid,
  status text,
  started_at timestamp with time zone,
  ended_at timestamp with time zone,
  created_by uuid,
  call_sid text,
  disposition text CHECK (disposition = ANY (ARRAY['sale'::text, 'no_answer'::text, 'voicemail'::text, 'not_interested'::text, 'follow_up'::text, 'wrong_number'::text, 'other'::text])),
  disposition_set_at timestamp with time zone,
  disposition_set_by uuid,
  consent_method text CHECK (consent_method = ANY (ARRAY['ivr_played'::text, 'verbal_yes'::text, 'dtmf_confirm'::text, 'written'::text, 'assumed'::text, 'none'::text])),
  consent_timestamp timestamp with time zone,
  consent_audio_offset_ms integer,
  disposition_notes text,
  is_deleted boolean DEFAULT false,
  deleted_at timestamp with time zone,
  deleted_by uuid,
  is_authoritative boolean NOT NULL DEFAULT true,
  immutability_policy text NOT NULL DEFAULT 'limited'::text CHECK (immutability_policy = ANY (ARRAY['immutable'::text, 'limited'::text, 'mutable'::text])),
  custody_status text NOT NULL DEFAULT 'active'::text CHECK (custody_status = ANY (ARRAY['active'::text, 'archived'::text, 'legal_hold'::text, 'expired'::text])),
  retention_class text NOT NULL DEFAULT 'default'::text CHECK (retention_class = ANY (ARRAY['default'::text, 'regulated'::text, 'legal_hold'::text])),
  legal_hold_flag boolean NOT NULL DEFAULT false,
  evidence_completeness text NOT NULL DEFAULT 'unknown'::text CHECK (evidence_completeness = ANY (ARRAY['unknown'::text, 'partial'::text, 'complete'::text, 'failed'::text])),
  disclosure_type text CHECK (disclosure_type = ANY (ARRAY['recording'::text, 'survey'::text, 'translation'::text, 'qa_evaluation'::text, 'multi'::text])),
  disclosure_given boolean DEFAULT false,
  disclosure_timestamp timestamp with time zone,
  disclosure_text text,
  caller_id_number_id uuid,
  caller_id_used text,
  CONSTRAINT calls_pkey PRIMARY KEY (id),
  CONSTRAINT calls_organization_id_fkey FOREIGN KEY (organization_id) REFERENCES public.organizations(id),
  CONSTRAINT calls_system_id_fkey FOREIGN KEY (system_id) REFERENCES public.systems(id),
  CONSTRAINT calls_caller_id_number_id_fkey FOREIGN KEY (caller_id_number_id) REFERENCES public.caller_id_numbers(id)
);
CREATE TABLE public.campaign_audit_log (
  id uuid NOT NULL DEFAULT gen_random_uuid(),
  campaign_id uuid NOT NULL,
  user_id uuid,
  action text NOT NULL,
  changes jsonb,
  created_at timestamp with time zone NOT NULL DEFAULT now(),
  CONSTRAINT campaign_audit_log_pkey PRIMARY KEY (id),
  CONSTRAINT campaign_audit_log_campaign_id_fkey FOREIGN KEY (campaign_id) REFERENCES public.campaigns(id)
);
CREATE TABLE public.campaign_calls (
  id uuid NOT NULL DEFAULT gen_random_uuid(),
  campaign_id uuid NOT NULL,
  call_id uuid,
  target_phone text NOT NULL,
  target_metadata jsonb DEFAULT '{}'::jsonb,
  status text NOT NULL DEFAULT 'pending'::text CHECK (status = ANY (ARRAY['pending'::text, 'calling'::text, 'completed'::text, 'failed'::text, 'canceled'::text])),
  attempt_number integer NOT NULL DEFAULT 1,
  max_attempts integer NOT NULL DEFAULT 3,
  outcome text CHECK (outcome = ANY (ARRAY['answered'::text, 'no_answer'::text, 'busy'::text, 'failed'::text, 'error'::text])),
  duration_seconds integer,
  error_message text,
  score_data jsonb,
  scheduled_for timestamp with time zone,
  started_at timestamp with time zone,
  completed_at timestamp with time zone,
  created_at timestamp with time zone NOT NULL DEFAULT now(),
  updated_at timestamp with time zone NOT NULL DEFAULT now(),
  CONSTRAINT campaign_calls_pkey PRIMARY KEY (id),
  CONSTRAINT campaign_calls_campaign_id_fkey FOREIGN KEY (campaign_id) REFERENCES public.campaigns(id),
  CONSTRAINT campaign_calls_call_id_fkey FOREIGN KEY (call_id) REFERENCES public.calls(id)
);
CREATE TABLE public.campaigns (
  id uuid NOT NULL DEFAULT gen_random_uuid(),
  organization_id uuid NOT NULL,
  name text NOT NULL,
  description text,
  status text NOT NULL DEFAULT 'draft'::text CHECK (status = ANY (ARRAY['draft'::text, 'scheduled'::text, 'active'::text, 'paused'::text, 'completed'::text, 'canceled'::text])),
  call_flow_type text NOT NULL CHECK (call_flow_type = ANY (ARRAY['secret_shopper'::text, 'survey'::text, 'outbound'::text, 'test'::text])),
  target_list jsonb NOT NULL DEFAULT '[]'::jsonb,
  caller_id_id uuid,
  script_id uuid,
  survey_id uuid,
  custom_prompt text,
  schedule_type text NOT NULL DEFAULT 'immediate'::text CHECK (schedule_type = ANY (ARRAY['immediate'::text, 'scheduled'::text, 'recurring'::text])),
  scheduled_at timestamp with time zone,
  recurring_pattern jsonb,
  call_config jsonb DEFAULT '{}'::jsonb,
  total_targets integer NOT NULL DEFAULT 0,
  calls_completed integer NOT NULL DEFAULT 0,
  calls_successful integer NOT NULL DEFAULT 0,
  calls_failed integer NOT NULL DEFAULT 0,
  created_by uuid NOT NULL,
  created_at timestamp with time zone NOT NULL DEFAULT now(),
  updated_at timestamp with time zone NOT NULL DEFAULT now(),
  started_at timestamp with time zone,
  completed_at timestamp with time zone,
  CONSTRAINT campaigns_pkey PRIMARY KEY (id),
  CONSTRAINT campaigns_caller_id_id_fkey FOREIGN KEY (caller_id_id) REFERENCES public.caller_id_numbers(id),
  CONSTRAINT campaigns_script_id_fkey FOREIGN KEY (script_id) REFERENCES public.shopper_scripts(id),
  CONSTRAINT campaigns_survey_id_fkey FOREIGN KEY (survey_id) REFERENCES public.surveys(id),
  CONSTRAINT campaigns_organization_id_fkey FOREIGN KEY (organization_id) REFERENCES public.organizations(id)
);
CREATE TABLE public.capabilities_archived (
  id uuid NOT NULL,
  system_id uuid,
  action text NOT NULL,
  description text,
  CONSTRAINT capabilities_archived_pkey PRIMARY KEY (id),
  CONSTRAINT capabilities_system_id_fkey FOREIGN KEY (system_id) REFERENCES public.systems(id)
);
CREATE TABLE public.carrier_status (
  id uuid NOT NULL DEFAULT uuid_generate_v4(),
  carrier_name text NOT NULL UNIQUE,
  status text NOT NULL CHECK (status = ANY (ARRAY['operational'::text, 'degraded'::text, 'outage'::text])),
  last_updated timestamp with time zone DEFAULT now(),
  official_url text,
  status_page_api text,
  description text,
  created_at timestamp with time zone DEFAULT now(),
  incident_count integer DEFAULT 0,
  last_incident_at timestamp with time zone,
  CONSTRAINT carrier_status_pkey PRIMARY KEY (id)
);
CREATE TABLE public.compliance_restrictions (
  id uuid NOT NULL DEFAULT gen_random_uuid(),
  organization_id uuid NOT NULL,
  restriction_code text NOT NULL UNIQUE CHECK (restriction_code = ANY (ARRAY['QA_NO_CONFIRMATIONS'::text, 'QA_NO_OUTCOMES'::text, 'QA_NO_AGREEMENTS'::text, 'SURVEY_NO_AGREEMENTS'::text, 'AI_NO_NEGOTIATION'::text])),
  restriction_name text NOT NULL,
  description text NOT NULL,
  is_active boolean DEFAULT true,
  violation_action text NOT NULL DEFAULT 'warn'::text CHECK (violation_action = ANY (ARRAY['block'::text, 'warn'::text, 'log'::text])),
  created_at timestamp with time zone NOT NULL DEFAULT now(),
  updated_at timestamp with time zone NOT NULL DEFAULT now(),
  CONSTRAINT compliance_restrictions_pkey PRIMARY KEY (id),
  CONSTRAINT compliance_restrictions_organization_id_fkey FOREIGN KEY (organization_id) REFERENCES public.organizations(id)
);
CREATE TABLE public.compliance_violations (
  id uuid NOT NULL DEFAULT gen_random_uuid(),
  organization_id uuid NOT NULL,
  call_id uuid,
  user_id uuid,
  restriction_code text NOT NULL,
  violation_type text NOT NULL CHECK (violation_type = ANY (ARRAY['blocked'::text, 'warned'::text, 'detected'::text, 'prevented'::text])),
  violation_context jsonb,
  resolution_status text DEFAULT 'open'::text CHECK (resolution_status = ANY (ARRAY['open'::text, 'reviewed'::text, 'dismissed'::text, 'confirmed'::text])),
  resolution_notes text,
  resolved_by uuid,
  resolved_at timestamp with time zone,
  created_at timestamp with time zone NOT NULL DEFAULT now(),
  CONSTRAINT compliance_violations_pkey PRIMARY KEY (id),
  CONSTRAINT compliance_violations_organization_id_fkey FOREIGN KEY (organization_id) REFERENCES public.organizations(id),
  CONSTRAINT compliance_violations_call_id_fkey FOREIGN KEY (call_id) REFERENCES public.calls(id)
);
CREATE TABLE public.confirmation_templates (
  id uuid NOT NULL DEFAULT gen_random_uuid(),
  organization_id uuid NOT NULL,
  confirmation_type text NOT NULL,
  label text NOT NULL,
  prompt_text text NOT NULL,
  description text,
  icon text DEFAULT 'ðŸ“‹'::text,
  display_order integer DEFAULT 0,
  is_active boolean DEFAULT true,
  is_required boolean DEFAULT false,
  use_cases ARRAY DEFAULT ARRAY['general'::text],
  created_at timestamp with time zone NOT NULL DEFAULT now(),
  updated_at timestamp with time zone NOT NULL DEFAULT now(),
  created_by uuid,
  CONSTRAINT confirmation_templates_pkey PRIMARY KEY (id),
  CONSTRAINT confirmation_templates_organization_id_fkey FOREIGN KEY (organization_id) REFERENCES public.organizations(id)
);
CREATE TABLE public.crm_object_links (
  id uuid NOT NULL DEFAULT gen_random_uuid(),
  organization_id uuid NOT NULL,
  integration_id uuid NOT NULL,
  call_id uuid NOT NULL,
  crm_object_type text NOT NULL CHECK (crm_object_type = ANY (ARRAY['contact'::text, 'company'::text, 'deal'::text, 'lead'::text, 'account'::text, 'opportunity'::text])),
  crm_object_id text NOT NULL,
  crm_object_name text,
  crm_object_url text,
  synced_at timestamp with time zone,
  sync_direction text NOT NULL CHECK (sync_direction = ANY (ARRAY['inbound'::text, 'outbound'::text])),
  created_at timestamp with time zone NOT NULL DEFAULT now(),
  updated_at timestamp with time zone NOT NULL DEFAULT now(),
  CONSTRAINT crm_object_links_pkey PRIMARY KEY (id),
  CONSTRAINT crm_object_links_organization_id_fkey FOREIGN KEY (organization_id) REFERENCES public.organizations(id),
  CONSTRAINT crm_object_links_integration_id_fkey FOREIGN KEY (integration_id) REFERENCES public.integrations(id),
  CONSTRAINT crm_object_links_call_id_fkey FOREIGN KEY (call_id) REFERENCES public.calls(id)
);
CREATE TABLE public.crm_sync_log (
  id uuid NOT NULL DEFAULT gen_random_uuid(),
  organization_id uuid NOT NULL,
  integration_id uuid NOT NULL,
  operation text NOT NULL CHECK (operation = ANY (ARRAY['oauth_connect'::text, 'oauth_disconnect'::text, 'oauth_refresh'::text, 'push_evidence'::text, 'push_note'::text, 'push_engagement'::text, 'pull_contact'::text, 'pull_company'::text, 'pull_deal'::text, 'link_object'::text, 'unlink_object'::text, 'error'::text, 'rate_limited'::text])),
  status text NOT NULL CHECK (status = ANY (ARRAY['pending'::text, 'success'::text, 'failed'::text, 'rate_limited'::text, 'skipped'::text])),
  call_id uuid,
  export_bundle_id uuid,
  crm_object_link_id uuid,
  idempotency_key text,
  request_summary jsonb,
  response_summary jsonb,
  error_details jsonb,
  started_at timestamp with time zone NOT NULL DEFAULT now(),
  completed_at timestamp with time zone,
  triggered_by text NOT NULL CHECK (triggered_by = ANY (ARRAY['user'::text, 'system'::text, 'webhook'::text, 'scheduler'::text])),
  triggered_by_user_id uuid,
  CONSTRAINT crm_sync_log_pkey PRIMARY KEY (id),
  CONSTRAINT crm_sync_log_export_bundle_id_fkey FOREIGN KEY (export_bundle_id) REFERENCES public.call_export_bundles(id),
  CONSTRAINT crm_sync_log_organization_id_fkey FOREIGN KEY (organization_id) REFERENCES public.organizations(id),
  CONSTRAINT crm_sync_log_integration_id_fkey FOREIGN KEY (integration_id) REFERENCES public.integrations(id),
  CONSTRAINT crm_sync_log_call_id_fkey FOREIGN KEY (call_id) REFERENCES public.calls(id)
);
CREATE TABLE public.digest_items (
  id uuid NOT NULL DEFAULT gen_random_uuid(),
  digest_id uuid NOT NULL,
  attention_decision_id uuid NOT NULL,
  item_order integer NOT NULL,
  is_highlighted boolean NOT NULL DEFAULT false,
  highlight_reason text,
  CONSTRAINT digest_items_pkey PRIMARY KEY (id),
  CONSTRAINT digest_items_digest_fkey FOREIGN KEY (digest_id) REFERENCES public.digests(id),
  CONSTRAINT digest_items_decision_fkey FOREIGN KEY (attention_decision_id) REFERENCES public.attention_decisions(id)
);
CREATE TABLE public.digests (
  id uuid NOT NULL DEFAULT gen_random_uuid(),
  organization_id uuid NOT NULL,
  digest_type text NOT NULL CHECK (digest_type = ANY (ARRAY['overnight'::text, 'weekly'::text, 'on_demand'::text])),
  period_start timestamp with time zone NOT NULL,
  period_end timestamp with time zone NOT NULL,
  summary_text text NOT NULL,
  total_events integer NOT NULL DEFAULT 0,
  escalated_count integer NOT NULL DEFAULT 0,
  suppressed_count integer NOT NULL DEFAULT 0,
  needs_review_count integer NOT NULL DEFAULT 0,
  generated_at timestamp with time zone NOT NULL DEFAULT now(),
  generated_by text NOT NULL DEFAULT 'system'::text,
  generated_by_user_id uuid,
  CONSTRAINT digests_pkey PRIMARY KEY (id),
  CONSTRAINT digests_org_fkey FOREIGN KEY (organization_id) REFERENCES public.organizations(id)
);
CREATE TABLE public.disclosure_logs (
  id uuid NOT NULL DEFAULT gen_random_uuid(),
  organization_id uuid NOT NULL,
  call_id uuid,
  disclosure_type text NOT NULL CHECK (disclosure_type = ANY (ARRAY['recording'::text, 'survey'::text, 'translation'::text, 'qa_evaluation'::text, 'multi'::text])),
  disclosure_text text NOT NULL,
  disclosed_at timestamp with time zone NOT NULL DEFAULT now(),
  disclosure_method text NOT NULL DEFAULT 'tts'::text CHECK (disclosure_method = ANY (ARRAY['tts'::text, 'prerecorded'::text, 'ivr'::text, 'agent'::text])),
  caller_response text,
  created_at timestamp with time zone NOT NULL DEFAULT now(),
  CONSTRAINT disclosure_logs_pkey PRIMARY KEY (id),
  CONSTRAINT disclosure_logs_organization_id_fkey FOREIGN KEY (organization_id) REFERENCES public.organizations(id),
  CONSTRAINT disclosure_logs_call_id_fkey FOREIGN KEY (call_id) REFERENCES public.calls(id)
);
CREATE TABLE public.evidence_bundles (
  id uuid NOT NULL DEFAULT gen_random_uuid(),
  organization_id uuid NOT NULL,
  call_id uuid NOT NULL,
  recording_id uuid,
  manifest_id uuid NOT NULL,
  manifest_hash text NOT NULL,
  artifact_hashes jsonb NOT NULL DEFAULT '[]'::jsonb,
  bundle_payload jsonb NOT NULL,
  bundle_hash text NOT NULL,
  bundle_hash_algo text NOT NULL DEFAULT 'sha256'::text,
  version integer NOT NULL DEFAULT 1,
  parent_bundle_id uuid,
  superseded_at timestamp with time zone,
  superseded_by uuid,
  immutable_storage boolean NOT NULL DEFAULT true,
  is_authoritative boolean NOT NULL DEFAULT true,
  produced_by text NOT NULL DEFAULT 'system_cas'::text,
  immutability_policy text NOT NULL DEFAULT 'immutable'::text CHECK (immutability_policy = ANY (ARRAY['immutable'::text, 'limited'::text, 'mutable'::text])),
  tsa jsonb,
  tsa_status text NOT NULL DEFAULT 'not_configured'::text CHECK (tsa_status = ANY (ARRAY['not_configured'::text, 'pending'::text, 'completed'::text, 'error'::text])),
  tsa_requested_at timestamp with time zone,
  tsa_received_at timestamp with time zone,
  tsa_error text,
  created_at timestamp with time zone NOT NULL DEFAULT now(),
  custody_status text NOT NULL DEFAULT 'active'::text CHECK (custody_status = ANY (ARRAY['active'::text, 'archived'::text, 'legal_hold'::text, 'expired'::text])),
  retention_class text NOT NULL DEFAULT 'default'::text CHECK (retention_class = ANY (ARRAY['default'::text, 'regulated'::text, 'legal_hold'::text])),
  legal_hold_flag boolean NOT NULL DEFAULT false,
  evidence_completeness text NOT NULL DEFAULT 'unknown'::text CHECK (evidence_completeness = ANY (ARRAY['unknown'::text, 'partial'::text, 'complete'::text, 'failed'::text])),
  CONSTRAINT evidence_bundles_pkey PRIMARY KEY (id),
  CONSTRAINT evidence_bundles_organization_id_fkey FOREIGN KEY (organization_id) REFERENCES public.organizations(id),
  CONSTRAINT evidence_bundles_call_id_fkey FOREIGN KEY (call_id) REFERENCES public.calls(id),
  CONSTRAINT evidence_bundles_recording_id_fkey FOREIGN KEY (recording_id) REFERENCES public.recordings(id),
  CONSTRAINT evidence_bundles_manifest_id_fkey FOREIGN KEY (manifest_id) REFERENCES public.evidence_manifests(id),
  CONSTRAINT evidence_bundles_parent_bundle_id_fkey FOREIGN KEY (parent_bundle_id) REFERENCES public.evidence_bundles(id),
  CONSTRAINT evidence_bundles_superseded_by_fkey FOREIGN KEY (superseded_by) REFERENCES public.evidence_bundles(id)
);
CREATE TABLE public.evidence_manifests (
  id uuid NOT NULL DEFAULT gen_random_uuid(),
  organization_id uuid NOT NULL,
  recording_id uuid NOT NULL,
  scorecard_id uuid,
  manifest jsonb NOT NULL,
  created_at timestamp with time zone DEFAULT now(),
  version integer NOT NULL DEFAULT 1,
  parent_manifest_id uuid,
  superseded_at timestamp with time zone,
  superseded_by uuid,
  is_authoritative boolean NOT NULL DEFAULT true,
  produced_by text NOT NULL DEFAULT 'system_cas'::text,
  immutability_policy text NOT NULL DEFAULT 'immutable'::text CHECK (immutability_policy = ANY (ARRAY['immutable'::text, 'limited'::text, 'mutable'::text])),
  cryptographic_hash text,
  CONSTRAINT evidence_manifests_pkey PRIMARY KEY (id),
  CONSTRAINT evidence_manifests_recording_id_fkey FOREIGN KEY (recording_id) REFERENCES public.recordings(id),
  CONSTRAINT evidence_manifests_parent_manifest_id_fkey FOREIGN KEY (parent_manifest_id) REFERENCES public.evidence_manifests(id),
  CONSTRAINT evidence_manifests_superseded_by_fkey FOREIGN KEY (superseded_by) REFERENCES public.evidence_manifests(id)
);
CREATE TABLE public.execution_contexts (
  id uuid NOT NULL,
  name text UNIQUE,
  isolation_level text,
  description text,
  CONSTRAINT execution_contexts_pkey PRIMARY KEY (id)
);
CREATE TABLE public.export_compliance_log (
  id uuid NOT NULL DEFAULT gen_random_uuid(),
  organization_id uuid NOT NULL,
  call_id uuid NOT NULL,
  bundle_id uuid,
  retention_check_passed boolean NOT NULL,
  legal_hold_check_passed boolean NOT NULL,
  custody_status_at_export text NOT NULL,
  retention_class_at_export text NOT NULL,
  export_allowed boolean NOT NULL,
  denial_reason text,
  requested_by uuid NOT NULL,
  requested_at timestamp with time zone NOT NULL DEFAULT now(),
  decision_metadata jsonb,
  CONSTRAINT export_compliance_log_pkey PRIMARY KEY (id),
  CONSTRAINT export_compliance_log_organization_id_fkey FOREIGN KEY (organization_id) REFERENCES public.organizations(id),
  CONSTRAINT export_compliance_log_call_id_fkey FOREIGN KEY (call_id) REFERENCES public.calls(id),
  CONSTRAINT export_compliance_log_bundle_id_fkey FOREIGN KEY (bundle_id) REFERENCES public.evidence_bundles(id)
);
CREATE TABLE public.external_entities (
  id uuid NOT NULL DEFAULT gen_random_uuid(),
  organization_id uuid NOT NULL,
  display_name text,
  entity_type text NOT NULL DEFAULT 'contact'::text CHECK (entity_type = ANY (ARRAY['contact'::text, 'company'::text, 'location'::text, 'other'::text])),
  notes text,
  tags ARRAY,
  metadata jsonb DEFAULT '{}'::jsonb,
  is_active boolean NOT NULL DEFAULT true,
  created_at timestamp with time zone NOT NULL DEFAULT now(),
  updated_at timestamp with time zone NOT NULL DEFAULT now(),
  created_by uuid,
  CONSTRAINT external_entities_pkey PRIMARY KEY (id),
  CONSTRAINT external_entities_organization_id_fkey FOREIGN KEY (organization_id) REFERENCES public.organizations(id)
);
CREATE TABLE public.external_entity_identifiers (
  id uuid NOT NULL DEFAULT gen_random_uuid(),
  organization_id uuid NOT NULL,
  entity_id uuid,
  identifier_type text NOT NULL CHECK (identifier_type = ANY (ARRAY['phone'::text, 'email_domain'::text, 'email'::text, 'crm_object'::text, 'other'::text])),
  identifier_value text NOT NULL,
  identifier_normalized text NOT NULL,
  first_observed_at timestamp with time zone NOT NULL DEFAULT now(),
  last_observed_at timestamp with time zone NOT NULL DEFAULT now(),
  observation_count integer NOT NULL DEFAULT 1,
  first_observed_source text,
  first_observed_source_id uuid,
  is_verified boolean NOT NULL DEFAULT false,
  verified_at timestamp with time zone,
  verified_by uuid,
  created_at timestamp with time zone NOT NULL DEFAULT now(),
  CONSTRAINT external_entity_identifiers_pkey PRIMARY KEY (id),
  CONSTRAINT external_entity_identifiers_organization_id_fkey FOREIGN KEY (organization_id) REFERENCES public.organizations(id),
  CONSTRAINT external_entity_identifiers_entity_id_fkey FOREIGN KEY (entity_id) REFERENCES public.external_entities(id)
);
CREATE TABLE public.external_entity_links (
  id uuid NOT NULL DEFAULT gen_random_uuid(),
  organization_id uuid NOT NULL,
  link_type text NOT NULL CHECK (link_type = ANY (ARRAY['identifier_to_entity'::text, 'entity_merge'::text, 'entity_split'::text, 'identifier_transfer'::text])),
  source_entity_id uuid,
  target_entity_id uuid,
  identifier_id uuid,
  created_by uuid NOT NULL,
  reason text,
  is_active boolean NOT NULL DEFAULT true,
  revoked_at timestamp with time zone,
  revoked_by uuid,
  revoke_reason text,
  created_at timestamp with time zone NOT NULL DEFAULT now(),
  CONSTRAINT external_entity_links_pkey PRIMARY KEY (id),
  CONSTRAINT external_entity_links_organization_id_fkey FOREIGN KEY (organization_id) REFERENCES public.organizations(id),
  CONSTRAINT external_entity_links_source_entity_id_fkey FOREIGN KEY (source_entity_id) REFERENCES public.external_entities(id),
  CONSTRAINT external_entity_links_target_entity_id_fkey FOREIGN KEY (target_entity_id) REFERENCES public.external_entities(id),
  CONSTRAINT external_entity_links_identifier_id_fkey FOREIGN KEY (identifier_id) REFERENCES public.external_entity_identifiers(id)
);
CREATE TABLE public.external_entity_observations (
  id uuid NOT NULL DEFAULT gen_random_uuid(),
  organization_id uuid NOT NULL,
  identifier_id uuid NOT NULL,
  source_type text NOT NULL CHECK (source_type = ANY (ARRAY['call'::text, 'target'::text, 'campaign_call'::text, 'booking'::text, 'manual'::text])),
  source_id uuid NOT NULL,
  role text CHECK (role = ANY (ARRAY['caller'::text, 'callee'::text, 'participant'::text, 'target'::text, 'other'::text])),
  direction text CHECK (direction = ANY (ARRAY['inbound'::text, 'outbound'::text])),
  observed_at timestamp with time zone NOT NULL DEFAULT now(),
  CONSTRAINT external_entity_observations_pkey PRIMARY KEY (id),
  CONSTRAINT external_entity_observations_organization_id_fkey FOREIGN KEY (organization_id) REFERENCES public.organizations(id),
  CONSTRAINT external_entity_observations_identifier_id_fkey FOREIGN KEY (identifier_id) REFERENCES public.external_entity_identifiers(id)
);
CREATE TABLE public.generated_reports (
  id uuid NOT NULL DEFAULT gen_random_uuid(),
  template_id uuid NOT NULL,
  organization_id uuid NOT NULL,
  name text NOT NULL,
  file_path text,
  file_format text CHECK (file_format = ANY (ARRAY['pdf'::text, 'csv'::text, 'xlsx'::text, 'json'::text])),
  file_size_bytes integer,
  report_data jsonb,
  parameters jsonb NOT NULL DEFAULT '{}'::jsonb,
  generated_by uuid NOT NULL,
  generated_at timestamp with time zone NOT NULL DEFAULT now(),
  status text NOT NULL DEFAULT 'generating'::text CHECK (status = ANY (ARRAY['generating'::text, 'completed'::text, 'failed'::text])),
  error_message text,
  generation_duration_ms integer,
  expires_at timestamp with time zone,
  created_at timestamp with time zone NOT NULL DEFAULT now(),
  CONSTRAINT generated_reports_pkey PRIMARY KEY (id),
  CONSTRAINT generated_reports_template_id_fkey FOREIGN KEY (template_id) REFERENCES public.report_templates(id),
  CONSTRAINT generated_reports_organization_id_fkey FOREIGN KEY (organization_id) REFERENCES public.organizations(id)
);
CREATE TABLE public.global_feature_flags (
  id uuid NOT NULL DEFAULT gen_random_uuid(),
  feature text NOT NULL UNIQUE,
  enabled boolean DEFAULT true,
  created_at timestamp with time zone DEFAULT now(),
  CONSTRAINT global_feature_flags_pkey PRIMARY KEY (id)
);
CREATE TABLE public.incidents (
  id uuid NOT NULL DEFAULT gen_random_uuid(),
  organization_id uuid,
  severity text NOT NULL CHECK (severity = ANY (ARRAY['CRITICAL'::text, 'HIGH'::text, 'MEDIUM'::text, 'LOW'::text])),
  error_code text NOT NULL,
  error_message text NOT NULL,
  resource_type text,
  resource_id uuid,
  call_id uuid,
  stack_trace text,
  metadata jsonb,
  resolved_at timestamp with time zone,
  resolved_by uuid,
  created_at timestamp with time zone NOT NULL DEFAULT now(),
  CONSTRAINT incidents_pkey PRIMARY KEY (id),
  CONSTRAINT incidents_organization_id_fkey FOREIGN KEY (organization_id) REFERENCES public.organizations(id),
  CONSTRAINT incidents_call_id_fkey FOREIGN KEY (call_id) REFERENCES public.calls(id)
);
CREATE TABLE public.integrations (
  id uuid NOT NULL DEFAULT gen_random_uuid(),
  organization_id uuid NOT NULL,
  provider text NOT NULL CHECK (provider = ANY (ARRAY['hubspot'::text, 'salesforce'::text, 'zoho'::text, 'pipedrive'::text])),
  provider_account_id text,
  provider_account_name text,
  status text NOT NULL DEFAULT 'pending'::text CHECK (status = ANY (ARRAY['pending'::text, 'active'::text, 'disconnected'::text, 'error'::text, 'expired'::text])),
  error_message text,
  last_error_at timestamp with time zone,
  settings jsonb DEFAULT '{}'::jsonb,
  sync_enabled boolean NOT NULL DEFAULT true,
  connected_at timestamp with time zone,
  disconnected_at timestamp with time zone,
  created_at timestamp with time zone NOT NULL DEFAULT now(),
  updated_at timestamp with time zone NOT NULL DEFAULT now(),
  connected_by uuid,
  CONSTRAINT integrations_pkey PRIMARY KEY (id),
  CONSTRAINT integrations_organization_id_fkey FOREIGN KEY (organization_id) REFERENCES public.organizations(id)
);
CREATE TABLE public.invoices (
  id uuid NOT NULL,
  organization_id uuid,
  stripe_invoice_id text,
  amount_cents integer,
  status text,
  paid_at timestamp with time zone,
  created_at timestamp with time zone DEFAULT now(),
  CONSTRAINT invoices_pkey PRIMARY KEY (id),
  CONSTRAINT invoices_organization_id_fkey FOREIGN KEY (organization_id) REFERENCES public.organizations(id)
);
CREATE TABLE public.kpi_logs (
  id bigint NOT NULL DEFAULT nextval('kpi_logs_id_seq'::regclass),
  test_id uuid,
  stage text NOT NULL,
  status text NOT NULL CHECK (status = ANY (ARRAY['success'::text, 'failure'::text])),
  message text NOT NULL,
  duration_ms integer,
  error_details text,
  metadata jsonb DEFAULT '{}'::jsonb,
  created_at timestamp with time zone DEFAULT now(),
  CONSTRAINT kpi_logs_pkey PRIMARY KEY (id),
  CONSTRAINT kpi_logs_test_id_fkey FOREIGN KEY (test_id) REFERENCES public.test_configs(id)
);
CREATE TABLE public.kpi_settings (
  id uuid NOT NULL DEFAULT gen_random_uuid(),
  organization_id uuid NOT NULL UNIQUE,
  response_time_threshold_ms integer DEFAULT 5000,
  response_time_warning_ms integer DEFAULT 3000,
  consecutive_failures_before_alert integer DEFAULT 3,
  alert_sensitivity text DEFAULT 'medium'::text CHECK (alert_sensitivity = ANY (ARRAY['low'::text, 'medium'::text, 'high'::text])),
  default_test_frequency text DEFAULT '5min'::text CHECK (default_test_frequency = ANY (ARRAY['5min'::text, '15min'::text, '30min'::text, '1hr'::text, '4hr'::text, '24hr'::text])),
  send_email_alerts boolean DEFAULT true,
  send_sms_alerts boolean DEFAULT true,
  alert_on_recovery boolean DEFAULT true,
  created_at timestamp with time zone DEFAULT now(),
  updated_at timestamp with time zone DEFAULT now(),
  CONSTRAINT kpi_settings_pkey PRIMARY KEY (id),
  CONSTRAINT kpi_settings_organization_id_fkey FOREIGN KEY (organization_id) REFERENCES public.organizations(id)
);
CREATE TABLE public.legal_holds (
  id uuid NOT NULL DEFAULT gen_random_uuid(),
  organization_id uuid NOT NULL,
  hold_name text NOT NULL,
  matter_reference text,
  description text,
  applies_to_all boolean NOT NULL DEFAULT false,
  call_ids ARRAY DEFAULT '{}'::uuid[],
  status text NOT NULL DEFAULT 'active'::text CHECK (status = ANY (ARRAY['active'::text, 'released'::text, 'expired'::text])),
  effective_from timestamp with time zone NOT NULL DEFAULT now(),
  effective_until timestamp with time zone,
  released_at timestamp with time zone,
  released_by uuid,
  release_reason text,
  created_by uuid NOT NULL,
  created_at timestamp with time zone NOT NULL DEFAULT now(),
  updated_at timestamp with time zone NOT NULL DEFAULT now(),
  CONSTRAINT legal_holds_pkey PRIMARY KEY (id),
  CONSTRAINT legal_holds_organization_id_fkey FOREIGN KEY (organization_id) REFERENCES public.organizations(id)
);
CREATE TABLE public.login_attempts (
  id uuid NOT NULL DEFAULT gen_random_uuid(),
  username text NOT NULL,
  ip text,
  succeeded boolean NOT NULL DEFAULT false,
  attempted_at timestamp with time zone NOT NULL DEFAULT now(),
  CONSTRAINT login_attempts_pkey PRIMARY KEY (id)
);
CREATE TABLE public.media_sessions (
  id uuid NOT NULL,
  call_id uuid,
  system_id uuid,
  freeswitch_node text,
  started_at timestamp with time zone,
  ended_at timestamp with time zone,
  CONSTRAINT media_sessions_pkey PRIMARY KEY (id),
  CONSTRAINT media_sessions_call_id_fkey FOREIGN KEY (call_id) REFERENCES public.calls(id),
  CONSTRAINT media_sessions_system_id_fkey FOREIGN KEY (system_id) REFERENCES public.systems(id)
);
CREATE TABLE public.monitored_numbers (
  id uuid NOT NULL DEFAULT gen_random_uuid(),
  organization_id uuid NOT NULL,
  number text NOT NULL,
  name text,
  description text,
  type text DEFAULT 'inbound'::text,
  test_frequency text NOT NULL DEFAULT 'hourly'::text,
  greeting_message_id uuid,
  custom_greeting_message text,
  is_active boolean DEFAULT true,
  created_at timestamp with time zone DEFAULT now(),
  updated_at timestamp with time zone DEFAULT now(),
  CONSTRAINT monitored_numbers_pkey PRIMARY KEY (id),
  CONSTRAINT monitored_numbers_organization_id_fkey FOREIGN KEY (organization_id) REFERENCES public.organizations(id),
  CONSTRAINT monitored_numbers_greeting_message_id_fkey FOREIGN KEY (greeting_message_id) REFERENCES public.stock_messages(id)
);
CREATE TABLE public.network_incidents (
  id uuid NOT NULL DEFAULT uuid_generate_v4(),
  title text NOT NULL,
  description text,
  source text NOT NULL,
  link text,
  pub_date timestamp with time zone,
  severity text CHECK (severity = ANY (ARRAY['low'::text, 'medium'::text, 'high'::text, 'critical'::text])),
  affected_carriers ARRAY,
  created_at timestamp with time zone DEFAULT now(),
  is_active boolean DEFAULT true,
  CONSTRAINT network_incidents_pkey PRIMARY KEY (id)
);
CREATE TABLE public.number_kpi_logs (
  id uuid NOT NULL DEFAULT gen_random_uuid(),
  monitored_number_id uuid NOT NULL,
  organization_id uuid NOT NULL,
  stage text,
  duration_ms integer,
  meta jsonb,
  created_at timestamp with time zone DEFAULT now(),
  CONSTRAINT number_kpi_logs_pkey PRIMARY KEY (id),
  CONSTRAINT number_kpi_logs_monitored_number_id_fkey FOREIGN KEY (monitored_number_id) REFERENCES public.monitored_numbers(id),
  CONSTRAINT number_kpi_logs_organization_id_fkey FOREIGN KEY (organization_id) REFERENCES public.organizations(id)
);
CREATE TABLE public.number_kpi_snapshot (
  id uuid NOT NULL DEFAULT gen_random_uuid(),
  monitored_number_id uuid NOT NULL,
  organization_id uuid NOT NULL,
  status text NOT NULL,
  uptime_percentage numeric,
  last_24h_failures integer,
  last_test_at timestamp with time zone,
  last_test_status text,
  avg_response_time_ms integer,
  last_updated timestamp with time zone DEFAULT now(),
  CONSTRAINT number_kpi_snapshot_pkey PRIMARY KEY (id),
  CONSTRAINT number_kpi_snapshot_monitored_number_id_fkey FOREIGN KEY (monitored_number_id) REFERENCES public.monitored_numbers(id),
  CONSTRAINT number_kpi_snapshot_organization_id_fkey FOREIGN KEY (organization_id) REFERENCES public.organizations(id)
);
CREATE TABLE public.oauth_tokens (
  id uuid NOT NULL DEFAULT gen_random_uuid(),
  integration_id uuid NOT NULL UNIQUE,
  access_token_encrypted text NOT NULL,
  refresh_token_encrypted text,
  token_type text DEFAULT 'Bearer'::text,
  expires_at timestamp with time zone,
  refresh_expires_at timestamp with time zone,
  scopes ARRAY,
  instance_url text,
  last_refreshed_at timestamp with time zone,
  refresh_count integer NOT NULL DEFAULT 0,
  created_at timestamp with time zone NOT NULL DEFAULT now(),
  updated_at timestamp with time zone NOT NULL DEFAULT now(),
  CONSTRAINT oauth_tokens_pkey PRIMARY KEY (id),
  CONSTRAINT oauth_tokens_integration_id_fkey FOREIGN KEY (integration_id) REFERENCES public.integrations(id)
);
CREATE TABLE public.org_feature_flags (
  id uuid NOT NULL DEFAULT gen_random_uuid(),
  organization_id uuid NOT NULL,
  feature text NOT NULL,
  enabled boolean DEFAULT true,
  created_at timestamp with time zone DEFAULT now(),
  disabled_reason text,
  disabled_at timestamp with time zone,
  disabled_by uuid,
  daily_limit integer,
  monthly_limit integer,
  current_daily_usage integer DEFAULT 0,
  current_monthly_usage integer DEFAULT 0,
  usage_reset_at timestamp with time zone,
  updated_at timestamp with time zone DEFAULT now(),
  CONSTRAINT org_feature_flags_pkey PRIMARY KEY (id)
);
CREATE TABLE public.org_members (
  id uuid NOT NULL DEFAULT gen_random_uuid(),
  organization_id uuid NOT NULL,
  user_id uuid NOT NULL,
  role text DEFAULT 'member'::text,
  created_at timestamp with time zone DEFAULT now(),
  invite_id uuid,
  CONSTRAINT org_members_pkey PRIMARY KEY (id),
  CONSTRAINT org_members_organization_id_fkey FOREIGN KEY (organization_id) REFERENCES public.organizations(id)
);
CREATE TABLE public.org_sso_configs (
  id uuid NOT NULL DEFAULT gen_random_uuid(),
  organization_id uuid NOT NULL,
  provider_type text NOT NULL CHECK (provider_type = ANY (ARRAY['saml'::text, 'oidc'::text, 'azure_ad'::text, 'okta'::text, 'google_workspace'::text])),
  provider_name text NOT NULL,
  is_enabled boolean DEFAULT false,
  saml_entity_id text,
  saml_sso_url text,
  saml_slo_url text,
  saml_certificate text,
  saml_signature_algorithm text DEFAULT 'sha256'::text,
  saml_name_id_format text DEFAULT 'emailAddress'::text,
  oidc_client_id text,
  oidc_client_secret_encrypted text,
  oidc_issuer_url text,
  oidc_authorization_url text,
  oidc_token_url text,
  oidc_userinfo_url text,
  oidc_scopes ARRAY DEFAULT ARRAY['openid'::text, 'email'::text, 'profile'::text],
  verified_domains ARRAY DEFAULT '{}'::text[],
  auto_provision_users boolean DEFAULT true,
  default_role text DEFAULT 'member'::text,
  require_sso boolean DEFAULT false,
  allow_idp_initiated boolean DEFAULT true,
  session_duration_hours integer DEFAULT 24,
  attribute_mapping jsonb DEFAULT '{"name": "displayName", "email": "email", "groups": "groups", "given_name": "firstName", "family_name": "lastName"}'::jsonb,
  group_mapping jsonb DEFAULT '{}'::jsonb,
  created_by uuid,
  created_at timestamp with time zone DEFAULT now(),
  updated_by uuid,
  updated_at timestamp with time zone DEFAULT now(),
  last_login_at timestamp with time zone,
  login_count integer DEFAULT 0,
  CONSTRAINT org_sso_configs_pkey PRIMARY KEY (id),
  CONSTRAINT org_sso_configs_organization_id_fkey FOREIGN KEY (organization_id) REFERENCES public.organizations(id)
);
CREATE TABLE public.organizations (
  id uuid NOT NULL DEFAULT gen_random_uuid(),
  name text NOT NULL,
  plan text,
  created_at timestamp with time zone DEFAULT now(),
  plan_status text DEFAULT 'active'::text CHECK (plan_status = ANY (ARRAY['active'::text, 'past_due'::text, 'canceled'::text, 'trialing'::text, 'incomplete'::text])),
  stripe_customer_id text UNIQUE,
  stripe_subscription_id text,
  tenant_id uuid,
  tool_id uuid,
  created_by uuid,
  default_booking_duration integer DEFAULT 30,
  booking_enabled boolean DEFAULT false,
  CONSTRAINT organizations_pkey PRIMARY KEY (id),
  CONSTRAINT organizations_created_by_fkey FOREIGN KEY (created_by) REFERENCES auth.users(id)
);
CREATE TABLE public.qa_evaluation_disclosures (
  id uuid NOT NULL DEFAULT gen_random_uuid(),
  call_id uuid NOT NULL,
  organization_id uuid NOT NULL,
  disclosure_type text NOT NULL DEFAULT 'qa_evaluation'::text CHECK (disclosure_type = ANY (ARRAY['qa_evaluation'::text, 'internal_audit'::text, 'training'::text])),
  disclosure_text text NOT NULL,
  disclosed_at timestamp with time zone NOT NULL DEFAULT now(),
  disclosure_position_seconds numeric,
  created_at timestamp with time zone NOT NULL DEFAULT now(),
  CONSTRAINT qa_evaluation_disclosures_pkey PRIMARY KEY (id),
  CONSTRAINT qa_evaluation_disclosures_call_id_fkey FOREIGN KEY (call_id) REFERENCES public.calls(id),
  CONSTRAINT qa_evaluation_disclosures_organization_id_fkey FOREIGN KEY (organization_id) REFERENCES public.organizations(id)
);
CREATE TABLE public.recordings (
  id uuid NOT NULL DEFAULT gen_random_uuid(),
  organization_id uuid NOT NULL,
  call_sid text NOT NULL,
  recording_sid text UNIQUE,
  recording_url text NOT NULL,
  duration_seconds integer CHECK (duration_seconds IS NULL OR duration_seconds >= 0),
  transcript_json jsonb,
  status text DEFAULT 'pending'::text,
  created_at timestamp with time zone DEFAULT now(),
  updated_at timestamp with time zone DEFAULT now(),
  tool_id uuid NOT NULL,
  created_by uuid,
  has_live_translation boolean NOT NULL DEFAULT false,
  live_translation_provider text CHECK (live_translation_provider = 'signalwire'::text OR live_translation_provider IS NULL),
  source text NOT NULL DEFAULT 'signalwire'::text CHECK (source = ANY (ARRAY['signalwire'::text, 'webrtc'::text, 'upload'::text, 'external'::text])),
  external_call_id text,
  media_hash text,
  is_altered boolean DEFAULT false,
  original_url text,
  is_deleted boolean DEFAULT false,
  deleted_at timestamp with time zone,
  deleted_by uuid,
  is_authoritative boolean NOT NULL DEFAULT true,
  immutability_policy text NOT NULL DEFAULT 'immutable'::text CHECK (immutability_policy = ANY (ARRAY['immutable'::text, 'limited'::text, 'mutable'::text])),
  custody_status text NOT NULL DEFAULT 'active'::text CHECK (custody_status = ANY (ARRAY['active'::text, 'archived'::text, 'legal_hold'::text, 'expired'::text])),
  retention_class text NOT NULL DEFAULT 'default'::text CHECK (retention_class = ANY (ARRAY['default'::text, 'regulated'::text, 'legal_hold'::text])),
  legal_hold_flag boolean NOT NULL DEFAULT false,
  evidence_completeness text NOT NULL DEFAULT 'unknown'::text CHECK (evidence_completeness = ANY (ARRAY['unknown'::text, 'partial'::text, 'complete'::text, 'failed'::text])),
  disclosure_given boolean DEFAULT false,
  disclosure_type text,
  call_id uuid,
  CONSTRAINT recordings_pkey PRIMARY KEY (id),
  CONSTRAINT recordings_organization_id_fkey FOREIGN KEY (organization_id) REFERENCES public.organizations(id),
  CONSTRAINT recordings_tool_id_fkey FOREIGN KEY (tool_id) REFERENCES public.tools(id),
  CONSTRAINT recordings_created_by_fkey FOREIGN KEY (created_by) REFERENCES auth.users(id),
  CONSTRAINT recordings_call_id_fkey FOREIGN KEY (call_id) REFERENCES public.calls(id)
);
CREATE TABLE public.report_access_log (
  id uuid NOT NULL DEFAULT gen_random_uuid(),
  report_id uuid NOT NULL,
  user_id uuid NOT NULL,
  action text NOT NULL CHECK (action = ANY (ARRAY['viewed'::text, 'downloaded'::text, 'shared'::text])),
  accessed_at timestamp with time zone NOT NULL DEFAULT now(),
  CONSTRAINT report_access_log_pkey PRIMARY KEY (id),
  CONSTRAINT report_access_log_report_id_fkey FOREIGN KEY (report_id) REFERENCES public.generated_reports(id)
);
CREATE TABLE public.report_schedules (
  id uuid NOT NULL DEFAULT gen_random_uuid(),
  organization_id uuid,
  test_config_id uuid,
  frequency text NOT NULL CHECK (frequency = ANY (ARRAY['daily'::text, 'weekly'::text])),
  recipient_emails ARRAY NOT NULL,
  is_active boolean DEFAULT true,
  created_at timestamp with time zone DEFAULT now(),
  CONSTRAINT report_schedules_pkey PRIMARY KEY (id),
  CONSTRAINT report_schedules_organization_id_fkey FOREIGN KEY (organization_id) REFERENCES public.organizations(id),
  CONSTRAINT report_schedules_test_config_id_fkey FOREIGN KEY (test_config_id) REFERENCES public.test_configs(id)
);
CREATE TABLE public.report_templates (
  id uuid NOT NULL DEFAULT gen_random_uuid(),
  organization_id uuid NOT NULL,
  name text NOT NULL,
  description text,
  report_type text NOT NULL CHECK (report_type = ANY (ARRAY['call_volume'::text, 'quality_scorecard'::text, 'campaign_performance'::text, 'custom'::text])),
  data_source text NOT NULL CHECK (data_source = ANY (ARRAY['calls'::text, 'campaigns'::text, 'scorecards'::text, 'surveys'::text, 'multi'::text])),
  filters jsonb NOT NULL DEFAULT '{}'::jsonb,
  metrics jsonb NOT NULL DEFAULT '[]'::jsonb,
  dimensions jsonb NOT NULL DEFAULT '[]'::jsonb,
  visualization_config jsonb DEFAULT '{}'::jsonb,
  is_public boolean NOT NULL DEFAULT false,
  created_by uuid NOT NULL,
  created_at timestamp with time zone NOT NULL DEFAULT now(),
  updated_at timestamp with time zone NOT NULL DEFAULT now(),
  CONSTRAINT report_templates_pkey PRIMARY KEY (id),
  CONSTRAINT report_templates_organization_id_fkey FOREIGN KEY (organization_id) REFERENCES public.organizations(id)
);
CREATE TABLE public.retention_policies (
  id uuid NOT NULL DEFAULT gen_random_uuid(),
  organization_id uuid NOT NULL UNIQUE,
  default_retention_class text NOT NULL DEFAULT 'default'::text CHECK (default_retention_class = ANY (ARRAY['default'::text, 'regulated'::text, 'legal_hold'::text])),
  default_retention_days integer NOT NULL DEFAULT 0,
  regulated_retention_days integer NOT NULL DEFAULT 2555,
  auto_archive_after_days integer DEFAULT 90,
  auto_delete_after_days integer,
  legal_hold_contact_email text,
  legal_hold_notes text,
  created_at timestamp with time zone NOT NULL DEFAULT now(),
  updated_at timestamp with time zone NOT NULL DEFAULT now(),
  updated_by uuid,
  CONSTRAINT retention_policies_pkey PRIMARY KEY (id),
  CONSTRAINT retention_policies_organization_id_fkey FOREIGN KEY (organization_id) REFERENCES public.organizations(id)
);
CREATE TABLE public.role_capabilities_archived (
  role_id uuid NOT NULL,
  capability_id uuid NOT NULL,
  CONSTRAINT role_capabilities_archived_pkey PRIMARY KEY (role_id, capability_id),
  CONSTRAINT role_capabilities_role_id_fkey FOREIGN KEY (role_id) REFERENCES public.roles_archived(id),
  CONSTRAINT role_capabilities_capability_id_fkey FOREIGN KEY (capability_id) REFERENCES public.capabilities_archived(id)
);
CREATE TABLE public.roles_archived (
  id uuid NOT NULL,
  organization_id uuid,
  name text,
  created_at timestamp with time zone DEFAULT now(),
  CONSTRAINT roles_archived_pkey PRIMARY KEY (id),
  CONSTRAINT roles_organization_id_fkey FOREIGN KEY (organization_id) REFERENCES public.organizations(id)
);
CREATE TABLE public.scheduled_reports (
  id uuid NOT NULL DEFAULT gen_random_uuid(),
  template_id uuid NOT NULL,
  organization_id uuid NOT NULL,
  name text NOT NULL,
  schedule_pattern text NOT NULL,
  schedule_time time without time zone NOT NULL DEFAULT '09:00:00'::time without time zone,
  schedule_days ARRAY,
  timezone text NOT NULL DEFAULT 'UTC'::text,
  delivery_method text NOT NULL DEFAULT 'email'::text CHECK (delivery_method = ANY (ARRAY['email'::text, 'webhook'::text, 'storage'::text])),
  delivery_config jsonb NOT NULL DEFAULT '{}'::jsonb,
  is_active boolean NOT NULL DEFAULT true,
  last_run_at timestamp with time zone,
  next_run_at timestamp with time zone,
  created_by uuid NOT NULL,
  created_at timestamp with time zone NOT NULL DEFAULT now(),
  updated_at timestamp with time zone NOT NULL DEFAULT now(),
  CONSTRAINT scheduled_reports_pkey PRIMARY KEY (id),
  CONSTRAINT scheduled_reports_template_id_fkey FOREIGN KEY (template_id) REFERENCES public.report_templates(id),
  CONSTRAINT scheduled_reports_organization_id_fkey FOREIGN KEY (organization_id) REFERENCES public.organizations(id)
);
CREATE TABLE public.scorecards (
  id uuid NOT NULL DEFAULT gen_random_uuid(),
  organization_id uuid NOT NULL,
  name text NOT NULL,
  description text,
  structure jsonb NOT NULL,
  is_template boolean DEFAULT false,
  created_at timestamp with time zone DEFAULT now(),
  updated_at timestamp with time zone DEFAULT now(),
  tool_id uuid NOT NULL,
  created_by uuid,
  CONSTRAINT scorecards_pkey PRIMARY KEY (id),
  CONSTRAINT scorecards_organization_id_fkey FOREIGN KEY (organization_id) REFERENCES public.organizations(id),
  CONSTRAINT scorecards_tool_id_fkey FOREIGN KEY (tool_id) REFERENCES public.tools(id),
  CONSTRAINT scorecards_created_by_fkey FOREIGN KEY (created_by) REFERENCES auth.users(id)
);
CREATE TABLE public.scored_recordings (
  id uuid NOT NULL DEFAULT gen_random_uuid(),
  organization_id uuid NOT NULL,
  recording_id uuid NOT NULL,
  scorecard_id uuid NOT NULL,
  scores_json jsonb NOT NULL,
  total_score numeric,
  manual_overrides_json jsonb,
  created_at timestamp with time zone DEFAULT now(),
  updated_at timestamp with time zone DEFAULT now(),
  is_deleted boolean DEFAULT false,
  deleted_at timestamp with time zone,
  deleted_by uuid,
  CONSTRAINT scored_recordings_pkey PRIMARY KEY (id),
  CONSTRAINT scored_recordings_organization_id_fkey FOREIGN KEY (organization_id) REFERENCES public.organizations(id),
  CONSTRAINT scored_recordings_recording_id_fkey FOREIGN KEY (recording_id) REFERENCES public.recordings(id),
  CONSTRAINT scored_recordings_scorecard_id_fkey FOREIGN KEY (scorecard_id) REFERENCES public.scorecards(id)
);
CREATE TABLE public.search_documents (
  id uuid NOT NULL DEFAULT gen_random_uuid(),
  organization_id uuid NOT NULL,
  source_type text NOT NULL CHECK (source_type = ANY (ARRAY['call'::text, 'recording'::text, 'transcript'::text, 'evidence'::text, 'note'::text])),
  source_id uuid NOT NULL,
  version integer NOT NULL DEFAULT 1,
  is_current boolean NOT NULL DEFAULT true,
  superseded_by uuid,
  title text,
  content text NOT NULL,
  content_hash text NOT NULL,
  call_id uuid,
  phone_number text,
  domain text,
  tags ARRAY,
  source_created_at timestamp with time zone,
  indexed_at timestamp with time zone NOT NULL DEFAULT now(),
  indexed_by text NOT NULL DEFAULT 'system'::text,
  indexed_by_user_id uuid,
  CONSTRAINT search_documents_pkey PRIMARY KEY (id),
  CONSTRAINT search_documents_organization_id_fkey FOREIGN KEY (organization_id) REFERENCES public.organizations(id),
  CONSTRAINT search_documents_superseded_by_fkey FOREIGN KEY (superseded_by) REFERENCES public.search_documents(id)
);
CREATE TABLE public.search_events (
  id uuid NOT NULL DEFAULT gen_random_uuid(),
  organization_id uuid NOT NULL,
  event_type text NOT NULL CHECK (event_type = ANY (ARRAY['indexed'::text, 'reindexed'::text, 'rebuild_started'::text, 'rebuild_completed'::text])),
  document_id uuid,
  source_type text,
  source_id uuid,
  metadata jsonb,
  created_at timestamp with time zone NOT NULL DEFAULT now(),
  actor_type text NOT NULL CHECK (actor_type = ANY (ARRAY['system'::text, 'human'::text, 'automation'::text])),
  actor_id uuid,
  actor_label text,
  CONSTRAINT search_events_pkey PRIMARY KEY (id),
  CONSTRAINT search_events_organization_id_fkey FOREIGN KEY (organization_id) REFERENCES public.organizations(id),
  CONSTRAINT search_events_document_id_fkey FOREIGN KEY (document_id) REFERENCES public.search_documents(id)
);
CREATE TABLE public.sessions (
  id text NOT NULL,
  session_token text NOT NULL UNIQUE,
  user_id text NOT NULL,
  expires timestamp with time zone NOT NULL,
  sessionToken text UNIQUE,
  CONSTRAINT sessions_pkey PRIMARY KEY (id)
);
CREATE TABLE public.shopper_campaigns_archive (
  id uuid NOT NULL DEFAULT uuid_generate_v4(),
  organization_id uuid NOT NULL,
  name text NOT NULL,
  description text,
  scenario text NOT NULL,
  schedule text DEFAULT 'manual'::text,
  phone_numbers ARRAY DEFAULT '{}'::text[],
  is_active boolean DEFAULT true,
  created_at timestamp with time zone DEFAULT now(),
  updated_at timestamp with time zone DEFAULT now(),
  created_by uuid,
  caller_number text,
  phone_to_test text,
  CONSTRAINT shopper_campaigns_archive_pkey PRIMARY KEY (id)
);
CREATE TABLE public.shopper_jobs_archive (
  id uuid NOT NULL DEFAULT gen_random_uuid(),
  campaign_id uuid,
  organization_id uuid,
  result_id uuid,
  payload jsonb,
  status text NOT NULL DEFAULT 'pending'::text,
  attempt_count integer NOT NULL DEFAULT 0,
  max_attempts integer NOT NULL DEFAULT 5,
  next_try_at timestamp with time zone DEFAULT now(),
  last_error text,
  created_at timestamp with time zone DEFAULT now(),
  updated_at timestamp with time zone DEFAULT now(),
  CONSTRAINT shopper_jobs_archive_pkey PRIMARY KEY (id)
);
CREATE TABLE public.shopper_results (
  id uuid NOT NULL DEFAULT gen_random_uuid(),
  organization_id uuid NOT NULL,
  call_id uuid,
  recording_id uuid,
  script_id uuid,
  overall_score integer CHECK (overall_score >= 0 AND overall_score <= 100),
  sentiment_score text,
  sentiment_confidence numeric,
  outcome_results jsonb DEFAULT '[]'::jsonb,
  keywords_found ARRAY,
  key_phrases ARRAY,
  issues_detected ARRAY,
  first_response_time_ms integer,
  hold_time_total_seconds integer,
  evaluated_at timestamp with time zone DEFAULT now(),
  evaluated_by text DEFAULT 'system'::text,
  notes text,
  CONSTRAINT shopper_results_pkey PRIMARY KEY (id),
  CONSTRAINT shopper_results_organization_id_fkey FOREIGN KEY (organization_id) REFERENCES public.organizations(id),
  CONSTRAINT shopper_results_call_id_fkey FOREIGN KEY (call_id) REFERENCES public.calls(id),
  CONSTRAINT shopper_results_recording_id_fkey FOREIGN KEY (recording_id) REFERENCES public.recordings(id),
  CONSTRAINT shopper_results_script_id_fkey FOREIGN KEY (script_id) REFERENCES public.shopper_scripts(id)
);
CREATE TABLE public.shopper_scripts (
  id uuid NOT NULL DEFAULT gen_random_uuid(),
  organization_id uuid NOT NULL,
  name text NOT NULL,
  description text,
  script_text text NOT NULL,
  persona text DEFAULT 'professional'::text,
  tts_provider text DEFAULT 'signalwire'::text,
  tts_voice text DEFAULT 'rime.spore'::text,
  elevenlabs_voice_id text,
  expected_outcomes jsonb DEFAULT '[]'::jsonb,
  scoring_weights jsonb DEFAULT '{}'::jsonb,
  is_active boolean DEFAULT true,
  use_count integer DEFAULT 0,
  last_used_at timestamp with time zone,
  created_at timestamp with time zone DEFAULT now(),
  updated_at timestamp with time zone DEFAULT now(),
  created_by uuid,
  CONSTRAINT shopper_scripts_pkey PRIMARY KEY (id),
  CONSTRAINT shopper_scripts_organization_id_fkey FOREIGN KEY (organization_id) REFERENCES public.organizations(id)
);
CREATE TABLE public.sso_login_events (
  id uuid NOT NULL DEFAULT gen_random_uuid(),
  organization_id uuid NOT NULL,
  sso_config_id uuid NOT NULL,
  user_id uuid,
  event_type text NOT NULL CHECK (event_type = ANY (ARRAY['login_success'::text, 'login_failure'::text, 'logout'::text, 'token_refresh'::text])),
  idp_subject text,
  idp_session_id text,
  email text,
  name text,
  groups ARRAY,
  raw_claims jsonb,
  ip_address inet,
  user_agent text,
  error_code text,
  error_message text,
  created_at timestamp with time zone DEFAULT now(),
  CONSTRAINT sso_login_events_pkey PRIMARY KEY (id),
  CONSTRAINT sso_login_events_organization_id_fkey FOREIGN KEY (organization_id) REFERENCES public.organizations(id),
  CONSTRAINT sso_login_events_sso_config_id_fkey FOREIGN KEY (sso_config_id) REFERENCES public.org_sso_configs(id)
);
CREATE TABLE public.stock_messages (
  id uuid NOT NULL DEFAULT gen_random_uuid(),
  name text NOT NULL,
  type text NOT NULL DEFAULT 'greeting'::text,
  text text NOT NULL,
  category text,
  duration_seconds integer,
  is_active boolean DEFAULT true,
  created_at timestamp with time zone DEFAULT now(),
  CONSTRAINT stock_messages_pkey PRIMARY KEY (id)
);
CREATE TABLE public.stripe_events (
  id uuid NOT NULL DEFAULT uuid_generate_v4(),
  stripe_event_id text NOT NULL UNIQUE,
  event_type text NOT NULL,
  organization_id uuid,
  data jsonb NOT NULL,
  processed boolean NOT NULL DEFAULT false,
  error_message text,
  created_at timestamp with time zone NOT NULL DEFAULT now(),
  processed_at timestamp with time zone,
  CONSTRAINT stripe_events_pkey PRIMARY KEY (id),
  CONSTRAINT stripe_events_organization_id_fkey FOREIGN KEY (organization_id) REFERENCES public.organizations(id)
);
CREATE TABLE public.stripe_invoices (
  id uuid NOT NULL DEFAULT uuid_generate_v4(),
  organization_id uuid NOT NULL,
  stripe_invoice_id text NOT NULL UNIQUE,
  stripe_customer_id text NOT NULL,
  stripe_subscription_id text,
  status text NOT NULL CHECK (status = ANY (ARRAY['draft'::text, 'open'::text, 'paid'::text, 'void'::text, 'uncollectible'::text])),
  amount_due_cents integer NOT NULL,
  amount_paid_cents integer NOT NULL DEFAULT 0,
  currency text NOT NULL DEFAULT 'usd'::text,
  invoice_date timestamp with time zone NOT NULL,
  due_date timestamp with time zone,
  paid_at timestamp with time zone,
  invoice_pdf_url text,
  hosted_invoice_url text,
  created_at timestamp with time zone NOT NULL DEFAULT now(),
  updated_at timestamp with time zone NOT NULL DEFAULT now(),
  CONSTRAINT stripe_invoices_pkey PRIMARY KEY (id),
  CONSTRAINT stripe_invoices_organization_id_fkey FOREIGN KEY (organization_id) REFERENCES public.organizations(id)
);
CREATE TABLE public.stripe_payment_methods (
  id uuid NOT NULL DEFAULT uuid_generate_v4(),
  organization_id uuid NOT NULL,
  stripe_customer_id text NOT NULL,
  stripe_payment_method_id text NOT NULL UNIQUE,
  type text NOT NULL CHECK (type = ANY (ARRAY['card'::text, 'bank_account'::text, 'sepa_debit'::text, 'us_bank_account'::text])),
  is_default boolean NOT NULL DEFAULT false,
  card_brand text,
  card_last4 text,
  card_exp_month integer,
  card_exp_year integer,
  bank_name text,
  bank_last4 text,
  created_at timestamp with time zone NOT NULL DEFAULT now(),
  updated_at timestamp with time zone NOT NULL DEFAULT now(),
  CONSTRAINT stripe_payment_methods_pkey PRIMARY KEY (id),
  CONSTRAINT stripe_payment_methods_organization_id_fkey FOREIGN KEY (organization_id) REFERENCES public.organizations(id)
);
CREATE TABLE public.stripe_subscriptions (
  id uuid NOT NULL DEFAULT uuid_generate_v4(),
  organization_id uuid NOT NULL,
  stripe_customer_id text NOT NULL,
  stripe_subscription_id text NOT NULL UNIQUE,
  stripe_price_id text NOT NULL,
  plan text NOT NULL CHECK (plan = ANY (ARRAY['free'::text, 'pro'::text, 'business'::text, 'enterprise'::text])),
  status text NOT NULL CHECK (status = ANY (ARRAY['active'::text, 'canceled'::text, 'past_due'::text, 'unpaid'::text, 'incomplete'::text, 'incomplete_expired'::text, 'trialing'::text, 'paused'::text])),
  current_period_start timestamp with time zone NOT NULL,
  current_period_end timestamp with time zone NOT NULL,
  cancel_at_period_end boolean NOT NULL DEFAULT false,
  canceled_at timestamp with time zone,
  amount_cents integer NOT NULL,
  currency text NOT NULL DEFAULT 'usd'::text,
  interval text NOT NULL CHECK ("interval" = ANY (ARRAY['month'::text, 'year'::text])),
  trial_start timestamp with time zone,
  trial_end timestamp with time zone,
  created_at timestamp with time zone NOT NULL DEFAULT now(),
  updated_at timestamp with time zone NOT NULL DEFAULT now(),
  CONSTRAINT stripe_subscriptions_pkey PRIMARY KEY (id),
  CONSTRAINT stripe_subscriptions_organization_id_fkey FOREIGN KEY (organization_id) REFERENCES public.organizations(id)
);
CREATE TABLE public.subscriptions (
  id uuid NOT NULL,
  organization_id uuid,
  stripe_subscription_id text,
  plan text,
  status text,
  current_period_start timestamp with time zone,
  current_period_end timestamp with time zone,
  created_at timestamp with time zone DEFAULT now(),
  CONSTRAINT subscriptions_pkey PRIMARY KEY (id),
  CONSTRAINT subscriptions_organization_id_fkey FOREIGN KEY (organization_id) REFERENCES public.organizations(id)
);
CREATE TABLE public.surveys (
  id uuid NOT NULL DEFAULT gen_random_uuid(),
  organization_id uuid NOT NULL,
  name text NOT NULL,
  description text,
  questions jsonb DEFAULT '[]'::jsonb,
  is_active boolean DEFAULT true,
  created_at timestamp with time zone DEFAULT now(),
  updated_at timestamp with time zone DEFAULT now(),
  created_by uuid,
  CONSTRAINT surveys_pkey PRIMARY KEY (id),
  CONSTRAINT surveys_organization_id_fkey FOREIGN KEY (organization_id) REFERENCES public.organizations(id)
);
CREATE TABLE public.systems (
  id uuid NOT NULL,
  key text NOT NULL UNIQUE,
  name text NOT NULL,
  description text,
  category text,
  execution_plane text CHECK (execution_plane = ANY (ARRAY['control'::text, 'media'::text, 'ai'::text])),
  is_billable boolean DEFAULT false,
  is_internal boolean DEFAULT true,
  created_at timestamp with time zone DEFAULT now(),
  CONSTRAINT systems_pkey PRIMARY KEY (id)
);
CREATE TABLE public.team_invites (
  id uuid NOT NULL DEFAULT gen_random_uuid(),
  organization_id uuid NOT NULL,
  email text NOT NULL,
  role text NOT NULL DEFAULT 'viewer'::text,
  token uuid NOT NULL UNIQUE,
  status text NOT NULL DEFAULT 'pending'::text CHECK (status = ANY (ARRAY['pending'::text, 'accepted'::text, 'cancelled'::text, 'expired'::text])),
  invited_by uuid,
  accepted_by uuid,
  created_at timestamp with time zone DEFAULT now(),
  expires_at timestamp with time zone NOT NULL,
  accepted_at timestamp with time zone,
  CONSTRAINT team_invites_pkey PRIMARY KEY (id),
  CONSTRAINT team_invites_organization_id_fkey FOREIGN KEY (organization_id) REFERENCES public.organizations(id)
);
CREATE TABLE public.test_configs (
  id uuid NOT NULL DEFAULT gen_random_uuid(),
  organization_id uuid,
  name text,
  phone_to text NOT NULL,
  schedule text NOT NULL,
  active boolean DEFAULT true,
  created_at timestamp with time zone DEFAULT now(),
  custom_message text,
  dtmf_required boolean DEFAULT false,
  dtmf_expected character varying,
  description text,
  carrier text,
  test_script text DEFAULT 'basic'::text,
  alert_rules jsonb DEFAULT '{"alert_email": true, "consecutive_failures": 2}'::jsonb,
  last_test_at timestamp with time zone,
  last_status text,
  updated_at timestamp with time zone DEFAULT now(),
  tool_id uuid NOT NULL,
  created_by uuid,
  CONSTRAINT test_configs_pkey PRIMARY KEY (id),
  CONSTRAINT test_configs_organization_id_fkey FOREIGN KEY (organization_id) REFERENCES public.organizations(id),
  CONSTRAINT test_configs_tool_id_fkey FOREIGN KEY (tool_id) REFERENCES public.tools(id),
  CONSTRAINT test_configs_created_by_fkey FOREIGN KEY (created_by) REFERENCES auth.users(id)
);
CREATE TABLE public.test_frequency_config (
  id uuid NOT NULL DEFAULT gen_random_uuid(),
  monitored_number_id uuid,
  frequency text NOT NULL,
  hours_between_tests integer,
  day_of_week integer,
  time_of_day time without time zone,
  is_active boolean DEFAULT true,
  created_at timestamp with time zone DEFAULT now(),
  CONSTRAINT test_frequency_config_pkey PRIMARY KEY (id),
  CONSTRAINT test_frequency_config_monitored_number_id_fkey FOREIGN KEY (monitored_number_id) REFERENCES public.monitored_numbers(id)
);
CREATE TABLE public.test_results (
  id uuid NOT NULL DEFAULT gen_random_uuid(),
  test_config_id uuid,
  status text,
  duration_ms integer,
  meta jsonb,
  created_at timestamp with time zone DEFAULT now(),
  tool_id uuid NOT NULL,
  created_by uuid,
  CONSTRAINT test_results_pkey PRIMARY KEY (id),
  CONSTRAINT test_results_test_config_id_fkey FOREIGN KEY (test_config_id) REFERENCES public.test_configs(id),
  CONSTRAINT test_results_tool_id_fkey FOREIGN KEY (tool_id) REFERENCES public.tools(id),
  CONSTRAINT test_results_created_by_fkey FOREIGN KEY (created_by) REFERENCES auth.users(id)
);
CREATE TABLE public.test_statistics (
  id uuid NOT NULL DEFAULT gen_random_uuid(),
  test_config_id uuid NOT NULL UNIQUE,
  uptime_percentage_24h numeric DEFAULT 100.00,
  uptime_percentage_7d numeric DEFAULT 100.00,
  uptime_percentage_30d numeric DEFAULT 100.00,
  avg_response_ms_24h integer,
  min_response_ms_24h integer,
  max_response_ms_24h integer,
  total_tests_24h integer DEFAULT 0,
  failures_24h integer DEFAULT 0,
  consecutive_failures integer DEFAULT 0,
  current_status text DEFAULT 'unknown'::text CHECK (current_status = ANY (ARRAY['healthy'::text, 'warning'::text, 'critical'::text, 'unknown'::text])),
  last_success_at timestamp with time zone,
  last_failure_at timestamp with time zone,
  hourly_uptime_trend jsonb DEFAULT '[]'::jsonb,
  updated_at timestamp with time zone DEFAULT now(),
  system_id uuid,
  created_by uuid,
  visibility text DEFAULT 'org'::text CHECK (visibility = ANY (ARRAY['private'::text, 'team'::text, 'org'::text])),
  CONSTRAINT test_statistics_pkey PRIMARY KEY (id),
  CONSTRAINT test_statistics_test_config_id_fkey FOREIGN KEY (test_config_id) REFERENCES public.test_configs(id),
  CONSTRAINT test_statistics_system_id_fkey FOREIGN KEY (system_id) REFERENCES public.systems(id)
);
CREATE TABLE public.tool_access (
  id uuid,
  organization_id uuid,
  user_id uuid,
  tool USER-DEFINED,
  role USER-DEFINED,
  created_at timestamp with time zone,
  updated_at timestamp with time zone
);
CREATE TABLE public.tool_access_archived (
  id uuid NOT NULL DEFAULT gen_random_uuid(),
  organization_id uuid NOT NULL,
  user_id uuid NOT NULL,
  tool USER-DEFINED NOT NULL,
  role USER-DEFINED NOT NULL DEFAULT 'viewer'::tool_role_type,
  created_at timestamp with time zone DEFAULT now(),
  updated_at timestamp with time zone DEFAULT now(),
  CONSTRAINT tool_access_archived_pkey PRIMARY KEY (id),
  CONSTRAINT tool_access_organization_id_fkey FOREIGN KEY (organization_id) REFERENCES public.organizations(id),
  CONSTRAINT tool_access_user_id_fkey FOREIGN KEY (user_id) REFERENCES auth.users(id)
);
CREATE TABLE public.tool_settings (
  id uuid NOT NULL DEFAULT gen_random_uuid(),
  organization_id uuid NOT NULL,
  tool USER-DEFINED NOT NULL,
  settings jsonb DEFAULT '{}'::jsonb,
  created_at timestamp with time zone DEFAULT now(),
  updated_at timestamp with time zone DEFAULT now(),
  CONSTRAINT tool_settings_pkey PRIMARY KEY (id),
  CONSTRAINT tool_settings_organization_id_fkey FOREIGN KEY (organization_id) REFERENCES public.organizations(id)
);
CREATE TABLE public.tool_team_members (
  id uuid NOT NULL DEFAULT gen_random_uuid(),
  organization_id uuid NOT NULL,
  user_id uuid NOT NULL,
  tool USER-DEFINED NOT NULL,
  role USER-DEFINED NOT NULL,
  invited_by uuid,
  invited_at timestamp with time zone,
  accepted_at timestamp with time zone,
  created_at timestamp with time zone DEFAULT now(),
  CONSTRAINT tool_team_members_pkey PRIMARY KEY (id),
  CONSTRAINT tool_team_members_organization_id_fkey FOREIGN KEY (organization_id) REFERENCES public.organizations(id),
  CONSTRAINT tool_team_members_user_id_fkey FOREIGN KEY (user_id) REFERENCES auth.users(id),
  CONSTRAINT tool_team_members_invited_by_fkey FOREIGN KEY (invited_by) REFERENCES auth.users(id)
);
CREATE TABLE public.tools (
  id uuid NOT NULL DEFAULT gen_random_uuid(),
  name text NOT NULL UNIQUE,
  description text,
  created_at timestamp with time zone DEFAULT now(),
  CONSTRAINT tools_pkey PRIMARY KEY (id)
);
CREATE TABLE public.transcript_versions (
  id uuid NOT NULL DEFAULT gen_random_uuid(),
  recording_id uuid NOT NULL,
  organization_id uuid NOT NULL,
  version integer NOT NULL DEFAULT 1,
  transcript_json jsonb NOT NULL,
  transcript_hash text NOT NULL,
  produced_by text NOT NULL CHECK (produced_by = ANY (ARRAY['system'::text, 'human'::text, 'model'::text])),
  produced_by_model text,
  produced_by_user_id uuid,
  input_refs jsonb,
  created_at timestamp with time zone NOT NULL DEFAULT now(),
  is_authoritative boolean NOT NULL DEFAULT true,
  immutability_policy text NOT NULL DEFAULT 'immutable'::text CHECK (immutability_policy = ANY (ARRAY['immutable'::text, 'limited'::text, 'mutable'::text])),
  CONSTRAINT transcript_versions_pkey PRIMARY KEY (id),
  CONSTRAINT transcript_versions_recording_id_fkey FOREIGN KEY (recording_id) REFERENCES public.recordings(id),
  CONSTRAINT transcript_versions_organization_id_fkey FOREIGN KEY (organization_id) REFERENCES public.organizations(id)
);
CREATE TABLE public.usage_limits (
  id uuid NOT NULL DEFAULT gen_random_uuid(),
  organization_id uuid,
  plan text,
  metric text,
  limit_value integer,
  billing_period text,
  created_at timestamp with time zone DEFAULT now(),
  CONSTRAINT usage_limits_pkey PRIMARY KEY (id),
  CONSTRAINT usage_limits_organization_id_fkey FOREIGN KEY (organization_id) REFERENCES public.organizations(id)
);
CREATE TABLE public.usage_records (
  id uuid NOT NULL,
  organization_id uuid,
  metric text,
  value integer,
  recorded_at timestamp with time zone DEFAULT now(),
  call_id uuid,
  quantity integer,
  billing_period_start timestamp with time zone,
  billing_period_end timestamp with time zone,
  metadata jsonb,
  CONSTRAINT usage_records_pkey PRIMARY KEY (id),
  CONSTRAINT usage_records_organization_id_fkey FOREIGN KEY (organization_id) REFERENCES public.organizations(id)
);
CREATE TABLE public.users (
  id text NOT NULL,
  name text,
  email text NOT NULL UNIQUE,
  email_verified timestamp with time zone,
  image text,
  CONSTRAINT users_pkey PRIMARY KEY (id),
  CONSTRAINT fk_public_users_next_auth_users FOREIGN KEY (id) REFERENCES next_auth.users(id)
);
CREATE TABLE public.verification_tokens (
  identifier text NOT NULL,
  token text NOT NULL,
  expires timestamp with time zone NOT NULL,
  CONSTRAINT verification_tokens_pkey PRIMARY KEY (identifier, token)
);
CREATE TABLE public.voice_configs (
  id uuid NOT NULL DEFAULT gen_random_uuid(),
  organization_id uuid NOT NULL,
  record boolean DEFAULT false,
  transcribe boolean DEFAULT false,
  translate boolean DEFAULT false,
  translate_from text,
  translate_to text,
  survey boolean DEFAULT false,
  synthetic_caller boolean DEFAULT false,
  updated_by uuid,
  updated_at timestamp with time zone DEFAULT now(),
  use_voice_cloning boolean DEFAULT false,
  cloned_voice_id text,
  survey_prompts jsonb DEFAULT '[]'::jsonb,
  survey_voice text DEFAULT 'rime.spore'::text,
  survey_webhook_email text,
  survey_inbound_number text,
  shopper_script text,
  shopper_persona text DEFAULT 'professional'::text,
  shopper_expected_outcomes jsonb DEFAULT '[]'::jsonb,
  script_id uuid,
  caller_id_mask text,
  caller_id_verified boolean DEFAULT false,
  caller_id_verified_at timestamp with time zone,
  translation_from text,
  translation_to text,
  survey_question_types jsonb DEFAULT '[]'::jsonb,
  survey_prompts_locales jsonb DEFAULT '{}'::jsonb,
  ai_agent_id text,
  ai_agent_prompt text,
  ai_agent_temperature numeric DEFAULT 0.3 CHECK (ai_agent_temperature >= 0::numeric AND ai_agent_temperature <= 2::numeric),
  ai_agent_model text DEFAULT 'gpt-4o-mini'::text CHECK (ai_agent_model = ANY (ARRAY['gpt-4o-mini'::text, 'gpt-4o'::text, 'gpt-4-turbo'::text])),
  ai_post_prompt_url text,
  ai_features_enabled boolean DEFAULT true,
  live_translate boolean DEFAULT false,
  CONSTRAINT voice_configs_pkey PRIMARY KEY (id),
  CONSTRAINT voice_configs_organization_id_fkey FOREIGN KEY (organization_id) REFERENCES public.organizations(id),
  CONSTRAINT voice_configs_script_id_fkey FOREIGN KEY (script_id) REFERENCES public.shopper_scripts(id)
);
CREATE TABLE public.voice_targets (
  id uuid NOT NULL DEFAULT gen_random_uuid(),
  organization_id uuid NOT NULL,
  phone_number text NOT NULL,
  name text,
  description text,
  is_active boolean DEFAULT true,
  created_at timestamp with time zone DEFAULT now(),
  created_by uuid,
  CONSTRAINT voice_targets_pkey PRIMARY KEY (id),
  CONSTRAINT voice_targets_organization_id_fkey FOREIGN KEY (organization_id) REFERENCES public.organizations(id)
);
CREATE TABLE public.webhook_configs (
  id uuid NOT NULL DEFAULT gen_random_uuid(),
  organization_id uuid,
  type text NOT NULL CHECK (type = ANY (ARRAY['slack'::text, 'teams'::text])),
  url text NOT NULL,
  is_active boolean DEFAULT true,
  test_sent_at timestamp with time zone,
  created_at timestamp with time zone DEFAULT now(),
  updated_at timestamp with time zone DEFAULT now(),
  CONSTRAINT webhook_configs_pkey PRIMARY KEY (id),
  CONSTRAINT webhook_configs_organization_id_fkey FOREIGN KEY (organization_id) REFERENCES public.organizations(id)
);
CREATE TABLE public.webhook_deliveries (
  id uuid NOT NULL DEFAULT gen_random_uuid(),
  subscription_id uuid NOT NULL,
  event_type text NOT NULL,
  event_id uuid NOT NULL,
  payload jsonb NOT NULL,
  status text DEFAULT 'pending'::text,
  attempts integer DEFAULT 0,
  created_at timestamp with time zone DEFAULT now(),
  max_attempts integer DEFAULT 5,
  next_retry_at timestamp with time zone,
  response_status integer,
  response_body text,
  response_time_ms integer,
  last_error text,
  delivered_at timestamp with time zone,
  CONSTRAINT webhook_deliveries_pkey PRIMARY KEY (id)
);
CREATE TABLE public.webhook_failures (
  id uuid NOT NULL DEFAULT gen_random_uuid(),
  organization_id uuid,
  source text NOT NULL CHECK (source = ANY (ARRAY['signalwire'::text, 'assemblyai'::text, 'resend'::text, 'stripe'::text, 'internal'::text])),
  endpoint text NOT NULL,
  payload jsonb NOT NULL,
  headers jsonb,
  error_message text NOT NULL,
  error_code text,
  http_status integer,
  idempotency_key text UNIQUE,
  attempt_count integer NOT NULL DEFAULT 1,
  max_attempts integer NOT NULL DEFAULT 5,
  next_retry_at timestamp with time zone,
  last_attempt_at timestamp with time zone NOT NULL DEFAULT now(),
  status text NOT NULL DEFAULT 'pending'::text CHECK (status = ANY (ARRAY['pending'::text, 'retrying'::text, 'succeeded'::text, 'failed'::text, 'manual_review'::text, 'discarded'::text])),
  resolved_at timestamp with time zone,
  resolved_by uuid,
  resolution_notes text,
  created_at timestamp with time zone NOT NULL DEFAULT now(),
  resource_type text,
  resource_id uuid,
  CONSTRAINT webhook_failures_pkey PRIMARY KEY (id),
  CONSTRAINT webhook_failures_organization_id_fkey FOREIGN KEY (organization_id) REFERENCES public.organizations(id)
);
CREATE TABLE public.webhook_subscriptions (
  id uuid NOT NULL DEFAULT gen_random_uuid(),
  organization_id uuid NOT NULL,
  name text NOT NULL,
  url text NOT NULL,
  secret text NOT NULL,
  events ARRAY NOT NULL,
  active boolean DEFAULT true,
  headers jsonb DEFAULT '{}'::jsonb,
  created_by uuid,
  created_at timestamp with time zone DEFAULT now(),
  retry_policy text DEFAULT 'exponential'::text,
  max_retries integer DEFAULT 5,
  timeout_ms integer DEFAULT 30000,
  updated_at timestamp with time zone,
  CONSTRAINT webhook_subscriptions_pkey PRIMARY KEY (id)
);
CREATE TABLE public.webrtc_sessions (
  id uuid NOT NULL DEFAULT gen_random_uuid(),
  organization_id uuid NOT NULL,
  user_id uuid NOT NULL,
  session_token text NOT NULL UNIQUE,
  status text DEFAULT 'initializing'::text,
  created_at timestamp with time zone DEFAULT now(),
  call_id uuid,
  updated_at timestamp with time zone,
  CONSTRAINT webrtc_sessions_pkey PRIMARY KEY (id),
  CONSTRAINT webrtc_sessions_call_id_fkey FOREIGN KEY (call_id) REFERENCES public.calls(id)
);