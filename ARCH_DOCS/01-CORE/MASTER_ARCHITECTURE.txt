### What this updated master architecture now enforces

**1. Voice-first, call-rooted design**

* The *call* is the root object.
* Recording, translation, surveys, and secret shopper are **call modulations**, not tools.
* This directly prevents schema drift and tool sprawl.

**2. SignalWire-first v1**

* SignalWire is the authoritative **media execution plane**.
* AssemblyAI is the intelligence plane.
* No FreeSWITCH dependency exists in v1 (explicitly deferred).
2.1 SignalWire AI Agents ‚Äì Live Translation Execution (v1 Optional)

Purpose: Enable real-time bi-directional translation without self-hosted media plane.

Boundaries (non-negotiable):
- **Execution only** ‚Äî SignalWire AI Agent handles live STT/TTS/translation
- **Non-authoritative** ‚Äî AssemblyAI remains the canonical transcript source
- **Capability-gated** ‚Äî Business plan + feature flag: `translation_live_assist_preview`
- **Replaceable** ‚Äî Zero contract change when moving to FreeSWITCH v2
- **Minimal vendor lock-in** ‚Äî All persistence and evidence stay in your stack
- Live output is ephemeral and non-authoritative
- Agents do not own, decide, persist, or score

Data Flow:
```
SignalWire AI Agent (live STT ‚Üí LLM ‚Üí TTS injection)
   ‚Üì (events + partial transcripts - non-authoritative)
COE (normalization + validation)
   ‚Üì
AssemblyAI (canonical transcript + translation)
   ‚Üì
Supabase (recordings, ai_runs, evidence_manifests)
```

SignalWire AI Agent Configuration:
- Agent executes live translation during call
- Listens to one speaker, translates, and speaks translation immediately
- Preserves tone, intent, and nuance
- Auto-detects language switches
- Does NOT persist data ‚Äî ephemeral execution only
- Falls back gracefully on failure (continue without translation)

Agent Config Payload Structure:
```json
{
  "agent": {
    "name": "Word Is Bond Live Translation Agent (Preview)",
    "version": "1.0.0",
    "languages": {
      "primary": "en-US",
      "secondary": "{{dynamic:detected_language}}",
      "target": "{{dynamic:translation_to}}"
    },
    "prompt": {
      "system": "You are a live, real-time translator for phone calls...",
      "user": "Translate from {{primary}} to {{target}} in real time."
    },
    "voice": {
      "primary": "en-US-Neural2-J",
      "secondary": "{{dynamic:detected_voice}}"
    },
    "model": "gpt-4o-mini",
    "temperature": 0.3,
    "max_tokens": 150,
    "timeout": 30000
  },
  "execution": {
    "type": "live_translation",
    "trigger": "call_answered",
    "on_event": ["speech_detected", "language_changed", "silence_timeout"]
  },
  "metadata": {
    "callmonitor_call_id": "{{dynamic:call_id}}",
    "callmonitor_org_id": "{{dynamic:organization_id}}",
    "canonical_transcript_source": "assemblyai",
    "feature_flag": "translation_live_assist_preview"
  },
  "fallback": {
    "on_failure": "continue_without_translation",
    "log_to": "callmonitor_audit_logs",
    "notify": "callmonitor_kpi_live_translation_failure"
  }
}
```

Implementation Requirements:
1. **Capability Check (GET /api/call-capabilities)**
   - If `real_time_translation_preview` enabled (Business plan + flag)
   - Return `{ translation_live: true }`
   - UI enables toggle + shows "(Preview)" badge

2. **Voice Config Validation (PUT /api/voice/config)**
   - Require `translation_from` and `translation_to` when `translation_enabled: true`
   - Store in `voice_configs` table (intent only)

3. **Call Initiation (startCall server action)**
   - If live translation requested and capability allows:
     - Attach agent to SignalWire call with config payload
     - Pass dynamic values (call_id, org_id, languages)
   - Continue as normal ‚Üí COE queues AssemblyAI for canonical processing

4. **Webhook Handling (AssemblyAI)**
   - Update `ai_runs` status
   - Generate `evidence_manifests` from AssemblyAI output
   - **Ignore** SignalWire AI transcript ‚Äî it is non-authoritative

Schema Additions (minimal):
```sql
recordings
  - has_live_translation boolean DEFAULT false
  - live_translation_provider text NULLABLE ('signalwire')

ai_runs
  - Optional: model = 'signalwire-live-translate' (non-authoritative)
```

**3. One Voice Operations UI**

* All v1 voice features live on a **single page**.
* Toggles expand configuration inline.
* No feature-specific pages that imply architectural separation.

**4. Clean pre-/post-FreeSWITCH alignment**

* v1: SignalWire-only, fully capable for translation, survey, shopper.
* v2+: FreeSWITCH slots in without changing the call contract.
* This preserves forward compatibility without contaminating v1.

**5. Artifact integrity preserved**

* Recordings are first-class.
* Evidence manifests immutable.
* Scoring and alerts are post-execution intelligence layers.

**6. Capability-driven, not UI-driven**

* Plans and permissions gate execution, not visibility.
* Prevents accidental overreach from frontend toggles.

---

### What you can now safely discard

You can retire or downgrade to *reference-only*:

* Any doc implying **separate tools** for translation, shopper, or surveys
* Any v1 dependency on FreeSWITCH
* Any UI spec that creates per-feature pages
* Any architecture where AI or media systems write business state directly

---

### What to update next (recommended)

To fully lock integrity:

1. **Update UX_DESIGN_PRINCIPLES.txt**

   * Explicitly state ‚ÄúSingle Voice Operations Page‚Äù
   * Ban feature-specific navigation

2. **Add a Call Modulation Contract spec**

   * JSON schema for call configuration
   * Used by UI, COE, and tests

3. **Create a Table √ó Action √ó Phase matrix**

   * Prevents GET/PUT inversion
   * Ensures schema is used correctly per execution phase




Below is a **Voice Operations v1 sequence diagram** that is **fully aligned with the rewritten MASTER_ARCHITECTURE**, SignalWire-first execution, AssemblyAI intelligence, and a **single Voice Operations page**.

This is written so it can be:

* turned directly into a **Mermaid diagram**
* used as a **developer reference**
* embedded into documentation without ambiguity

---

# Voice Operations v1 ‚Äî Sequence Diagram

## Actors / Lifelines

* **User (UI)** ‚Äì Single Voice Operations Page
* **CPID** ‚Äì Control Plane & Insights Dashboard (Next.js / API routes)
* **COE** ‚Äì Call Orchestration Engine
* **SignalWire** ‚Äì Telephony & Media Execution Plane
* **AssemblyAI** ‚Äì Transcription / Translation / Survey NLP
* **CAS** ‚Äì Content Artifact System
* **QISE** ‚Äì Quality Intelligence & Scoring Engine
* **Supabase** ‚Äì System of Record (Postgres + Storage)
* **Notifier** ‚Äì Email/SMS/Webhooks

---

## Diagram: End-to-End Voice Operation (v1)

```
User (Voice Ops UI)
    |
    | Configure Call Modulations
    | (recording, translation, survey, secret shopper)
    v
CPID (API)
    |
    | POST /voice/execute
    | validates plan + permissions
    v
COE
    |
    | create calls row (status=pending)
    | insert call config snapshot
    v
Supabase
    |
    | OK
    v
COE
    |
    | Initiate Call
    | (SignalWire REST API)
    v
SignalWire
    |
    | PSTN Call Execution
    | Media anchored in SignalWire
    |
    |---- Media Events -----
    | call.started
    | call.answered
    | media.recording.started
    | media.recording.completed
    |
    v
COE (Webhooks)
    |
    | update calls.status = in_progress / completed
    | insert recordings row
    v
Supabase
    |
    | recording_url stored
    v
COE
    |
    | If transcription enabled
    | stream or post recording
    v
AssemblyAI
    |
    | Transcript
    | Language detection
    | Sentiment
    v
COE
    |
    | update recordings.transcript_json
    | insert ai_runs
    v
Supabase
    |
    | OK
    v
COE
    |
    | If translation enabled
    | translate transcript
    v
AssemblyAI
    |
    | Translated text
    v
COE
    |
    | If after-call survey enabled
    | extract answers / intent
    v
AssemblyAI
    |
    | Survey result JSON
    v
CAS
    |
    | Generate Evidence Manifest
    | (recording + transcript + survey)
    v
Supabase
    |
    | insert evidence_manifests
    v
QISE
    |
    | If scorecard attached
    | score recording
    v
Supabase
    |
    | insert scored_recordings
    v
MRIS
    |
    | evaluate KPIs
    | uptime / response time
    v
Supabase
    |
    | update test_statistics
    v
Alerts Engine
    |
    | if rule triggered
    v
Notifier
    |
    | Email / SMS / Webhook
    v
User (Voice Ops UI)
    |
    | Real-time updates via polling / subscriptions
    | Artifacts visible
```

---

## Key Architectural Guarantees (v1)

### 1. **Single Call Root**

Everything attaches to:

```
calls.id
```

No feature creates parallel roots.

---

### 2. **No Media Plane Leakage**

* SignalWire handles **all media**
* No FreeSWITCH
* No RTP handling in-app

This ensures:

* Lower operational risk
* Faster v1 ship
* Clean v2 insertion point

---

### 3. **AI is Post-Call (Non-Blocking)**

* Call success is independent of AI
* AI failures do not invalidate evidence
* Raw recording always preserved

---

### 4. **UI Never Orchestrates**

The UI:

* submits intent
* toggles modulations
* renders artifacts

The UI **never**:

* calls SignalWire
* calls AssemblyAI
* mutates execution state directly

---

## Where FreeSWITCH Will Slot In (v2 ‚Äì Not Active)

```
SignalWire
    |
    | delegate media
    v
FreeSWITCH (RTMPE / LLMS)
    |
    | RTP processing
    | live translation
    v
AssemblyAI / TTS
```

The **sequence above does not change**.
Only the **media execution path** does.

---

## Tables Touched by Phase

| Phase         | Tables                         |
| ------------- | ------------------------------ |
| Call intent   | calls                          |
| Execution     | calls                          |
| Recording     | recordings                     |
| Transcription | recordings, ai_runs            |
| Translation   | ai_runs                        |
| Survey        | evidence_manifests             |
| Scoring       | scored_recordings              |
| Metrics       | test_statistics                |
| Alerts        | alerts, alert_acknowledgements |

---

## Why this diagram matters

This sequence:

* prevents tool sprawl
* enforces correct table usage
* makes v2 extensibility explicit
* keeps devs from inventing new flows

---



# **Voice Operations v1 ‚Äî UI ‚Üí API ‚Üí Table Contract**

**Scope:**
Defines the **binding contract** between:

* **UI elements**
* **Backend APIs**
* **Persistent tables / artifacts**

This document is **normative**: UI cannot invent fields, APIs cannot infer intent, tables cannot be written without a contract.

---

## 1Ô∏è‚É£ Voice Operations UI (Single Page)

**Page:** `/voice-operations`

This page is a **configuration + execution surface**, not a dashboard.

### UI Sections

1. Target & Campaign
2. Feature Toggles
3. Feature Parameters
4. Execution Controls

---

## 2Ô∏è‚É£ UI ‚Üí API ‚Üí Table Matrix (Core)

### **A. Target & Campaign**

| UI Element             | API                  | Method | Tables          | Notes                  |
| ---------------------- | -------------------- | ------ | --------------- | ---------------------- |
| Target Number Selector | `/api/voice/targets` | GET    | `voice_targets` | Read-only              |
| Campaign Selector      | `/api/campaigns`     | GET    | `campaigns`     | Optional grouping      |
| Save Target+Campaign   | `/api/voice/config`  | PUT    | `voice_configs` | Creates/updates config |

---

### **B. Call Feature Toggles**

| UI Toggle                  | API                 | Method | Tables                                 | Contract Rule               |
| -------------------------- | ------------------- | ------ | -------------------------------------- | --------------------------- |
| Recording Enabled          | `/api/voice/config` | PUT    | `voice_configs.recording_enabled`      | Boolean only                |
| Transcription (AssemblyAI) | `/api/voice/config` | PUT    | `voice_configs.transcription_enabled`  | Enables AssemblyAI pipeline |
| Translation Enabled        | `/api/voice/config` | PUT    | `voice_configs.translation_enabled`    | No language = invalid       |
| After-Call Survey          | `/api/voice/config` | PUT    | `voice_configs.survey_enabled`         | Requires survey_id          |
| Secret Shopper Mode        | `/api/voice/config` | PUT    | `voice_configs.secret_shopper_enabled` | Locks script                |

üö® **Rule:** Toggles only change **intent**, never execution.

---

### **C. Feature Settings**

#### Translation

| UI Element    | API                 | Method | Tables                           |
| ------------- | ------------------- | ------ | -------------------------------- |
| From Language | `/api/voice/config` | PUT    | `voice_configs.translation_from` |
| To Language   | `/api/voice/config` | PUT    | `voice_configs.translation_to`   |

**Constraint:**
If `translation_enabled = true`, both fields required.

---

#### Survey

| UI Element      | API                 | Method | Tables                    |
| --------------- | ------------------- | ------ | ------------------------- |
| Survey Selector | `/api/surveys`      | GET    | `surveys`                 |
| Assign Survey   | `/api/voice/config` | PUT    | `voice_configs.survey_id` |

---

#### Secret Shopper

| UI Element      | API                    | Method | Tables                    |
| --------------- | ---------------------- | ------ | ------------------------- |
| Script Selector | `/api/shopper/scripts` | GET    | `shopper_scripts`         |
| Assign Script   | `/api/voice/config`    | PUT    | `voice_configs.script_id` |

**Constraint:**
Secret Shopper:

* Forces recording ON
* Forces transcription ON
* Survey optional but recommended

---

### **D. Execution Controls**

| UI Button          | API                 | Method | Tables          | Result              |
| ------------------ | ------------------- | ------ | --------------- | ------------------- |
| Place Test Call    | `/api/voice/call`   | POST   | `calls`         | Immediate execution |
| Save Configuration | `/api/voice/config` | PUT    | `voice_configs` | No execution        |

---

## 3Ô∏è‚É£ Call Execution Path (SignalWire v1)

### `/api/voice/call` (POST)

**Consumes:**

* `voice_configs`
* `voice_targets`
* `campaigns`

**Writes:**

| Table              | Purpose                       |
| ------------------ | ----------------------------- |
| `calls`            | Call lifecycle                |
| `call_legs`        | PSTN legs                     |
| `recordings`       | SignalWire recording metadata |
| `transcripts`      | AssemblyAI outputs            |
| `translations`     | Translated segments           |
| `survey_responses` | After-call survey             |
| `shopper_runs`     | Secret shopper results        |

---

## 4Ô∏è‚É£ AssemblyAI Integration Contract

### Trigger Conditions

* `transcription_enabled = true`
* Recording exists OR live stream available

### Tables

| Table                 | Source          | Notes          |
| --------------------- | --------------- | -------------- |
| `transcripts`         | AssemblyAI      | Canonical text |
| `transcript_segments` | AssemblyAI      | Timestamped    |
| `ai_insights`         | Post-processing | Optional       |

üö® **Rule:**
AssemblyAI is **downstream-only**. It never blocks call completion.

---

## 5Ô∏è‚É£ Pre-FreeSWITCH vs Post-FreeSWITCH Alignment

### v1 (Current ‚Äì SignalWire Native)

```
UI
 ‚Üí API
   ‚Üí SignalWire Call
     ‚Üí Recording
       ‚Üí AssemblyAI
         ‚Üí Surveys / Shopper
```

### v2 (Future ‚Äì FreeSWITCH Inserted)

```
UI
 ‚Üí API
   ‚Üí FreeSWITCH
     ‚Üí SignalWire / SIP
       ‚Üí Recording
         ‚Üí AssemblyAI
```

‚úÖ **No UI or table changes required**
Only the **Call Orchestration Engine adapter** changes.

---

## 6Ô∏è‚É£ Integrity Rules (Non-Negotiable)

1. **UI never writes tables directly**
2. **APIs never infer missing config**
3. **Tables never encode business logic**
4. **All execution derives from `voice_configs`**
5. **One Voice Operations page = one config**

---

## 7Ô∏è‚É£ Why This Holds

* Single-page UI stays clean
* Feature sprawl collapses into toggles + params
* AssemblyAI ‚Äúturned up‚Äù without architectural risk
* Secret Shopper, Survey, Translation coexist safely
* FreeSWITCH deferred without rework

---

## 8Ô∏è‚É£ Next (Optional but Powerful)


Excellent choice. This is the **last guardrail** that prevents product entropy.

Below is a **clean, enforceable RBAC √ó Feature Visibility Matrix** aligned with:

* Single **Voice Operations** page
* SignalWire-first v1
* AssemblyAI fully enabled
* FreeSWITCH deferred
* Feature toggles, not feature pages
* Plan gating + permissions decoupled

This matrix is **authoritative**: UI visibility, API access, and execution rights all derive from it.

---

# **RBAC √ó Feature Visibility Matrix (Voice Operations v1)**

---

## 1Ô∏è‚É£ Role Definitions (System-Wide)

| Role         | Description                            |
| ------------ | -------------------------------------- |
| **Owner**    | Account owner, billing authority       |
| **Admin**    | Full ops control, no billing           |
| **Operator** | Execute calls, cannot modify structure |
| **Analyst**  | Read-only insights                     |
| **Viewer**   | Read-only metadata                     |

---

## 2Ô∏è‚É£ Plan Definitions (Orthogonal to Role)

| Plan         | Purpose                      |
| ------------ | ---------------------------- |
| **Base**     | Core SignalWire calling      |
| **Pro**      | Recording + transcription    |
| **Insights** | Secret shopper + surveys     |
| **Global**   | Translation + multi-language |

üö® **Rule:**
Plan controls **availability**, Role controls **authority**.

---

## 3Ô∏è‚É£ Feature Visibility Matrix (UI)

### **Voice Operations Page**

| Feature          | Owner | Admin | Operator | Analyst | Viewer | Plan |
| ---------------- | ----- | ----- | -------- | ------- | ------ | ---- |
| Access Page      | ‚úÖ     | ‚úÖ     | ‚úÖ        | ‚úÖ       | üëÅ     | Base |
| Target Selector  | ‚úÖ     | ‚úÖ     | ‚úÖ        | ‚ùå       | üëÅ     | Base |
| Place Call       | ‚úÖ     | ‚úÖ     | ‚úÖ        | ‚ùå       | ‚ùå      | Base |
| Save Config      | ‚úÖ     | ‚úÖ     | ‚ùå        | ‚ùå       | ‚ùå      | Base |
| View Call Status | ‚úÖ     | ‚úÖ     | ‚úÖ        | ‚úÖ       | üëÅ     | Base |

---

### **Recording & Transcription**

| Feature              | Owner | Admin | Operator | Analyst | Viewer | Plan |
| -------------------- | ----- | ----- | -------- | ------- | ------ | ---- |
| Enable Recording     | ‚úÖ     | ‚úÖ     | ‚ùå        | ‚ùå       | ‚ùå      | Pro  |
| View Recordings      | ‚úÖ     | ‚úÖ     | ‚úÖ        | ‚úÖ       | üëÅ     | Pro  |
| Enable Transcription | ‚úÖ     | ‚úÖ     | ‚ùå        | ‚ùå       | ‚ùå      | Pro  |
| View Transcripts     | ‚úÖ     | ‚úÖ     | ‚úÖ        | ‚úÖ       | üëÅ     | Pro  |

---

### **Translation**

| Feature             | Owner | Admin | Operator | Analyst | Viewer | Plan   |
| ------------------- | ----- | ----- | -------- | ------- | ------ | ------ |
| Enable Translation  | ‚úÖ     | ‚úÖ     | ‚ùå        | ‚ùå       | ‚ùå      | Global |
| Configure Languages | ‚úÖ     | ‚úÖ     | ‚ùå        | ‚ùå       | ‚ùå      | Global |
| View Translations   | ‚úÖ     | ‚úÖ     | ‚úÖ        | ‚úÖ       | üëÅ     | Global |

---

### **After-Call Survey**

| Feature        | Owner | Admin | Operator | Analyst | Viewer | Plan     |
| -------------- | ----- | ----- | -------- | ------- | ------ | -------- |
| Enable Survey  | ‚úÖ     | ‚úÖ     | ‚ùå        | ‚ùå       | ‚ùå      | Insights |
| Assign Survey  | ‚úÖ     | ‚úÖ     | ‚ùå        | ‚ùå       | ‚ùå      | Insights |
| View Responses | ‚úÖ     | ‚úÖ     | ‚úÖ        | ‚úÖ       | üëÅ     | Insights |

---

### **Secret Shopper**

| Feature              | Owner | Admin | Operator | Analyst | Viewer | Plan     |
| -------------------- | ----- | ----- | -------- | ------- | ------ | -------- |
| Enable Shopper Mode  | ‚úÖ     | ‚úÖ     | ‚ùå        | ‚ùå       | ‚ùå      | Insights |
| Assign Script        | ‚úÖ     | ‚úÖ     | ‚ùå        | ‚ùå       | ‚ùå      | Insights |
| Execute Shopper Call | ‚úÖ     | ‚úÖ     | ‚úÖ        | ‚ùå       | ‚ùå      | Insights |
| View Shopper Results | ‚úÖ     | ‚úÖ     | ‚úÖ        | ‚úÖ       | üëÅ     | Insights |

---

## 4Ô∏è‚É£ Execution Rights Matrix (API-Level)

| API Endpoint               | Owner | Admin | Operator | Analyst | Viewer |
| -------------------------- | ----- | ----- | -------- | ------- | ------ |
| `POST /api/voice/call`     | ‚úÖ     | ‚úÖ     | ‚úÖ        | ‚ùå       | ‚ùå      |
| `PUT /api/voice/config`    | ‚úÖ     | ‚úÖ     | ‚ùå        | ‚ùå       | ‚ùå      |
| `GET /api/voice/config`    | ‚úÖ     | ‚úÖ     | ‚úÖ        | ‚úÖ       | üëÅ     |
| `GET /api/recordings`      | ‚úÖ     | ‚úÖ     | ‚úÖ        | ‚úÖ       | üëÅ     |
| `GET /api/transcripts`     | ‚úÖ     | ‚úÖ     | ‚úÖ        | ‚úÖ       | üëÅ     |
| `GET /api/surveys/results` | ‚úÖ     | ‚úÖ     | ‚úÖ        | ‚úÖ       | üëÅ     |
| `GET /api/shopper/results` | ‚úÖ     | ‚úÖ     | ‚úÖ        | ‚úÖ       | üëÅ     |

üëÅ = masked / metadata-only

---

## 5Ô∏è‚É£ Enforcement Model (How This Actually Works)

### Frontend

* Feature flags derived from:

  * `user.role`
  * `org.plan`
* Disabled features **do not render**, not just disabled

### Backend

* Middleware checks:

  * Role permission
  * Plan entitlement
* Violations return `403 Forbidden`

### Database

* No permissions logic stored
* All enforcement happens **before write**

---

## 6Ô∏è‚É£ Why This Matrix Is Correct

* Prevents ‚Äúcheckbox creep‚Äù
* Preserves single Voice Operations page
* Enables upsell without redesign
* Protects execution paths
* Future FreeSWITCH support slots in cleanly

---
Perfect. These are the **guardrail tests** that stop your platform from quietly rotting.

Below is a **Negative Test Suite for Permission Abuse**, aligned to your **Voice Operations v1**, RBAC matrix, schema, and execution flow.

This is written so it can be used by:

* QA
* Backend tests
* Security review
* Future auditors

---

# üîê Negative Test Cases ‚Äî Permission Abuse

## PURPOSE

Ensure **no role, plan, or UI trick** can:

* Execute calls
* Modify configurations
* Access restricted artifacts
* Infer restricted data

All tests assume **valid authentication** but **insufficient authorization**.

---

## 1Ô∏è‚É£ UI-Level Abuse Tests (Visibility ‚â† Capability)

### ‚ùå NT-UI-01: Viewer attempts to place a call

**Role:** Viewer
**Plan:** Base

**Action**

* Manually trigger ‚ÄúPlace Call‚Äù via DOM or devtools

**Expected**

* Button not rendered
* API call blocked with `403`
* Audit log written:

  * `action: call_attempt_denied`
  * `reason: insufficient_role`

---

### ‚ùå NT-UI-02: Analyst enables recording via UI manipulation

**Role:** Analyst
**Plan:** Pro

**Action**

* Force-enable recording toggle via React state injection

**Expected**

* UI state ignored
* Backend rejects config update
* No write to `tool_settings`
* Audit log records attempted privilege escalation

---

## 2Ô∏è‚É£ API-Level Permission Abuse

### ‚ùå NT-API-01: Operator updates voice configuration

**Endpoint**

```
PUT /api/voice/config
```

**Role:** Operator
**Plan:** Base

**Expected**

* HTTP `403 Forbidden`
* No mutation of:

  * `tool_settings`
  * `test_configs`
* Audit log:

  * `resource_type: voice_config`
  * `action: update_denied`

---

### ‚ùå NT-API-02: Viewer fetches full transcript

**Endpoint**

```
GET /api/transcripts/:recording_id
```

**Role:** Viewer
**Plan:** Pro

**Expected**

* Response contains:

  * duration
  * language
  * timestamps
* Transcript body omitted or redacted
* No access to `recordings.transcript_json`

---

### ‚ùå NT-API-03: Analyst attempts to execute secret shopper call

**Endpoint**

```
POST /api/shopper/execute
```

**Role:** Analyst
**Plan:** Insights

**Expected**

* `403 Forbidden`
* No `shopper_jobs` row created
* No SignalWire call initiated
* Audit log created

---

## 3Ô∏è‚É£ Plan Abuse (Entitlement Violations)

### ‚ùå NT-PLAN-01: Base plan enables translation

**Role:** Admin
**Plan:** Base

**Action**

* Enable translation toggle

**Expected**

* UI hides toggle
* API rejects config
* No AI run created
* No AssemblyAI invocation

---

### ‚ùå NT-PLAN-02: Pro plan accesses shopper results

**Role:** Admin
**Plan:** Pro

**Endpoint**

```
GET /api/shopper/results
```

**Expected**

* `402 Payment Required` or `403 Forbidden`
* No access to:

  * `shopper_results`
  * `shopper_campaigns`

---

## 4Ô∏è‚É£ Cross-Tenant & Data Leakage

### ‚ùå NT-DATA-01: User accesses recording from another org

**Role:** Admin
**Plan:** Pro

**Action**

* Request recording ID not owned by org

**Expected**

* `404 Not Found` (not `403`)
* Prevents ID probing
* No timing side-channel

---

### ‚ùå NT-DATA-02: Analyst queries raw AssemblyAI output

**Endpoint**

```
GET /api/ai_runs/:id/output
```

**Expected**

* Access denied
* Only post-processed artifacts allowed
* No raw model output exposed

---

## 5Ô∏è‚É£ Execution Plane Abuse

### ‚ùå NT-EXEC-01: Operator attempts to invoke AI directly

**Action**

* Call internal AI execution endpoint

**Expected**

* Endpoint not exposed
* Service-to-service auth required
* User token rejected

---

### ‚ùå NT-EXEC-02: UI attempts to start call without org context

**Action**

* Strip `organization_id` from request

**Expected**

* Request rejected
* No call created
* No SignalWire webhook armed

---

## 6Ô∏è‚É£ State Corruption & Inversion Tests

### ‚ùå NT-STATE-01: Frontend sends PUT instead of POST

**Endpoint**

```
PUT /api/voice/call
```

**Expected**

* `405 Method Not Allowed`
* Prevents ‚Äúupdate call‚Äù anti-pattern

---

### ‚ùå NT-STATE-02: Attempt to modify immutable artifacts

**Target Tables**

* `recordings`
* `evidence_manifests`
* `audit_logs`

**Expected**

* Database-level immutability
* Application-level rejection
* Audit log entry

---

## 7Ô∏è‚É£ Timing & Replay Attacks

### ‚ùå NT-REPLAY-01: Reuse call execution payload

**Action**

* Replay identical call payload

**Expected**

* Idempotency key enforced
* Only one call created
* Duplicate rejected

---

### ‚ùå NT-REPLAY-02: Expired role token

**Expected**

* Token rejected
* No partial execution
* No side effects

---

## 8Ô∏è‚É£ Audit Integrity Tests

### ‚ùå NT-AUDIT-01: Failed action without audit log

**Expected**

* Every denied action produces an audit log
* Logs include:

  * user_id
  * org_id
  * action
  * reason
  * timestamp

---

### ‚ùå NT-AUDIT-02: User attempts to delete audit logs

**Expected**

* Endpoint does not exist
* DB permissions deny
* Tamper-proof guarantee

---

## 9Ô∏è‚É£ Kill-Switch Tests (Emergency Control)

### ‚ùå NT-KILL-01: Org plan suspended

**Expected**

* All execution endpoints disabled
* Read-only access remains
* Clear error messaging

---

## 10Ô∏è‚É£ Why This Matters

This suite guarantees:

* UI cannot lie
* API cannot be tricked
* Plans are enforceable
* Roles are meaningful
* Future FreeSWITCH won‚Äôt introduce privilege creep

---

Excellent move. This is the right moment to formalize it.

Below is a **SOC 2‚Äìstyle control mapping** tailored to your **Voice Operations v1 architecture**, SignalWire-first execution, Supabase-backed data layer, and call-rooted artifact model.

This is written in **audit-ready language** but remains **engineering-usable**.

---

# SOC 2 Control Mapping ‚Äî Voice Operations Platform (v1)

**Trust Services Criteria (TSC):**

* Security (CC)
* Availability (A)
* Confidentiality (C)
* Processing Integrity (PI)

---

## 1Ô∏è‚É£ SECURITY (COMMON CRITERIA)

### CC1 ‚Äî Control Environment

| Control | Description                                                                       |
| ------- | --------------------------------------------------------------------------------- |
| CC1.1   | Organization establishes roles, responsibilities, and authority for system access |
| CC1.2   | Management defines acceptable use and access standards                            |

**Implementation**

* Role-based access via `org_members`, `tool_team_members`
* Plan entitlements via `organizations.plan`
* No implicit permissions in UI or API

**Evidence**

* RBAC √ó Feature Visibility Matrix
* Org member role assignments
* Audit logs for access changes

---

### CC2 ‚Äî Communication & Information

| Control | Description                                             |
| ------- | ------------------------------------------------------- |
| CC2.1   | Security responsibilities are communicated and enforced |

**Implementation**

* UI hides unauthorized features
* API rejects unauthorized actions
* Explicit error messages without leakage

**Evidence**

* UI contract docs
* API permission middleware
* Negative permission test cases

---

### CC3 ‚Äî Risk Assessment

| Control | Description                                                        |
| ------- | ------------------------------------------------------------------ |
| CC3.2   | Risks related to data access, execution, and misuse are identified |

**Identified Risks**

* Unauthorized call execution
* Transcript exposure
* AI output misuse
* Cross-org data access

**Mitigations**

* Call-rooted execution model
* Immutable artifacts
* RLS + service-role separation

---

### CC5 ‚Äî Control Activities

| Control | Description                                          |
| ------- | ---------------------------------------------------- |
| CC5.2   | Logical access controls prevent unauthorized actions |

**Implementation**

* Supabase RLS for all client access
* Service role key restricted to backend
* Idempotent write contracts

**Evidence**

* RLS migration files
* API logs
* Audit trail records

---

### CC6 ‚Äî Logical & Physical Access Controls

| Control | Description                                            |
| ------- | ------------------------------------------------------ |
| CC6.1   | Access to systems and data is restricted based on role |

**Implementation**

* API authorization middleware
* Table-level RLS policies
* No direct client access to execution systems

**Evidence**

* Access control tests
* Blocked API responses
* Role assignment logs

---

### CC6.6 ‚Äî Privileged Access Management

| Control | Description                                   |
| ------- | --------------------------------------------- |
| CC6.6   | Privileged operations are logged and reviewed |

**Implementation**

* All privileged writes require service-role key
* All privilege denials logged

**Evidence**

* `audit_logs`
* Service execution logs

---

### CC7 ‚Äî System Operations

| Control | Description                                                  |
| ------- | ------------------------------------------------------------ |
| CC7.2   | System activity is monitored and anomalous behavior detected |

**Implementation**

* Execution status tracking (`calls.status`, `ai_runs.status`)
* KPI monitoring tables
* Alerting via `alerts`

**Evidence**

* Alert rules
* KPI logs
* Incident records

---

## 2Ô∏è‚É£ AVAILABILITY

### A1 ‚Äî System Availability Commitments

| Control | Description                                    |
| ------- | ---------------------------------------------- |
| A1.2    | System availability commitments are documented |

**Implementation**

* Plan-based SLAs (Business tier)
* Carrier monitoring via `carrier_status`

**Evidence**

* Plan documentation
* Carrier incident history

---

### A2 ‚Äî Backup & Recovery

| Control | Description                              |
| ------- | ---------------------------------------- |
| A2.1    | System data is backed up and recoverable |

**Implementation**

* Supabase managed backups
* Immutable recording artifacts

**Evidence**

* Backup policy documentation
* Recovery test logs

---

## 3Ô∏è‚É£ CONFIDENTIALITY

### C1 ‚Äî Data Classification

| Control | Description                                   |
| ------- | --------------------------------------------- |
| C1.1    | Confidential data is identified and protected |

**Implementation**

* Transcript and call metadata classified as confidential
* AI raw outputs restricted

**Evidence**

* Data classification policy
* API response filtering

---

### C1.2 ‚Äî Encryption

| Control | Description                              |
| ------- | ---------------------------------------- |
| C1.2    | Data is encrypted at rest and in transit |

**Implementation**

* Supabase encryption at rest
* TLS for all APIs
* SignalWire encrypted media transport

**Evidence**

* Vendor security documentation
* TLS configs

---

### C1.3 ‚Äî Confidential Output Handling

| Control | Description                           |
| ------- | ------------------------------------- |
| C1.3    | Sensitive outputs are not overexposed |

**Implementation**

* Transcript redaction by role
* No raw AI output exposure

**Evidence**

* API contracts
* Role-based response examples

---

## 4Ô∏è‚É£ PROCESSING INTEGRITY

### PI1 ‚Äî Data Processing Accuracy

| Control | Description                                     |
| ------- | ----------------------------------------------- |
| PI1.1   | System processes data accurately and completely |

**Implementation**

* Idempotent scoring writes
* Deterministic evidence manifests

**Evidence**

* `scored_recordings` uniqueness constraints
* Manifest versioning

---

### PI1.2 ‚Äî Input Validation

| Control | Description                              |
| ------- | ---------------------------------------- |
| PI1.2   | Inputs are validated prior to processing |

**Implementation**

* Strict API schemas
* Call configuration validation

**Evidence**

* API validation code
* Rejected request logs

---

### PI1.3 ‚Äî Output Validation

| Control | Description                         |
| ------- | ----------------------------------- |
| PI1.3   | Outputs are reviewed and verifiable |

**Implementation**

* Evidence manifests link inputs ‚Üí outputs
* Human review tooling (Business tier)

**Evidence**

* Manifest samples
* Review logs

---

## 5Ô∏è‚É£ CHANGE MANAGEMENT

### CC8 ‚Äî Change Control

| Control | Description                                    |
| ------- | ---------------------------------------------- |
| CC8.1   | Changes are authorized, tested, and documented |

**Implementation**

* Schema migrations
* Feature flags
* Plan-gated rollouts

**Evidence**

* Migration history
* Feature flag configs

---

## 6Ô∏è‚É£ INCIDENT RESPONSE

### CC7.4 ‚Äî Incident Handling

| Control | Description                                      |
| ------- | ------------------------------------------------ |
| CC7.4   | Incidents are logged, investigated, and resolved |

**Implementation**

* Alerts + acknowledgements
* Incident tracking tables

**Evidence**

* Incident records
* Response timelines

---

## 7Ô∏è‚É£ VENDOR & DEPENDENCY CONTROLS

### CC9 ‚Äî Vendor Risk Management

| Vendor     | Control                             |
| ---------- | ----------------------------------- |
| SignalWire | Media execution security            |
| AssemblyAI | Transcription & language processing |
| Supabase   | Data storage & RLS                  |
| Stripe     | Billing & plan enforcement          |

**Evidence**

* Vendor SOC reports
* Security documentation

---

## 8Ô∏è‚É£ CONTROL SUMMARY MATRIX

| Area                | Coverage |
| ------------------- | -------- |
| Authentication      | ‚úÖ        |
| Authorization       | ‚úÖ        |
| Execution Isolation | ‚úÖ        |
| Data Integrity      | ‚úÖ        |
| Auditability        | ‚úÖ        |
| Confidentiality     | ‚úÖ        |
| Availability        | ‚úÖ        |

---

## 9Ô∏è‚É£ What This Enables

With this mapping you can:

* Pass early SOC2 Type I
* Support enterprise due diligence
* Onboard regulated customers
* Scale to FreeSWITCH later without rewriting controls

---










