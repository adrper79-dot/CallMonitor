# Error Handling Plan

## Overview
This document describes the error handling architecture, philosophy, and implementation for the CallRoute Monitor project. It covers error categorization, tracking, reporting, and integration with monitoring systems.

---

## 1. Philosophy
- Every error is classified by category and severity.
- All errors are cataloged with unique codes and user-facing messages.
- Each error instance is assigned a unique tracking ID for correlation across logs and systems.
- KPIs are collected for error frequency, endpoint health, and system status.
- Customer-facing messages are separated from internal/debug messages.
- All API endpoints use a consistent error response structure.
- **NEVER use console.log/console.error** - Use centralized `logger` from `@/lib/logger`.

**New error codes for live translation (SignalWire AI Agents):**
- `LIVE_TRANSLATE_EXECUTION_FAILED` (MEDIUM, EXTERNAL category)
  - User message: "Live translation encountered an issue. Post-call transcript is still available."
  - Category: EXTERNAL
  - Severity: MEDIUM
  - HTTP Status: 500
  - Track KPI: true
  - Should alert: false
- `LIVE_TRANSLATE_VENDOR_DOWN` (HIGH, EXTERNAL category)
  - User message: "Live translation service is temporarily unavailable. Post-call transcript will be available."
  - Category: EXTERNAL
  - Severity: HIGH
  - HTTP Status: 503
  - Track KPI: true
  - Should alert: true
  - Triggers KPI increment for vendor health monitoring

---

## 2. Error Catalog
- Centralized in `lib/errors/errorCatalog.ts`.
- Defines all error codes, categories, severities, and messages.
- Example categories: AUTH, USER, ORG, DB, TEST_CONFIG, TEST_EXEC, DATA, SYSTEM, EXTERNAL.
- Example severities: CRITICAL, HIGH, MEDIUM, LOW.
- Each error has:
  - Internal message (for logs)
  - Customer message (for UI/API)
  - Severity
  - HTTP status code
  - Should alert (for monitoring)
  - Track KPI (for metrics)

---

## 3. Error Tracking & Logging
- Implemented in `lib/errors/errorTracker.ts`.
- Every error instance gets a unique tracking ID: `ERR_YYYYMMDD_ABC123`.
- Structured error object includes:
  - Code, category, severity
  - Internal and customer messages
  - Endpoint, method, user/org context
  - Timestamp, stack trace, request info
- Errors are logged to console (with severity) and sent to monitoring (e.g., Sentry).

---

## 4. KPI Collection
- Implemented in `lib/errors/kpi.ts`.
- Tracks:
  - Error frequency by code
  - Error rate by endpoint
  - Critical error count
  - System health status (healthy, degraded, critical)
- KPIs are available via `/api/errors/metrics` endpoint for dashboards/alerting.

---

## 5. API Integration
- All API endpoints use helpers from `lib/errors/apiHandler.ts`:
  - `ApiErrors.*` - Pre-built error responses (unauthorized, notFound, etc.)
  - `apiError()` - Custom error response with tracking ID
  - `apiSuccess()` - Standard success response
  - `withErrorHandling()` - Full wrapper with KPI tracking
- Error responses always include:
  - `success: false`
  - `error: { id, code, message, severity, ... }`
  - Internal details only in development

### Quick Reference:
```typescript
import { ApiErrors, apiSuccess, apiError } from '@/lib/errors/apiHandler'
import { logger } from '@/lib/logger'

// Standard error responses
return ApiErrors.unauthorized()           // 401
return ApiErrors.forbidden()              // 403
return ApiErrors.notFound('Campaign')     // 404
return ApiErrors.badRequest('Invalid ID') // 400
return ApiErrors.internal('Server error') // 500
return ApiErrors.dbError('Query failed')  // 500

// Custom error
return apiError('CUSTOM_CODE', 'Message', 400, 'MEDIUM')

// Success response
return apiSuccess({ data: result })

// Logging (NEVER use console.error)
logger.error('Operation failed', error, { context: 'value' })
```

---

## 6. Monitoring & Alerting
- Critical and high-severity errors trigger alerts (configurable).
- Sentry integration planned for production.
- KPIs and error logs are available for review and trend analysis.

---

## 7. Example Error Response
```
{
  "success": false,
  "error": {
    "id": "ERR_20260103_ABC123",
    "code": "DB_QUERY_FAILED",
    "message": "Could not retrieve data. Please try again.",
    "severity": "high"
  }
}
```

---

## 8. Future Improvements
- Add error localization for multi-language support.
- Integrate with external alerting (PagerDuty, Slack).
- Persist error logs and KPIs in database for long-term analysis.
- Add error suppression/aggregation for noisy endpoints.
