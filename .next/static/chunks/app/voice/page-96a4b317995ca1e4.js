(self.webpackChunk_N_E=self.webpackChunk_N_E||[]).push([[288],{9208:function(e,t,a){Promise.resolve().then(a.bind(a,9166))},2869:function(e,t,a){"use strict";a.d(t,{z:function(){return l}});var s=a(7437);function l(e){let{children:t,className:a="",variant:l="default",size:n="md",...i}=e;return(0,s.jsx)("button",{className:"".concat("inline-flex items-center justify-center rounded-md focus:outline-none"," ").concat({default:"bg-indigo-600 text-white hover:bg-indigo-500",outline:"border border-slate-700 text-slate-100",ghost:"bg-transparent text-slate-100"}[l]," ").concat({sm:"px-2 py-1 text-sm",md:"px-3 py-2",lg:"px-4 py-2"}[n]," ").concat(a),...i,children:t})}a(2265)},4895:function(e,t,a){"use strict";function s(e){let{title:t,description:a,variant:s}=e;console.log("TOAST",{title:t,description:a,variant:s})}a.d(t,{A:function(){return s}})},9166:function(e,t,a){"use strict";a.d(t,{default:function(){return B}});var s=a(7437),l=a(2265);function n(e){let[t,a]=(0,l.useState)({role:null,plan:null,loading:!0,error:null});return(0,l.useEffect)(()=>{if(!e){a({role:null,plan:null,loading:!1,error:null});return}(async function(){try{let t=await fetch("/api/rbac/context?orgId=".concat(encodeURIComponent(e)));if(!t.ok)throw Error("Failed to fetch RBAC context");let s=await t.json();a({role:s.role||null,plan:s.plan||null,loading:!1,error:null})}catch(e){a({role:null,plan:null,loading:!1,error:(null==e?void 0:e.message)||"Failed to load permissions"})}})()},[e]),t}var i=a(2869);function r(e){let{children:t,className:a="",variant:l="default",...n}=e;return(0,s.jsx)("span",{className:"inline-flex items-center px-2 py-0.5 rounded-full text-xs font-medium ".concat({default:"bg-slate-700 text-slate-100",success:"bg-green-600 text-white",warning:"bg-yellow-600 text-white",error:"bg-red-600 text-white",info:"bg-blue-600 text-white"}[l]," ").concat(a),...n,children:t})}function c(e){let{organizationId:t,organizationName:a}=e,{role:l,plan:c,loading:d}=n(t),o=c?c.charAt(0).toUpperCase()+c.slice(1):"Loading...",u=l?l.charAt(0).toUpperCase()+l.slice(1):"",m=c&&!["global","enterprise"].includes(c.toLowerCase());return(0,s.jsx)("header",{className:"w-full border-b border-slate-800 bg-slate-950 px-6 py-4",children:(0,s.jsxs)("div",{className:"flex items-center justify-between",children:[(0,s.jsxs)("div",{className:"flex items-center gap-4",children:[(0,s.jsx)("h1",{className:"text-xl font-semibold text-slate-100",children:"CallMonitor – Voice Operations"}),a&&(0,s.jsxs)("span",{className:"text-sm text-slate-400",children:["Org: ",a]})]}),(0,s.jsx)("div",{className:"flex items-center gap-4",children:!d&&(0,s.jsxs)(s.Fragment,{children:[c&&(0,s.jsxs)("div",{className:"flex items-center gap-2",children:[(0,s.jsx)("span",{className:"text-sm text-slate-400",children:"Plan:"}),(0,s.jsx)(r,{variant:"info",children:o})]}),l&&(0,s.jsxs)("div",{className:"flex items-center gap-2",children:[(0,s.jsx)("span",{className:"text-sm text-slate-400",children:"Role:"}),(0,s.jsx)(r,{variant:"default",children:u})]}),m&&(0,s.jsx)(i.z,{variant:"outline",size:"sm",onClick:()=>{window.location.href="/settings/billing?upgrade=true"},"aria-label":"Upgrade plan",children:"Upgrade"})]})})]})})}function d(e){let{className:t="",label:a,error:l,id:n,...i}=e,r=n||"input-".concat(Math.random().toString(36).substr(2,9));return(0,s.jsxs)("div",{className:"w-full",children:[a&&(0,s.jsx)("label",{className:"block text-sm font-medium text-slate-100 mb-1",htmlFor:r,children:a}),(0,s.jsx)("input",{id:r,className:"w-full px-3 py-2 bg-slate-800 border border-slate-700 rounded-md text-slate-100 focus:outline-none focus:ring-2 focus:ring-indigo-500 ".concat(l?"border-red-500":""," ").concat(t),...i}),l&&(0,s.jsx)("p",{className:"mt-1 text-sm text-red-400",children:l})]})}function o(e){let{children:t,className:a="",label:l,error:n,...i}=e;return(0,s.jsxs)("div",{className:"w-full",children:[l&&(0,s.jsx)("label",{className:"block text-sm font-medium text-slate-100 mb-1",htmlFor:i.id,children:l}),(0,s.jsx)("select",{className:"w-full px-3 py-2 bg-slate-800 border border-slate-700 rounded-md text-slate-100 focus:outline-none focus:ring-2 focus:ring-indigo-500 ".concat(a),...i,children:t}),n&&(0,s.jsx)("p",{className:"mt-1 text-sm text-red-400",children:n})]})}var u=a(3053);function m(e){let[t,a]=(0,l.useState)([]),[s,n]=(0,l.useState)(!1),i=(0,l.useRef)([]);return(0,l.useEffect)(()=>{if(!e)return;let t=null,s=!0;return async function(){try{let l=await fetch("/api/realtime/subscribe",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({organization_id:e})});if(!l.ok)return;let{config:r}=await l.json();for(let e of(t=(0,u.eI)(r.supabaseUrl,"sb_publishable_lRUy5ZWTCzCNPTuOP9K9Rg_Nh-nEClF"),r.channels)){let l=t.channel(e.name).on("postgres_changes",{event:"*",schema:"public",table:e.table,filter:e.filter},e=>{s&&a(t=>[...t,{...e,timestamp:new Date().toISOString()}])}).subscribe(e=>{s&&n("SUBSCRIBED"===e)});i.current.push(l)}}catch(e){console.error("useRealtime: setup failed",e)}}(),()=>{s=!1,i.current.forEach(e=>{t&&t.removeChannel(e)}),i.current=[]}},[e]),{updates:t,connected:s,clearUpdates:()=>a([])}}function x(e){let t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:5e3,a=!(arguments.length>2)||void 0===arguments[2]||arguments[2],[s,n]=(0,l.useState)([]),[i,r]=(0,l.useState)(!0);return(0,l.useEffect)(()=>{if(!a)return;let s=!0;async function l(){try{let t=await e();s&&(n(t),r(!1))}catch(e){s&&r(!1)}}l();let i=setInterval(l,t);return()=>{s=!1,clearInterval(i)}},[e,t,a]),{data:s,loading:i}}function h(e){let{calls:t,selectedCallId:a,organizationId:n,onSelect:c}=e,[u,h]=(0,l.useState)(t),[f,v]=(0,l.useState)(t),[p,g]=(0,l.useState)(0),[j,b]=(0,l.useState)("all"),[N,y]=(0,l.useState)(""),[w,S]=(0,l.useState)("date"),[_,C]=(0,l.useState)(1),[k,E]=(0,l.useState)(!1),I=(0,l.useRef)(null),{updates:z,connected:D}=m(n||null),{data:T}=x(async()=>{if(!n)return[];try{let e=await fetch("/api/calls?orgId=".concat(encodeURIComponent(n),"&page=").concat(_,"&limit=").concat(20));if(e.ok)return(await e.json()).calls||[];return[]}catch(e){return[]}},5e3,!D&&null!==n);(0,l.useEffect)(()=>{z.length&&z.forEach(e=>{if("calls"===e.table&&("INSERT"===e.eventType||"UPDATE"===e.eventType)){let t=e.new;h(e=>{let a=e.findIndex(e=>e.id===t.id);if(!(a>=0))return[t,...e];{let s=[...e];return s[a]={...s[a],...t},s}})}})},[z]),(0,l.useEffect)(()=>{!D&&T.length>0&&h(T)},[T,D]),(0,l.useEffect)(()=>{let e=[...u];if("all"!==j&&(e=e.filter(e=>"active"===j?"in_progress"===e.status||"ringing"===e.status:"completed"===j?"completed"===e.status:"failed"!==j||"failed"===e.status||"no-answer"===e.status||"busy"===e.status)),N){let t=N.toLowerCase();e=e.filter(e=>{var a,s;return e.id.toLowerCase().includes(t)||(null===(a=e.call_sid)||void 0===a?void 0:a.toLowerCase().includes(t))||(null===(s=e.created_by)||void 0===s?void 0:s.toLowerCase().includes(t))})}e.sort((e,t)=>{if("date"===w){let a=e.started_at?new Date(e.started_at).getTime():0;return(t.started_at?new Date(t.started_at).getTime():0)-a}return 0}),v(e),C(1)},[u,j,N,w]);let O=f.slice(0,20*_),L=f.length>20*_;function R(e){g(e);let t=I.current,a=null==t?void 0:t.querySelectorAll('[role="listitem"]')[e];null==a||a.focus()}(0,l.useEffect)(()=>{if(a){let e=O.findIndex(e=>e.id===a);e>=0&&g(e)}},[a,O]);let U=e=>"completed"===e?"success":"in_progress"===e||"ringing"===e?"info":"failed"===e||"no-answer"===e||"busy"===e?"error":"default";return(0,s.jsxs)("div",{className:"h-full flex flex-col",children:[(0,s.jsxs)("div",{className:"p-4 border-b border-slate-800 space-y-3",children:[(0,s.jsx)(d,{label:"Search",type:"search",value:N,onChange:e=>y(e.target.value),placeholder:"Search by ID, SID, or user...",className:"w-full"}),(0,s.jsxs)("div",{className:"grid grid-cols-2 gap-2",children:[(0,s.jsxs)(o,{label:"Status",value:j,onChange:e=>b(e.target.value),children:[(0,s.jsx)("option",{value:"all",children:"All"}),(0,s.jsx)("option",{value:"active",children:"Active"}),(0,s.jsx)("option",{value:"completed",children:"Completed"}),(0,s.jsx)("option",{value:"failed",children:"Failed"})]}),(0,s.jsxs)(o,{label:"Sort By",value:w,onChange:e=>S(e.target.value),children:[(0,s.jsx)("option",{value:"date",children:"Date (Newest)"}),(0,s.jsx)("option",{value:"score",children:"Score"}),(0,s.jsx)("option",{value:"duration",children:"Duration"})]})]}),!D&&(0,s.jsxs)("div",{className:"text-xs text-amber-400 flex items-center gap-1",children:[(0,s.jsx)("span",{children:"⚠"}),(0,s.jsx)("span",{children:"Real-time disconnected. Using polling."})]})]}),(0,s.jsxs)("div",{ref:I,role:"list","aria-label":"Calls list",onKeyDown:function(e){if(O&&0!==O.length){if("ArrowDown"===e.key)e.preventDefault(),R(Math.min(O.length-1,p+1));else if("ArrowUp"===e.key)e.preventDefault(),R(Math.max(0,p-1));else if("Enter"===e.key||" "===e.key){e.preventDefault();let t=O[p];t&&(null==c||c(t.id))}}},tabIndex:0,className:"flex-1 overflow-y-auto p-4 space-y-2",children:[k?(0,s.jsx)("div",{className:"text-center text-slate-400 py-8",children:"Loading calls..."}):0===O.length?(0,s.jsx)("div",{className:"text-center text-slate-400 py-8",children:"No calls found"}):O.map((e,t)=>{var l;let n=a===e.id;return(0,s.jsx)("div",{role:"listitem",tabIndex:-1,"aria-selected":n,onClick:()=>null==c?void 0:c(e.id),onFocus:()=>g(t),className:"w-full p-3 rounded-md focus:outline-none focus:ring-2 focus:ring-offset-1 focus:ring-indigo-500 transition-colors cursor-pointer bg-slate-800 hover:bg-slate-700 ".concat(n?"ring-2 ring-indigo-500":""),children:(0,s.jsxs)("div",{className:"flex items-center justify-between",children:[(0,s.jsxs)("div",{className:"flex-1 min-w-0",children:[(0,s.jsxs)("div",{className:"flex items-center gap-2 mb-1",children:[(0,s.jsx)("h4",{className:"text-sm font-medium text-slate-100 truncate",children:e.id}),(0,s.jsx)(r,{variant:U(e.status),children:null!==(l=e.status)&&void 0!==l?l:"unknown"})]}),(0,s.jsx)("div",{className:"mt-1 text-xs text-slate-400 truncate",children:e.started_at?new Date(e.started_at).toLocaleString():"—"}),e.created_by&&(0,s.jsxs)("div",{className:"mt-0.5 text-xs text-slate-500 truncate",children:["By: ",e.created_by]})]}),e.call_sid&&(0,s.jsx)("div",{className:"ml-3 text-right",children:(0,s.jsx)("div",{className:"text-xs text-slate-500 font-mono truncate max-w-[100px]",children:e.call_sid})})]})},e.id)}),L&&(0,s.jsx)("div",{className:"pt-4 text-center",children:(0,s.jsxs)(i.z,{variant:"outline",size:"sm",onClick:function(){C(e=>e+1)},children:["Load More (",f.length-O.length," remaining)"]})})]}),(0,s.jsxs)("div",{className:"p-4 border-t border-slate-800 text-xs text-slate-400",children:["Showing ",O.length," of ",f.length," calls"]})]})}function f(e){let{children:t,className:a="",...l}=e;return(0,s.jsx)("label",{className:"text-sm font-medium ".concat(a),...l,children:t})}function v(e){let{checked:t=!1,onChange:a,onCheckedChange:l,className:n="",...i}=e;return(0,s.jsx)("button",{type:"button",role:"switch","aria-checked":t,onClick:()=>{let e=!t;null==a||a(e),null==l||l(e)},className:"inline-flex items-center h-7 w-12 rounded-full p-1 ".concat(t?"bg-indigo-600":"bg-slate-700"," ").concat(n),...i,children:(0,s.jsx)("span",{className:"inline-block h-5 w-5 rounded-full bg-white transform ".concat(t?"translate-x-5":"translate-x-0")})})}let p={recording:["pro","insights","global","enterprise","standard","active"],transcription:["pro","insights","global","enterprise","standard","active"],translation:["global","enterprise"],real_time_translation_preview:["business","enterprise"],survey:["insights","global","enterprise"],secret_shopper:["insights","global","enterprise"]};function g(e){let[t,a]=(0,l.useState)(null),[s,n]=(0,l.useState)(!0),[i,r]=(0,l.useState)(null);return(0,l.useEffect)(()=>{if(!e){a(null),n(!1);return}(async function(){try{n(!0),r(null);let t=await fetch("/api/voice/config?orgId=".concat(encodeURIComponent(e)));if(!t.ok)throw Error("Failed to fetch voice config");let s=await t.json();a(s.config||{})}catch(e){r((null==e?void 0:e.message)||"Failed to load config"),a(null)}finally{n(!1)}})()},[e]),{config:t,loading:s,error:i,updateConfig:async function(t){if(!e)throw Error("Organization ID required");try{r(null);let s=await fetch("/api/voice/config",{method:"PUT",headers:{"Content-Type":"application/json"},body:JSON.stringify({orgId:e,...t})});if(!s.ok){let e=await s.json().catch(()=>({error:"Failed to update config"}));throw Error(e.error||"Failed to update config")}let l=await s.json();return a(l.config||{}),l.config}catch(e){throw r((null==e?void 0:e.message)||"Failed to update config"),e}}}}let j=[{key:"record",label:"Recording",desc:"Capture call audio",feature:"recording",plan:"Pro+"},{key:"transcribe",label:"Transcribe",desc:"Generate transcript",feature:"transcription",plan:"Pro+"},{key:"translate",label:"Translate",desc:"Translate transcript",feature:"translation",plan:"Global+"},{key:"survey",label:"After-call Survey",desc:"Run after-call survey",feature:"survey",plan:"Insights+"},{key:"synthetic_caller",label:"Secret Shopper",desc:"Use secret shopper script",feature:"secret_shopper",plan:"Insights+"}];function b(e){let{callId:t,organizationId:a,initialModulations:i,onChange:c}=e,{role:d,plan:u,loading:m}=n(a),{config:x,updateConfig:h}=g(a),{capabilities:b,loading:N}=function(e){let[t,a]=(0,l.useState)({}),[s,n]=(0,l.useState)(!0);return(0,l.useEffect)(()=>{if(!e){a({}),n(!1);return}let t=!0;return n(!0),fetch("/api/call-capabilities?orgId=".concat(encodeURIComponent(e))).then(e=>e.json()).then(e=>{t&&(e.success&&e.capabilities?a(e.capabilities):a({}),n(!1))}).catch(()=>{t&&(a({}),n(!1))}),()=>{t=!1}},[e]),{capabilities:t,loading:s}}(a),[y,w]=(0,l.useState)(()=>({...i})),[S,_]=(0,l.useState)(()=>({record:!1,transcribe:!1,translate:!1,survey:!1,synthetic_caller:!1})),[C,k]=(0,l.useState)(null);(0,l.useEffect)(()=>{w({...i})},[i]);let E="owner"===d||"admin"===d;async function I(e){if(!E){k("Only Owners and Admins can modify modulations");return}k(null);let t={...y},a={...y,[e]:!y[e]};w(a),_(t=>({...t,[e]:!0}));try{await h({["record"===e?"recording_enabled":"transcribe"===e?"transcription_enabled":"translate"===e?"translation_enabled":"survey"===e?"survey_enabled":"secret_shopper_enabled"]:a[e]}),await c(a)}catch(e){var s;w(t),k(null!==(s=null==e?void 0:e.message)&&void 0!==s?s:"Update failed")}finally{_(t=>({...t,[e]:!1}))}}return(0,s.jsxs)("section",{"aria-labelledby":"call-modulations-".concat(t),className:"w-full p-4 bg-slate-950 rounded-md border border-slate-800",children:[(0,s.jsxs)("div",{className:"flex items-center justify-between mb-4",children:[(0,s.jsx)("h3",{id:"call-modulations-".concat(t),className:"text-lg font-medium text-slate-100",children:"Call Modulations"}),!E&&(0,s.jsx)("p",{className:"text-sm text-slate-400",children:"Read-only (Owner/Admin can modify)"})]}),(0,s.jsx)("div",{className:"mt-4 grid grid-cols-1 gap-3",children:j.map(e=>{let{disabled:t,reason:a}=function(e,t){if(m)return{disabled:!0,reason:"Loading permissions..."};if(!u)return{disabled:!0,reason:"Plan not available"};if(!function(e,t){let a=e.toLowerCase(),s=p[t];return!s||s.includes(a)}(u,t)){var a;return{disabled:!0,reason:"This feature requires ".concat((null===(a=j.find(t=>t.key===e))||void 0===a?void 0:a.plan)||"a higher plan")}}return E||"record"===e||"transcribe"===e?{disabled:!1}:{disabled:!0,reason:"Only Owners and Admins can modify this"}}(e.key,e.feature),l=y[e.key],n="translate"===e.key&&!0===b.real_time_translation_preview,i=n?"Live Translation":e.label,c=n?"Real-time voice translation (post-call transcripts are authoritative)":e.desc;return(0,s.jsxs)("div",{className:"flex items-center justify-between p-3 rounded-md bg-slate-800 hover:bg-slate-700",children:[(0,s.jsxs)("div",{className:"flex flex-col flex-1",children:[(0,s.jsxs)("div",{className:"flex items-center gap-2",children:[(0,s.jsx)(f,{htmlFor:"mod-".concat(e.key),className:"text-sm text-slate-100",children:i}),n&&(0,s.jsx)(r,{variant:"default",className:"text-xs bg-blue-600 text-white",children:"Preview"}),n&&(0,s.jsx)("span",{className:"text-xs text-blue-400 cursor-help","aria-label":"Live translation info",title:"Live translation is immediate. Post-call transcripts are authoritative.",children:"ℹ️"}),t&&a&&!n&&(0,s.jsx)("span",{className:"text-xs text-amber-400","aria-label":a,title:a,children:"⚠"})]}),(0,s.jsx)("span",{className:"text-xs text-slate-400",children:c}),l&&"translate"===e.key&&(0,s.jsxs)("div",{className:"mt-2 grid grid-cols-2 gap-2",children:[(0,s.jsxs)(o,{label:"From Language",value:(null==x?void 0:x.translation_from)||"",onChange:e=>h({translation_from:e.target.value}),disabled:!E,className:"text-sm",children:[(0,s.jsx)("option",{value:"",children:"Select..."}),(0,s.jsx)("option",{value:"en",children:"English"}),(0,s.jsx)("option",{value:"es",children:"Spanish"}),(0,s.jsx)("option",{value:"fr",children:"French"}),(0,s.jsx)("option",{value:"de",children:"German"})]}),(0,s.jsxs)(o,{label:"To Language",value:(null==x?void 0:x.translation_to)||"",onChange:e=>h({translation_to:e.target.value}),disabled:!E,className:"text-sm",children:[(0,s.jsx)("option",{value:"",children:"Select..."}),(0,s.jsx)("option",{value:"en",children:"English"}),(0,s.jsx)("option",{value:"es",children:"Spanish"}),(0,s.jsx)("option",{value:"fr",children:"French"}),(0,s.jsx)("option",{value:"de",children:"German"})]})]}),l&&"survey"===e.key&&(0,s.jsx)("div",{className:"mt-2",children:(0,s.jsx)(o,{label:"Survey",value:(null==x?void 0:x.survey_id)||"",onChange:e=>h({survey_id:e.target.value||null}),disabled:!E,className:"text-sm",children:(0,s.jsx)("option",{value:"",children:"Select a survey..."})})}),l&&"synthetic_caller"===e.key&&(0,s.jsx)("div",{className:"mt-2",children:(0,s.jsx)(o,{label:"Script",value:(null==x?void 0:x.script_id)||"",onChange:e=>h({script_id:e.target.value||null}),disabled:!E,className:"text-sm",children:(0,s.jsx)("option",{value:"",children:"Select a script..."})})})]}),(0,s.jsxs)("div",{className:"flex items-center gap-3 ml-4",children:[(0,s.jsx)(v,{id:"mod-".concat(e.key),checked:l,onCheckedChange:()=>!t&&!S[e.key]&&I(e.key),disabled:t||S[e.key],"aria-label":e.label,"aria-describedby":t&&a?"mod-".concat(e.key,"-hint"):void 0}),(0,s.jsx)("div",{className:"text-xs text-slate-400 w-12 text-right",children:S[e.key]?(0,s.jsx)("span",{"aria-live":"polite",children:"Updating…"}):l?"On":"Off"})]})]},e.key)})}),C&&(0,s.jsx)("div",{role:"status","aria-live":"assertive",className:"mt-3 text-sm text-red-400",children:C})]})}let N=(0,l.createContext)(null);function y(e){let{defaultValue:t,children:a,className:n=""}=e,[i,r]=(0,l.useState)(t);return(0,s.jsx)(N.Provider,{value:{activeTab:i,setActiveTab:r},children:(0,s.jsx)("div",{className:n,children:a})})}function w(e){let{children:t,className:a=""}=e;return(0,s.jsx)("div",{className:"flex border-b border-slate-800 ".concat(a),role:"tablist",children:t})}function S(e){let{value:t,children:a,className:n=""}=e,i=(0,l.useContext)(N);if(!i)throw Error("TabsTrigger must be used within Tabs");let{activeTab:r,setActiveTab:c}=i,d=r===t;return(0,s.jsx)("button",{role:"tab","aria-selected":d,onClick:()=>c(t),className:"px-4 py-2 text-sm font-medium border-b-2 transition-colors focus:outline-none focus:ring-2 focus:ring-indigo-500 ".concat(d?"border-indigo-500 text-indigo-400":"border-transparent text-slate-400 hover:text-slate-100"," ").concat(n),children:a})}function _(e){let{value:t,children:a,className:n=""}=e,i=(0,l.useContext)(N);if(!i)throw Error("TabsContent must be used within Tabs");let{activeTab:r}=i;return r!==t?null:(0,s.jsx)("div",{role:"tabpanel",className:n,children:a})}function C(e){let{recordingUrl:t,transcriptPreview:a,onPlay:n}=e,r=(0,l.useRef)(null),[c,d]=(0,l.useState)(!1),[o,u]=(0,l.useState)(0),[m,x]=(0,l.useState)(null),[h,f]=(0,l.useState)(1);function v(){let e=r.current;e&&(e.paused?e.play().catch(()=>{}):e.pause())}function p(e){let t=r.current;t&&(t.currentTime=Math.max(0,Math.min(t.duration||0,t.currentTime+e)))}function g(e){return null===e?"0:00":"".concat(Math.floor(e/60),":").concat(Math.floor(e%60).toString().padStart(2,"0"))}return(0,l.useEffect)(()=>{let e=r.current;if(e)return e.addEventListener("timeupdate",t),e.addEventListener("durationchange",a),e.addEventListener("play",s),e.addEventListener("pause",l),e.addEventListener("ended",i),()=>{e.removeEventListener("timeupdate",t),e.removeEventListener("durationchange",a),e.removeEventListener("play",s),e.removeEventListener("pause",l),e.removeEventListener("ended",i)};function t(){u(e.currentTime)}function a(){x(isFinite(e.duration)?e.duration:null)}function s(){d(!0),null==n||n()}function l(){d(!1)}function i(){d(!1),u(0)}},[n]),(0,l.useEffect)(()=>{let e=r.current;e&&(e.volume=h)},[h]),(0,s.jsxs)("section",{"aria-label":"Audio player",role:"region",className:"w-full space-y-4",children:[(0,s.jsxs)("div",{className:"flex items-center gap-4",children:[(0,s.jsx)("button",{onClick:v,onKeyDown:function(e){" "===e.key||"Spacebar"===e.key?(e.preventDefault(),v()):"ArrowRight"===e.key?(e.preventDefault(),p(5)):"ArrowLeft"===e.key?(e.preventDefault(),p(-5)):"ArrowUp"===e.key?(e.preventDefault(),f(Math.min(1,h+.1))):"ArrowDown"===e.key&&(e.preventDefault(),f(Math.max(0,h-.1)))},"aria-pressed":c,"aria-label":c?"Pause audio":"Play audio",className:"inline-flex items-center justify-center h-12 w-12 rounded-full bg-indigo-600 text-white hover:bg-indigo-500 focus:outline-none focus:ring-2 focus:ring-indigo-400 focus:ring-offset-2 focus:ring-offset-slate-950",children:(0,s.jsx)("span",{"aria-hidden":!0,children:c?"▮▮":"▶"})}),(0,s.jsxs)("div",{className:"flex-1",children:[(0,s.jsx)("div",{className:"text-sm text-slate-100 mb-1",children:"Recording"}),(0,s.jsxs)("div",{className:"flex items-center gap-2",children:[(0,s.jsx)("input",{type:"range",min:"0",max:m||0,value:o,onChange:function(e){let t=r.current;if(!t)return;let a=parseFloat(e.target.value);t.currentTime=a,u(a)},className:"flex-1 h-2 bg-slate-700 rounded-lg appearance-none cursor-pointer accent-indigo-600","aria-label":"Seek position"}),(0,s.jsxs)("span",{className:"text-xs text-slate-400 font-mono min-w-[4rem] text-right",children:[g(o)," / ",g(m)]})]})]}),(0,s.jsxs)("div",{className:"flex items-center gap-2",children:[(0,s.jsx)("label",{className:"text-xs text-slate-400",htmlFor:"volume-control",children:"Volume"}),(0,s.jsx)("input",{id:"volume-control",type:"range",min:"0",max:"1",step:"0.1",value:h,onChange:e=>f(parseFloat(e.target.value)),className:"w-20 h-2 bg-slate-700 rounded-lg appearance-none cursor-pointer accent-indigo-600","aria-label":"Volume control"})]}),(0,s.jsx)(i.z,{variant:"outline",size:"sm",onClick:function(){let e=document.createElement("a");e.href=t,e.download="recording-".concat(Date.now(),".mp3"),e.click()},"aria-label":"Download recording",children:"Download"})]}),(0,s.jsx)("audio",{ref:r,src:t,className:"hidden",preload:"metadata","aria-label":"Audio recording"}),(0,s.jsxs)("div",{className:"flex items-center gap-2",children:[(0,s.jsx)(i.z,{variant:"ghost",size:"sm",onClick:()=>p(-5),"aria-label":"Rewind 5 seconds",children:"-5s"}),(0,s.jsx)(i.z,{variant:"ghost",size:"sm",onClick:()=>p(5),"aria-label":"Forward 5 seconds",children:"+5s"}),a&&(0,s.jsx)("a",{href:"#transcript",className:"text-xs text-indigo-400 hover:underline ml-auto",onClick:e=>{var t;e.preventDefault(),null===(t=document.getElementById("artifact-transcript"))||void 0===t||t.scrollIntoView({behavior:"smooth"})},children:"View Transcript →"})]}),a&&(0,s.jsxs)("div",{className:"p-3 bg-slate-900 rounded-md border border-slate-800",children:[(0,s.jsx)("div",{className:"text-xs text-slate-400 mb-1",children:"Transcript Preview"}),(0,s.jsx)("div",{className:"text-sm text-slate-200 line-clamp-3",children:a})]})]})}function k(e){let{transcript:t}=e,[a,n]=(0,l.useState)(!1),r="string"==typeof t?t:(null==t?void 0:t.text)?t.text:(null==t?void 0:t.transcript)?t.transcript:JSON.stringify(t,null,2),c=(null==t?void 0:t.words)||(null==t?void 0:t.segments)||[],d=c.length>0;async function o(){try{await navigator.clipboard.writeText(r),n(!0),setTimeout(()=>n(!1),2e3)}catch(e){console.error("Failed to copy",e)}}return(0,s.jsxs)("section",{"aria-labelledby":"transcript-view",className:"w-full space-y-4",children:[(0,s.jsxs)("div",{className:"flex items-center justify-between",children:[(0,s.jsx)("h4",{id:"transcript-view",className:"text-lg font-medium text-slate-100",children:"Transcript"}),(0,s.jsxs)("div",{className:"flex gap-2",children:[(0,s.jsx)(i.z,{variant:"outline",size:"sm",onClick:o,children:a?"Copied!":"Copy"}),(0,s.jsx)(i.z,{variant:"outline",size:"sm",onClick:function(){let e=new Blob([r],{type:"text/plain"}),t=URL.createObjectURL(e),a=document.createElement("a");a.href=t,a.download="transcript-".concat(Date.now(),".txt"),a.click(),URL.revokeObjectURL(t)},children:"Export TXT"}),(0,s.jsx)(i.z,{variant:"outline",size:"sm",onClick:function(){let e=new Blob([JSON.stringify(t,null,2)],{type:"application/json"}),a=URL.createObjectURL(e),s=document.createElement("a");s.href=a,s.download="transcript-".concat(Date.now(),".json"),s.click(),URL.revokeObjectURL(a)},children:"Export JSON"})]})]}),d?(0,s.jsx)("div",{className:"space-y-2 max-h-[60vh] overflow-y-auto",children:c.map((e,t)=>(0,s.jsxs)("div",{className:"p-3 bg-slate-900 rounded-md border border-slate-800",children:[void 0!==e.start&&void 0!==e.end&&(0,s.jsxs)("div",{className:"text-xs text-slate-400 mb-1 font-mono",children:[E(e.start)," - ",E(e.end)]}),e.speaker&&(0,s.jsxs)("div",{className:"text-xs text-indigo-400 mb-1",children:["Speaker ",e.speaker]}),(0,s.jsx)("div",{className:"text-sm text-slate-100",children:e.text||e.word}),void 0!==e.confidence&&(0,s.jsxs)("div",{className:"text-xs text-slate-500 mt-1",children:["Confidence: ",(100*e.confidence).toFixed(1),"%"]})]},t))}):(0,s.jsx)("div",{className:"p-4 bg-slate-900 rounded-md border border-slate-800",children:(0,s.jsx)("pre",{className:"text-sm text-slate-100 whitespace-pre-wrap font-sans",children:r})})]})}function E(e){return"".concat(Math.floor(e/60),":").concat(Math.floor(e%60).toString().padStart(2,"0"))}function I(e){let{translation:t,originalTranscript:a}=e,[n,c]=(0,l.useState)("side-by-side"),[d,o]=(0,l.useState)(!0),u="string"==typeof t?t:(null==t?void 0:t.text)?t.text:(null==t?void 0:t.translation)?t.translation:JSON.stringify(t,null,2),m=(null==a?void 0:a.text)||("string"==typeof a?a:"")||"Original transcript not available",x=(null==t?void 0:t.from_language)||(null==t?void 0:t.from)||"Unknown",h=(null==t?void 0:t.to_language)||(null==t?void 0:t.to)||"Unknown";return(0,s.jsxs)("section",{"aria-labelledby":"translation-view",className:"w-full space-y-4",children:[(0,s.jsxs)("div",{className:"flex items-center justify-between",children:[(0,s.jsx)("h4",{id:"translation-view",className:"text-lg font-medium text-slate-100",children:"Translation"}),(0,s.jsxs)("div",{className:"flex items-center gap-2",children:[(0,s.jsxs)(r,{variant:"info",children:[x," → ",h]}),(0,s.jsxs)("div",{className:"flex gap-2",children:[(0,s.jsx)(i.z,{variant:"side-by-side"===n?"default":"outline",size:"sm",onClick:()=>c("side-by-side"),children:"Side by Side"}),(0,s.jsx)(i.z,{variant:"toggle"===n?"default":"outline",size:"sm",onClick:()=>c("toggle"),children:"Toggle"})]})]})]}),"side-by-side"===n?(0,s.jsxs)("div",{className:"grid grid-cols-2 gap-4",children:[(0,s.jsxs)("div",{className:"p-4 bg-slate-900 rounded-md border border-slate-800",children:[(0,s.jsx)("div",{className:"flex items-center justify-between mb-2",children:(0,s.jsx)(r,{variant:"default",children:x})}),(0,s.jsx)("div",{className:"text-sm text-slate-100 whitespace-pre-wrap max-h-[50vh] overflow-y-auto",children:m})]}),(0,s.jsxs)("div",{className:"p-4 bg-slate-900 rounded-md border border-slate-800",children:[(0,s.jsx)("div",{className:"flex items-center justify-between mb-2",children:(0,s.jsx)(r,{variant:"info",children:h})}),(0,s.jsx)("div",{className:"text-sm text-slate-100 whitespace-pre-wrap max-h-[50vh] overflow-y-auto",children:u})]})]}):(0,s.jsxs)("div",{className:"space-y-4",children:[(0,s.jsxs)("div",{className:"flex gap-2",children:[(0,s.jsxs)(i.z,{variant:d?"default":"outline",size:"sm",onClick:()=>o(!0),children:["Original (",x,")"]}),(0,s.jsxs)(i.z,{variant:d?"outline":"default",size:"sm",onClick:()=>o(!1),children:["Translation (",h,")"]})]}),(0,s.jsx)("div",{className:"p-4 bg-slate-900 rounded-md border border-slate-800",children:(0,s.jsx)("div",{className:"text-sm text-slate-100 whitespace-pre-wrap max-h-[50vh] overflow-y-auto",children:d?m:u})})]})]})}function z(e){let{survey:t}=e,a=(null==t?void 0:t.results)||(null==t?void 0:t.responses)||t||{},l=(null==t?void 0:t.questions)||[],n=(null==t?void 0:t.sentiment)||(null==t?void 0:t.sentiment_analysis),i=(null==t?void 0:t.score)||(null==t?void 0:t.overall_score);return(0,s.jsxs)("section",{"aria-labelledby":"survey-results",className:"w-full space-y-4",children:[(0,s.jsxs)("div",{className:"flex items-center justify-between",children:[(0,s.jsx)("h4",{id:"survey-results",className:"text-lg font-medium text-slate-100",children:"Survey Results"}),void 0!==i&&(0,s.jsxs)(r,{variant:i>=4?"success":i>=3?"warning":"error",children:["Score: ",i,"/5"]})]}),n&&(0,s.jsxs)("div",{className:"p-4 bg-slate-900 rounded-md border border-slate-800",children:[(0,s.jsx)("div",{className:"text-sm font-medium text-slate-100 mb-2",children:"Sentiment Analysis"}),(0,s.jsxs)("div",{className:"flex items-center gap-2",children:[(0,s.jsx)(r,{variant:"positive"===n?"success":"negative"===n?"error":"warning",children:n}),(null==t?void 0:t.sentiment_score)&&(0,s.jsxs)("span",{className:"text-sm text-slate-400",children:["Confidence: ",(100*t.sentiment_score).toFixed(1),"%"]})]})]}),l.length>0?(0,s.jsx)("div",{className:"space-y-4",children:l.map((e,t)=>(0,s.jsxs)("div",{className:"p-4 bg-slate-900 rounded-md border border-slate-800",children:[(0,s.jsx)("div",{className:"text-sm font-medium text-slate-100 mb-2",children:e.question||e.text}),(0,s.jsxs)("div",{className:"text-sm text-slate-300 mb-2",children:["Response: ",e.response||e.answer||"No response"]}),void 0!==e.score&&(0,s.jsxs)("div",{className:"flex items-center gap-2",children:[(0,s.jsx)("span",{className:"text-xs text-slate-400",children:"Score:"}),(0,s.jsxs)(r,{variant:e.score>=4?"success":e.score>=3?"warning":"error",children:[e.score,"/5"]})]})]},t))}):(0,s.jsxs)("div",{className:"p-4 bg-slate-900 rounded-md border border-slate-800",children:[(0,s.jsx)("div",{className:"text-sm text-slate-400 mb-2",children:"Survey Responses:"}),(0,s.jsx)("pre",{className:"text-xs text-slate-200 whitespace-pre-wrap font-mono",children:JSON.stringify(a,null,2)})]}),(null==t?void 0:t.breakdown)&&(0,s.jsxs)("div",{className:"p-4 bg-slate-900 rounded-md border border-slate-800",children:[(0,s.jsx)("div",{className:"text-sm font-medium text-slate-100 mb-2",children:"Score Breakdown"}),(0,s.jsx)("div",{className:"space-y-2",children:Object.entries(t.breakdown).map(e=>{let[t,a]=e;return(0,s.jsxs)("div",{className:"flex items-center justify-between",children:[(0,s.jsx)("span",{className:"text-sm text-slate-300",children:t}),(0,s.jsx)(r,{variant:"default",children:a})]},t)})})]})]})}function D(e){let{manifest:t}=e,[a,n]=(0,l.useState)(!1);if(!t)return(0,s.jsx)("div",{className:"p-4 bg-slate-950 rounded-md text-slate-400 text-sm",children:"No evidence manifest available"});let i=t.manifest_id||t.id||"unknown",r=t.created_at||t.createdAt||"unknown",c=Array.isArray(t.artifacts)?t.artifacts.length:0,d=t.manifest_hash||t.hash||t.manifestHash||"n/a";return(0,s.jsxs)("section",{role:"region","aria-label":"Evidence manifest summary",className:"w-full p-4 bg-slate-950 rounded-md",children:[(0,s.jsxs)("div",{className:"flex items-center justify-between",children:[(0,s.jsxs)("div",{children:[(0,s.jsx)("div",{className:"text-xs text-slate-400",children:"Manifest"}),(0,s.jsx)("div",{className:"text-sm text-slate-100 font-medium",children:i}),(0,s.jsx)("div",{className:"text-xs text-slate-400",children:new Date(r).toLocaleString()})]}),(0,s.jsxs)("div",{className:"text-right",children:[(0,s.jsx)("div",{className:"text-xs text-slate-400",children:"Artifacts"}),(0,s.jsx)("div",{className:"text-sm text-slate-100",children:c}),(0,s.jsx)("div",{className:"text-xs text-slate-400 mt-1",children:d})]})]}),(0,s.jsx)("div",{className:"mt-3 flex items-center justify-end",children:(0,s.jsx)("button",{onClick:()=>n(e=>!e),"aria-expanded":a,className:"text-xs text-indigo-400 hover:underline focus:outline-none focus:ring-2 focus:ring-indigo-400 rounded px-2 py-1",children:a?"Hide JSON":"Show full manifest"})}),a?(0,s.jsx)("pre",{className:"mt-3 p-3 rounded bg-slate-800 text-slate-100 text-xs font-mono overflow-auto max-h-80",tabIndex:0,"aria-label":"Full evidence manifest JSON",children:(0,s.jsx)("code",{children:JSON.stringify(t,null,2)})}):null]})}function T(e){let{manifest:t}=e,[a,n]=(0,l.useState)(!1);function r(){let e=new Blob([JSON.stringify(t,null,2)],{type:"application/json"}),a=URL.createObjectURL(e),s=document.createElement("a");s.href=a,s.download="evidence-manifest-".concat(t.id||Date.now(),".json"),s.click(),URL.revokeObjectURL(a)}return(0,s.jsxs)("section",{"aria-labelledby":"manifest-view",className:"w-full space-y-4",children:[(0,s.jsxs)("div",{className:"flex items-center justify-between",children:[(0,s.jsx)("h4",{id:"manifest-view",className:"text-lg font-medium text-slate-100",children:"Evidence Manifest"}),(0,s.jsxs)("div",{className:"flex gap-2",children:[(0,s.jsx)(i.z,{variant:"outline",size:"sm",onClick:r,children:"Export JSON"}),(0,s.jsx)(i.z,{variant:"outline",size:"sm",onClick:function(){r()},children:"Download"})]})]}),(0,s.jsx)(D,{manifest:t}),a&&(0,s.jsxs)("div",{className:"p-4 bg-slate-900 rounded-md border border-slate-800",children:[(0,s.jsx)("div",{className:"text-sm font-medium text-slate-100 mb-2",children:"Provenance Metadata"}),(0,s.jsxs)("div",{className:"space-y-2 text-xs text-slate-300",children:[t.producer&&(0,s.jsxs)("div",{children:[(0,s.jsx)("span",{className:"text-slate-400",children:"Producer:"})," ",t.producer]}),t.created_at&&(0,s.jsxs)("div",{children:[(0,s.jsx)("span",{className:"text-slate-400",children:"Created:"})," ",new Date(t.created_at).toLocaleString()]}),t.manifest_hash&&(0,s.jsxs)("div",{children:[(0,s.jsx)("span",{className:"text-slate-400",children:"Hash:"})," ",(0,s.jsx)("code",{className:"text-slate-200",children:t.manifest_hash})]})]})]}),(0,s.jsxs)("div",{className:"p-4 bg-slate-900 rounded-md border border-slate-800",children:[(0,s.jsxs)("div",{className:"flex items-center justify-between mb-2",children:[(0,s.jsx)("div",{className:"text-sm font-medium text-slate-100",children:"Full Manifest JSON"}),(0,s.jsx)(i.z,{variant:"ghost",size:"sm",onClick:()=>n(!a),"aria-expanded":a,children:a?"Collapse":"Expand"})]}),a&&(0,s.jsx)("pre",{className:"text-xs text-slate-200 whitespace-pre-wrap font-mono max-h-[60vh] overflow-y-auto",children:JSON.stringify(t,null,2)})]})]})}function O(e){let{score:t}=e,a=t.score,l=t.breakdown||{},n=t.scorecard_id;return(0,s.jsxs)("section",{"aria-labelledby":"score-view",className:"w-full space-y-4",children:[(0,s.jsxs)("div",{className:"flex items-center justify-between",children:[(0,s.jsx)("h4",{id:"score-view",className:"text-lg font-medium text-slate-100",children:"Call Score"}),n&&(0,s.jsxs)(r,{variant:"info",children:["Scorecard: ",n]})]}),(0,s.jsxs)("div",{className:"p-6 bg-slate-900 rounded-md border border-slate-800 text-center",children:[(0,s.jsxs)("div",{className:"text-4xl font-bold text-slate-100 mb-2",children:[a,"%"]}),(0,s.jsx)(r,{variant:a>=80?"success":a>=60?"warning":"error",className:"text-lg px-4 py-1",children:a>=90?"Excellent":a>=80?"Good":a>=70?"Fair":a>=60?"Needs Improvement":"Poor"})]}),Object.keys(l).length>0&&(0,s.jsxs)("div",{className:"p-4 bg-slate-900 rounded-md border border-slate-800",children:[(0,s.jsx)("div",{className:"text-sm font-medium text-slate-100 mb-4",children:"Score Breakdown"}),(0,s.jsx)("div",{className:"space-y-3",children:Object.entries(l).map(e=>{let[t,a]=e,l="number"==typeof a?a:(null==a?void 0:a.score)||0;return(0,s.jsxs)("div",{className:"flex items-center justify-between",children:[(0,s.jsxs)("div",{className:"flex-1",children:[(0,s.jsx)("div",{className:"text-sm text-slate-100",children:t}),"object"==typeof a&&(null==a?void 0:a.notes)&&(0,s.jsx)("div",{className:"text-xs text-slate-400 mt-1",children:a.notes})]}),(0,s.jsxs)(r,{variant:l>=80?"success":l>=60?"warning":"error",children:[l,"%"]})]},t)})})]}),n&&(0,s.jsxs)("div",{className:"p-4 bg-slate-900 rounded-md border border-slate-800",children:[(0,s.jsx)("div",{className:"text-sm font-medium text-slate-100 mb-2",children:"Scorecard Information"}),(0,s.jsxs)("div",{className:"text-xs text-slate-400",children:["This score was calculated using scorecard: ",(0,s.jsx)("code",{className:"text-slate-200",children:n})]})]})]})}function L(e){var t;let{callId:a,recording:l,transcript:n,translation:i,manifest:r,score:c,survey:d}=e,o=!!(null==l?void 0:l.recording_url),u=!!n,m=!!i,x=!!d,h=!!r,f=!!c,v=o?"recording":u?"transcript":h?"manifest":"recording";return(0,s.jsxs)("section",{"aria-labelledby":"artifact-viewer",className:"w-full bg-slate-950 rounded-md border border-slate-800",children:[(0,s.jsx)("h3",{id:"artifact-viewer",className:"text-lg font-medium text-slate-100 p-4 border-b border-slate-800",children:"Artifacts"}),(0,s.jsxs)(y,{defaultValue:v,className:"w-full",children:[(0,s.jsxs)(w,{className:"w-full border-b border-slate-800",children:[o&&(0,s.jsx)(S,{value:"recording",id:"artifact-recording",children:"Recording"}),u&&(0,s.jsx)(S,{value:"transcript",id:"artifact-transcript",children:"Transcript"}),m&&(0,s.jsx)(S,{value:"translation",id:"artifact-translation",children:"Translation"}),x&&(0,s.jsx)(S,{value:"survey",id:"artifact-survey",children:"Survey"}),h&&(0,s.jsx)(S,{value:"manifest",id:"artifact-manifest",children:"Manifest"}),f&&(0,s.jsx)(S,{value:"score",id:"artifact-score",children:"Score"})]}),o&&(0,s.jsx)(_,{value:"recording",className:"p-4",children:(0,s.jsx)(C,{recordingUrl:l.recording_url,transcriptPreview:(null===(t=l.transcript_json)||void 0===t?void 0:t.text)||null})}),u&&(0,s.jsx)(_,{value:"transcript",className:"p-4",children:(0,s.jsx)(k,{transcript:n})}),m&&(0,s.jsx)(_,{value:"translation",className:"p-4",children:(0,s.jsx)(I,{translation:i,originalTranscript:n})}),x&&(0,s.jsx)(_,{value:"survey",className:"p-4",children:(0,s.jsx)(z,{survey:d})}),h&&(0,s.jsx)(_,{value:"manifest",className:"p-4",children:(0,s.jsx)(T,{manifest:r})}),f&&(0,s.jsx)(_,{value:"score",className:"p-4",children:(0,s.jsx)(O,{score:c})}),!o&&!u&&!m&&!x&&!h&&!f&&(0,s.jsx)("div",{className:"p-8 text-center text-slate-400",children:"No artifacts available for this call yet."})]})]})}function R(e){let{callId:t,organizationId:a,onModulationChange:n}=e,{call:c,recording:d,transcript:o,translation:u,manifest:m,score:x,loading:h,error:f}=function(e){let[t,a]=(0,l.useState)(null),[s,n]=(0,l.useState)(!0),[i,r]=(0,l.useState)(null);return(0,l.useEffect)(()=>{if(!e){a(null),n(!1);return}(async function(){try{n(!0),r(null);let s=await fetch("/api/calls/".concat(encodeURIComponent(e)));if(!s.ok){var t;let s=await fetch("/api/calls/getCallStatus?callId=".concat(encodeURIComponent(e)));if(!s.ok)throw Error("Failed to fetch call details");let l=await s.json();a({call:l.call||null,recording:l.recording||null,transcript:(null===(t=l.recording)||void 0===t?void 0:t.transcript_json)||null,translation:null,manifest:l.evidence_manifest||null,score:null,survey:null});return}let l=await s.json();a(l)}catch(e){r((null==e?void 0:e.message)||"Failed to load call details"),a(null)}finally{n(!1)}})()},[e]),{call:(null==t?void 0:t.call)||null,recording:(null==t?void 0:t.recording)||null,transcript:(null==t?void 0:t.transcript)||null,translation:(null==t?void 0:t.translation)||null,manifest:(null==t?void 0:t.manifest)||null,score:(null==t?void 0:t.score)||null,survey:(null==t?void 0:t.survey)||null,loading:s,error:i}}(t);if(!t)return(0,s.jsx)("div",{className:"flex items-center justify-center h-full text-slate-400",children:"Select a call from the list to view details"});if(h)return(0,s.jsx)("div",{className:"flex items-center justify-center h-full text-slate-400",children:"Loading call details..."});if(f)return(0,s.jsxs)("div",{className:"p-4 bg-red-900/20 border border-red-800 rounded-md text-red-400",children:["Error: ",f]});if(!c)return(0,s.jsx)("div",{className:"p-4 bg-slate-900 rounded-md text-slate-400",children:"Call not found"});let v="completed"===c.status?"success":"failed"===c.status||"no-answer"===c.status||"busy"===c.status?"error":"in_progress"===c.status?"info":"default";return(0,s.jsxs)("div",{className:"space-y-6",children:[(0,s.jsxs)("section",{"aria-labelledby":"call-header",className:"p-4 bg-slate-950 rounded-md border border-slate-800",children:[(0,s.jsxs)("div",{className:"flex items-start justify-between mb-4",children:[(0,s.jsxs)("div",{children:[(0,s.jsxs)("h2",{id:"call-header",className:"text-xl font-semibold text-slate-100 mb-2",children:["Call ",c.id]}),(0,s.jsxs)("div",{className:"flex items-center gap-2 mb-2",children:[(0,s.jsx)("span",{className:"text-sm text-slate-400",children:"Status:"}),(0,s.jsx)(r,{variant:v,children:c.status||"unknown"})]}),c.call_sid&&(0,s.jsxs)("div",{className:"text-xs text-slate-500 font-mono",children:["SID: ",c.call_sid]})]}),(0,s.jsxs)("div",{className:"text-right",children:[(0,s.jsx)("div",{className:"text-sm text-slate-400 mb-1",children:"Duration"}),(0,s.jsx)("div",{className:"text-lg font-mono text-slate-100",children:((e,t)=>{if(!e)return"—";if(!t)return"In progress...";let a=new Date(e),s=Math.floor((new Date(t).getTime()-a.getTime())/1e3);return"".concat(Math.floor(s/60),":").concat((s%60).toString().padStart(2,"0"))})(c.started_at,c.ended_at)}),x&&(0,s.jsxs)("div",{className:"mt-2",children:[(0,s.jsx)("div",{className:"text-sm text-slate-400 mb-1",children:"Score"}),(0,s.jsxs)(r,{variant:x.score>=80?"success":x.score>=60?"warning":"error",children:[x.score,"%"]})]})]})]}),(0,s.jsxs)("div",{className:"grid grid-cols-2 gap-4 text-sm",children:[(0,s.jsxs)("div",{children:[(0,s.jsx)("div",{className:"text-slate-400",children:"Started"}),(0,s.jsx)("div",{className:"text-slate-100",children:c.started_at?new Date(c.started_at).toLocaleString():"—"})]}),c.ended_at&&(0,s.jsxs)("div",{children:[(0,s.jsx)("div",{className:"text-slate-400",children:"Ended"}),(0,s.jsx)("div",{className:"text-slate-100",children:new Date(c.ended_at).toLocaleString()})]})]})]}),(0,s.jsxs)("section",{"aria-label":"Quick actions",className:"flex gap-2",children:[(null==d?void 0:d.recording_url)&&(0,s.jsx)(i.z,{variant:"outline",size:"sm",onClick:()=>{var e;null===(e=document.getElementById("artifact-recording"))||void 0===e||e.scrollIntoView({behavior:"smooth"})},children:"Play Recording"}),o&&(0,s.jsx)(i.z,{variant:"outline",size:"sm",onClick:()=>{var e;null===(e=document.getElementById("artifact-transcript"))||void 0===e||e.scrollIntoView({behavior:"smooth"})},children:"View Transcript"}),m&&(0,s.jsx)(i.z,{variant:"outline",size:"sm",onClick:()=>{var e;null===(e=document.getElementById("artifact-manifest"))||void 0===e||e.scrollIntoView({behavior:"smooth"})},children:"View Manifest"})]}),a&&(0,s.jsx)(b,{callId:c.id,organizationId:a,initialModulations:{record:!1,transcribe:!1,translate:!1,survey:!1,synthetic_caller:!1},onChange:n||(async()=>{})}),(0,s.jsx)(L,{callId:c.id,recording:d,transcript:o,translation:u,manifest:m,score:x})]})}function U(e){let{open:t,onOpenChange:a,title:n,children:i,footer:r}=e,c=(0,l.useRef)(null);return((0,l.useEffect)(()=>{if(!t)return;let e=e=>{"Escape"===e.key&&a(!1)},s=e=>{c.current&&!c.current.contains(e.target)&&a(!1)};return document.addEventListener("keydown",e),document.addEventListener("mousedown",s),()=>{document.removeEventListener("keydown",e),document.removeEventListener("mousedown",s)}},[t,a]),t)?(0,s.jsx)("div",{className:"fixed inset-0 z-50 flex items-center justify-center bg-black/50",role:"dialog","aria-modal":"true","aria-labelledby":n?"dialog-title":void 0,children:(0,s.jsxs)("div",{ref:c,className:"bg-slate-900 border border-slate-800 rounded-lg shadow-lg max-w-lg w-full mx-4 max-h-[90vh] overflow-auto",children:[n&&(0,s.jsx)("div",{className:"px-6 py-4 border-b border-slate-800",children:(0,s.jsx)("h2",{id:"dialog-title",className:"text-lg font-semibold text-slate-100",children:n})}),(0,s.jsx)("div",{className:"px-6 py-4",children:i}),r&&(0,s.jsx)("div",{className:"px-6 py-4 border-t border-slate-800 flex justify-end gap-2",children:r})]})}):null}var A=a(4895);function F(e){let{organizationId:t}=e,{config:a,loading:r,updateConfig:c}=g(t),{role:u}=n(t),{toast:m}=(0,A.useToast)(),[x,h]=(0,l.useState)([]),[f,v]=(0,l.useState)([]),[p,j]=(0,l.useState)(!0),[b,N]=(0,l.useState)(!1),[y,w]=(0,l.useState)(!1),[S,_]=(0,l.useState)({phone_number:"",name:""}),C="owner"===u||"admin"===u;async function k(){if(t&&C)try{N(!0),await c({target_id:null==a?void 0:a.target_id,campaign_id:null==a?void 0:a.campaign_id}),m({title:"Configuration saved",description:"Target and campaign selection saved successfully."})}catch(e){m({title:"Error",description:(null==e?void 0:e.message)||"Failed to save configuration",variant:"destructive"})}finally{N(!1)}}async function E(){if(t&&C)try{w(!1),_({phone_number:"",name:""}),m({title:"Target added",description:"New target will be available after refresh."})}catch(e){m({title:"Error",description:(null==e?void 0:e.message)||"Failed to add target",variant:"destructive"})}}return((0,l.useEffect)(()=>{t&&e();async function e(){try{j(!0);let[e,a]=await Promise.all([fetch("/api/voice/targets?orgId=".concat(encodeURIComponent(t))),fetch("/api/campaigns?orgId=".concat(encodeURIComponent(t)))]);if(e.ok){let t=await e.json();h(t.targets||[])}if(a.ok){let e=await a.json();v(e.campaigns||[])}}catch(e){console.error("Failed to fetch targets/campaigns",e)}finally{j(!1)}}},[t]),p||r)?(0,s.jsx)("div",{className:"p-4 text-slate-400 text-sm",children:"Loading..."}):(0,s.jsxs)("section",{"aria-labelledby":"target-campaign-selector",className:"w-full p-4 bg-slate-950 rounded-md border border-slate-800",children:[(0,s.jsx)("h3",{id:"target-campaign-selector",className:"text-lg font-medium text-slate-100 mb-4",children:"Target & Campaign"}),(0,s.jsxs)("div",{className:"space-y-4",children:[(0,s.jsxs)("div",{children:[(0,s.jsxs)(o,{label:"Target Number",value:(null==a?void 0:a.target_id)||"",onChange:e=>{C&&c({target_id:e.target.value||null})},disabled:!C,"aria-label":"Select target phone number",children:[(0,s.jsx)("option",{value:"",children:"Select a target..."}),x.filter(e=>e.is_active).map(e=>(0,s.jsxs)("option",{value:e.id,children:[e.name||e.phone_number," (",e.phone_number,")"]},e.id))]}),C&&(0,s.jsx)(i.z,{variant:"ghost",size:"sm",onClick:()=>w(!0),className:"mt-2",children:"+ Add Target"})]}),(0,s.jsx)("div",{children:(0,s.jsxs)(o,{label:"Campaign (Optional)",value:(null==a?void 0:a.campaign_id)||"",onChange:e=>{C&&c({campaign_id:e.target.value||null})},disabled:!C,"aria-label":"Select campaign",children:[(0,s.jsx)("option",{value:"",children:"None"}),f.filter(e=>e.is_active).map(e=>(0,s.jsx)("option",{value:e.id,children:e.name},e.id))]})}),C&&(0,s.jsx)(i.z,{onClick:k,disabled:b,className:"w-full","aria-label":"Save configuration",children:b?"Saving...":"Save Configuration"}),!C&&(0,s.jsx)("p",{className:"text-xs text-slate-400",children:"Only Owners and Admins can modify configuration."})]}),(0,s.jsxs)(U,{open:y,onOpenChange:w,title:"Add Target",children:[(0,s.jsxs)("div",{className:"space-y-4",children:[(0,s.jsx)(d,{label:"Phone Number",type:"tel",value:S.phone_number,onChange:e=>_({...S,phone_number:e.target.value}),placeholder:"+1234567890",required:!0}),(0,s.jsx)(d,{label:"Name (Optional)",value:S.name,onChange:e=>_({...S,name:e.target.value}),placeholder:"Main Office"})]}),(0,s.jsxs)("div",{className:"flex justify-end gap-2 mt-4",children:[(0,s.jsx)(i.z,{variant:"outline",onClick:()=>w(!1),children:"Cancel"}),(0,s.jsx)(i.z,{onClick:E,children:"Add Target"})]})]})]})}function P(e){let{organizationId:t,onCallPlaced:a}=e,{role:c}=n(t),d=function(e,t,a){let{role:s,plan:l,loading:i}=n(e);return!i&&!!s&&!!l&&(["owner","admin"].includes(s)||"read"===a&&["operator","analyst","viewer"].includes(s)||"execute"===a&&"operator"===s)&&("free"!==l||"call"===t)}(t,"call","execute"),{config:o}=g(t),{toast:u}=(0,A.useToast)(),{updates:x,connected:h}=m(t),[f,v]=(0,l.useState)(!1),[p,j]=(0,l.useState)(null),[b,N]=(0,l.useState)(null),[y,w]=(0,l.useState)(0);async function S(){if(!t||!d||!(null==o?void 0:o.target_id)){u({title:"Error",description:"Cannot place call: missing target or insufficient permissions",variant:"destructive"});return}try{v(!0),N("initiating");let e=await fetch("/api/voice/call",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({organization_id:t,target_id:o.target_id,campaign_id:o.campaign_id||null,modulations:{record:o.recording_enabled||!1,transcribe:o.transcription_enabled||!1,translate:o.translation_enabled||!1,survey:o.survey_enabled||!1,synthetic_caller:o.secret_shopper_enabled||!1}})});if(!e.ok){let t=await e.json().catch(()=>({error:"Failed to place call"}));throw Error(t.error||"Failed to place call")}let s=(await e.json()).call_id;j(s),N("ringing"),w(0),null==a||a(s),u({title:"Call placed",description:"Call ".concat(s," is being initiated...")})}catch(e){N(null),u({title:"Error",description:(null==e?void 0:e.message)||"Failed to place call",variant:"destructive"})}finally{v(!1)}}(0,l.useEffect)(()=>{p&&x.length&&x.forEach(e=>{var t;if("calls"===e.table&&(null===(t=e.new)||void 0===t?void 0:t.id)===p){let t=e.new.status;N(t),("completed"===t||"failed"===t||"no-answer"===t||"busy"===t)&&(j(null),w(0))}})},[x,p]),(0,l.useEffect)(()=>{if(!p||"in_progress"!==b)return;let e=setInterval(()=>{w(e=>e+1)},1e3);return()=>clearInterval(e)},[p,b]);let _="completed"===b?"success":"failed"===b||"no-answer"===b||"busy"===b?"error":"in_progress"===b?"info":"ringing"===b?"warning":"default";return d?(0,s.jsxs)("section",{"aria-labelledby":"execution-controls",className:"w-full p-4 bg-slate-950 rounded-md border border-slate-800",children:[(0,s.jsx)("h3",{id:"execution-controls",className:"text-lg font-medium text-slate-100 mb-4",children:"Execution Controls"}),(0,s.jsxs)("div",{className:"space-y-4",children:[(0,s.jsx)(i.z,{onClick:S,disabled:f||!(null==o?void 0:o.target_id)||null!==p,className:"w-full",size:"lg","aria-label":"Place call",children:f?"Placing Call...":p?"Call in Progress":"Place Call"}),p&&b&&(0,s.jsxs)("div",{className:"p-3 bg-slate-900 rounded-md border border-slate-800",children:[(0,s.jsxs)("div",{className:"flex items-center justify-between mb-2",children:[(0,s.jsx)("span",{className:"text-sm text-slate-400",children:"Call Status:"}),(0,s.jsx)(r,{variant:_,children:b})]}),"in_progress"===b&&(0,s.jsxs)("div",{className:"flex items-center justify-between",children:[(0,s.jsx)("span",{className:"text-sm text-slate-400",children:"Duration:"}),(0,s.jsx)("span",{className:"text-sm font-mono text-slate-100",children:"".concat(Math.floor(y/60),":").concat((y%60).toString().padStart(2,"0"))})]}),(0,s.jsxs)("div",{className:"mt-2 text-xs text-slate-500",children:["Call ID: ",p]}),!h&&(0,s.jsx)("div",{className:"mt-2 text-xs text-amber-400",children:"Real-time updates disconnected. Using polling fallback."})]}),!(null==o?void 0:o.target_id)&&(0,s.jsx)("p",{className:"text-sm text-amber-400",children:"Please select a target number before placing a call."})]})]}):(0,s.jsx)("div",{className:"p-4 bg-slate-950 rounded-md border border-slate-800",children:(0,s.jsx)("p",{className:"text-sm text-slate-400",children:"Only Owners, Admins, and Operators can place calls."})})}function M(e){let{callId:t,organizationId:a,limit:n=10,events:c}=e,[d,o]=(0,l.useState)(c||[]),[u,h]=(0,l.useState)("all"),{updates:f,connected:v}=m(a||null),{data:p}=x(async()=>{if(!a)return[];try{let e=await fetch("/api/audit-logs?orgId=".concat(encodeURIComponent(a),"&limit=").concat(n));if(e.ok)return(await e.json()).events||[];return[]}catch(e){return[]}},1e4,!v&&null!==a);(0,l.useEffect)(()=>{f.length&&f.forEach(e=>{if("audit_logs"===e.table||"calls"===e.table||"recordings"===e.table||"ai_runs"===e.table){var t,a,s,l,i,r;let c={id:(null===(t=e.new)||void 0===t?void 0:t.id)||"event-".concat(Date.now()),call_id:(null===(a=e.new)||void 0===a?void 0:a.call_id)||(null===(s=e.new)||void 0===s?void 0:s.call_sid)||void 0,timestamp:(null===(l=e.new)||void 0===l?void 0:l.created_at)||new Date().toISOString(),type:function(e,t){if("calls"===e)return"completed"===t.status?"call.completed":"failed"===t.status?"call.failed":"call.started";if("recordings"===e)return"recording.available";if("ai_runs"===e){var a,s;return(null===(a=t.model)||void 0===a?void 0:a.includes("transcription"))?"transcription.completed":(null===(s=t.model)||void 0===s?void 0:s.includes("translation"))?"translation.completed":"ai.run.completed"}return"".concat(e,".updated")}(e.table,e.new),title:function(e,t){if("calls"===e)return"completed"===t.status?"Call completed":"failed"===t.status?"Call failed":"Call started";if("recordings"===e)return"Recording available";if("ai_runs"===e){var a,s;return(null===(a=t.model)||void 0===a?void 0:a.includes("transcription"))?"Transcription completed":(null===(s=t.model)||void 0===s?void 0:s.includes("translation"))?"Translation completed":"AI processing completed"}return"".concat(e," updated")}(e.table,e.new),status:(i=e.table,r=e.new,"calls"===i?"completed"===r.status?"success":"failed"===r.status?"error":"info":"recordings"===i||"ai_runs"===i?"success":"info")};o(e=>[c,...e].slice(0,2*n))}})},[f,n]),(0,l.useEffect)(()=>{!v&&p.length>0&&o(p)},[p,v]);let g=d.filter(e=>t?e.call_id===t:"all"===u||e.type.includes(u)).slice(0,n);return(0,s.jsxs)("section",{"aria-label":"Activity feed",className:"w-full bg-slate-950 rounded-md border border-slate-800",children:[(0,s.jsxs)("div",{className:"p-4 border-b border-slate-800",children:[(0,s.jsxs)("div",{className:"flex items-center justify-between mb-2",children:[(0,s.jsx)("h4",{className:"text-sm font-medium text-slate-100",children:"Activity"}),!v&&(0,s.jsx)("span",{className:"text-xs text-amber-400","aria-label":"Real-time disconnected",children:"⚠"})]}),!t&&(0,s.jsxs)("div",{className:"flex gap-2",children:[(0,s.jsx)(i.z,{variant:"all"===u?"default":"outline",size:"sm",onClick:()=>h("all"),className:"text-xs",children:"All"}),(0,s.jsx)(i.z,{variant:"call"===u?"default":"outline",size:"sm",onClick:()=>h("call"),className:"text-xs",children:"Calls"}),(0,s.jsx)(i.z,{variant:"transcript"===u?"default":"outline",size:"sm",onClick:()=>h("transcript"),className:"text-xs",children:"Transcripts"})]})]}),(0,s.jsxs)("div",{role:"status","aria-live":"polite",className:"sr-only",children:[g.length," events shown"]}),(0,s.jsx)("div",{className:"max-h-[60vh] overflow-y-auto",children:0===g.length?(0,s.jsx)("div",{className:"p-4 text-center text-slate-400 text-sm",children:"No recent activity"}):(0,s.jsx)("ul",{role:"list",className:"divide-y divide-slate-800",children:g.map(e=>{var t;return(0,s.jsx)("li",{className:"p-3 hover:bg-slate-900 transition-colors ".concat(e.call_id?"cursor-pointer":""),onClick:()=>e.call_id&&void(e.call_id&&window.dispatchEvent(new CustomEvent("call:select",{detail:{callId:e.call_id}}))),"aria-labelledby":"evt-".concat(e.id,"-title"),children:(0,s.jsxs)("div",{className:"flex items-start gap-3",children:[(0,s.jsx)("div",{className:"text-lg","aria-hidden":!0,children:(t=e.type).includes("error")||t.includes("failed")?"❌":t.includes("record")?"⏺️":t.includes("transcript")||t.includes("transcription")?"\uD83D\uDCDD":t.includes("translation")?"\uD83C\uDF10":t.includes("survey")?"\uD83D\uDCCB":t.includes("score")?"⭐":t.includes("call.started")||t.includes("call_started")?"\uD83D\uDCDE":t.includes("call.ended")||t.includes("call_ended")||t.includes("call.completed")?"\uD83D\uDD1A":"ℹ️"}),(0,s.jsxs)("div",{className:"flex-1 min-w-0",children:[(0,s.jsx)("div",{id:"evt-".concat(e.id,"-title"),className:"text-sm text-slate-100",children:e.title}),(0,s.jsx)("div",{className:"text-xs text-slate-400 mt-1",children:new Date(e.timestamp).toLocaleString()}),e.call_id&&(0,s.jsxs)("div",{className:"text-xs text-indigo-400 mt-1",children:["Call: ",e.call_id]})]}),(0,s.jsx)(r,{variant:"error"===e.status?"error":"warning"===e.status?"warning":"success"===e.status?"success":"default",className:"text-xs",children:e.status||"info"})]})},e.id)})})})]})}function B(e){let{initialCalls:t,organizationId:a,organizationName:n}=e,[i,r]=(0,l.useState)(null);async function d(e){console.log("Modulation change:",e)}return(0,l.useEffect)(()=>{function e(e){var t,a;let s=null===(t=e.detail)||void 0===t?void 0:t.callId;s&&(r(s),null===(a=document.getElementById("call-detail-container"))||void 0===a||a.scrollIntoView({behavior:"smooth"}))}return window.addEventListener("call:select",e),()=>{window.removeEventListener("call:select",e)}},[]),(0,s.jsxs)("div",{className:"flex flex-col h-screen bg-slate-950 text-slate-100",children:[(0,s.jsx)(c,{organizationId:a,organizationName:n}),(0,s.jsxs)("div",{className:"flex flex-1 overflow-hidden",children:[(0,s.jsx)("aside",{className:"w-1/4 border-r border-slate-800 flex flex-col overflow-hidden",children:(0,s.jsx)(h,{calls:t,selectedCallId:i,organizationId:a,onSelect:r})}),(0,s.jsx)("main",{className:"flex-1 overflow-y-auto p-6",children:(0,s.jsxs)("div",{className:"max-w-6xl mx-auto space-y-6",children:[(0,s.jsx)(F,{organizationId:a}),(0,s.jsx)(P,{organizationId:a}),(0,s.jsx)("div",{id:"call-detail-container",children:(0,s.jsx)(R,{callId:i,organizationId:a,onModulationChange:d})})]})}),(0,s.jsx)("aside",{className:"w-1/4 border-l border-slate-800 overflow-y-auto p-4",children:(0,s.jsx)(M,{organizationId:a,limit:20})})]})]})}}},function(e){e.O(0,[53,971,117,744],function(){return e(e.s=9208)}),_N_E=e.O()}]);