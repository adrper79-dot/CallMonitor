"use strict";exports.id=228,exports.ids=[228],exports.modules={98228:(e,t,a)=>{a.d(t,{checkAndGenerateManifest:()=>d});var r=a(79843),i=a(62632),s=a(84770),n=a.n(s);async function o(e,t,a,s){try{let{data:o}=await i.default.from("evidence_manifests").select("id").eq("recording_id",t).limit(1);if(o&&o.length>0)return console.log("evidenceManifest: manifest already exists",{manifestId:o[0].id,recordingId:t}),o[0].id;let d=[],c={},{data:l}=await i.default.from("recordings").select("id, recording_url, duration_seconds, status, created_at").eq("id",t).limit(1),u=l?.[0];u&&(d.push({type:"recording",id:u.id,uri:u.recording_url,metadata:{duration_seconds:u.duration_seconds,status:u.status,created_at:u.created_at}}),c.recording_source="signalwire");let{data:_}=await i.default.from("recordings").select("transcript_json").eq("id",t).limit(1);if(_?.[0]?.transcript_json){let e=_[0].transcript_json;d.push({type:"transcript",id:`${t}-transcript`,metadata:{text:e.text,confidence:e.confidence,transcript_id:e.transcript_id,completed_at:e.completed_at}}),c.transcription_model="assemblyai-v1"}let{data:m}=await i.default.from("ai_runs").select("id, output, model, completed_at").eq("call_id",e).eq("model","assemblyai-translation").eq("status","completed").limit(1);if(m&&m.length>0){let e=m[0];d.push({type:"translation",id:e.id,metadata:{from_language:e.output?.from_language,to_language:e.output?.to_language,translated_text:e.output?.translated_text,completed_at:e.completed_at}}),c.translation_model="assemblyai-translation"}let{data:f}=await i.default.from("ai_runs").select("id, output").eq("call_id",e).contains("output",{type:"survey"}).limit(1);if(f&&f.length>0){let e=f[0];d.push({type:"survey",id:e.id,metadata:{responses:e.output?.responses,score:e.output?.score,completed_at:e.output?.completed_at}}),c.survey_processor="assemblyai-nlp"}if(s){let{data:e}=await i.default.from("scored_recordings").select("id, scores_json, total_score, created_at").eq("recording_id",t).eq("scorecard_id",s).limit(1);if(e&&e.length>0){let t=e[0];d.push({type:"score",id:t.id,metadata:{scores:t.scores_json,total_score:t.total_score,created_at:t.created_at}}),c.scoring_engine="qise-v1"}}let p=(0,r.Z)(),g=new Date().toISOString(),h={manifest_id:p,created_at:g,call_id:e,organization_id:a,artifacts:d,manifest_hash:"",producer:"call_monitor_v1",version:"1.0",provenance:c},y=JSON.stringify(h,Object.keys(h).sort()),v=n().createHash("sha256").update(y).digest("hex");h.manifest_hash=`sha256:${v}`;let{error:w}=await i.default.from("evidence_manifests").insert({id:p,organization_id:a,recording_id:t,scorecard_id:s||null,manifest:h,created_at:g});if(w)throw console.error("evidenceManifest: failed to insert manifest",{error:w.message,callId:e,recordingId:t}),Error(`Failed to store evidence manifest: ${w.message}`);return console.log("evidenceManifest: generated manifest",{manifestId:p,callId:e,recordingId:t,artifactCount:d.length}),p}catch(a){throw console.error("evidenceManifest: generation error",{error:a?.message,callId:e,recordingId:t}),a}}async function d(e,t,a){try{let{data:r}=await i.default.from("recordings").select("status, transcript_json").eq("id",t).limit(1),s=r?.[0];if(!s||"completed"!==s.status)return null;let{data:n}=await i.default.from("voice_configs").select("transcribe").eq("organization_id",a).limit(1);if(n?.[0]?.transcribe===!0&&!s.transcript_json)return null;return await o(e,t,a)}catch(a){return console.error("evidenceManifest: check error",{error:a?.message,callId:e,recordingId:t}),null}}}};