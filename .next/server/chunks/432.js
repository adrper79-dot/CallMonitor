"use strict";exports.id=432,exports.ids=[432],exports.modules={73045:(e,t,a)=>{a.d(t,{Z:()=>l});var r=a(79843),s=a(23151);let i=/^\+?[1-9]\d{1,14}$/;async function l(e,t){let{supabaseAdmin:a,getSession:l,signalwireCall:o,env:n=process.env}=t,c=null,d=null,u=null,g=e.organization_id;async function _(e,t,s){try{await a.from("audit_logs").insert({id:(0,r.Z)(),organization_id:g,user_id:c,system_id:d,resource_type:e,resource_id:t,action:"error",before:null,after:s,created_at:new Date().toISOString()})}catch(e){console.error("failed to write audit error",e)}}let I=async e=>{let t;let a=n.SIGNALWIRE_PROJECT_ID,i=n.SIGNALWIRE_TOKEN,l=n.SIGNALWIRE_NUMBER,o=String(n.SIGNALWIRE_SPACE||"").replace(/^https?:\/\//,"").replace(/\/$/,"").replace(/\.signalwire\.com$/i,"").trim();if(!(a&&i&&o&&l)){if("production"===n.NODE_ENV){let e=new s.g({code:"SIGNALWIRE_CONFIG_MISSING",message:"SignalWire credentials missing",user_message:"System configuration error",severity:"CRITICAL",retriable:!1});throw await _("systems",null,e.toJSON()),e}return`mock-${(0,r.Z)()}`}let c=Buffer.from(`${a}:${i}`).toString("base64"),d=new URLSearchParams;d.append("From",l),d.append("To",e),d.append("Url",`${n.NEXT_PUBLIC_APP_URL}/api/voice/laml/outbound`),d.append("StatusCallback",`${n.NEXT_PUBLIC_APP_URL}/api/webhooks/signalwire`);let g=`https://${o}.signalwire.com/api/laml/2010-04-01/Accounts/${a}/Calls.json`;console.log("startCallHandler: sending SignalWire POST",{endpoint:g,to:e,from:l});let I=new AbortController,m=setTimeout(()=>I.abort(),1e4);try{t=await fetch(g,{method:"POST",headers:{Authorization:`Basic ${c}`,"Content-Type":"application/x-www-form-urlencoded"},body:d,signal:I.signal})}catch(t){console.error("startCallHandler: SignalWire fetch error",{error:t?.message??String(t)});let e=new s.g({code:"SIGNALWIRE_FETCH_FAILED",message:"Failed to reach SignalWire",user_message:"Failed to place call via carrier",severity:"HIGH",retriable:!0,details:{cause:t?.message??String(t)}});throw await _("calls",u,e.toJSON()),e}finally{clearTimeout(m)}if(!t.ok){let e=await t.text();console.error("startCallHandler: SignalWire POST failed",{status:t.status,body:e});let a=new s.g({code:"SIGNALWIRE_API_ERROR",message:`SignalWire Error: ${t.status}`,user_message:"Failed to place call via carrier",severity:"HIGH",retriable:!0,details:{provider_error:e}});throw await _("calls",u,a.toJSON()),a}let S=await t.json();return console.log("startCallHandler: SignalWire responded",{sid:S?.sid?"[REDACTED]":null}),S?.sid??null};try{let{from_number:t,phone_number:m,flow_type:S,modulations:A}=e;g=e.organization_id;let E=["5f64d900-e212-42ab-bf41-7518f0bbcd4f","f25e038f-5006-4468-8e6a-12712a6afe95"];if(!E.includes(g)||/^0{8}-0{4}-0{4}-0{4}-0{12}$/.test(String(g))){let t=E[0];console.warn("startCallHandler: overriding organization_id for outbound connectivity",{requested:e.organization_id,using:t}),g=t}console.log("startCallHandler: initiating call",{organization_id:g,from_number:t,phone_number:m,flow_type:S,modulations:A});let y=await l().catch(()=>null),f=y?.user?.id??null;if(c=f,!f){if("production"!==n.NODE_ENV)c=f="28d68e05-ab20-40ee-b935-b19e8927ae68",console.warn("startCallHandler: using dev fallback actorId",{actorId:f});else{let e=new s.g({code:"AUTH_REQUIRED",message:"Unauthenticated",user_message:"Authentication required",severity:"HIGH",retriable:!1});throw await _("organizations",null,e.toJSON()),e}}if(!/^[0-9a-fA-F-]{36}$/.test(g)){let e=new s.g({code:"CALL_START_INVALID_ORG",message:"Invalid organization id",user_message:"Invalid organization identifier",severity:"MEDIUM",retriable:!1});throw await _("organizations",null,e.toJSON()),e}let{data:h,error:w}=await a.from("organizations").select("id,plan,tool_id").eq("id",g).limit(1);if(w){let e=new s.g({code:"CALL_START_DB_ORG_LOOKUP",message:"Organization lookup failed",user_message:"Unable to verify organization.",severity:"HIGH",retriable:!0,details:{cause:w.message}});throw await _("organizations",null,e.toJSON()),e}let p=h?.[0];if(!p){let e=new s.g({code:"CALL_START_ORG_NOT_FOUND",message:"Organization not found",user_message:"Organization not found.",severity:"HIGH",retriable:!1});throw await _("organizations",null,e.toJSON()),e}if("free"===p.plan){let e=new s.g({code:"CALL_START_PLAN_LIMIT_EXCEEDED",message:"Plan does not permit outbound calls",user_message:"Your plan does not allow outbound calls. Please upgrade.",severity:"HIGH",retriable:!1});throw await _("organizations",p.id,e.toJSON()),e}let{data:T,error:R}=await a.from("org_members").select("id,role").eq("organization_id",g).eq("user_id",f).limit(1);if(R){let e=new s.g({code:"AUTH_MEMBERSHIP_LOOKUP_FAILED",message:"Membership lookup failed",user_message:"Unable to verify membership",severity:"HIGH",retriable:!0,details:{cause:R.message}});throw await _("org_members",null,e.toJSON()),e}let N={record:!1,transcribe:!1,translate:!1};try{let{data:e,error:t}=await a.from("voice_configs").select("record,transcribe,translate,translate_from,translate_to,survey,synthetic_caller").eq("organization_id",g).limit(1);if(!t&&e&&e[0]){let t=e[0];N.record=!!t.record,N.transcribe=!!t.transcribe,N.translate=!!t.translate,N.survey=!!t.survey,N.synthetic_caller=!!t.synthetic_caller,"string"==typeof t.translate_from&&(N.translate_from=t.translate_from),"string"==typeof t.translate_to&&(N.translate_to=t.translate_to)}}catch(e){}if(!T||0===T.length){let e=new s.g({code:"AUTH_ORG_MISMATCH",message:"Actor not authorized for organization",user_message:"Not authorized for this organization",severity:"HIGH",retriable:!1});throw await _("org_members",null,e.toJSON()),e}if(!i.test(m)){let e=new s.g({code:"CALL_START_INVALID_PHONE",message:"Invalid phone number format",user_message:"The phone number provided is invalid. Please verify and try again.",severity:"MEDIUM",retriable:!1});throw await _("calls",null,e.toJSON()),e}let{data:b,error:L}=await a.from("systems").select("id,key").in("key",["system-cpid","system-ai"]);if(L){let e=new s.g({code:"CALL_START_SYS_LOOKUP_FAILED",message:"System lookup failed",user_message:"Service error",severity:"HIGH",retriable:!0,details:{cause:L.message}});throw await _("systems",null,e.toJSON()),e}let v={};(b||[]).forEach(e=>{v[e.key]=e.id});let D=v["system-cpid"]??null,M=v["system-ai"]??null;if(d=D,!D){let e=new s.g({code:"CALL_START_SYS_MISSING",message:"Control system not registered",user_message:"Service misconfiguration",severity:"HIGH",retriable:!1});throw await _("systems",null,e.toJSON()),e}let C={id:u=(0,r.Z)(),organization_id:g,system_id:D,status:"pending",started_at:null,ended_at:null,created_by:f},{error:O}=await a.from("calls").insert(C);if(O){console.error("startCallHandler: failed to insert call row",{callId:u,error:O?.message});let e=new s.g({code:"CALL_START_DB_INSERT",message:"Failed to create call record",user_message:"We encountered a system error while starting your call. Please try again.",severity:"HIGH",retriable:!0,details:{cause:O.message}});throw await _("calls",u,e.toJSON()),e}let P=null;if(o){if(console.log("startCallHandler: using injected signalwireCall to place outbound call"),"bridge"===S&&t&&i.test(t)){let e=await o({from:String(n.SIGNALWIRE_NUMBER||""),to:t,url:String(n.NEXT_PUBLIC_APP_URL)+"/api/voice/laml/outbound",statusCallback:String(n.NEXT_PUBLIC_APP_URL)+"/api/webhooks/signalwire"}),a=await o({from:String(n.SIGNALWIRE_NUMBER||""),to:m,url:String(n.NEXT_PUBLIC_APP_URL)+"/api/voice/laml/outbound",statusCallback:String(n.NEXT_PUBLIC_APP_URL)+"/api/webhooks/signalwire"});P=a.call_sid,console.log("startCallHandler: injected signalwireCall bridge created",{a:e.call_sid?"[REDACTED]":null,b:a.call_sid?"[REDACTED]":null})}else P=(await o({from:String(n.SIGNALWIRE_NUMBER||""),to:m,url:String(n.NEXT_PUBLIC_APP_URL)+"/api/voice/laml/outbound",statusCallback:String(n.NEXT_PUBLIC_APP_URL)+"/api/webhooks/signalwire"})).call_sid,console.log("startCallHandler: injected signalwireCall returned",{call_sid:P?"[REDACTED]":null})}else if("bridge"===S&&t&&i.test(t)){let e=await I(t),a=await I(m);P=a,console.log("startCallHandler: signalwire bridge created",{a:e?"[REDACTED]":null,b:a?"[REDACTED]":null})}else P=await I(m),console.log("startCallHandler: signalwire call placed",{call_sid:P?"[REDACTED]":null});let{error:H}=await a.from("calls").update({status:"in-progress"}).eq("id",u);if(H&&(console.error("startCallHandler: failed to update call status",{callId:u,error:H?.message}),await _("calls",u,{message:"Failed to save call_sid",error:H.message})),N.transcribe){if(M){let e={id:(0,r.Z)(),call_id:u,system_id:M,model:"assemblyai-v1",status:"queued"};try{let{error:t}=await a.from("ai_runs").insert(e);t&&(console.error("startCallHandler: failed to insert ai_run",{callId:u,error:t?.message}),await _("ai_runs",u,new s.g({code:"AI_TRANSC_INSERT_FAILED",message:"Failed to enqueue transcription",user_message:"Transcription could not be started. The call will continue without transcription.",severity:"MEDIUM",retriable:!0,details:{cause:t.message}}).toJSON()))}catch(e){await _("ai_runs",u,new s.g({code:"AI_TRANSC_INSERT_FAILED",message:"Failed to enqueue transcription",user_message:"Transcription could not be started. The call will continue without transcription.",severity:"MEDIUM",retriable:!0,details:{cause:e.message}}).toJSON())}}else await _("systems",u,new s.g({code:"CALL_START_AI_SYSTEM_MISSING",message:"AI system not registered",user_message:"Transcription unavailable right now.",severity:"MEDIUM",retriable:!0}).toJSON())}if(N.translate){let e=N.translate_from??null,t=N.translate_to??null;if(e&&t){if(M){let i={id:(0,r.Z)(),call_id:u,system_id:M,model:"assemblyai-translation-v1",status:"queued",meta:{translate_from:e,translate_to:t}};try{let{error:e}=await a.from("ai_runs").insert(i);e&&(console.error("startCallHandler: failed to insert ai_run (translation)",{callId:u,error:e?.message}),await _("ai_runs",u,new s.g({code:"AI_TRANSL_INSERT_FAILED",message:"Failed to enqueue translation",user_message:"Translation could not be started. The call will continue without translation.",severity:"MEDIUM",retriable:!0,details:{cause:e.message}}).toJSON()))}catch(e){await _("ai_runs",u,new s.g({code:"AI_TRANSL_INSERT_FAILED",message:"Failed to enqueue translation",user_message:"Translation could not be started. The call will continue without translation.",severity:"MEDIUM",retriable:!0,details:{cause:e.message}}).toJSON())}}else await _("systems",u,new s.g({code:"CALL_START_AI_SYSTEM_MISSING",message:"AI system not registered",user_message:"Translation unavailable right now.",severity:"MEDIUM",retriable:!0}).toJSON())}else await _("ai_runs",u,new s.g({code:"AI_TRANSL_LANG_MISSING",message:"Translation configured but language codes missing",user_message:"Translation configuration incomplete; skipping translation.",severity:"MEDIUM",retriable:!1}).toJSON())}if(N.record){let e=p?.tool_id??null;if(e)try{await a.from("audit_logs").insert({id:(0,r.Z)(),organization_id:g,user_id:c,system_id:d,resource_type:"calls",resource_id:u,action:"intent:recording_requested",before:null,after:{tool_id:e,requested_at:new Date().toISOString()},created_at:new Date().toISOString()})}catch(e){}else await _("calls",u,new s.g({code:"RECORDING_TOOL_NOT_FOUND",message:"No recording tool available for organization",user_message:"No recording tool available for your organization",severity:"MEDIUM",retriable:!1}).toJSON())}let{data:U,error:G}=await a.from("calls").select("*").eq("id",u).limit(1);if(G||!U?.[0]){console.error("startCallHandler: failed to fetch persisted call",{callId:u,error:G?.message});let e=new s.g({code:"CALL_START_FETCH_PERSISTED_FAILED",message:"Failed to read back persisted call",user_message:"We started the call but could not verify its record. Please contact support.",severity:"HIGH",retriable:!0,details:{cause:G?.message}});throw await _("calls",u,e.toJSON()),e}let F=U[0];try{await a.from("audit_logs").insert({id:(0,r.Z)(),organization_id:g,user_id:c,system_id:d,resource_type:"calls",resource_id:u,action:"create",before:null,after:{...F,config:N,call_sid:P},created_at:new Date().toISOString()})}catch(e){console.error("startCallHandler: failed to insert audit log",{callId:u,error:e?.message}),await _("audit_logs",u,new s.g({code:"AUDIT_LOG_INSERT_FAILED",message:"Failed to write audit log",user_message:"Call started but an internal audit log could not be saved.",severity:"MEDIUM",retriable:!0,details:{cause:e.message}}).toJSON())}return console.log("startCallHandler: call flow completed",{callId:u}),{success:!0,call_id:u}}catch(t){if(t instanceof s.g){let e=t.toJSON();try{await a.from("audit_logs").insert({id:(0,r.Z)(),organization_id:g,user_id:c??null,system_id:d??null,resource_type:"calls",resource_id:u??null,action:"error",before:null,after:e,created_at:new Date().toISOString()})}catch(e){}return{success:!1,error:{id:e.id,code:e.code,message:e.user_message??e.message,severity:e.severity}}}console.error("startCallHandler unexpected error",t);let e=new s.g({code:"CALL_START_UNEXPECTED",message:t?.message??"Unexpected error",user_message:"An unexpected error occurred while starting the call.",severity:"CRITICAL",retriable:!0,details:{stack:t?.stack}}).toJSON();try{await a.from("audit_logs").insert({id:(0,r.Z)(),organization_id:g,user_id:null,system_id:null,resource_type:"calls",resource_id:null,action:"error",before:null,after:e,created_at:new Date().toISOString()})}catch(e){}return{success:!1,error:{id:e.id,code:e.code,message:e.user_message??e.message,severity:e.severity}}}}},6781:(e,t,a)=>{a.r(t),a.d(t,{ERROR_CATALOG:()=>r,getDefaultError:()=>i,getErrorDefinition:()=>s});let r={AUTH_REQUIRED:{code:"AUTH_REQUIRED",category:"AUTH",severity:"HIGH",internalMessage:"Authentication required",userMessage:"Please sign in to continue",httpStatus:401,shouldAlert:!1,trackKPI:!0},AUTH_ORG_MISMATCH:{code:"AUTH_ORG_MISMATCH",category:"AUTH",severity:"HIGH",internalMessage:"User not authorized for organization",userMessage:"You do not have access to this organization",httpStatus:401,shouldAlert:!1,trackKPI:!0},FORBIDDEN:{code:"FORBIDDEN",category:"AUTH",severity:"HIGH",internalMessage:"Insufficient permissions",userMessage:"You do not have permission to perform this action",httpStatus:403,shouldAlert:!1,trackKPI:!0},DB_QUERY_FAILED:{code:"DB_QUERY_FAILED",category:"DB",severity:"HIGH",internalMessage:"Database query failed",userMessage:"Could not retrieve data. Please try again.",httpStatus:500,shouldAlert:!0,trackKPI:!0},DB_INSERT_FAILED:{code:"DB_INSERT_FAILED",category:"DB",severity:"HIGH",internalMessage:"Database insert failed",userMessage:"Could not save data. Please try again.",httpStatus:500,shouldAlert:!0,trackKPI:!0},DB_UPDATE_FAILED:{code:"DB_UPDATE_FAILED",category:"DB",severity:"HIGH",internalMessage:"Database update failed",userMessage:"Could not update data. Please try again.",httpStatus:500,shouldAlert:!0,trackKPI:!0},CALL_START_FAILED:{code:"CALL_START_FAILED",category:"VOICE",severity:"HIGH",internalMessage:"Failed to start call",userMessage:"Unable to place call. Please try again.",httpStatus:500,shouldAlert:!0,trackKPI:!0},SIGNALWIRE_CONFIG_MISSING:{code:"SIGNALWIRE_CONFIG_MISSING",category:"EXTERNAL",severity:"CRITICAL",internalMessage:"SignalWire credentials missing",userMessage:"System configuration error. Please contact support.",httpStatus:500,shouldAlert:!0,trackKPI:!0},SIGNALWIRE_API_ERROR:{code:"SIGNALWIRE_API_ERROR",category:"EXTERNAL",severity:"HIGH",internalMessage:"SignalWire API error",userMessage:"Call service temporarily unavailable. Please try again.",httpStatus:502,shouldAlert:!0,trackKPI:!0},ASSEMBLYAI_API_ERROR:{code:"ASSEMBLYAI_API_ERROR",category:"AI",severity:"HIGH",internalMessage:"AssemblyAI API error",userMessage:"Transcription service temporarily unavailable.",httpStatus:502,shouldAlert:!0,trackKPI:!0},TRANSCRIPTION_FAILED:{code:"TRANSCRIPTION_FAILED",category:"AI",severity:"MEDIUM",internalMessage:"Transcription processing failed",userMessage:"Transcription could not be completed.",httpStatus:500,shouldAlert:!1,trackKPI:!0},PLAN_LIMIT_EXCEEDED:{code:"PLAN_LIMIT_EXCEEDED",category:"ORG",severity:"MEDIUM",internalMessage:"Plan limit exceeded",userMessage:"This feature is not available on your current plan. Please upgrade.",httpStatus:403,shouldAlert:!1,trackKPI:!0},ORG_NOT_FOUND:{code:"ORG_NOT_FOUND",category:"ORG",severity:"MEDIUM",internalMessage:"Organization not found",userMessage:"Organization not found",httpStatus:404,shouldAlert:!1,trackKPI:!1},SYSTEM_ERROR:{code:"SYSTEM_ERROR",category:"SYSTEM",severity:"CRITICAL",internalMessage:"Unexpected system error",userMessage:"An unexpected error occurred. Please try again.",httpStatus:500,shouldAlert:!0,trackKPI:!0},SERVICE_UNAVAILABLE:{code:"SERVICE_UNAVAILABLE",category:"SYSTEM",severity:"HIGH",internalMessage:"Service temporarily unavailable",userMessage:"Service temporarily unavailable. Please try again later.",httpStatus:503,shouldAlert:!0,trackKPI:!0},INVALID_INPUT:{code:"INVALID_INPUT",category:"USER",severity:"MEDIUM",internalMessage:"Invalid input provided",userMessage:"Invalid input. Please check your request and try again.",httpStatus:400,shouldAlert:!1,trackKPI:!1},INVALID_PHONE:{code:"INVALID_PHONE",category:"USER",severity:"MEDIUM",internalMessage:"Invalid phone number format",userMessage:"The phone number provided is invalid. Please verify and try again.",httpStatus:400,shouldAlert:!1,trackKPI:!1}};function s(e){return r[e]||null}function i(){return r.SYSTEM_ERROR}},62632:(e,t,a)=>{a.r(t),a.d(t,{default:()=>r});let r={from:e=>({insert:async e=>({data:[e],error:null}),update:async e=>({data:[e],error:null}),select:t=>(function(e,t){let a={_table:e,_cols:t,eq:(e,t)=>a,in:(e,t)=>a,limit:e=>a,order:(e,t)=>a,single:async()=>({data:null,error:null})};return a.then=(e,t)=>Promise.resolve({data:null,error:null}).then(e,t),a.catch=e=>Promise.resolve({data:null,error:null}).catch(e),a})(e,t),in:(e,t)=>({data:null,error:null})})}},6649:(e,t,a)=>{a.d(t,{Z:()=>o});var r=a(84770),s=a.n(r);let i=new Uint8Array(256),l=i.length;function o(){return l>i.length-16&&(s().randomFillSync(i),l=0),i.slice(l,l+=16)}},16099:(e,t,a)=>{a.d(t,{Z:()=>i});var r=a(30900);let s=[];for(let e=0;e<256;++e)s.push((e+256).toString(16).substr(1));let i=function(e,t=0){let a=(s[e[t+0]]+s[e[t+1]]+s[e[t+2]]+s[e[t+3]]+"-"+s[e[t+4]]+s[e[t+5]]+"-"+s[e[t+6]]+s[e[t+7]]+"-"+s[e[t+8]]+s[e[t+9]]+"-"+s[e[t+10]]+s[e[t+11]]+s[e[t+12]]+s[e[t+13]]+s[e[t+14]]+s[e[t+15]]).toLowerCase();if(!(0,r.Z)(a))throw TypeError("Stringified UUID is invalid");return a}},79843:(e,t,a)=>{a.d(t,{Z:()=>i});var r=a(6649),s=a(16099);let i=function(e,t,a){let i=(e=e||{}).random||(e.rng||r.Z)();if(i[6]=15&i[6]|64,i[8]=63&i[8]|128,t){a=a||0;for(let e=0;e<16;++e)t[a+e]=i[e];return t}return(0,s.Z)(i)}},30900:(e,t,a)=>{a.d(t,{Z:()=>s});let r=/^(?:[0-9a-f]{8}-[0-9a-f]{4}-[1-5][0-9a-f]{3}-[89ab][0-9a-f]{3}-[0-9a-f]{12}|00000000-0000-0000-0000-000000000000)$/i,s=function(e){return"string"==typeof e&&r.test(e)}},23151:(e,t,a)=>{a.d(t,{g:()=>r});class r extends Error{constructor(e){super(e.message),this.id=e.id??"err_"+Math.random().toString(36).slice(2,9),this.code=e.code,this.user_message=e.user_message,this.severity=e.severity??"MEDIUM",this.retriable=!!e.retriable,this.details=e.details;try{let{getErrorDefinition:e}=a(6781),t=e(this.code);this.httpStatus=t?.httpStatus||500}catch{this.httpStatus=500}}toJSON(){return{id:this.id,code:this.code,message:this.message,user_message:this.user_message,severity:this.severity,httpStatus:this.httpStatus}}}}};