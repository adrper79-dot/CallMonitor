"use strict";exports.id=432,exports.ids=[432],exports.modules={3045:(e,t,a)=>{a.d(t,{Z:()=>i});var r=a(9843),s=a(3151);let l=/^\+?[1-9]\d{1,14}$/;async function i(e,t){let{supabaseAdmin:a,getSession:i,signalwireCall:o,env:n=process.env}=t,d=null,c=null,u=null,g=e.organization_id;async function _(e,t,s){try{await a.from("audit_logs").insert({id:(0,r.Z)(),organization_id:g,user_id:d,system_id:c,resource_type:e,resource_id:t,action:"error",before:null,after:s,created_at:new Date().toISOString()})}catch(e){console.error("failed to write audit error",e)}}let m=async e=>{let t;let a=n.SIGNALWIRE_PROJECT_ID,l=n.SIGNALWIRE_TOKEN,i=n.SIGNALWIRE_NUMBER,o=String(n.SIGNALWIRE_SPACE||"").replace(/^https?:\/\//,"").replace(/\/$/,"").replace(/\.signalwire\.com$/i,"").trim();if(!(a&&l&&o&&i)){if("production"===n.NODE_ENV){let e=new s.g({code:"SIGNALWIRE_CONFIG_MISSING",message:"SignalWire credentials missing",user_message:"System configuration error",severity:"CRITICAL",retriable:!1});throw await _("systems",null,e.toJSON()),e}return`mock-${(0,r.Z)()}`}let d=Buffer.from(`${a}:${l}`).toString("base64"),c=new URLSearchParams;c.append("From",i),c.append("To",e),c.append("Url",`${n.NEXT_PUBLIC_APP_URL}/api/voice/laml/outbound`),c.append("StatusCallback",`${n.NEXT_PUBLIC_APP_URL}/api/webhooks/signalwire`);let g=`https://${o}.signalwire.com/api/laml/2010-04-01/Accounts/${a}/Calls.json`;console.log("startCallHandler: sending SignalWire POST",{endpoint:g,to:e,from:i});let m=new AbortController,w=setTimeout(()=>m.abort(),1e4);try{t=await fetch(g,{method:"POST",headers:{Authorization:`Basic ${d}`,"Content-Type":"application/x-www-form-urlencoded"},body:c,signal:m.signal})}catch(t){console.error("startCallHandler: SignalWire fetch error",{error:t?.message??String(t)});let e=new s.g({code:"SIGNALWIRE_FETCH_FAILED",message:"Failed to reach SignalWire",user_message:"Failed to place call via carrier",severity:"HIGH",retriable:!0,details:{cause:t?.message??String(t)}});throw await _("calls",u,e.toJSON()),e}finally{clearTimeout(w)}if(!t.ok){let e=await t.text();console.error("startCallHandler: SignalWire POST failed",{status:t.status,body:e});let a=new s.g({code:"SIGNALWIRE_API_ERROR",message:`SignalWire Error: ${t.status}`,user_message:"Failed to place call via carrier",severity:"HIGH",retriable:!0,details:{provider_error:e}});throw await _("calls",u,a.toJSON()),a}let S=await t.json();return console.log("startCallHandler: SignalWire responded",{sid:S?.sid?"[REDACTED]":null}),S?.sid??null};try{let{from_number:t,phone_number:w,flow_type:S,modulations:f}=e;g=e.organization_id;let I=["5f64d900-e212-42ab-bf41-7518f0bbcd4f","f25e038f-5006-4468-8e6a-12712a6afe95"];if(!I.includes(g)||/^0{8}-0{4}-0{4}-0{4}-0{12}$/.test(String(g))){let t=I[0];console.warn("startCallHandler: overriding organization_id for outbound connectivity",{requested:e.organization_id,using:t}),g=t}console.log("startCallHandler: initiating call",{organization_id:g,from_number:t,phone_number:w,flow_type:S,modulations:f});let y=await i().catch(()=>null),b=y?.user?.id??null;if(d=b,!b){if("production"!==n.NODE_ENV)d=b="28d68e05-ab20-40ee-b935-b19e8927ae68",console.warn("startCallHandler: using dev fallback actorId",{actorId:b});else{let e=new s.g({code:"AUTH_REQUIRED",message:"Unauthenticated",user_message:"Authentication required",severity:"HIGH",retriable:!1});throw await _("organizations",null,e.toJSON()),e}}if(!/^[0-9a-fA-F-]{36}$/.test(g)){let e=new s.g({code:"CALL_START_INVALID_ORG",message:"Invalid organization id",user_message:"Invalid organization identifier",severity:"MEDIUM",retriable:!1});throw await _("organizations",null,e.toJSON()),e}let{data:E,error:A}=await a.from("organizations").select("id,plan,tool_id").eq("id",g).limit(1);if(A){let e=new s.g({code:"CALL_START_DB_ORG_LOOKUP",message:"Organization lookup failed",user_message:"Unable to verify organization.",severity:"HIGH",retriable:!0,details:{cause:A.message}});throw await _("organizations",null,e.toJSON()),e}let T=E?.[0];if(!T){let e=new s.g({code:"CALL_START_ORG_NOT_FOUND",message:"Organization not found",user_message:"Organization not found.",severity:"HIGH",retriable:!1});throw await _("organizations",null,e.toJSON()),e}if("free"===T.plan){let e=new s.g({code:"CALL_START_PLAN_LIMIT_EXCEEDED",message:"Plan does not permit outbound calls",user_message:"Your plan does not allow outbound calls. Please upgrade.",severity:"HIGH",retriable:!1});throw await _("organizations",T.id,e.toJSON()),e}let{data:h,error:N}=await a.from("org_members").select("id,role").eq("organization_id",g).eq("user_id",b).limit(1);if(N){let e=new s.g({code:"AUTH_MEMBERSHIP_LOOKUP_FAILED",message:"Membership lookup failed",user_message:"Unable to verify membership",severity:"HIGH",retriable:!0,details:{cause:N.message}});throw await _("org_members",null,e.toJSON()),e}let p={record:!1,transcribe:!1,translate:!1};try{let{data:e,error:t}=await a.from("voice_configs").select("record,transcribe,translate,translate_from,translate_to,survey,synthetic_caller").eq("organization_id",g).limit(1);if(!t&&e&&e[0]){let t=e[0];p.record=!!t.record,p.transcribe=!!t.transcribe,p.translate=!!t.translate,p.survey=!!t.survey,p.synthetic_caller=!!t.synthetic_caller,"string"==typeof t.translate_from&&(p.translate_from=t.translate_from),"string"==typeof t.translate_to&&(p.translate_to=t.translate_to)}}catch(e){}if(!h||0===h.length){let e=new s.g({code:"AUTH_ORG_MISMATCH",message:"Actor not authorized for organization",user_message:"Not authorized for this organization",severity:"HIGH",retriable:!1});throw await _("org_members",null,e.toJSON()),e}if(!l.test(w)){let e=new s.g({code:"CALL_START_INVALID_PHONE",message:"Invalid phone number format",user_message:"The phone number provided is invalid. Please verify and try again.",severity:"MEDIUM",retriable:!1});throw await _("calls",null,e.toJSON()),e}let{data:L,error:C}=await a.from("systems").select("id,key").in("key",["system-cpid","system-ai"]);if(C){let e=new s.g({code:"CALL_START_SYS_LOOKUP_FAILED",message:"System lookup failed",user_message:"Service error",severity:"HIGH",retriable:!0,details:{cause:C.message}});throw await _("systems",null,e.toJSON()),e}let v={};(L||[]).forEach(e=>{v[e.key]=e.id});let R=v["system-cpid"]??null,O=v["system-ai"]??null;if(c=R,!R){let e=new s.g({code:"CALL_START_SYS_MISSING",message:"Control system not registered",user_message:"Service misconfiguration",severity:"HIGH",retriable:!1});throw await _("systems",null,e.toJSON()),e}let D={id:u=(0,r.Z)(),organization_id:g,system_id:R,status:"pending",started_at:null,ended_at:null,created_by:b},{error:H}=await a.from("calls").insert(D);if(H){console.error("startCallHandler: failed to insert call row",{callId:u,error:H?.message});let e=new s.g({code:"CALL_START_DB_INSERT",message:"Failed to create call record",user_message:"We encountered a system error while starting your call. Please try again.",severity:"HIGH",retriable:!0,details:{cause:H.message}});throw await _("calls",u,e.toJSON()),e}let U=null;if(o){if(console.log("startCallHandler: using injected signalwireCall to place outbound call"),"bridge"===S&&t&&l.test(t)){let e=await o({from:String(n.SIGNALWIRE_NUMBER||""),to:t,url:String(n.NEXT_PUBLIC_APP_URL)+"/api/voice/laml/outbound",statusCallback:String(n.NEXT_PUBLIC_APP_URL)+"/api/webhooks/signalwire"}),a=await o({from:String(n.SIGNALWIRE_NUMBER||""),to:w,url:String(n.NEXT_PUBLIC_APP_URL)+"/api/voice/laml/outbound",statusCallback:String(n.NEXT_PUBLIC_APP_URL)+"/api/webhooks/signalwire"});U=a.call_sid,console.log("startCallHandler: injected signalwireCall bridge created",{a:e.call_sid?"[REDACTED]":null,b:a.call_sid?"[REDACTED]":null})}else U=(await o({from:String(n.SIGNALWIRE_NUMBER||""),to:w,url:String(n.NEXT_PUBLIC_APP_URL)+"/api/voice/laml/outbound",statusCallback:String(n.NEXT_PUBLIC_APP_URL)+"/api/webhooks/signalwire"})).call_sid,console.log("startCallHandler: injected signalwireCall returned",{call_sid:U?"[REDACTED]":null})}else if("bridge"===S&&t&&l.test(t)){let e=await m(t),a=await m(w);U=a,console.log("startCallHandler: signalwire bridge created",{a:e?"[REDACTED]":null,b:a?"[REDACTED]":null})}else U=await m(w),console.log("startCallHandler: signalwire call placed",{call_sid:U?"[REDACTED]":null});let{error:P}=await a.from("calls").update({status:"in-progress"}).eq("id",u);if(P&&(console.error("startCallHandler: failed to update call status",{callId:u,error:P?.message}),await _("calls",u,{message:"Failed to save call_sid",error:P.message})),p.transcribe){if(O){let e={id:(0,r.Z)(),call_id:u,system_id:O,model:"assemblyai-v1",status:"queued"};try{let{error:t}=await a.from("ai_runs").insert(e);t&&(console.error("startCallHandler: failed to insert ai_run",{callId:u,error:t?.message}),await _("ai_runs",u,new s.g({code:"AI_TRANSC_INSERT_FAILED",message:"Failed to enqueue transcription",user_message:"Transcription could not be started. The call will continue without transcription.",severity:"MEDIUM",retriable:!0,details:{cause:t.message}}).toJSON()))}catch(e){await _("ai_runs",u,new s.g({code:"AI_TRANSC_INSERT_FAILED",message:"Failed to enqueue transcription",user_message:"Transcription could not be started. The call will continue without transcription.",severity:"MEDIUM",retriable:!0,details:{cause:e.message}}).toJSON())}}else await _("systems",u,new s.g({code:"CALL_START_AI_SYSTEM_MISSING",message:"AI system not registered",user_message:"Transcription unavailable right now.",severity:"MEDIUM",retriable:!0}).toJSON())}if(p.translate){let e=p.translate_from??null,t=p.translate_to??null;if(e&&t){if(O){let l={id:(0,r.Z)(),call_id:u,system_id:O,model:"assemblyai-translation-v1",status:"queued",meta:{translate_from:e,translate_to:t}};try{let{error:e}=await a.from("ai_runs").insert(l);e&&(console.error("startCallHandler: failed to insert ai_run (translation)",{callId:u,error:e?.message}),await _("ai_runs",u,new s.g({code:"AI_TRANSL_INSERT_FAILED",message:"Failed to enqueue translation",user_message:"Translation could not be started. The call will continue without translation.",severity:"MEDIUM",retriable:!0,details:{cause:e.message}}).toJSON()))}catch(e){await _("ai_runs",u,new s.g({code:"AI_TRANSL_INSERT_FAILED",message:"Failed to enqueue translation",user_message:"Translation could not be started. The call will continue without translation.",severity:"MEDIUM",retriable:!0,details:{cause:e.message}}).toJSON())}}else await _("systems",u,new s.g({code:"CALL_START_AI_SYSTEM_MISSING",message:"AI system not registered",user_message:"Translation unavailable right now.",severity:"MEDIUM",retriable:!0}).toJSON())}else await _("ai_runs",u,new s.g({code:"AI_TRANSL_LANG_MISSING",message:"Translation configured but language codes missing",user_message:"Translation configuration incomplete; skipping translation.",severity:"MEDIUM",retriable:!1}).toJSON())}if(p.record){let e=T?.tool_id??null;if(e)try{await a.from("audit_logs").insert({id:(0,r.Z)(),organization_id:g,user_id:d,system_id:c,resource_type:"calls",resource_id:u,action:"intent:recording_requested",before:null,after:{tool_id:e,requested_at:new Date().toISOString()},created_at:new Date().toISOString()})}catch(e){}else await _("calls",u,new s.g({code:"RECORDING_TOOL_NOT_FOUND",message:"No recording tool available for organization",user_message:"No recording tool available for your organization",severity:"MEDIUM",retriable:!1}).toJSON())}let{data:M,error:G}=await a.from("calls").select("*").eq("id",u).limit(1);if(G||!M?.[0]){console.error("startCallHandler: failed to fetch persisted call",{callId:u,error:G?.message});let e=new s.g({code:"CALL_START_FETCH_PERSISTED_FAILED",message:"Failed to read back persisted call",user_message:"We started the call but could not verify its record. Please contact support.",severity:"HIGH",retriable:!0,details:{cause:G?.message}});throw await _("calls",u,e.toJSON()),e}let J=M[0];try{await a.from("audit_logs").insert({id:(0,r.Z)(),organization_id:g,user_id:d,system_id:c,resource_type:"calls",resource_id:u,action:"create",before:null,after:{...J,config:p,call_sid:U},created_at:new Date().toISOString()})}catch(e){console.error("startCallHandler: failed to insert audit log",{callId:u,error:e?.message}),await _("audit_logs",u,new s.g({code:"AUDIT_LOG_INSERT_FAILED",message:"Failed to write audit log",user_message:"Call started but an internal audit log could not be saved.",severity:"MEDIUM",retriable:!0,details:{cause:e.message}}).toJSON())}return console.log("startCallHandler: call flow completed",{callId:u}),{success:!0,call_id:u}}catch(t){if(t instanceof s.g){let e=t.toJSON();try{await a.from("audit_logs").insert({id:(0,r.Z)(),organization_id:g,user_id:d??null,system_id:c??null,resource_type:"calls",resource_id:u??null,action:"error",before:null,after:e,created_at:new Date().toISOString()})}catch(e){}return{success:!1,error:{id:e.id,code:e.code,message:e.user_message??e.message,severity:e.severity}}}console.error("startCallHandler unexpected error",t);let e=new s.g({code:"CALL_START_UNEXPECTED",message:t?.message??"Unexpected error",user_message:"An unexpected error occurred while starting the call.",severity:"CRITICAL",retriable:!0,details:{stack:t?.stack}}).toJSON();try{await a.from("audit_logs").insert({id:(0,r.Z)(),organization_id:g,user_id:null,system_id:null,resource_type:"calls",resource_id:null,action:"error",before:null,after:e,created_at:new Date().toISOString()})}catch(e){}return{success:!1,error:{id:e.id,code:e.code,message:e.user_message??e.message,severity:e.severity}}}}},2632:(e,t,a)=>{a.d(t,{Z:()=>r});let r={from:e=>({insert:async e=>({data:[e],error:null}),update:async e=>({data:[e],error:null}),select:t=>(function(e,t){let a={_table:e,_cols:t,eq:(e,t)=>a,in:(e,t)=>a,limit:e=>a,order:(e,t)=>a,single:async()=>({data:null,error:null})};return a.then=(e,t)=>Promise.resolve({data:null,error:null}).then(e,t),a.catch=e=>Promise.resolve({data:null,error:null}).catch(e),a})(e,t),in:(e,t)=>({data:null,error:null})})}},3151:(e,t,a)=>{a.d(t,{g:()=>r});class r extends Error{constructor(e){super(e.message),this.id=e.id??"err_"+Math.random().toString(36).slice(2,9),this.code=e.code,this.user_message=e.user_message,this.severity=e.severity??"MEDIUM",this.retriable=!!e.retriable,this.details=e.details}toJSON(){return{id:this.id,code:this.code,message:this.message,user_message:this.user_message,severity:this.severity}}}}};