"use strict";exports.id=75,exports.ids=[75],exports.modules={3175:(e,t,a)=>{a.d(t,{Z:()=>l});var r=a(9843);class s extends Error{constructor(e){super(e.message),this.id=e.id??"err_"+Math.random().toString(36).slice(2,9),this.code=e.code,this.user_message=e.user_message,this.severity=e.severity??"MEDIUM",this.retriable=!!e.retriable,this.details=e.details}toJSON(){return{id:this.id,code:this.code,message:this.message,user_message:this.user_message,severity:this.severity}}}let i=/^\+?[1-9]\d{1,14}$/;async function l(e,t){let{supabaseAdmin:a,getSession:l,signalwireCall:o,env:n=process.env}=t,d=null,c=null,u=null;async function _(t,s,i){try{await a.from("audit_logs").insert({id:(0,r.Z)(),organization_id:e.organization_id,user_id:d,system_id:c,resource_type:t,resource_id:s,action:"error",before:null,after:i,created_at:new Date().toISOString()})}catch(e){console.error("failed to write audit error",e)}}let g=async e=>{let t;let a=n.SIGNALWIRE_PROJECT_ID,i=n.SIGNALWIRE_TOKEN,l=n.SIGNALWIRE_NUMBER,o=String(n.SIGNALWIRE_SPACE||"").replace(/^https?:\/\//,"").replace(/\/$/,"").replace(/\.signalwire\.com$/i,"").trim();if(!(a&&i&&o&&l)){if("production"===n.NODE_ENV){let e=new s({code:"SIGNALWIRE_CONFIG_MISSING",message:"SignalWire credentials missing",user_message:"System configuration error",severity:"CRITICAL",retriable:!1});throw await _("systems",null,e.toJSON()),e}return`mock-${(0,r.Z)()}`}let d=Buffer.from(`${a}:${i}`).toString("base64"),c=new URLSearchParams;c.append("From",l),c.append("To",e),c.append("Url",`${n.NEXT_PUBLIC_APP_URL}/api/voice/laml/outbound`),c.append("StatusCallback",`${n.NEXT_PUBLIC_APP_URL}/api/webhooks/signalwire`);let g=`https://${o}.signalwire.com/api/laml/2010-04-01/Accounts/${a}/Calls.json`;console.log("startCallHandler: sending SignalWire POST",{endpoint:g,to:e,from:l});let m=new AbortController,w=setTimeout(()=>m.abort(),1e4);try{t=await fetch(g,{method:"POST",headers:{Authorization:`Basic ${d}`,"Content-Type":"application/x-www-form-urlencoded"},body:c,signal:m.signal})}catch(t){console.error("startCallHandler: SignalWire fetch error",{error:t?.message??String(t)});let e=new s({code:"SIGNALWIRE_FETCH_FAILED",message:"Failed to reach SignalWire",user_message:"Failed to place call via carrier",severity:"HIGH",retriable:!0,details:{cause:t?.message??String(t)}});throw await _("calls",u,e.toJSON()),e}finally{clearTimeout(w)}if(!t.ok){let e=await t.text();console.error("startCallHandler: SignalWire POST failed",{status:t.status,body:e});let a=new s({code:"SIGNALWIRE_API_ERROR",message:`SignalWire Error: ${t.status}`,user_message:"Failed to place call via carrier",severity:"HIGH",retriable:!0,details:{provider_error:e}});throw await _("calls",u,a.toJSON()),a}let S=await t.json();return console.log("startCallHandler: SignalWire responded",{sid:S?.sid?"[REDACTED]":null}),S?.sid??null};try{let{from_number:t,phone_number:m,flow_type:w,modulations:S}=e,f=e.organization_id,I=["5f64d900-e212-42ab-bf41-7518f0bbcd4f","f25e038f-5006-4468-8e6a-12712a6afe95"];if(!I.includes(f)||/^0{8}-0{4}-0{4}-0{4}-0{12}$/.test(String(f))){let t=(e=>{if(!e)return I[0];let t=0;for(let a=0;a<e.length;a++)t=31*t+e.charCodeAt(a)|0;let a=Math.abs(t)%I.length;return I[a]})(m);console.warn("startCallHandler: overriding organization_id for outbound connectivity",{requested:e.organization_id,using:t}),f=t}console.log("startCallHandler: initiating call",{organization_id:f,from_number:t,phone_number:m,flow_type:w,modulations:S});let y=await l().catch(()=>null),b=y?.user?.id??null;if(d=b,!b){if("production"!==n.NODE_ENV)d=b="28d68e05-ab20-40ee-b935-b19e8927ae68",console.warn("startCallHandler: using dev fallback actorId",{actorId:b});else{let e=new s({code:"AUTH_REQUIRED",message:"Unauthenticated",user_message:"Authentication required",severity:"HIGH",retriable:!1});throw await _("organizations",null,e.toJSON()),e}}if(!/^[0-9a-fA-F-]{36}$/.test(f)){let e=new s({code:"CALL_START_INVALID_ORG",message:"Invalid organization id",user_message:"Invalid organization identifier",severity:"MEDIUM",retriable:!1});throw await _("organizations",null,e.toJSON()),e}let{data:E,error:A}=await a.from("organizations").select("id,plan,tool_id").eq("id",f).limit(1);if(A){let e=new s({code:"CALL_START_DB_ORG_LOOKUP",message:"Organization lookup failed",user_message:"Unable to verify organization.",severity:"HIGH",retriable:!0,details:{cause:A.message}});throw await _("organizations",null,e.toJSON()),e}let h=E?.[0];if(!h){let e=new s({code:"CALL_START_ORG_NOT_FOUND",message:"Organization not found",user_message:"Organization not found.",severity:"HIGH",retriable:!1});throw await _("organizations",null,e.toJSON()),e}if("free"===h.plan){let e=new s({code:"CALL_START_PLAN_LIMIT_EXCEEDED",message:"Plan does not permit outbound calls",user_message:"Your plan does not allow outbound calls. Please upgrade.",severity:"HIGH",retriable:!1});throw await _("organizations",h.id,e.toJSON()),e}let{data:p,error:T}=await a.from("org_members").select("id,role").eq("organization_id",f).eq("user_id",b).limit(1);if(T){let e=new s({code:"AUTH_MEMBERSHIP_LOOKUP_FAILED",message:"Membership lookup failed",user_message:"Unable to verify membership",severity:"HIGH",retriable:!0,details:{cause:T.message}});throw await _("org_members",null,e.toJSON()),e}if(!p||0===p.length){let e=new s({code:"AUTH_ORG_MISMATCH",message:"Actor not authorized for organization",user_message:"Not authorized for this organization",severity:"HIGH",retriable:!1});throw await _("org_members",null,e.toJSON()),e}if(!i.test(m)){let e=new s({code:"CALL_START_INVALID_PHONE",message:"Invalid phone number format",user_message:"The phone number provided is invalid. Please verify and try again.",severity:"MEDIUM",retriable:!1});throw await _("calls",null,e.toJSON()),e}let{data:N,error:C}=await a.from("systems").select("id,key").in("key",["system-cpid","system-ai"]);if(C){let e=new s({code:"CALL_START_SYS_LOOKUP_FAILED",message:"System lookup failed",user_message:"Service error",severity:"HIGH",retriable:!0,details:{cause:C.message}});throw await _("systems",null,e.toJSON()),e}let L={};(N||[]).forEach(e=>{L[e.key]=e.id});let R=L["system-cpid"]??null,v=L["system-ai"]??null;if(c=R,!R){let e=new s({code:"CALL_START_SYS_MISSING",message:"Control system not registered",user_message:"Service misconfiguration",severity:"HIGH",retriable:!1});throw await _("systems",null,e.toJSON()),e}let O={id:u=(0,r.Z)(),organization_id:f,system_id:R,status:"pending",started_at:null,ended_at:null,created_by:b},{error:D}=await a.from("calls").insert(O);if(D){console.error("startCallHandler: failed to insert call row",{callId:u,error:D?.message});let e=new s({code:"CALL_START_DB_INSERT",message:"Failed to create call record",user_message:"We encountered a system error while starting your call. Please try again.",severity:"HIGH",retriable:!0,details:{cause:D.message}});throw await _("calls",u,e.toJSON()),e}let H=null;if(o){if(console.log("startCallHandler: using injected signalwireCall to place outbound call"),"bridge"===w&&t&&i.test(t)){let e=await o({from:String(n.SIGNALWIRE_NUMBER||""),to:t,url:String(n.NEXT_PUBLIC_APP_URL)+"/api/voice/laml/outbound",statusCallback:String(n.NEXT_PUBLIC_APP_URL)+"/api/webhooks/signalwire"}),a=await o({from:String(n.SIGNALWIRE_NUMBER||""),to:m,url:String(n.NEXT_PUBLIC_APP_URL)+"/api/voice/laml/outbound",statusCallback:String(n.NEXT_PUBLIC_APP_URL)+"/api/webhooks/signalwire"});H=a.call_sid,console.log("startCallHandler: injected signalwireCall bridge created",{a:e.call_sid?"[REDACTED]":null,b:a.call_sid?"[REDACTED]":null})}else H=(await o({from:String(n.SIGNALWIRE_NUMBER||""),to:m,url:String(n.NEXT_PUBLIC_APP_URL)+"/api/voice/laml/outbound",statusCallback:String(n.NEXT_PUBLIC_APP_URL)+"/api/webhooks/signalwire"})).call_sid,console.log("startCallHandler: injected signalwireCall returned",{call_sid:H?"[REDACTED]":null})}else if("bridge"===w&&t&&i.test(t)){let e=await g(t),a=await g(m);H=a,console.log("startCallHandler: signalwire bridge created",{a:e?"[REDACTED]":null,b:a?"[REDACTED]":null})}else H=await g(m),console.log("startCallHandler: signalwire call placed",{call_sid:H?"[REDACTED]":null});let{error:P}=await a.from("calls").update({status:"in-progress"}).eq("id",u);if(P&&(console.error("startCallHandler: failed to update call status",{callId:u,error:P?.message}),await _("calls",u,{message:"Failed to save call_sid",error:P.message})),S.transcribe){if(v){let e={id:(0,r.Z)(),call_id:u,system_id:v,model:"assemblyai-v1",status:"queued"};try{let{error:t}=await a.from("ai_runs").insert(e);t&&(console.error("startCallHandler: failed to insert ai_run",{callId:u,error:t?.message}),await _("ai_runs",u,new s({code:"AI_TRANSC_INSERT_FAILED",message:"Failed to enqueue transcription",user_message:"Transcription could not be started. The call will continue without transcription.",severity:"MEDIUM",retriable:!0,details:{cause:t.message}}).toJSON()))}catch(e){await _("ai_runs",u,new s({code:"AI_TRANSC_INSERT_FAILED",message:"Failed to enqueue transcription",user_message:"Transcription could not be started. The call will continue without transcription.",severity:"MEDIUM",retriable:!0,details:{cause:e.message}}).toJSON())}}else await _("systems",u,new s({code:"CALL_START_AI_SYSTEM_MISSING",message:"AI system not registered",user_message:"Transcription unavailable right now.",severity:"MEDIUM",retriable:!0}).toJSON())}if(S.record){let e=h?.tool_id??null;if(e)try{await a.from("audit_logs").insert({id:(0,r.Z)(),organization_id:f,user_id:d,system_id:c,resource_type:"calls",resource_id:u,action:"intent:recording_requested",before:null,after:{tool_id:e,requested_at:new Date().toISOString()},created_at:new Date().toISOString()})}catch(e){}else await _("calls",u,new s({code:"RECORDING_TOOL_NOT_FOUND",message:"No recording tool available for organization",user_message:"No recording tool available for your organization",severity:"MEDIUM",retriable:!1}).toJSON())}let{data:U,error:G}=await a.from("calls").select("*").eq("id",u).limit(1);if(G||!U?.[0]){console.error("startCallHandler: failed to fetch persisted call",{callId:u,error:G?.message});let e=new s({code:"CALL_START_FETCH_PERSISTED_FAILED",message:"Failed to read back persisted call",user_message:"We started the call but could not verify its record. Please contact support.",severity:"HIGH",retriable:!0,details:{cause:G?.message}});throw await _("calls",u,e.toJSON()),e}let M=U[0];try{await a.from("audit_logs").insert({id:(0,r.Z)(),organization_id:f,user_id:d,system_id:c,resource_type:"calls",resource_id:u,action:"create",before:null,after:{...M,config:S,call_sid:H},created_at:new Date().toISOString()})}catch(e){console.error("startCallHandler: failed to insert audit log",{callId:u,error:e?.message}),await _("audit_logs",u,new s({code:"AUDIT_LOG_INSERT_FAILED",message:"Failed to write audit log",user_message:"Call started but an internal audit log could not be saved.",severity:"MEDIUM",retriable:!0,details:{cause:e.message}}).toJSON())}return console.log("startCallHandler: call flow completed",{callId:u}),{success:!0,call_id:u}}catch(i){if(i instanceof s){let t=i.toJSON();try{await a.from("audit_logs").insert({id:(0,r.Z)(),organization_id:e.organization_id,user_id:d??null,system_id:c??null,resource_type:"calls",resource_id:u??null,action:"error",before:null,after:t,created_at:new Date().toISOString()})}catch(e){}return{success:!1,error:{id:t.id,code:t.code,message:t.user_message??t.message,severity:t.severity}}}let t=new s({code:"CALL_START_UNEXPECTED",message:i?.message??"Unexpected error",user_message:"An unexpected error occurred while starting the call.",severity:"CRITICAL",retriable:!0,details:{stack:i?.stack}}).toJSON();try{await a.from("audit_logs").insert({id:(0,r.Z)(),organization_id:e.organization_id,user_id:null,system_id:null,resource_type:"calls",resource_id:null,action:"error",before:null,after:t,created_at:new Date().toISOString()})}catch(e){}return{success:!1,error:{id:t.id,code:t.code,message:t.user_message??t.message,severity:t.severity}}}}},2632:(e,t,a)=>{a.d(t,{Z:()=>r});let r={from:e=>({insert:async e=>({data:[e],error:null}),update:async e=>({data:[e],error:null}),select:t=>(function(e,t){let a={_table:e,_cols:t,eq:(e,t)=>a,in:(e,t)=>a,limit:e=>a,order:(e,t)=>a,single:async()=>({data:null,error:null})};return a.then=(e,t)=>Promise.resolve({data:null,error:null}).then(e,t),a.catch=e=>Promise.resolve({data:null,error:null}).catch(e),a})(e,t),in:(e,t)=>({data:null,error:null})})}}};