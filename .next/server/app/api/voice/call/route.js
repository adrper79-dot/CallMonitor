"use strict";(()=>{var e={};e.id=584,e.ids=[584],e.modules={72934:e=>{e.exports=require("next/dist/client/components/action-async-storage.external.js")},54580:e=>{e.exports=require("next/dist/client/components/request-async-storage.external.js")},45869:e=>{e.exports=require("next/dist/client/components/static-generation-async-storage.external.js")},20399:e=>{e.exports=require("next/dist/compiled/next-server/app-page.runtime.prod.js")},30517:e=>{e.exports=require("next/dist/compiled/next-server/app-route.runtime.prod.js")},27790:e=>{e.exports=require("assert")},78893:e=>{e.exports=require("buffer")},84770:e=>{e.exports=require("crypto")},17702:e=>{e.exports=require("events")},32615:e=>{e.exports=require("http")},35240:e=>{e.exports=require("https")},86624:e=>{e.exports=require("querystring")},17360:e=>{e.exports=require("url")},21764:e=>{e.exports=require("util")},71568:e=>{e.exports=require("zlib")},77124:(e,t,r)=>{r.r(t),r.d(t,{originalPathname:()=>y,patchFetch:()=>x,requestAsyncStorage:()=>w,routeModule:()=>g,serverHooks:()=>h,staticGenerationAsyncStorage:()=>f});var a={};r.r(a),r.d(a,{POST:()=>m});var n=r(49303),i=r(88716),s=r(60670),o=r(87070),l=r(73045),c=r(23151),d=r(98373),u=r(18902);async function p(e){try{let t=await e.json(),a=await (0,l.Z)({organization_id:t.organization_id||t.orgId,phone_number:t.phone_to||t.phone_number||t.to,modulations:t.modulations||{}},{supabaseAdmin:(await Promise.resolve().then(r.bind(r,62632))).default,getServerSession:(await r.e(609).then(r.bind(r,45609))).getServerSession});if(a.success)return o.NextResponse.json(a);{let e=a.error||{code:"CALL_START_FAILED",message:"Failed to start call",severity:"HIGH"};return o.NextResponse.json({success:!1,error:e},{status:e.httpStatus||500})}}catch(t){let e=t instanceof c.g?t:new c.g({code:"CALL_START_FAILED",message:t?.message??"Unexpected error",user_message:"Failed to start call",severity:"HIGH"});return o.NextResponse.json({success:!1,error:{id:e.id,code:e.code,message:e.user_message,severity:e.severity}},{status:e.httpStatus||500})}}let m=(0,d.er)((0,u.ax)(p,{getKey:e=>(0,d.H9)(e)+"-"+Date.now().toString(),ttlSeconds:3600}),{identifier:e=>{let t=new URL(e.url).searchParams.get("orgId");return`${(0,d.H9)(e)}-${t||"anonymous"}`},config:{maxAttempts:10,windowMs:6e4,blockMs:3e5}}),g=new n.AppRouteRouteModule({definition:{kind:i.x.APP_ROUTE,page:"/api/voice/call/route",pathname:"/api/voice/call",filename:"route",bundlePath:"app/api/voice/call/route"},resolvedPagePath:"C:\\Users\\Ultimate Warrior\\My project\\gemini-project\\app\\api\\voice\\call\\route.ts",nextConfigOutput:"",userland:a}),{requestAsyncStorage:w,staticGenerationAsyncStorage:f,serverHooks:h}=g,y="/api/voice/call/route";function x(){return(0,s.patchFetch)({serverHooks:h,staticGenerationAsyncStorage:f})}},18902:(e,t,r)=>{r.d(t,{ax:()=>o});var a=r(62632),n=r(79843);async function i(e,t,r=3600){try{let{data:n,error:i}=await a.default.from("audit_logs").select("id, after").eq("resource_type","idempotency").eq("resource_id",e).gte("created_at",new Date(Date.now()-1e3*r).toISOString()).limit(1);if(!i&&n&&n.length>0){let e=n[0];if(e.after?.request_hash===t)return{cached:!0,response:e.after?.response}}return{cached:!1}}catch(e){return console.warn("idempotency check failed",e),{cached:!1}}}async function s(e,t,r,i,s=3600){try{await a.default.from("audit_logs").insert({id:(0,n.Z)(),organization_id:i||null,user_id:null,system_id:null,resource_type:"idempotency",resource_id:e,action:"create",before:null,after:{request_hash:t,response:r,expires_at:new Date(Date.now()+1e3*s).toISOString()},created_at:new Date().toISOString()})}catch(e){console.warn("storeIdempotency failed",e)}}function o(e,t){return async r=>{let a=r.headers.get("Idempotency-Key")||t?.getKey?.(r)||null;if(!a)return await e(r);let n=null;try{let e=r.clone();n=await e.json().catch(()=>({}))}catch{}let o=function(e){let t=JSON.stringify(e),r=0;for(let e=0;e<t.length;e++)r=(r<<5)-r+t.charCodeAt(e),r&=r;return Math.abs(r).toString(36)}({key:a,body:n}),l=await i(a,o,t?.ttlSeconds);if(l.cached&&l.response)return new Response(JSON.stringify(l.response),{status:200,headers:{"Content-Type":"application/json","X-Idempotency-Key":a,"X-Idempotency-Cached":"true"}});let c=await e(r);if(c.ok){let e=await c.clone().json().catch(()=>({})),n=new URL(r.url).searchParams.get("orgId");await s(a,o,e,n||void 0,t?.ttlSeconds)}let d=new Headers(c.headers);return d.set("X-Idempotency-Key",a),new Response(c.body,{status:c.status,statusText:c.statusText,headers:d})}}},98373:(e,t,r)=>{r.d(t,{H9:()=>s,er:()=>o});var a=r(62632);let n={maxAttempts:5,windowMs:9e5,blockMs:9e5};async function i(e,t=n){let r=Date.now(),i=r-t.windowMs;try{let{data:n,error:s}=await a.default.from("login_attempts").select("attempted_at, succeeded").eq("username",e).gte("attempted_at",new Date(i).toISOString()).order("attempted_at",{ascending:!1});if(!s&&n){let e;let a=n.filter(e=>!e.succeeded),i=a.length,s=a[0];if(s&&i>=t.maxAttempts&&(e=new Date(s.attempted_at).getTime()+t.blockMs)>r)return{allowed:!1,remaining:0,resetAt:e,blockedUntil:e};let o=Math.max(0,t.maxAttempts-i);return{allowed:o>0,remaining:o,resetAt:r+t.windowMs,blockedUntil:e}}}catch(e){console.warn("rateLimit: DB query failed, using in-memory fallback",e)}global.__rateLimiter||(global.__rateLimiter=new Map);let s=global.__rateLimiter,o=s.get(e)||{attempts:[],blockedUntil:0};if(o.attempts=o.attempts.filter(e=>e>i),o.blockedUntil&&o.blockedUntil>r)return{allowed:!1,remaining:0,resetAt:o.blockedUntil,blockedUntil:o.blockedUntil};let l=o.attempts.length;return l>=t.maxAttempts?(o.blockedUntil=r+t.blockMs,s.set(e,o),{allowed:!1,remaining:0,resetAt:o.blockedUntil,blockedUntil:o.blockedUntil}):{allowed:!0,remaining:t.maxAttempts-l,resetAt:r+t.windowMs}}function s(e){let t=e.headers.get("x-forwarded-for");return t?t.split(",")[0].trim():e.headers.get("x-real-ip")||"unknown"}function o(e,t){return async r=>{let a=t?.identifier?t.identifier(r):s(r),o=t?.config||n,l=await i(a,o);if(!l.allowed)return new Response(JSON.stringify({success:!1,error:{code:"RATE_LIMIT_EXCEEDED",message:"Too many requests. Please try again later.",severity:"MEDIUM"}}),{status:429,headers:{"Content-Type":"application/json","X-RateLimit-Limit":String(o.maxAttempts),"X-RateLimit-Remaining":String(l.remaining),"X-RateLimit-Reset":String(Math.ceil(l.resetAt/1e3)),...l.blockedUntil?{"Retry-After":String(Math.ceil((l.blockedUntil-Date.now())/1e3))}:{}}});let c=await e(r);return c.headers.set("X-RateLimit-Limit",String(o.maxAttempts)),c.headers.set("X-RateLimit-Remaining",String(l.remaining)),c.headers.set("X-RateLimit-Reset",String(Math.ceil(l.resetAt/1e3))),c}}}};var t=require("../../../../webpack-runtime.js");t.C(e);var r=e=>t(t.s=e),a=t.X(0,[276,972,432],()=>r(77124));module.exports=a})();