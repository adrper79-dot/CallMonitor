"use strict";(()=>{var e={};e.id=627,e.ids=[627],e.modules={20399:e=>{e.exports=require("next/dist/compiled/next-server/app-page.runtime.prod.js")},30517:e=>{e.exports=require("next/dist/compiled/next-server/app-route.runtime.prod.js")},84770:e=>{e.exports=require("crypto")},47868:(e,r,t)=>{t.r(r),t.d(r,{originalPathname:()=>S,patchFetch:()=>b,requestAsyncStorage:()=>w,routeModule:()=>m,serverHooks:()=>h,staticGenerationAsyncStorage:()=>_});var a={};t.r(a),t.d(a,{POST:()=>g});var i=t(49303),o=t(88716),n=t(60670),s=t(87070),l=t(79843),d=t(62632),u=t(90511),c=t(70332);async function g(e){let r=process.env.SIGNALWIRE_TOKEN;if(r){let t=e.headers.get("X-SignalWire-Signature")||e.headers.get("X-Signature")||e.headers.get("Signature");if(!t)return console.warn("signalwire webhook: signature header missing in production"),s.NextResponse.json({success:!1,error:{code:"WEBHOOK_SIGNATURE_MISSING",message:"Webhook signature required"}},{status:401});{let a=await e.text();if(!(0,u.V8)(a,t,r))return console.error("signalwire webhook: invalid signature",{signature:t.substring(0,10)+"..."}),s.NextResponse.json({success:!1,error:{code:"WEBHOOK_SIGNATURE_INVALID",message:"Invalid webhook signature"}},{status:401});e=new Request(e.url,{method:e.method,headers:e.headers,body:a})}}return p(e).catch(e=>{console.error("signalwire webhook async processing error",{error:e?.message??String(e)})}),s.NextResponse.json({ok:!0,received:!0})}async function p(e){try{let a=e.headers.get("content-type")||"",i=null;if(a.includes("application/x-www-form-urlencoded")){var r;r=await e.text(),i=Object.fromEntries(new URLSearchParams(r))}else try{i=await e.json()}catch(r){i=await e.text()}let o=i.CallSid||i.CallSid||i.call_sid,n=i.CallStatus||i.call_status,s=i.RecordingSid||i.RecordingSid||i.recording_sid,u=i.RecordingUrl||i.RecordingUrl||i.recording_url,g=i.RecordingDuration||i.RecordingDuration||i.recording_duration,p=i.CallDuration||i.CallDuration||i.call_duration,m=i.EventType||i.event_type||(s?"recording":"call");if(console.log("signalwire webhook processing",{callSid:o?"[REDACTED]":null,callStatus:n,eventType:m,hasRecording:!!s}),!o){console.warn("signalwire webhook: missing CallSid, skipping");return}let{data:w,error:_}=await d.default.from("calls").select("id, organization_id, status, started_at, ended_at").eq("call_sid",o).limit(1);if(_){console.error("signalwire webhook: failed to find call",{error:_.message,callSid:"[REDACTED]"});return}let h=w?.[0];if(!h){console.warn("signalwire webhook: call not found",{callSid:"[REDACTED]"});return}let S=h.id,b=h.organization_id,v=!1;try{let{data:e}=await d.default.from("organizations").select("plan").eq("id",b).limit(1),r=String(e?.[0]?.plan??"").toLowerCase(),t=["business","enterprise"].includes(r),a=(0,c.Au)();if(t&&a){let{data:e}=await d.default.from("voice_configs").select("translate, translate_from, translate_to").eq("organization_id",b).limit(1),r=e?.[0];r?.translate===!0&&r?.translate_from&&r?.translate_to&&(v=!0)}}catch(e){console.warn("signalwire webhook: failed to check live translation",{error:e})}if("call"===m||n){let e={completed:"completed",failed:"failed","no-answer":"failed",busy:"failed",ringing:"in_progress","in-progress":"in_progress",queued:"pending"}[n?.toLowerCase()]||n||"unknown",r={status:e};("completed"===e||"failed"===e)&&(r.ended_at=new Date().toISOString()),"in_progress"!==e&&"completed"!==e||h.started_at||(r.started_at=new Date().toISOString());let{error:t}=await d.default.from("calls").update(r).eq("id",S);t?console.error("signalwire webhook: failed to update call",{error:t.message,callId:S}):console.log("signalwire webhook: updated call status",{callId:S,status:e})}if(s&&u){let{data:e}=await d.default.from("recordings").select("id, status").eq("recording_sid",s).limit(1),r=e?.[0],{data:a}=await d.default.from("organizations").select("tool_id").eq("id",b).limit(1),i=a?.[0]?.tool_id;if(i){let e=g?Math.round(parseInt(String(g),10)/1e3):p?Math.round(parseInt(String(p),10)):null;if(r){let t={recording_url:u,duration_seconds:e,status:"completed",updated_at:new Date().toISOString()};v&&(t.has_live_translation=!0,t.live_translation_provider="signalwire");let{error:a}=await d.default.from("recordings").update(t).eq("id",r.id);a?console.error("signalwire webhook: failed to update recording",{error:a.message,recordingId:r.id}):(console.log("signalwire webhook: updated recording",{recordingId:r.id}),await f(S,r.id,b,s))}else{let r=(0,l.Z)(),a={id:r,organization_id:b,call_sid:o,recording_sid:s,recording_url:u,duration_seconds:e,status:"completed",tool_id:i,created_at:new Date().toISOString(),updated_at:new Date().toISOString()};v&&(a.has_live_translation=!0,a.live_translation_provider="signalwire");let{error:n}=await d.default.from("recordings").insert(a);if(n)console.error("signalwire webhook: failed to create recording",{error:n.message,callId:S});else{console.log("signalwire webhook: created recording",{recordingId:r,callId:S});try{await d.default.from("audit_logs").insert({id:(0,l.Z)(),organization_id:b,user_id:null,system_id:null,resource_type:"recordings",resource_id:r,action:"create",before:null,after:{call_id:S,recording_sid:s,recording_url:u},created_at:new Date().toISOString()})}catch(e){}(async()=>{try{let{storeRecording:e,ensureRecordingsBucket:a}=await t.e(973).then(t.bind(t,92973));await a(),await e(u,b,S,r)}catch(e){console.error("signalwire webhook: failed to store recording",{error:e,recordingId:r})}})(),await f(S,r,b,s)}}}else console.warn("signalwire webhook: organization has no tool_id, cannot create recording",{organizationId:b})}}catch(e){console.error("signalwire webhook processing error",{error:e?.message??String(e)})}}async function f(e,r,t,a){try{let{data:a}=await d.default.from("voice_configs").select("transcribe").eq("organization_id",t).limit(1);if(a?.[0]?.transcribe!==!0)return;let{data:i}=await d.default.from("ai_runs").select("id, status").eq("call_id",e).eq("model","assemblyai-v1").limit(1);if(i&&i.length>0&&"failed"!==i[0].status)return;let{data:o}=await d.default.from("systems").select("id").eq("key","system-ai").limit(1),n=o?.[0]?.id;if(!n){console.warn("signalwire webhook: AI system not found, cannot trigger transcription",{callId:e});return}let{data:s}=await d.default.from("recordings").select("recording_url").eq("id",r).limit(1),u=s?.[0]?.recording_url;if(!u){console.warn("signalwire webhook: recording URL not found",{recordingId:r});return}let{data:c}=await d.default.from("organizations").select("plan").eq("id",t).limit(1),g=c?.[0]?.plan;if("free"===g)return;if(!process.env.ASSEMBLYAI_API_KEY){console.warn("signalwire webhook: ASSEMBLYAI_API_KEY not configured");return}let p=(0,l.Z)(),{error:f}=await d.default.from("ai_runs").insert({id:p,call_id:e,system_id:n,model:"assemblyai-v1",status:"queued",started_at:new Date().toISOString()});if(f){console.error("signalwire webhook: failed to create ai_run",{error:f.message,callId:e});return}let m=await fetch("https://api.assemblyai.com/v2/transcript",{method:"POST",headers:{Authorization:process.env.ASSEMBLYAI_API_KEY,"Content-Type":"application/json"},body:JSON.stringify({audio_url:u,webhook_url:"https://voxsouth.online/api/webhooks/assemblyai"})});if(m.ok){let e=await m.json();await d.default.from("ai_runs").update({status:"processing",output:{job_id:e.id,status:"queued"}}).eq("id",p),console.log("signalwire webhook: triggered AssemblyAI transcription",{aiRunId:p,jobId:e.id})}else{let e=await m.text();console.error("signalwire webhook: AssemblyAI API error",{status:m.status,error:e,recordingId:r}),await d.default.from("ai_runs").update({status:"failed",output:{error:e,status_code:m.status}}).eq("id",p)}}catch(r){console.error("signalwire webhook: transcription trigger error",{error:r?.message,callId:e})}}let m=new i.AppRouteRouteModule({definition:{kind:o.x.APP_ROUTE,page:"/api/webhooks/signalwire/route",pathname:"/api/webhooks/signalwire",filename:"route",bundlePath:"app/api/webhooks/signalwire/route"},resolvedPagePath:"C:\\Users\\Ultimate Warrior\\My project\\gemini-project\\app\\api\\webhooks\\signalwire\\route.ts",nextConfigOutput:"",userland:a}),{requestAsyncStorage:w,staticGenerationAsyncStorage:_,serverHooks:h}=m,S="/api/webhooks/signalwire/route";function b(){return(0,n.patchFetch)({serverHooks:h,staticGenerationAsyncStorage:_})}},70332:(e,r,t)=>{t.d(r,{Au:()=>o,PF:()=>i});let a=[{name:"SIGNALWIRE_PROJECT_ID",required:!0,description:"SignalWire project ID for call execution",validate:e=>e.length>0||"Must not be empty"},{name:"SIGNALWIRE_TOKEN",required:!0,description:"SignalWire API token",validate:e=>e.length>0||"Must not be empty"},{name:"SIGNALWIRE_SPACE",required:!0,description:"SignalWire space URL",validate:e=>e.includes("signalwire.com")||"Must be a valid SignalWire space URL"},{name:"ASSEMBLYAI_API_KEY",required:!0,description:"AssemblyAI API key for transcription",validate:e=>e.length>0||"Must not be empty"},{name:"NEXT_PUBLIC_SUPABASE_URL",required:!0,description:"Supabase project URL",validate:e=>e.startsWith("https://")||"Must be a valid HTTPS URL"},{name:"NEXT_PUBLIC_SUPABASE_ANON_KEY",required:!0,description:"Supabase anonymous key",validate:e=>e.length>0||"Must not be empty"},{name:"SUPABASE_SERVICE_ROLE_KEY",required:!0,description:"Supabase service role key (server-side only)",validate:e=>e.length>0||"Must not be empty"},{name:"NEXT_PUBLIC_APP_URL",required:!0,description:"Public application URL for webhooks",validate:e=>e.startsWith("https://")||e.startsWith("http://localhost")||"Must be a valid URL"},{name:"NEXTAUTH_SECRET",required:!0,description:"NextAuth secret for session encryption",validate:e=>e.length>=32||"Must be at least 32 characters"},{name:"OPENAI_API_KEY",required:!1,description:"OpenAI API key for translation (optional)",validate:e=>e.length>0||"Must not be empty if provided"},{name:"TRANSLATION_LIVE_ASSIST_PREVIEW",required:!1,description:"Enable live translation preview feature (SignalWire AI Agents)",validate:e=>"true"===e||"false"===e||'Must be "true" or "false"'}];function i(){let e=[],r=[];for(let t of a){let a=process.env[t.name];if(a){if(t.validate){let i=t.validate(a);if(!0!==i){let a="string"==typeof i?i:"Invalid value";t.required?e.push({name:t.name,message:`${t.description}: ${a}`}):r.push({name:t.name,message:`${t.description}: ${a}`})}}}else t.required?e.push({name:t.name,message:`Required environment variable missing: ${t.description}`}):r.push({name:t.name,message:`Optional environment variable not set: ${t.description}`})}return{valid:0===e.length,errors:e,warnings:r}}function o(){return"true"===process.env.TRANSLATION_LIVE_ASSIST_PREVIEW}},62632:(e,r,t)=>{t.r(r),t.d(r,{default:()=>a});let a={from:e=>({insert:async e=>({data:[e],error:null}),update:async e=>({data:[e],error:null}),select:r=>(function(e,r){let t={_table:e,_cols:r,eq:(e,r)=>t,in:(e,r)=>t,limit:e=>t,order:(e,r)=>t,single:async()=>({data:null,error:null})};return t.then=(e,r)=>Promise.resolve({data:null,error:null}).then(e,r),t.catch=e=>Promise.resolve({data:null,error:null}).catch(e),t})(e,r),in:(e,r)=>({data:null,error:null})})}},90511:(e,r,t)=>{t.d(r,{Fj:()=>n,V8:()=>o});var a=t(84770),i=t.n(a);function o(e,r,t){try{let a=i().createHmac("sha256",t).update(e).digest("hex");return i().timingSafeEqual(Buffer.from(r),Buffer.from(a))}catch(e){return!1}}function n(e,r,t){try{let a=i().createHmac("sha256",t).update(e).digest("hex");return i().timingSafeEqual(Buffer.from(r),Buffer.from(a))}catch(e){return!1}}},6649:(e,r,t)=>{t.d(r,{Z:()=>s});var a=t(84770),i=t.n(a);let o=new Uint8Array(256),n=o.length;function s(){return n>o.length-16&&(i().randomFillSync(o),n=0),o.slice(n,n+=16)}},16099:(e,r,t)=>{t.d(r,{Z:()=>o});var a=t(30900);let i=[];for(let e=0;e<256;++e)i.push((e+256).toString(16).substr(1));let o=function(e,r=0){let t=(i[e[r+0]]+i[e[r+1]]+i[e[r+2]]+i[e[r+3]]+"-"+i[e[r+4]]+i[e[r+5]]+"-"+i[e[r+6]]+i[e[r+7]]+"-"+i[e[r+8]]+i[e[r+9]]+"-"+i[e[r+10]]+i[e[r+11]]+i[e[r+12]]+i[e[r+13]]+i[e[r+14]]+i[e[r+15]]).toLowerCase();if(!(0,a.Z)(t))throw TypeError("Stringified UUID is invalid");return t}},79843:(e,r,t)=>{t.d(r,{Z:()=>o});var a=t(6649),i=t(16099);let o=function(e,r,t){let o=(e=e||{}).random||(e.rng||a.Z)();if(o[6]=15&o[6]|64,o[8]=63&o[8]|128,r){t=t||0;for(let e=0;e<16;++e)r[t+e]=o[e];return r}return(0,i.Z)(o)}},30900:(e,r,t)=>{t.d(r,{Z:()=>i});let a=/^(?:[0-9a-f]{8}-[0-9a-f]{4}-[1-5][0-9a-f]{3}-[89ab][0-9a-f]{3}-[0-9a-f]{12}|00000000-0000-0000-0000-000000000000)$/i,i=function(e){return"string"==typeof e&&a.test(e)}}};var r=require("../../../../webpack-runtime.js");r.C(e);var t=e=>r(r.s=e),a=r.X(0,[276,972],()=>t(47868));module.exports=a})();