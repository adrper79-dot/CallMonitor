"use strict";(()=>{var e={};e.id=627,e.ids=[627],e.modules={20399:e=>{e.exports=require("next/dist/compiled/next-server/app-page.runtime.prod.js")},30517:e=>{e.exports=require("next/dist/compiled/next-server/app-route.runtime.prod.js")},84770:e=>{e.exports=require("crypto")},47868:(e,r,t)=>{t.r(r),t.d(r,{originalPathname:()=>_,patchFetch:()=>b,requestAsyncStorage:()=>p,routeModule:()=>w,serverHooks:()=>h,staticGenerationAsyncStorage:()=>m});var a={};t.r(a),t.d(a,{POST:()=>u});var i=t(49303),o=t(88716),n=t(60670),s=t(87070),l=t(79843),d=t(62632),c=t(90511);async function u(e){let r=process.env.SIGNALWIRE_TOKEN;if(r){let t=e.headers.get("X-SignalWire-Signature")||e.headers.get("X-Signature")||e.headers.get("Signature");if(!t)return console.warn("signalwire webhook: signature header missing in production"),s.NextResponse.json({success:!1,error:{code:"WEBHOOK_SIGNATURE_MISSING",message:"Webhook signature required"}},{status:401});{let a=await e.text();if(!(0,c.V8)(a,t,r))return console.error("signalwire webhook: invalid signature",{signature:t.substring(0,10)+"..."}),s.NextResponse.json({success:!1,error:{code:"WEBHOOK_SIGNATURE_INVALID",message:"Invalid webhook signature"}},{status:401});e=new Request(e.url,{method:e.method,headers:e.headers,body:a})}}return g(e).catch(e=>{console.error("signalwire webhook async processing error",{error:e?.message??String(e)})}),s.NextResponse.json({ok:!0,received:!0})}async function g(e){try{let a=e.headers.get("content-type")||"",i=null;if(a.includes("application/x-www-form-urlencoded")){var r;r=await e.text(),i=Object.fromEntries(new URLSearchParams(r))}else try{i=await e.json()}catch(r){i=await e.text()}let o=i.CallSid||i.CallSid||i.call_sid,n=i.CallStatus||i.call_status,s=i.RecordingSid||i.RecordingSid||i.recording_sid,c=i.RecordingUrl||i.RecordingUrl||i.recording_url,u=i.RecordingDuration||i.RecordingDuration||i.recording_duration,g=i.CallDuration||i.CallDuration||i.call_duration,w=i.EventType||i.event_type||(s?"recording":"call");if(console.log("signalwire webhook processing",{callSid:o?"[REDACTED]":null,callStatus:n,eventType:w,hasRecording:!!s}),!o){console.warn("signalwire webhook: missing CallSid, skipping");return}let{data:p,error:m}=await d.default.from("calls").select("id, organization_id, status, started_at, ended_at").eq("call_sid",o).limit(1);if(m){console.error("signalwire webhook: failed to find call",{error:m.message,callSid:"[REDACTED]"});return}let h=p?.[0];if(!h){console.warn("signalwire webhook: call not found",{callSid:"[REDACTED]"});return}let _=h.id,b=h.organization_id;if("call"===w||n){let e={completed:"completed",failed:"failed","no-answer":"failed",busy:"failed",ringing:"in_progress","in-progress":"in_progress",queued:"pending"}[n?.toLowerCase()]||n||"unknown",r={status:e};("completed"===e||"failed"===e)&&(r.ended_at=new Date().toISOString()),"in_progress"!==e&&"completed"!==e||h.started_at||(r.started_at=new Date().toISOString());let{error:t}=await d.default.from("calls").update(r).eq("id",_);t?console.error("signalwire webhook: failed to update call",{error:t.message,callId:_}):console.log("signalwire webhook: updated call status",{callId:_,status:e})}if(s&&c){let{data:e}=await d.default.from("recordings").select("id, status").eq("recording_sid",s).limit(1),r=e?.[0],{data:a}=await d.default.from("organizations").select("tool_id").eq("id",b).limit(1),i=a?.[0]?.tool_id;if(i){let e=u?Math.round(parseInt(String(u),10)/1e3):g?Math.round(parseInt(String(g),10)):null;if(r){let{error:t}=await d.default.from("recordings").update({recording_url:c,duration_seconds:e,status:"completed",updated_at:new Date().toISOString()}).eq("id",r.id);t?console.error("signalwire webhook: failed to update recording",{error:t.message,recordingId:r.id}):(console.log("signalwire webhook: updated recording",{recordingId:r.id}),await f(_,r.id,b,s))}else{let r=(0,l.Z)(),{error:a}=await d.default.from("recordings").insert({id:r,organization_id:b,call_sid:o,recording_sid:s,recording_url:c,duration_seconds:e,status:"completed",tool_id:i,created_at:new Date().toISOString(),updated_at:new Date().toISOString()});if(a)console.error("signalwire webhook: failed to create recording",{error:a.message,callId:_});else{console.log("signalwire webhook: created recording",{recordingId:r,callId:_});try{await d.default.from("audit_logs").insert({id:(0,l.Z)(),organization_id:b,user_id:null,system_id:null,resource_type:"recordings",resource_id:r,action:"create",before:null,after:{call_id:_,recording_sid:s,recording_url:c},created_at:new Date().toISOString()})}catch(e){}(async()=>{try{let{storeRecording:e,ensureRecordingsBucket:a}=await t.e(973).then(t.bind(t,92973));await a(),await e(c,b,_,r)}catch(e){console.error("signalwire webhook: failed to store recording",{error:e,recordingId:r})}})(),await f(_,r,b,s)}}}else console.warn("signalwire webhook: organization has no tool_id, cannot create recording",{organizationId:b})}}catch(e){console.error("signalwire webhook processing error",{error:e?.message??String(e)})}}async function f(e,r,t,a){try{let{data:a}=await d.default.from("voice_configs").select("transcribe").eq("organization_id",t).limit(1);if(a?.[0]?.transcribe!==!0)return;let{data:i}=await d.default.from("ai_runs").select("id, status").eq("call_id",e).eq("model","assemblyai-v1").limit(1);if(i&&i.length>0&&"failed"!==i[0].status)return;let{data:o}=await d.default.from("systems").select("id").eq("key","system-ai").limit(1),n=o?.[0]?.id;if(!n){console.warn("signalwire webhook: AI system not found, cannot trigger transcription",{callId:e});return}let{data:s}=await d.default.from("recordings").select("recording_url").eq("id",r).limit(1),c=s?.[0]?.recording_url;if(!c){console.warn("signalwire webhook: recording URL not found",{recordingId:r});return}let{data:u}=await d.default.from("organizations").select("plan").eq("id",t).limit(1),g=u?.[0]?.plan;if("free"===g)return;if(!process.env.ASSEMBLYAI_API_KEY){console.warn("signalwire webhook: ASSEMBLYAI_API_KEY not configured");return}let f=(0,l.Z)(),{error:w}=await d.default.from("ai_runs").insert({id:f,call_id:e,system_id:n,model:"assemblyai-v1",status:"queued",started_at:new Date().toISOString()});if(w){console.error("signalwire webhook: failed to create ai_run",{error:w.message,callId:e});return}let p=await fetch("https://api.assemblyai.com/v2/transcript",{method:"POST",headers:{Authorization:process.env.ASSEMBLYAI_API_KEY,"Content-Type":"application/json"},body:JSON.stringify({audio_url:c,webhook_url:"https://voxsouth.online/api/webhooks/assemblyai"})});if(p.ok){let e=await p.json();await d.default.from("ai_runs").update({status:"processing",output:{job_id:e.id,status:"queued"}}).eq("id",f),console.log("signalwire webhook: triggered AssemblyAI transcription",{aiRunId:f,jobId:e.id})}else{let e=await p.text();console.error("signalwire webhook: AssemblyAI API error",{status:p.status,error:e,recordingId:r}),await d.default.from("ai_runs").update({status:"failed",output:{error:e,status_code:p.status}}).eq("id",f)}}catch(r){console.error("signalwire webhook: transcription trigger error",{error:r?.message,callId:e})}}let w=new i.AppRouteRouteModule({definition:{kind:o.x.APP_ROUTE,page:"/api/webhooks/signalwire/route",pathname:"/api/webhooks/signalwire",filename:"route",bundlePath:"app/api/webhooks/signalwire/route"},resolvedPagePath:"C:\\Users\\Ultimate Warrior\\My project\\gemini-project\\app\\api\\webhooks\\signalwire\\route.ts",nextConfigOutput:"",userland:a}),{requestAsyncStorage:p,staticGenerationAsyncStorage:m,serverHooks:h}=w,_="/api/webhooks/signalwire/route";function b(){return(0,n.patchFetch)({serverHooks:h,staticGenerationAsyncStorage:m})}},62632:(e,r,t)=>{t.r(r),t.d(r,{default:()=>a});let a={from:e=>({insert:async e=>({data:[e],error:null}),update:async e=>({data:[e],error:null}),select:r=>(function(e,r){let t={_table:e,_cols:r,eq:(e,r)=>t,in:(e,r)=>t,limit:e=>t,order:(e,r)=>t,single:async()=>({data:null,error:null})};return t.then=(e,r)=>Promise.resolve({data:null,error:null}).then(e,r),t.catch=e=>Promise.resolve({data:null,error:null}).catch(e),t})(e,r),in:(e,r)=>({data:null,error:null})})}},90511:(e,r,t)=>{t.d(r,{Fj:()=>n,V8:()=>o});var a=t(84770),i=t.n(a);function o(e,r,t){try{let a=i().createHmac("sha256",t).update(e).digest("hex");return i().timingSafeEqual(Buffer.from(r),Buffer.from(a))}catch(e){return!1}}function n(e,r,t){try{let a=i().createHmac("sha256",t).update(e).digest("hex");return i().timingSafeEqual(Buffer.from(r),Buffer.from(a))}catch(e){return!1}}},6649:(e,r,t)=>{t.d(r,{Z:()=>s});var a=t(84770),i=t.n(a);let o=new Uint8Array(256),n=o.length;function s(){return n>o.length-16&&(i().randomFillSync(o),n=0),o.slice(n,n+=16)}},16099:(e,r,t)=>{t.d(r,{Z:()=>o});var a=t(30900);let i=[];for(let e=0;e<256;++e)i.push((e+256).toString(16).substr(1));let o=function(e,r=0){let t=(i[e[r+0]]+i[e[r+1]]+i[e[r+2]]+i[e[r+3]]+"-"+i[e[r+4]]+i[e[r+5]]+"-"+i[e[r+6]]+i[e[r+7]]+"-"+i[e[r+8]]+i[e[r+9]]+"-"+i[e[r+10]]+i[e[r+11]]+i[e[r+12]]+i[e[r+13]]+i[e[r+14]]+i[e[r+15]]).toLowerCase();if(!(0,a.Z)(t))throw TypeError("Stringified UUID is invalid");return t}},79843:(e,r,t)=>{t.d(r,{Z:()=>o});var a=t(6649),i=t(16099);let o=function(e,r,t){let o=(e=e||{}).random||(e.rng||a.Z)();if(o[6]=15&o[6]|64,o[8]=63&o[8]|128,r){t=t||0;for(let e=0;e<16;++e)r[t+e]=o[e];return r}return(0,i.Z)(o)}},30900:(e,r,t)=>{t.d(r,{Z:()=>i});let a=/^(?:[0-9a-f]{8}-[0-9a-f]{4}-[1-5][0-9a-f]{3}-[89ab][0-9a-f]{3}-[0-9a-f]{12}|00000000-0000-0000-0000-000000000000)$/i,i=function(e){return"string"==typeof e&&a.test(e)}}};var r=require("../../../../webpack-runtime.js");r.C(e);var t=e=>r(r.s=e),a=r.X(0,[276,972],()=>t(47868));module.exports=a})();