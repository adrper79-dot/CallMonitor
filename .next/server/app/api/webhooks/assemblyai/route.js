"use strict";(()=>{var e={};e.id=687,e.ids=[687],e.modules={20399:e=>{e.exports=require("next/dist/compiled/next-server/app-page.runtime.prod.js")},30517:e=>{e.exports=require("next/dist/compiled/next-server/app-route.runtime.prod.js")},84770:e=>{e.exports=require("crypto")},47714:(e,t,a)=>{a.r(t),a.d(t,{originalPathname:()=>v,patchFetch:()=>k,requestAsyncStorage:()=>h,routeModule:()=>y,serverHooks:()=>b,staticGenerationAsyncStorage:()=>w});var r={};a.r(r),a.d(r,{POST:()=>c});var o=a(49303),s=a(88716),i=a(60670),n=a(87070),l=a(79843),u=a(62632),d=a(90511);async function c(e){let t=process.env.ASSEMBLYAI_API_KEY;if(t){let a=e.headers.get("X-AssemblyAI-Signature")||e.headers.get("X-Signature")||e.headers.get("Signature");if(!a)return console.warn("assemblyai webhook: signature header missing in production"),n.NextResponse.json({success:!1,error:{code:"WEBHOOK_SIGNATURE_MISSING",message:"Webhook signature required"}},{status:401});{let r=await e.text();if(!(0,d.Fj)(r,a,t))return console.error("assemblyai webhook: invalid signature",{signature:a.substring(0,10)+"..."}),n.NextResponse.json({success:!1,error:{code:"WEBHOOK_SIGNATURE_INVALID",message:"Invalid webhook signature"}},{status:401});e=new Request(e.url,{method:e.method,headers:e.headers,body:r})}}return f(e).catch(e=>{console.error("assemblyai webhook async processing error",{error:e?.message??String(e)})}),n.NextResponse.json({ok:!0,received:!0})}async function f(e){try{let t=await e.json(),r=t.transcript_id,o=t.status,s=t.text,i=t.words,n=t.confidence;t.audio_url;let d=t.language_code||t.language_detection?.language_code;if(console.log("assemblyai webhook processing",{transcriptId:r?"[REDACTED]":null,status:o,hasText:!!s}),!r){console.warn("assemblyai webhook: missing transcript_id, skipping");return}if("completed"!==o){if("error"===o){console.error("assemblyai webhook: transcription failed",{transcriptId:"[REDACTED]",error:t.error});let{data:e}=await u.default.from("ai_runs").select("id, call_id").eq("model","assemblyai-v1").contains("output",{job_id:r}).limit(1);e&&e.length>0&&await u.default.from("ai_runs").update({status:"failed",completed_at:new Date().toISOString(),output:{...e[0].output,error:t.error,status:"error"}}).eq("id",e[0].id)}return}let{data:c,error:f}=await u.default.from("ai_runs").select("id, call_id, output").eq("model","assemblyai-v1").contains("output",{job_id:r}).limit(1);if(f){console.error("assemblyai webhook: failed to find ai_run",{error:f.message,transcriptId:"[REDACTED]"});return}let _=c?.[0];if(!_){console.warn("assemblyai webhook: ai_run not found",{transcriptId:"[REDACTED]"});return}let y=_.id,h=_.call_id,{data:w,error:b}=await u.default.from("recordings").select("id, organization_id, call_sid").eq("call_sid",await p(h)||"").limit(1);(b||!w||0===w.length)&&console.warn("assemblyai webhook: recording not found for call",{callId:h});let v=w?.[0]?.id,k=w?.[0]?.organization_id,S={text:s,words:i||[],confidence:n||null,transcript_id:r,language_code:d||null,completed_at:new Date().toISOString()},{error:q}=await u.default.from("ai_runs").update({status:"completed",completed_at:new Date().toISOString(),output:{..."object"==typeof _.output?_.output:{},transcript:S,status:"completed"}}).eq("id",y);if(q)console.error("assemblyai webhook: failed to update ai_run",{error:q.message,aiRunId:y});else{console.log("assemblyai webhook: updated ai_run",{aiRunId:y,callId:h});try{await u.default.from("audit_logs").insert({id:(0,l.Z)(),organization_id:k||null,user_id:null,system_id:null,resource_type:"ai_runs",resource_id:y,action:"update",before:{status:"queued"},after:{status:"completed",transcript_id:r},created_at:new Date().toISOString()})}catch(e){}}if(v){let{error:e}=await u.default.from("recordings").update({transcript_json:S,updated_at:new Date().toISOString()}).eq("id",v);if(e?console.error("assemblyai webhook: failed to update recording",{error:e.message,recordingId:v}):console.log("assemblyai webhook: updated recording transcript",{recordingId:v}),k&&await m(h,k,s,d),k&&await g(h,k,s,v),k&&v){let{checkAndGenerateManifest:e}=await a.e(228).then(a.bind(a,98228));await e(h,v,k)}}}catch(e){console.error("assemblyai webhook processing error",{error:e?.message??String(e)})}}async function p(e){let{data:t}=await u.default.from("calls").select("call_sid").eq("id",e).limit(1);return t?.[0]?.call_sid||null}async function m(e,t,r,o){try{let{data:s}=await u.default.from("voice_configs").select("translate, translate_from, translate_to").eq("organization_id",t).limit(1),i=s?.[0];if(!i?.translate)return;let n=i.translate_from,d=i.translate_to,{data:c}=await u.default.from("calls").select("id, flow_type").eq("id",e).limit(1),f=c?.[0]?.flow_type==="bridge";if(f){o&&(n=o);let{data:t}=await u.default.from("recordings").select("id, transcript_json").eq("call_id",e);if(t&&t.length>=2){let a=t.find(e=>e.transcript_json?.language_code!==o);if(a?.transcript_json?.language_code)d=a.transcript_json.language_code;else if("auto"===d){console.log("translation: waiting for other leg transcript to detect language",{callId:e});return}}else if("auto"===d){console.log("translation: waiting for both bridge legs to complete",{callId:e});return}}else if("auto"===n&&o&&(n=o),"auto"===d){console.warn("translation: toLanguage cannot be auto for single-leg calls",{callId:e});return}if(!n||!d||"auto"===n||"auto"===d){console.log("translation: language detection incomplete",{callId:e,fromLanguage:n,toLanguage:d,detectedLanguage:o});return}let{data:p}=await u.default.from("systems").select("id").eq("key","system-ai").limit(1),m=p?.[0]?.id;if(!m)return;let g=(0,l.Z)();await u.default.from("ai_runs").insert({id:g,call_id:e,system_id:m,model:"assemblyai-translation",status:"queued",started_at:new Date().toISOString(),output:{from_language:n,to_language:d,source_text:r,detected_language:o,bridge_call:f}});let{translateText:_}=await a.e(569).then(a.bind(a,47569));await _({callId:e,translationRunId:g,text:r,fromLanguage:n,toLanguage:d,organizationId:t})}catch(t){console.error("assemblyai webhook: translation trigger error",{error:t?.message,callId:e})}}async function g(e,t,a,r){try{let{data:o}=await u.default.from("voice_configs").select("survey").eq("organization_id",t).limit(1),s=o?.[0];if(!s?.survey)return;let{data:i}=await u.default.from("ai_runs").select("id, output").eq("call_id",e).eq("model","assemblyai-survey").eq("status","queued").limit(1);if(!i||0===i.length)return;let n=i[0],l=await _(a,n.output);await u.default.from("ai_runs").update({status:"completed",completed_at:new Date().toISOString(),output:{...n.output,transcript:a,survey_results:l,completed_at:new Date().toISOString()}}).eq("id",n.id),console.log("assemblyai webhook: survey processed",{surveyRunId:n.id,callId:e,recordingId:r})}catch(t){console.error("assemblyai webhook: survey processing error",{error:t?.message,callId:e})}}async function _(e,t){let a={responses:[],score:null,sentiment:null};if(t?.dtmf_response){let e=parseInt(t.dtmf_response,10);!isNaN(e)&&e>=1&&e<=5&&(a.responses.push({question:"satisfaction_rating",answer:e,type:"numeric"}),a.score=e)}let r=e.toLowerCase();if(r.includes("very satisfied")||r.includes("extremely happy")?a.sentiment="very_positive":r.includes("satisfied")||r.includes("happy")?a.sentiment="positive":r.includes("dissatisfied")||r.includes("unhappy")?a.sentiment="negative":a.sentiment="neutral",process.env.OPENAI_API_KEY)try{let t=await fetch("https://api.openai.com/v1/chat/completions",{method:"POST",headers:{Authorization:`Bearer ${process.env.OPENAI_API_KEY}`,"Content-Type":"application/json"},body:JSON.stringify({model:"gpt-3.5-turbo",messages:[{role:"system",content:"Extract survey responses from the following call transcript. Return a JSON object with satisfaction_rating (1-5), key_feedback (array of strings), and overall_sentiment (positive/neutral/negative)."},{role:"user",content:e}],temperature:.3,max_tokens:500})});if(t.ok){let e=await t.json(),r=e.choices?.[0]?.message?.content;if(r)try{let e=JSON.parse(r);e.satisfaction_rating&&(a.score=e.satisfaction_rating),e.key_feedback&&a.responses.push({question:"key_feedback",answer:e.key_feedback,type:"text"}),e.overall_sentiment&&(a.sentiment=e.overall_sentiment)}catch{}}}catch(e){}return a}let y=new o.AppRouteRouteModule({definition:{kind:s.x.APP_ROUTE,page:"/api/webhooks/assemblyai/route",pathname:"/api/webhooks/assemblyai",filename:"route",bundlePath:"app/api/webhooks/assemblyai/route"},resolvedPagePath:"C:\\Users\\Ultimate Warrior\\My project\\gemini-project\\app\\api\\webhooks\\assemblyai\\route.ts",nextConfigOutput:"",userland:r}),{requestAsyncStorage:h,staticGenerationAsyncStorage:w,serverHooks:b}=y,v="/api/webhooks/assemblyai/route";function k(){return(0,i.patchFetch)({serverHooks:b,staticGenerationAsyncStorage:w})}},62632:(e,t,a)=>{a.r(t),a.d(t,{default:()=>r});let r={from:e=>({insert:async e=>({data:[e],error:null}),update:async e=>({data:[e],error:null}),select:t=>(function(e,t){let a={_table:e,_cols:t,eq:(e,t)=>a,in:(e,t)=>a,limit:e=>a,order:(e,t)=>a,single:async()=>({data:null,error:null})};return a.then=(e,t)=>Promise.resolve({data:null,error:null}).then(e,t),a.catch=e=>Promise.resolve({data:null,error:null}).catch(e),a})(e,t),in:(e,t)=>({data:null,error:null})})}},90511:(e,t,a)=>{a.d(t,{Fj:()=>i,V8:()=>s});var r=a(84770),o=a.n(r);function s(e,t,a){try{let r=o().createHmac("sha256",a).update(e).digest("hex");return o().timingSafeEqual(Buffer.from(t),Buffer.from(r))}catch(e){return!1}}function i(e,t,a){try{let r=o().createHmac("sha256",a).update(e).digest("hex");return o().timingSafeEqual(Buffer.from(t),Buffer.from(r))}catch(e){return!1}}},6649:(e,t,a)=>{a.d(t,{Z:()=>n});var r=a(84770),o=a.n(r);let s=new Uint8Array(256),i=s.length;function n(){return i>s.length-16&&(o().randomFillSync(s),i=0),s.slice(i,i+=16)}},16099:(e,t,a)=>{a.d(t,{Z:()=>s});var r=a(30900);let o=[];for(let e=0;e<256;++e)o.push((e+256).toString(16).substr(1));let s=function(e,t=0){let a=(o[e[t+0]]+o[e[t+1]]+o[e[t+2]]+o[e[t+3]]+"-"+o[e[t+4]]+o[e[t+5]]+"-"+o[e[t+6]]+o[e[t+7]]+"-"+o[e[t+8]]+o[e[t+9]]+"-"+o[e[t+10]]+o[e[t+11]]+o[e[t+12]]+o[e[t+13]]+o[e[t+14]]+o[e[t+15]]).toLowerCase();if(!(0,r.Z)(a))throw TypeError("Stringified UUID is invalid");return a}},79843:(e,t,a)=>{a.d(t,{Z:()=>s});var r=a(6649),o=a(16099);let s=function(e,t,a){let s=(e=e||{}).random||(e.rng||r.Z)();if(s[6]=15&s[6]|64,s[8]=63&s[8]|128,t){a=a||0;for(let e=0;e<16;++e)t[a+e]=s[e];return t}return(0,o.Z)(s)}},30900:(e,t,a)=>{a.d(t,{Z:()=>o});let r=/^(?:[0-9a-f]{8}-[0-9a-f]{4}-[1-5][0-9a-f]{3}-[89ab][0-9a-f]{3}-[0-9a-f]{12}|00000000-0000-0000-0000-000000000000)$/i,o=function(e){return"string"==typeof e&&r.test(e)}}};var t=require("../../../../webpack-runtime.js");t.C(e);var a=e=>t(t.s=e),r=t.X(0,[276,972],()=>a(47714));module.exports=r})();