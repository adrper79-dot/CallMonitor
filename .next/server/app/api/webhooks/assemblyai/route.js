"use strict";(()=>{var e={};e.id=687,e.ids=[687],e.modules={20399:e=>{e.exports=require("next/dist/compiled/next-server/app-page.runtime.prod.js")},30517:e=>{e.exports=require("next/dist/compiled/next-server/app-route.runtime.prod.js")},84770:e=>{e.exports=require("crypto")},47714:(e,t,r)=>{r.r(t),r.d(t,{originalPathname:()=>v,patchFetch:()=>k,requestAsyncStorage:()=>h,routeModule:()=>y,serverHooks:()=>b,staticGenerationAsyncStorage:()=>w});var a={};r.r(a),r.d(a,{POST:()=>c});var s=r(49303),o=r(88716),i=r(60670),n=r(87070),l=r(79843),u=r(62632),d=r(90511);async function c(e){let t=process.env.ASSEMBLYAI_API_KEY;if(t){let r=e.headers.get("X-AssemblyAI-Signature")||e.headers.get("X-Signature")||e.headers.get("Signature");if(!r)return console.warn("assemblyai webhook: signature header missing in production"),n.NextResponse.json({success:!1,error:{code:"WEBHOOK_SIGNATURE_MISSING",message:"Webhook signature required"}},{status:401});{let a=await e.text();if(!(0,d.Fj)(a,r,t))return console.error("assemblyai webhook: invalid signature",{signature:r.substring(0,10)+"..."}),n.NextResponse.json({success:!1,error:{code:"WEBHOOK_SIGNATURE_INVALID",message:"Invalid webhook signature"}},{status:401});e=new Request(e.url,{method:e.method,headers:e.headers,body:a})}}return m(e).catch(e=>{console.error("assemblyai webhook async processing error",{error:e?.message??String(e)})}),n.NextResponse.json({ok:!0,received:!0})}async function m(e){try{let t=await e.json(),a=t.transcript_id,s=t.status,o=t.text,i=t.words,n=t.confidence;if(t.audio_url,console.log("assemblyai webhook processing",{transcriptId:a?"[REDACTED]":null,status:s,hasText:!!o}),!a){console.warn("assemblyai webhook: missing transcript_id, skipping");return}if("completed"!==s){if("error"===s){console.error("assemblyai webhook: transcription failed",{transcriptId:"[REDACTED]",error:t.error});let{data:e}=await u.default.from("ai_runs").select("id, call_id").eq("model","assemblyai-v1").contains("output",{job_id:a}).limit(1);e&&e.length>0&&await u.default.from("ai_runs").update({status:"failed",completed_at:new Date().toISOString(),output:{...e[0].output,error:t.error,status:"error"}}).eq("id",e[0].id)}return}let{data:d,error:c}=await u.default.from("ai_runs").select("id, call_id, output").eq("model","assemblyai-v1").contains("output",{job_id:a}).limit(1);if(c){console.error("assemblyai webhook: failed to find ai_run",{error:c.message,transcriptId:"[REDACTED]"});return}let m=d?.[0];if(!m){console.warn("assemblyai webhook: ai_run not found",{transcriptId:"[REDACTED]"});return}let _=m.id,y=m.call_id,{data:h,error:w}=await u.default.from("recordings").select("id, organization_id, call_sid").eq("call_sid",await p(y)||"").limit(1);(w||!h||0===h.length)&&console.warn("assemblyai webhook: recording not found for call",{callId:y});let b=h?.[0]?.id,v=h?.[0]?.organization_id,k={text:o,words:i||[],confidence:n||null,transcript_id:a,completed_at:new Date().toISOString()},{error:S}=await u.default.from("ai_runs").update({status:"completed",completed_at:new Date().toISOString(),output:{..."object"==typeof m.output?m.output:{},transcript:k,status:"completed"}}).eq("id",_);if(S)console.error("assemblyai webhook: failed to update ai_run",{error:S.message,aiRunId:_});else{console.log("assemblyai webhook: updated ai_run",{aiRunId:_,callId:y});try{await u.default.from("audit_logs").insert({id:(0,l.Z)(),organization_id:v||null,user_id:null,system_id:null,resource_type:"ai_runs",resource_id:_,action:"update",before:{status:"queued"},after:{status:"completed",transcript_id:a},created_at:new Date().toISOString()})}catch(e){}}if(b){let{error:e}=await u.default.from("recordings").update({transcript_json:k,updated_at:new Date().toISOString()}).eq("id",b);if(e?console.error("assemblyai webhook: failed to update recording",{error:e.message,recordingId:b}):console.log("assemblyai webhook: updated recording transcript",{recordingId:b}),v&&await f(y,v,o),v&&await g(y,v,o,b),v&&b){let{checkAndGenerateManifest:e}=await r.e(228).then(r.bind(r,98228));await e(y,b,v)}}}catch(e){console.error("assemblyai webhook processing error",{error:e?.message??String(e)})}}async function p(e){let{data:t}=await u.default.from("calls").select("call_sid").eq("id",e).limit(1);return t?.[0]?.call_sid||null}async function f(e,t,a){try{let{data:s}=await u.default.from("voice_configs").select("translate, translate_from, translate_to").eq("organization_id",t).limit(1),o=s?.[0];if(!o?.translate||!o.translate_from||!o.translate_to)return;let{data:i}=await u.default.from("systems").select("id").eq("key","system-ai").limit(1),n=i?.[0]?.id;if(!n)return;let d=(0,l.Z)();await u.default.from("ai_runs").insert({id:d,call_id:e,system_id:n,model:"assemblyai-translation",status:"queued",started_at:new Date().toISOString(),output:{from_language:o.translate_from,to_language:o.translate_to,source_text:a}});let{translateText:c}=await r.e(569).then(r.bind(r,47569));await c({callId:e,translationRunId:d,text:a,fromLanguage:o.translate_from,toLanguage:o.translate_to,organizationId:t})}catch(t){console.error("assemblyai webhook: translation trigger error",{error:t?.message,callId:e})}}async function g(e,t,r,a){try{let{data:s}=await u.default.from("voice_configs").select("survey").eq("organization_id",t).limit(1),o=s?.[0];if(!o?.survey)return;let{data:i}=await u.default.from("ai_runs").select("id, output").eq("call_id",e).eq("model","assemblyai-survey").eq("status","queued").limit(1);if(!i||0===i.length)return;let n=i[0],l=await _(r,n.output);await u.default.from("ai_runs").update({status:"completed",completed_at:new Date().toISOString(),output:{...n.output,transcript:r,survey_results:l,completed_at:new Date().toISOString()}}).eq("id",n.id),console.log("assemblyai webhook: survey processed",{surveyRunId:n.id,callId:e,recordingId:a})}catch(t){console.error("assemblyai webhook: survey processing error",{error:t?.message,callId:e})}}async function _(e,t){let r={responses:[],score:null,sentiment:null};if(t?.dtmf_response){let e=parseInt(t.dtmf_response,10);!isNaN(e)&&e>=1&&e<=5&&(r.responses.push({question:"satisfaction_rating",answer:e,type:"numeric"}),r.score=e)}let a=e.toLowerCase();if(a.includes("very satisfied")||a.includes("extremely happy")?r.sentiment="very_positive":a.includes("satisfied")||a.includes("happy")?r.sentiment="positive":a.includes("dissatisfied")||a.includes("unhappy")?r.sentiment="negative":r.sentiment="neutral",process.env.OPENAI_API_KEY)try{let t=await fetch("https://api.openai.com/v1/chat/completions",{method:"POST",headers:{Authorization:`Bearer ${process.env.OPENAI_API_KEY}`,"Content-Type":"application/json"},body:JSON.stringify({model:"gpt-3.5-turbo",messages:[{role:"system",content:"Extract survey responses from the following call transcript. Return a JSON object with satisfaction_rating (1-5), key_feedback (array of strings), and overall_sentiment (positive/neutral/negative)."},{role:"user",content:e}],temperature:.3,max_tokens:500})});if(t.ok){let e=await t.json(),a=e.choices?.[0]?.message?.content;if(a)try{let e=JSON.parse(a);e.satisfaction_rating&&(r.score=e.satisfaction_rating),e.key_feedback&&r.responses.push({question:"key_feedback",answer:e.key_feedback,type:"text"}),e.overall_sentiment&&(r.sentiment=e.overall_sentiment)}catch{}}}catch(e){}return r}let y=new s.AppRouteRouteModule({definition:{kind:o.x.APP_ROUTE,page:"/api/webhooks/assemblyai/route",pathname:"/api/webhooks/assemblyai",filename:"route",bundlePath:"app/api/webhooks/assemblyai/route"},resolvedPagePath:"C:\\Users\\Ultimate Warrior\\My project\\gemini-project\\app\\api\\webhooks\\assemblyai\\route.ts",nextConfigOutput:"",userland:a}),{requestAsyncStorage:h,staticGenerationAsyncStorage:w,serverHooks:b}=y,v="/api/webhooks/assemblyai/route";function k(){return(0,i.patchFetch)({serverHooks:b,staticGenerationAsyncStorage:w})}},62632:(e,t,r)=>{r.r(t),r.d(t,{default:()=>a});let a={from:e=>({insert:async e=>({data:[e],error:null}),update:async e=>({data:[e],error:null}),select:t=>(function(e,t){let r={_table:e,_cols:t,eq:(e,t)=>r,in:(e,t)=>r,limit:e=>r,order:(e,t)=>r,single:async()=>({data:null,error:null})};return r.then=(e,t)=>Promise.resolve({data:null,error:null}).then(e,t),r.catch=e=>Promise.resolve({data:null,error:null}).catch(e),r})(e,t),in:(e,t)=>({data:null,error:null})})}},90511:(e,t,r)=>{r.d(t,{Fj:()=>i,V8:()=>o});var a=r(84770),s=r.n(a);function o(e,t,r){try{let a=s().createHmac("sha256",r).update(e).digest("hex");return s().timingSafeEqual(Buffer.from(t),Buffer.from(a))}catch(e){return!1}}function i(e,t,r){try{let a=s().createHmac("sha256",r).update(e).digest("hex");return s().timingSafeEqual(Buffer.from(t),Buffer.from(a))}catch(e){return!1}}},6649:(e,t,r)=>{r.d(t,{Z:()=>n});var a=r(84770),s=r.n(a);let o=new Uint8Array(256),i=o.length;function n(){return i>o.length-16&&(s().randomFillSync(o),i=0),o.slice(i,i+=16)}},16099:(e,t,r)=>{r.d(t,{Z:()=>o});var a=r(30900);let s=[];for(let e=0;e<256;++e)s.push((e+256).toString(16).substr(1));let o=function(e,t=0){let r=(s[e[t+0]]+s[e[t+1]]+s[e[t+2]]+s[e[t+3]]+"-"+s[e[t+4]]+s[e[t+5]]+"-"+s[e[t+6]]+s[e[t+7]]+"-"+s[e[t+8]]+s[e[t+9]]+"-"+s[e[t+10]]+s[e[t+11]]+s[e[t+12]]+s[e[t+13]]+s[e[t+14]]+s[e[t+15]]).toLowerCase();if(!(0,a.Z)(r))throw TypeError("Stringified UUID is invalid");return r}},79843:(e,t,r)=>{r.d(t,{Z:()=>o});var a=r(6649),s=r(16099);let o=function(e,t,r){let o=(e=e||{}).random||(e.rng||a.Z)();if(o[6]=15&o[6]|64,o[8]=63&o[8]|128,t){r=r||0;for(let e=0;e<16;++e)t[r+e]=o[e];return t}return(0,s.Z)(o)}},30900:(e,t,r)=>{r.d(t,{Z:()=>s});let a=/^(?:[0-9a-f]{8}-[0-9a-f]{4}-[1-5][0-9a-f]{3}-[89ab][0-9a-f]{3}-[0-9a-f]{12}|00000000-0000-0000-0000-000000000000)$/i,s=function(e){return"string"==typeof e&&a.test(e)}}};var t=require("../../../../webpack-runtime.js");t.C(e);var r=e=>t(t.s=e),a=t.X(0,[276,972],()=>r(47714));module.exports=a})();