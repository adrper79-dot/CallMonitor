# Duplicate Call Issue - Diagnosis & Fix - Jan 12, 2026

## üîç **Problem Statement**

**Symptoms:**
- User clicks "Start Call" once
- **TWO separate calls created** in database with different call_ids
- Same phone number rings **twice**
- Happens for both single-leg and bridge calls
- Frontend shows two success toasts

**Evidence:**
```
Call 287055e4-22b5-4b57-b46c-5f603a4e97d8 created
Call eaaee79f-0907-4ede-819c-d6c7719c62ec created
```
These are **different UUIDs** generated by the backend, confirming the handler was invoked twice.

---

## üß™ **Investigation Steps**

### Step 1: Verify Frontend Protection is Active

**Expected:** Frontend `isSubmittingRef` should prevent double-clicks

**Check:**
1. Hard refresh browser (Ctrl+Shift+F5)
2. Open DevTools ‚Üí Console
3. Click "Start Call" rapidly 2-3 times
4. Should see: `startCall: already submitting, ignoring duplicate click`
5. Should only create ONE call

**If this works:** Frontend protection is working, issue is elsewhere

**If this fails:** Frontend code not deployed yet, wait for Vercel

---

### Step 2: Check Backend Request ID Tracking

**Added in commit `43f4a14`:**
- Each API request gets unique ID: `req-{timestamp}-{random}`
- Logs show: `[req-xxx] POST /api/calls/start: REQUEST RECEIVED`

**How to Use:**
1. Make a test call (single-leg, "From" field empty)
2. Go to Vercel Dashboard ‚Üí Logs
3. Search for: `POST /api/calls/start: REQUEST RECEIVED`
4. **Count occurrences:**
   - **1 occurrence:** API called once ‚Üí Issue is in backend/SignalWire
   - **2+ occurrences:** API called multiple times ‚Üí Issue is in frontend/network

**Example:**
```
[req-1705012345678-abc123] POST /api/calls/start: REQUEST RECEIVED
[req-1705012345678-abc123] startCall route: session check
[req-1705012345678-abc123] startCall route: delegating to startCall handler
[req-1705012345678-abc123] startCall route: handler returned { success: true, callId: '287055e4-...' }

[req-1705012345890-def456] POST /api/calls/start: REQUEST RECEIVED  ‚Üê DUPLICATE!
```

---

### Step 3: Check SignalWire Logs

**What to Look For:**
- How many SignalWire API calls were made?
- Do the call SIDs match the number of rings?
- Are the calls created at exactly the same time or seconds apart?

**SignalWire Dashboard:**
1. Go to SignalWire ‚Üí Call Logs
2. Filter by time range (last 10 minutes)
3. Look for calls to `+17062677235` (or your test number)
4. Check creation timestamps

**Scenarios:**
- **2 calls, same timestamp:** Backend called SignalWire twice in same handler invocation
- **2 calls, 1-2 sec apart:** API route invoked twice (two separate requests)
- **1 call in logs, 2 rings:** SignalWire or carrier duplicating the call (rare)

---

## üîß **Possible Root Causes**

### 1. **Browser Auto-Retry** (LIKELY)
Some browsers automatically retry POST requests that:
- Fail to load fully
- Time out
- Return non-2xx status codes
- Get interrupted

**Solution:** Add idempotency keys to API calls

### 2. **Next.js Hot Reload** (DEV ONLY)
In development mode, Next.js might invoke handlers multiple times due to hot module replacement.

**Test:** Does this happen in production only, or also in local dev?

### 3. **Vercel Edge Network Retry** (POSSIBLE)
Vercel might retry requests that:
- Timeout at edge
- Fail to reach origin
- Return 5xx errors

**Solution:** Already implemented - idempotency middleware (see `withIdempotency`)

### 4. **React State Race Condition** (UNLIKELY)
Even with `isSubmittingRef`, if React re-renders the component before the ref is updated, it could fire twice.

**Solution:** Move ref check earlier in function, add more granular logging

### 5. **Webhook Triggering Duplicate** (UNLIKELY)
A webhook might be calling the API endpoint directly.

**Check:** Search codebase for any code that POSTs to `/api/calls/start`

---

## üõ†Ô∏è **Fixes Deployed**

### Fix 1: Request ID Tracking (commit `43f4a14`)
- Every API invocation gets unique ID
- Logs include request ID for tracing
- Can now correlate Vercel logs to identify duplicate invocations

### Fix 2: Frontend Debouncing (commit `e3b1428`)
- `useRef(false)` prevents double-clicks
- Check at start of `startCall` function
- Reset in `finally` block

### Fix 3: Idempotency Middleware (VERIFY USAGE)
**Check:** Is `/api/calls/start` wrapped with `withIdempotency`?

Currently, only `/api/voice/config` uses it. We should add it to `/api/calls/start`.

---

## ‚úÖ **Next Steps**

### Immediate (After Vercel Deploys):
1. **Hard refresh** browser (Ctrl+Shift+F5)
2. **Make ONE test call** (leave "From" empty)
3. **Check Vercel logs** for request ID tracking:
   - Go to Vercel Dashboard ‚Üí Project ‚Üí Logs
   - Search for `POST /api/calls/start: REQUEST RECEIVED`
   - Count how many times it appears
4. **Check SignalWire logs** for duplicate calls

### If API is Called Once But Phone Rings Twice:
‚Üí Issue is with SignalWire or carrier (contact SignalWire support)

### If API is Called Twice:
‚Üí Add idempotency middleware to `/api/calls/start` route

---

## üìä **Idempotency Fix (If Needed)**

If we confirm the API is being called twice, apply this fix:

```typescript
// app/api/calls/start/route.ts
import { withIdempotency } from '@/lib/idempotency'

async function handlePOST(req: Request) {
  // ... existing code ...
}

export const POST = withIdempotency(handlePOST, {
  ttlSeconds: 60, // Prevent duplicate calls within 60 seconds
  keyExtractor: (req) => {
    // Generate idempotency key from phone number + org
    const body = await req.json()
    return `call-${body.organization_id}-${body.phone_number}-${Date.now()}`
  }
})
```

This will ensure that even if the API is called twice with identical parameters, only ONE call is created.

---

## üöÄ **Deployment Status**

**Latest Commits:**
- `43f4a14` - Request ID tracking ‚Üê **DEPLOYING NOW**
- `0e698d3` - Credentials fix
- `e3b1428` - Frontend debouncing

**Vercel:** Building now (~2-3 minutes for production build)

**Next:** 
1. Wait 3 minutes for Vercel to finish
2. **HARD REFRESH** (Ctrl+Shift+F5) to clear old bundle
3. Test single call
4. Check Vercel logs for request IDs

---

**Status:** ‚è≥ **DEPLOYING - Wait 3 minutes, then hard refresh and test**
